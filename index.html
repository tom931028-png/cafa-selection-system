<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAFA 選課登入</title>
    <style>
        body { background: #00308F; height: 100vh; display: flex; justify-content: center; align-items: center; font-family: sans-serif; }
        .box { background: white; padding: 40px; border-radius: 10px; width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; background: #FFD700; border: none; font-weight: bold; cursor: pointer; color: #00308F; border-radius: 5px; margin-top: 10px; }
        .link { margin-top: 15px; font-size: 12px; color: #666; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>
    <div class="box">
        <h1 style="color:#00308F;">✈️ CAFA</h1>
        <div id="login-form">
            <input id="lid" placeholder="學號 (Admin用: admin)">
            <input id="lpw" type="password" placeholder="密碼 (Admin用: admin)">
            <button onclick="login()">登入系統</button>
            <div class="link" onclick="toggle('reg')">還沒帳號？點此註冊</div>
        </div>
        
        <div id="reg-form" style="display:none;">
            <input id="rid" placeholder="學號">
            <input id="rname" placeholder="姓名">
            <input id="rclass" placeholder="班級">
            <input id="rpw" type="password" placeholder="設定密碼">
            <button onclick="reg()">送出申請</button>
            <div class="link" onclick="toggle('login')">返回登入</div>
        </div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud } from './firebase-connect.js';

        window.toggle = (mode) => {
            document.getElementById('login-form').style.display = mode==='login'?'block':'none';
            document.getElementById('reg-form').style.display = mode==='reg'?'block':'none';
        };

        window.login = async () => {
            const id = document.getElementById('lid').value;
            const pw = document.getElementById('lpw').value;
            
            if(id === 'admin' && pw === 'admin') return location.href = 'admin.html';

            const db = (await loadFromCloud('cafa_all_students_db')) || [];
            const s = db.find(x => x.id === id);
            
            if(!s) return alert("帳號不存在");
            if(s.password !== pw) return alert("密碼錯誤");
            if(s.status === 'pending') return alert("帳號審核中，請通知教官");
            
            sessionStorage.setItem('cafa_user', JSON.stringify(s));
            location.href = 'dashboard.html';
        };

        window.reg = async () => {
            const id = document.getElementById('rid').value;
            const name = document.getElementById('rname').value;
            const pw = document.getElementById('rpw').value;
            const cls = document.getElementById('rclass').value;
            if(!id || !name || !pw) return alert("請填寫完整");

            let db = (await loadFromCloud('cafa_all_students_db')) || [];
            if(db.some(s => s.id === id)) return alert("此學號已註冊");

            // 自動抓取目前的必修課給新生
            const fixedCourses = (await loadFromCloud('cafa_fixed_courses')) || [];
            
            db.push({
                id, name, classId: cls, password: pw, status: 'pending',
                courses: fixedCourses.map(c => ({...c})), // 複製必修課
                careerTrack: '', interests: []
            });
            
            await saveToCloud('cafa_all_students_db', db);
            alert("申請已送出，請等待審核！");
            window.toggle('login');
        };
    </script>
</body>
</html>




