<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å¸«ç®¡ç†ç³»çµ± | CAFA Admin</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #ffebee; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 6px solid #c62828; }
        h2, h3 { color: #c62828; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        .section-box { margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px dashed #ccc; }
        
        /* è¡¨å–®æ§åˆ¶ */
        .control-panel { background-color: #fff3e0; padding: 20px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #ff9800; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { flex: 1; }
        label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 5px; color: #666; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* æŒ‰éˆ•ç¾¤ */
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s; }
        .btn-submit { background-color: #c62828; color: white; width: 100%; font-size: 16px; } .btn-submit:hover { background-color: #b71c1c; }
        .btn-delete { background-color: #555; color: white; }
        .btn-save { background-color: #2e7d32; color: white; width: 100%; }
        .btn-toggle-on { background-color: #2e7d32; color: white; } 
        .btn-toggle-off { background-color: #e65100; color: white; }
        
        /* è¡¨æ ¼èˆ‡æ¨™ç±¤ */
        table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
        th { background-color: #f5f5f5; color: #444; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        .tag-type { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; }
        .tag-fixed { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .tag-elective { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .status-badge { font-size: 12px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
        .status-open { background: #e8f5e9; color: green; border: 1px solid green; }
        .status-closed { background: #ffebee; color: red; border: 1px solid red; }
        .score-input { width: 60px; padding: 5px; text-align: center; font-weight: bold; border: 2px solid #ccc; }
    </style>
</head>
<body>

    <div class="container">
        <div class="section-box">
            <h2>ğŸ‘¨â€ğŸ« èª²ç¨‹ç®¡ç† (æ’èª²/é¸èª²é–‹é—œ)</h2>
            <div class="control-panel">
                <div class="form-row">
                    <div class="form-group">
                        <label>èª²ç¨‹å±¬æ€§</label>
                        <select id="c_type">
                            <option value="elective">ğŸ“– é–‹æ”¾é¸ä¿®</option>
                            <option value="fixed">ğŸ”’ ç­å®šå¿…ä¿®</option>
                        </select>
                    </div>
                    <div class="form-group"><label>ä»£ç¢¼</label><input type="text" id="c_id" placeholder="ID"></div>
                    <div class="form-group" style="flex:2;"><label>åç¨±</label><input type="text" id="c_name" placeholder="Name"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>å­¸åˆ†</label><input type="number" id="c_credit" value="2"></div>
                    <div class="form-group"><label>æ™‚é–“</label><input type="text" id="c_time" placeholder="ä¸‰/5,6"></div>
                    <div class="form-group"><label>åœ°é»</label><input type="text" id="c_location" placeholder="æ•™å®¤"></div>
                    <div class="form-group"><label>æ•™å®˜</label><input type="text" id="c_teacher" placeholder="å§“å"></div>
                </div>
                <button class="btn btn-submit" onclick="addNewCourse()">ç™¼å¸ƒèª²ç¨‹</button>
            </div>
            
            <h3>å·²ç™¼å¸ƒèª²ç¨‹åˆ—è¡¨</h3>
            <table>
                <thead><tr><th>å±¬æ€§/ç‹€æ…‹</th><th>åç¨±</th><th>æ™‚é–“/åœ°é»</th><th>é¸èª²é–‹é—œ</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="managed-list-body"></tbody>
            </table>
        </div>

        <div class="section-box" style="background-color: #fdfbf7; padding: 20px; border-radius: 8px;">
            <h2>ğŸ“ å­¸ç”Ÿæˆç¸¾ç™»éŒ„</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>é¸æ“‡å­¸ç”Ÿ</label>
                    <select id="student-selector" onchange="loadStudentGrades()"><option value="">-- è®€å–ä¸­ --</option></select>
                </div>
                <div class="form-group" style="display:flex; align-items:flex-end;">
                    <button class="btn btn-save" onclick="saveGrades()">ğŸ’¾ å„²å­˜è©²ç”Ÿæˆç¸¾</button>
                </div>
            </div>
            <table id="grade-table">
                <thead><tr><th>èª²ç¨‹åç¨±</th><th>å­¸åˆ†</th><th>ç›®å‰åˆ†æ•¸</th><th>è¼¸å…¥æ–°æˆç¸¾</th></tr></thead>
                <tbody id="grade-list-body"><tr><td colspan="4" style="text-align:center;color:#999;">è«‹å…ˆé¸æ“‡å­¸ç”Ÿ</td></tr></tbody>
            </table>
        </div>

        <div>
            <h3>ğŸ‘¨â€ğŸ“ å­¸ç”Ÿé¸èª²ç‹€æ³ç¸½è¦½</h3>
            <table>
                <thead><tr><th>å­¸è™Ÿ/å§“å</th><th>ç¸½å­¸åˆ†</th><th>é¸èª²æ˜ç´°</th></tr></thead>
                <tbody id="student-list-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        const FIXED_KEY = 'cafa_fixed_courses';
        const ELECTIVE_KEY = 'cafa_public_electives';
        const STUDENT_DB_KEY = 'cafa_all_students_db';
        let currentStudentId = null;

        window.onload = function() {
            renderManagedList(); renderStudentList(); updateStudentSelector();
            setInterval(() => { renderStudentList(); updateStudentSelector(); }, 5000);
        };

        // --- 1. æ’èª²åŠŸèƒ½ ---
        function addNewCourse() {
            const type = document.getElementById('c_type').value;
            const id = document.getElementById('c_id').value;
            const name = document.getElementById('c_name').value;
            const credit = parseInt(document.getElementById('c_credit').value);
            const time = document.getElementById('c_time').value;
            const location = document.getElementById('c_location').value;
            const teacher = document.getElementById('c_teacher').value;
            
            if(!id||!name) { alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š"); return; }
            
            const newCourse = { id, name, credit, time, location, teacher, type: type==='fixed'?'å¿…ä¿®':'é¸ä¿®', isFixed: type==='fixed', isOpen: true };
            const key = type === 'fixed' ? FIXED_KEY : ELECTIVE_KEY;
            let list = JSON.parse(localStorage.getItem(key)) || [];
            if(list.some(c=>c.id===id)) { alert("èª²ç¨‹ä»£ç¢¼é‡è¤‡"); return; }
            list.push(newCourse);
            localStorage.setItem(key, JSON.stringify(list));
            renderManagedList();
            document.querySelectorAll('input').forEach(i => i.value = '');
        }

        function renderManagedList() {
            const tbody = document.getElementById('managed-list-body'); tbody.innerHTML = '';
            const fixed = JSON.parse(localStorage.getItem(FIXED_KEY)) || [];
            const elect = JSON.parse(localStorage.getItem(ELECTIVE_KEY)) || [];
            
            fixed.forEach((c,i) => {
                tbody.innerHTML += `<tr><td><span class="tag-type tag-fixed">ç­å®š</span></td><td>${c.name}</td><td>${c.time}/${c.location}</td><td><small style="color:#999">(å¼·åˆ¶)</small></td><td><button class="btn btn-delete" onclick="delCourse('${FIXED_KEY}',${i})">åˆªé™¤</button></td></tr>`;
            });
            elect.forEach((c,i) => {
                let isOpen = (c.isOpen !== false);
                let badge = isOpen ? `<span class="status-badge status-open">é–‹æ”¾ä¸­</span>` : `<span class="status-badge status-closed">å·²é—œé–‰</span>`;
                let btn = isOpen ? `<button class="btn btn-toggle-off" onclick="toggleStatus('${ELECTIVE_KEY}',${i})">é—œé–‰é¸èª²</button>` : `<button class="btn btn-toggle-on" onclick="toggleStatus('${ELECTIVE_KEY}',${i})">é–‹å•Ÿé¸èª²</button>`;
                tbody.innerHTML += `<tr><td><span class="tag-type tag-elective">é¸ä¿®</span>${badge}</td><td>${c.name}</td><td>${c.time}/${c.location}</td><td>${btn}</td><td><button class="btn btn-delete" onclick="delCourse('${ELECTIVE_KEY}',${i})">åˆªé™¤</button></td></tr>`;
            });
        }
        
        function toggleStatus(key, idx) {
            let list = JSON.parse(localStorage.getItem(key)) || [];
            if(list[idx].isOpen === undefined) list[idx].isOpen = true;
            list[idx].isOpen = !list[idx].isOpen;
            localStorage.setItem(key, JSON.stringify(list));
            renderManagedList();
        }
        function delCourse(key, idx) { if(confirm("ç¢ºå®šåˆªé™¤?")) { let l=JSON.parse(localStorage.getItem(key))||[]; l.splice(idx,1); localStorage.setItem(key,JSON.stringify(l)); renderManagedList(); } }

        // --- 2. ç›£æ§èˆ‡æˆç¸¾ ---
        function renderStudentList() {
            const db = JSON.parse(localStorage.getItem(STUDENT_DB_KEY)) || [];
            const tbody = document.getElementById('student-list-body'); tbody.innerHTML = '';
            db.forEach(s => {
                let courses = s.courses.map(c => `<span style="background:#eee;padding:2px;margin:1px;font-size:12px;">${c.name}</span>`).join('');
                tbody.innerHTML += `<tr><td>${s.name} (${s.id})</td><td>${s.totalCredits}</td><td>${courses}</td></tr>`;
            });
        }
        function updateStudentSelector() {
            const sel = document.getElementById('student-selector');
            const db = JSON.parse(localStorage.getItem(STUDENT_DB_KEY)) || [];
            const saved = sel.value;
            sel.innerHTML = '<option value="">-- è«‹é¸æ“‡å­¸ç”Ÿ --</option>';
            db.forEach(s => { let opt=document.createElement('option'); opt.value=s.id; opt.text=`${s.id} - ${s.name}`; sel.add(opt); });
            sel.value = saved;
        }
        function loadStudentGrades() {
            currentStudentId = document.getElementById('student-selector').value;
            const tbody = document.getElementById('grade-list-body'); tbody.innerHTML='';
            if(!currentStudentId) return;
            const db = JSON.parse(localStorage.getItem(STUDENT_DB_KEY)) || [];
            const s = db.find(x => x.id === currentStudentId);
            if(!s || !s.courses.length) { tbody.innerHTML='<tr><td colspan=4>ç„¡èª²ç¨‹è³‡æ–™</td></tr>'; return; }
            s.courses.forEach(c => {
                let sc = (c.score!==undefined && c.score!==null) ? c.score : '';
                tbody.innerHTML += `<tr><td>${c.name}</td><td>${c.credit}</td><td style="color:blue;font-weight:bold">${sc||'-'}</td><td><input type="number" id="score-${c.id}" value="${sc}" class="score-input"></td></tr>`;
            });
        }
        function saveGrades() {
            if(!currentStudentId) return;
            const db = JSON.parse(localStorage.getItem(STUDENT_DB_KEY)) || [];
            const idx = db.findIndex(s => s.id === currentStudentId);
            if(idx===-1) return;
            db[idx].courses = db[idx].courses.map(c => {
                const inp = document.getElementById(`score-${c.id}`);
                if(inp && inp.value!=='') c.score = parseInt(inp.value);
                return c;
            });
            localStorage.setItem(STUDENT_DB_KEY, JSON.stringify(db));
            alert("âœ… æˆç¸¾å·²å„²å­˜"); loadStudentGrades();
        }
    </script>
</body>
</html>