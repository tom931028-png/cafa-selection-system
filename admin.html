<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å¸«ç®¡ç†ç³»çµ± | CAFA Admin</title>
    <style>
        /* --- æ ¸å¿ƒä¸»é¡Œè‰²ç³» --- */
        :root {
            --admin-blue: #00308F;
            --admin-dark: #002266;
            --admin-gold: #FFD700;
            --admin-bg: #f4f7fa;
            --admin-card-bg: #ffffff;
        }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: var(--admin-bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: #333; }
        
        /* --- å´é‚Šæ¬„ --- */
        .sidebar { width: 260px; background: linear-gradient(180deg, var(--admin-blue) 0%, var(--admin-dark) 100%); color: white; display: flex; flex-direction: column; padding-top: 25px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); position: relative; z-index: 10; }
        .sidebar-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .menu-item { padding: 15px 25px; cursor: pointer; transition: 0.3s; color: rgba(255,255,255,0.8); display: flex; align-items: center; font-size: 15px; border-left: 5px solid transparent; }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { background: rgba(0,0,0,0.2); border-left-color: var(--admin-gold); color: white; font-weight: bold; }
        .menu-item span { margin-right: 12px; font-size: 20px; }
        .admin-info { margin-top: auto; padding: 20px; background: rgba(0,0,0,0.25); font-size: 13px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; }

        /* --- ä¸»å…§å®¹å€ --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background-image: linear-gradient(to bottom, #eef2f7, #f4f7fa); }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header-title { font-size: 24px; font-weight: bold; color: var(--admin-blue); border-left: 8px solid var(--admin-gold); padding-left: 15px; }

        .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-top: 4px solid var(--admin-blue); box-shadow: 0 5px 20px rgba(0,0,0,0.05); transition: 0.3s; }
        .card h3 { margin-top: 0; color: var(--admin-blue); border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 18px; }

        /* é¢æ¿èˆ‡è¡¨å–® */
        .control-panel { background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e9ecef; }
        .student-panel { background-color: #e3f2fd; border-color: #bbdefb; }
        .batch-panel { background-color: #e0f2f1; border-color: #b2dfdb; }
        .stats-panel { background-color: #fff8e1; border: 1px solid #ffe0b2; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-around; font-weight: bold; color: #e65100; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 150px; }
        label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select { width: 100%; padding: 10px; border: 2px solid #dae1e7; border-radius: 6px; transition: 0.3s; box-sizing: border-box; }

        /* æŒ‰éˆ• */
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; color: white; display: inline-flex; align-items: center; justify-content: center; width: 100%; }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-submit { background-color: var(--admin-blue); padding: 12px; } 
        .btn-add { background-color: #00695c; padding: 12px; }
        .btn-batch { background-color: #00796b; font-size: 15px; padding: 12px; }
        .btn-del { background-color: #dc3545; width: auto; padding: 5px 12px; font-size: 12px; } 
        .btn-save { background-color: #2e7d32; padding: 12px; }
        .btn-toggle { width: auto; font-size: 12px; padding: 5px 10px; } .btn-toggle-on { background-color: #2e7d32; } .btn-toggle-off { background-color: #ff9800; }
        .btn-reset { background-color: #546e7a; margin-top: 10px; }
        .btn-print { background: #607d8b; width: auto; margin-left: 10px; }

        /* è¡¨æ ¼èˆ‡æ¨™ç±¤ */
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; margin-top: 10px; }
        th { background-color: #f1f3f5; color: #495057; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: bold; }
        td { padding: 12px; border-bottom: 1px solid #eee; background: white; vertical-align: middle; }
        .tag { padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; display: inline-block; margin: 2px; }
        .tag-class { background: #673ab7; color: white; border-radius: 12px; }
        .tag-fixed { background: #ffebee; color: #c62828; } .tag-elective { background: #e3f2fd; color: #0d47a1; }
        .tag-interest { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }
        .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .status-open { background: #e8f5e9; color: green; } .status-closed { background: #ffebee; color: red; }
        .score-input { width: 60px; text-align: center; border: 2px solid #ccc; padding: 5px; border-radius: 4px; }
        .score-fail { color: red; font-weight: bold; }
        .rank-badge { padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 12px; color: #333; display: inline-flex; align-items: center; gap: 5px; border: 1px solid rgba(0,0,0,0.1); }

        /* --- èª²è¡¨å°ˆç”¨æ¨£å¼ (ç¾åŒ–ç‰ˆ) --- */
        .schedule-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .schedule-table th { text-align: center; background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); padding: 10px; font-size: 14px; }
        .schedule-table td { height: 70px; border: 1px solid rgba(0,0,0,0.1); padding: 4px; vertical-align: top; text-align: center; font-size: 13px; }
        
        /* èª²ç¨‹å¡ç‰‡ */
        .course-block { 
            padding: 6px; border-radius: 6px; color: white; font-size: 12px; 
            margin-bottom: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            display: flex; flex-direction: column; justify-content: center; height: 90%;
            transition: transform 0.2s;
        }
        .course-block:hover { transform: scale(1.05); z-index: 5; }
        .block-fixed { background: linear-gradient(135deg, #e65100, #ff9800); border-left: 4px solid #bf360c; }
        .block-normal { background: linear-gradient(135deg, var(--admin-blue), #4a7bd1); border-left: 4px solid #002266; }

        /* èƒŒæ™¯ä¸»é¡ŒæŒ‰éˆ• */
        .theme-controls { display: flex; gap: 10px; align-items: center; margin-right: auto; }
        .theme-btn { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #ddd; transition: 0.2s; }
        .theme-btn:hover { transform: scale(1.2); }
        .tb-white { background: white; } .tb-blue { background: #e3f2fd; } .tb-warm { background: #fff8e1; } .tb-dark { background: #333; }

        /* ä¸»é¡Œæ¨£å¼å®šç¾© */
        .card-theme-blue { background: linear-gradient(to bottom right, #f0f7ff, #dbeafe) !important; border-color: #1e88e5 !important; position: relative; }
        .card-theme-blue::before { content: 'âœˆ'; position: absolute; font-size: 200px; color: rgba(0,0,0,0.03); top: 50px; left: 100px; pointer-events: none; transform: rotate(-15deg); }
        .card-theme-warm { background: #fffdeb !important; border-color: #fdd835 !important; }
        .card-theme-dark { background: #2c3e50 !important; color: #ecf0f1 !important; border-color: #34495e !important; }
        .card-theme-dark th { background: #34495e !important; color: white !important; border-color: #465c71 !important; }
        .card-theme-dark td { border-color: #465c71 !important; }

        /* Loading */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 18px; color: var(--admin-blue); z-index: 999; }

        /* åˆ—å°æ¨£å¼ */
        @media print {
            @page { size: landscape; margin: 1cm; }
            .sidebar, .header-bar, .theme-controls, .btn { display: none !important; }
            .main-content { padding: 0; margin: 0; background: white; }
            body { background: white; height: auto; overflow: visible; }
            .card { box-shadow: none; border: 1px solid #ccc; margin: 0; padding: 10px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .card-theme-dark { background: white !important; color: black !important; border-color: #ccc !important; }
            .card-theme-dark th { background: #f8f9fa !important; color: black !important; }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div style="font-size:40px; margin-bottom:10px;">â˜ï¸</div>
        <div>è³‡æ–™åŒæ­¥ä¸­...</div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>âœˆï¸ ç®¡ç†ç³»çµ±</h2>
            <div style="font-size:12px; opacity:0.7; margin-top:5px;">ç©ºè»å®˜æ ¡èª²å‹™çµ„</div>
        </div>
        
        <div class="menu-item active" onclick="switchTab('monitor')"><span>ğŸŒ</span> å…¨æ ¡ç›£æ§</div>
        <div class="menu-item" onclick="switchTab('schedule')"><span>ğŸ“…</span> æ•™å¸«èª²è¡¨</div>
        <div class="menu-item" onclick="switchTab('ranks')"><span>ğŸ†</span> çæ‡²è¨­å®š</div>
        <div class="menu-item" onclick="switchTab('students')"><span>ğŸ‘¥</span> å­¸ç”Ÿèˆ‡ç­ç´š</div>
        <div class="menu-item" onclick="switchTab('courses')"><span>ğŸ‘¨â€ğŸ«</span> èª²ç¨‹ç®¡ç†</div>
        <div class="menu-item" onclick="switchTab('grades')"><span>ğŸ“</span> æˆç¸¾èˆ‡åˆ†æ</div>
        
        <div class="admin-info">
            <div>èº«åˆ†ï¼šæ•™å®˜/ç®¡ç†è€…</div>
            <button class="btn btn-reset" onclick="resetSystem()">âš ï¸ åˆå§‹åŒ–ç³»çµ±</button>
        </div>
    </div>

    <div class="main-content">
        
        <div id="monitor-view">
            <div class="header-bar"><div class="header-title">å…¨æ ¡å­¸ç”Ÿé¸èª²èˆ‡è·æ¶¯ç›£æ§</div></div>
            <div class="card">
                <h3>å­¸ç”Ÿç‹€æ…‹ç¸½è¦½</h3>
                <table><thead><tr><th style="width:180px;">å­¸è™Ÿ / å§“å</th><th>ç­ç´š</th><th style="width:100px;">è·æ¶¯</th><th>èˆˆè¶£</th><th style="width:60px;">å­¸åˆ†</th><th>é¸èª²æ˜ç´°</th></tr></thead><tbody id="student-list-body"></tbody></table>
            </div>
        </div>

        <div id="schedule-view" style="display: none;">
            <div class="header-bar">
                <div class="header-title">æ•™å¸«èª²è¡¨æŸ¥è©¢</div>
                <div class="theme-controls">
                    <span style="font-size:12px; color:#666; margin-left:20px;">åˆ‡æ›èƒŒæ™¯:</span>
                    <div class="theme-btn tb-white" onclick="setTheme('white')" title="æ¨™æº–ç™½"></div>
                    <div class="theme-btn tb-blue" onclick="setTheme('blue')" title="ç©ºè»è—"></div>
                    <div class="theme-btn tb-warm" onclick="setTheme('warm')" title="è­·çœ¼é»ƒ"></div>
                    <div class="theme-btn tb-dark" onclick="setTheme('dark')" title="æ¥µç°¡é»‘"></div>
                </div>
                <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
            </div>
            
            <div class="card" id="teacher-schedule-card">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <h3 style="margin:0; border:none; padding:0;">æŸ¥è©¢å°è±¡ï¼š</h3>
                        <select id="teacher-schedule-selector" onchange="renderTeacherSchedule()" style="padding:8px; font-size:16px; min-width:200px; border:2px solid var(--admin-blue); border-radius:6px;">
                            <option value="">-- è«‹é¸æ“‡æ•™å®˜/æ•™æˆ --</option>
                        </select>
                    </div>
                    <div id="schedule-info" style="font-size:14px; color:#666;"></div>
                </div>
                
                <h4 style="text-align:center; margin-bottom:15px; font-size:18px; color:var(--admin-blue);" id="schedule-title">è«‹é¸æ“‡ä¸€ä½æ•™å®˜ä»¥é¡¯ç¤ºèª²è¡¨</h4>
                
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th style="width:60px;">ç¯€æ¬¡</th>
                            <th>æ˜ŸæœŸä¸€</th><th>æ˜ŸæœŸäºŒ</th><th>æ˜ŸæœŸä¸‰</th><th>æ˜ŸæœŸå››</th><th>æ˜ŸæœŸäº”</th>
                        </tr>
                    </thead>
                    <tbody id="teacher-schedule-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="ranks-view" style="display: none;">
            <div class="header-bar"><div class="header-title">ğŸ† ç‰Œä½çå‹µèˆ‡æ‡²ç½°è¨­å®š</div></div>
            <div class="card">
                <p style="color:#666; font-size:14px;">è¨­å®šå„æ’ä½çš„çæ‡²å…§å®¹ï¼Œå°‡åŒæ­¥è‡³å­¸ç”Ÿç«¯é¡¯ç¤ºã€‚</p>
                <table><thead><tr><th width="15%">ç‰Œä½åç¨±</th><th width="10%">æœ€ä½åˆ†</th><th width="10%">é¡è‰²</th><th>ğŸ çå‹µå…§å®¹</th><th>âš ï¸ æ‡²ç½°å…§å®¹</th></tr></thead><tbody id="rank-rules-body"></tbody></table>
                <div style="margin-top:20px;text-align:right;"><button class="btn btn-save" style="width:200px;" onclick="saveRankRules()">ğŸ’¾ å„²å­˜è¨­å®š</button></div>
            </div>
        </div>

        <div id="students-view" style="display: none;">
            <div class="header-bar"><div class="header-title">å­¸ç”Ÿèˆ‡ç­ç´šç®¡ç†</div></div>
            <div class="card">
                <h3>å­¸ç”Ÿç®¡ç†</h3>
                <div class="control-panel student-panel">
                    <div class="form-row">
                        <div class="form-group"><input type="text" id="s_id" placeholder="å­¸è™Ÿ"></div>
                        <div class="form-group"><input type="text" id="s_name" placeholder="å§“å"></div>
                        <div class="form-group"><input type="text" id="s_class" placeholder="ç­ç´š (å¦‚:114-èˆªå¤ª)"></div>
                        <div class="form-group"><input type="text" id="s_pass" placeholder="å¯†ç¢¼"></div>
                    </div>
                    <button class="btn btn-add" onclick="addStudent()">æ–°å¢ / æ›´æ–°</button>
                </div>
                <div style="max-height:300px;overflow-y:auto;"><table id="acc-table"><thead><tr><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç­ç´š</th><th>å¯†ç¢¼</th><th>æ“ä½œ</th></tr></thead><tbody id="account-list-body"></tbody></table></div>
            </div>
            <div class="card">
                <h3>ç­ç´šæ‰¹æ¬¡çŒæª”</h3>
                <div class="control-panel batch-panel"><div class="form-row"><select id="batch-class" class="form-group"></select><select id="batch-course" class="form-group"></select></div><button class="btn btn-batch" onclick="batchAssign()">ğŸš€ åŸ·è¡ŒçŒæª”</button></div>
            </div>
        </div>

        <div id="courses-view" style="display:none;"><div class="header-bar"><div class="header-title">èª²ç¨‹ç®¡ç†</div></div><div class="card"><div class="control-panel"><div class="form-row"><select id="c_type"><option value="fixed">å¿…ä¿®</option><option value="elective">é¸ä¿®</option></select><input id="c_id" placeholder="ä»£ç¢¼"><input id="c_name" placeholder="åç¨±"><input id="c_cr" type="number" value="2"><input id="c_time" placeholder="æ™‚é–“"><input id="c_loc" placeholder="åœ°é»"><input id="c_tea" placeholder="æ•™å®˜"></div><button class="btn btn-submit" onclick="addCourse()">ç™¼å¸ƒ</button></div><table id="course-table"><thead><tr><th>å±¬æ€§</th><th>åç¨±</th><th>æ™‚é–“</th><th>æ“ä½œ</th></tr></thead><tbody id="course-list"></tbody></table></div></div>
        <div id="grades-view" style="display:none;"><div class="header-bar"><div class="header-title">æˆç¸¾ç®¡ç†</div></div><div class="card"><div class="form-row"><select id="g_stu" onchange="loadGrades()" style="flex:2"></select><button class="btn btn-save" onclick="saveGrades()">å„²å­˜</button></div><table id="grade-table"><thead><tr><th>èª²ç¨‹</th><th>åˆ†</th><th>å…¥</th></tr></thead><tbody id="grade-body"></tbody></table></div></div>

    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud } from './firebase-connect.js';
        const KEYS = { STUDENTS:'cafa_all_students_db', FIXED:'cafa_fixed_courses', ELECTIVE:'cafa_public_electives', RANKS:'cafa_rank_rules' };
        let studentDB=[], fixedCourses=[], electiveCourses=[], rankRules=[];

        window.onload = async () => { showLoading(true); await refreshAll(); showLoading(false); setInterval(refreshAll, 10000); };
        
        window.switchTab = (id) => {
            ['monitor','schedule','ranks','students','courses','grades'].forEach(v=>document.getElementById(v+'-view').style.display='none');
            document.getElementById(id+'-view').style.display='block';
            document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active'));
            const m={'monitor':0,'schedule':1,'ranks':2,'students':3,'courses':4,'grades':5};
            document.querySelectorAll('.menu-item')[m[id]].classList.add('active');
            
            // å¦‚æœåˆ‡æ›åˆ°èª²è¡¨ï¼Œé‡æ–°æ¸²æŸ“ä¸€ä¸‹
            if(id === 'schedule') renderTeacherSchedule();
        };

        // --- ä¸»é¡Œåˆ‡æ› (JS) ---
        window.setTheme = function(theme) {
            const card = document.getElementById('teacher-schedule-card');
            card.className = 'card'; // æ¸…é™¤èˆŠä¸»é¡Œ
            if(theme !== 'white') card.classList.add(`card-theme-${theme}`);
        }

        // ç¶å®š
        window.resetSystem=resetSystem; window.saveRankRules=saveRankRules; window.renderTeacherSchedule=renderTeacherSchedule;
        window.addStudent=addStudent; window.deleteStudent=deleteStudent; window.batchAssign=batchAssign;
        window.addCourse=addCourse; window.delCourse=delCourse; window.loadGrades=loadGrades; window.saveGrades=saveGrades; window.toggleStatus=toggleStatus;

        async function refreshAll() {
            studentDB = (await loadFromCloud(KEYS.STUDENTS))||[];
            fixedCourses = (await loadFromCloud(KEYS.FIXED))||[];
            electiveCourses = (await loadFromCloud(KEYS.ELECTIVE))||[];
            rankRules = (await loadFromCloud(KEYS.RANKS))||getDefaultRanks();
            
            renderMonitor(); renderRankSettings(); renderStudents(); renderCourses(); updateSels();
        }

        // --- æ ¸å¿ƒå„ªåŒ–ï¼šæ•™å¸«èª²è¡¨ ---
        function renderTeacherSchedule() {
            const tea = document.getElementById('teacher-schedule-selector').value;
            const title = document.getElementById('schedule-title');
            const tbody = document.getElementById('teacher-schedule-body');
            tbody.innerHTML = ''; 

            // ç¹ªè£½ç©ºç¶²æ ¼
            const times = ["08:10", "09:10", "10:10", "11:10", "13:30", "14:30", "15:30", "16:30", "17:30", "19:00"];
            for(let i=1;i<=10;i++) tbody.innerHTML+=`<tr><td style="background:#f8f9fa;color:#666;font-weight:bold;">${i}</td><td id="t1-${i}"></td><td id="t2-${i}"></td><td id="t3-${i}"></td><td id="t4-${i}"></td><td id="t5-${i}"></td></tr>`;

            if(!tea) { title.innerText = "è«‹é¸æ“‡ä¸€ä½æ•™å®˜ä»¥é¡¯ç¤ºèª²è¡¨"; return; }
            title.innerText = `ğŸ“… ã€${tea}ã€‘æ•™å®˜æˆèª²æ™‚é–“è¡¨`;

            // æŠ“å–èª²ç¨‹
            const allC=[...fixedCourses,...electiveCourses].filter(c=>c.teacher===tea);
            const dMap={"ä¸€":1,"äºŒ":2,"ä¸‰":3,"å››":4,"äº”":5};
            
            let totalHours = 0;
            allC.forEach(c => {
                if(!c.time) return; 
                let [d,p]=c.time.split('/'); let dy=dMap[d];
                p.split(',').forEach(x => { 
                    totalHours++;
                    let el = document.getElementById(`t${dy}-${x}`);
                    if(el) {
                        // åˆ¤æ–·æ˜¯å¿…ä¿®é‚„æ˜¯é¸ä¿®ï¼Œçµ¦ä¸åŒé¡è‰²
                        let blockClass = c.isFixed ? 'block-fixed' : 'block-normal';
                        el.innerHTML = `
                            <div class="course-block ${blockClass}">
                                <div style="font-weight:bold;font-size:13px;">${c.name}</div>
                                <div style="opacity:0.9;">${c.location||'æœªå®šåœ°é»'}</div>
                                <div style="font-size:11px;opacity:0.8;margin-top:2px;">${c.type}</div>
                            </div>`;
                    }
                });
            });
            document.getElementById('schedule-info').innerText = `æœ¬å­¸æœŸæˆèª²æ™‚æ•¸ï¼š${totalHours} å°æ™‚`;
        }

        // --- å…¶ä»–åŠŸèƒ½ (ä¿æŒä¸è®Š) ---
        function getDefaultRanks() { return [{name:'ç‹è€…', min:90, color:'#ffe0b2', reward:'ç¦®åˆ¸', punishment:'ç„¡'}, {name:'é‘½çŸ³', min:80, color:'#b3e5fc', reward:'å˜‰ç', punishment:'ç„¡'}, {name:'é»ƒé‡‘', min:70, color:'#fff9c4', reward:'ç„¡', punishment:'ç„¡'}, {name:'ç™½éŠ€', min:60, color:'#f5f5f5', reward:'ç„¡', punishment:'æ™šè‡ªç¿’'}, {name:'é’éŠ…', min:0, color:'#ffccbc', reward:'ç„¡', punishment:'ç¦è¶³'}]; }
        
        function renderMonitor() {
            const t = document.getElementById('student-list-body'); t.innerHTML='';
            studentDB.forEach(s => {
                let tot=0, cr=0; (s.courses||[]).forEach(c => { if(c.score){ tot+=c.score*c.credit; cr+=c.credit; } });
                let gpa = cr>0 ? (tot/cr).toFixed(1) : 0;
                let rank = rankRules.find(r => gpa >= r.min) || rankRules[rankRules.length-1];
                let rankBadge = `<span class="rank-badge" style="background:${rank.color}">${rank.name} (${gpa})</span>`;
                if(cr===0) rankBadge = '<span style="color:#ccc">ç„¡æˆç¸¾</span>';
                let track = s.careerTrack==='pilot'?'ğŸ¦… é£›è¡Œ':(s.careerTrack==='ground'?'ğŸ› ï¸ åœ°å‹¤':'æœªå®š');
                t.innerHTML += `<tr><td>${s.name}<br><small>${s.id}</small></td><td><span class="tag tag-class" style="background:#673ab7;color:white;border-radius:10px;padding:2px 6px;">${s.classId||'-'}</span></td><td>${rankBadge}</td><td>${track}</td><td>${s.totalCredits||0}</td><td>${(s.courses||[]).length} ç§‘</td></tr>`;
            });
        }

        function renderRankSettings() {
            const t = document.getElementById('rank-rules-body'); t.innerHTML='';
            rankRules.forEach((r, i) => { t.innerHTML += `<tr><td><input value="${r.name}" id="rk-n-${i}" style="width:100%"></td><td><input type="number" value="${r.min}" id="rk-m-${i}" style="width:100%"></td><td><input type="color" value="${r.color}" id="rk-c-${i}"></td><td><input value="${r.reward}" id="rk-r-${i}" style="width:100%"></td><td><input value="${r.punishment}" id="rk-p-${i}" style="width:100%"></td></tr>`; });
        }
        async function saveRankRules() {
            rankRules = rankRules.map((r, i) => ({ name: document.getElementById(`rk-n-${i}`).value, min: parseInt(document.getElementById(`rk-m-${i}`).value), color: document.getElementById(`rk-c-${i}`).value, reward: document.getElementById(`rk-r-${i}`).value, punishment: document.getElementById(`rk-p-${i}`).value })).sort((a,b) => b.min - a.min);
            showLoading(true); await saveToCloud(KEYS.RANKS, rankRules); showLoading(false); alert("å·²å­˜"); renderMonitor();
        }

        async function addStudent() { const id=document.getElementById('s_id').value; const idx=studentDB.findIndex(s=>s.id===id); const obj={id, name:document.getElementById('s_name').value, classId:document.getElementById('s_class').value, password:document.getElementById('s_pass').value, dept:'-', courses:[], totalCredits:0}; if(idx>-1){Object.assign(studentDB[idx], obj);}else{studentDB.push(obj);} await saveToCloud(KEYS.STUDENTS, studentDB); renderStudents(); }
        async function deleteStudent(id) { if(confirm('åˆªé™¤?')){studentDB=studentDB.filter(s=>s.id!==id); await saveToCloud(KEYS.STUDENTS, studentDB); renderStudents();} }
        function renderStudents() { document.getElementById('account-list-body').innerHTML = studentDB.map(s=>`<tr><td>${s.id}</td><td>${s.name}</td><td>${s.classId}</td><td>${s.password}</td><td><button class="btn btn-del" onclick="deleteStudent('${s.id}')">åˆª</button></td></tr>`).join(''); }
        
        async function batchAssign() { 
            const cls=document.getElementById('batch-class').value; const cid=document.getElementById('batch-course').value;
            if(!cls||!cid)return alert("é¸ç­ç´šèª²ç¨‹"); const c=[...fixedCourses,...electiveCourses].find(x=>x.id===cid);
            studentDB.forEach(s=>{ if(s.classId===cls && !s.courses.some(x=>x.id===cid)){ s.courses.push(c); s.totalCredits+=c.credit; }});
            await saveToCloud(KEYS.STUDENTS, studentDB); alert("å®Œæˆ");
        }

        async function addCourse() { const t=document.getElementById('c_type').value; const c={id:document.getElementById('c_id').value, name:document.getElementById('c_name').value, credit:parseInt(document.getElementById('c_cr').value), time:document.getElementById('c_time').value, location:document.getElementById('c_loc').value, teacher:document.getElementById('c_teacher').value, type:t==='fixed'?'å¿…ä¿®':'é¸ä¿®', isFixed:t==='fixed', isOpen:true}; if(t==='fixed')fixedCourses.push(c);else electiveCourses.push(c); await saveToCloud(KEYS.FIXED,fixedCourses); await saveToCloud(KEYS.ELECTIVE,electiveCourses); renderCourses(); }
        async function delCourse(t,i) { if(t==='fixed')fixedCourses.splice(i,1);else electiveCourses.splice(i,1); await saveToCloud(KEYS.FIXED,fixedCourses); await saveToCloud(KEYS.ELECTIVE,electiveCourses); renderCourses(); }
        async function toggleStatus(i) { electiveCourses[i].isOpen=!electiveCourses[i].isOpen; await saveToCloud(KEYS.ELECTIVE,electiveCourses); renderCourses(); }
        function renderCourses() { document.getElementById('course-list').innerHTML = [...fixedCourses.map((c,i)=>`<tr><td>å¿…ä¿®</td><td>${c.name}</td><td>${c.time}</td><td><button class="btn btn-del" onclick="delCourse('fixed',${i})">åˆª</button></td></tr>`), ...electiveCourses.map((c,i)=>`<tr><td>é¸ä¿®</td><td>${c.name}</td><td>${c.time}</td><td><button class="btn btn-toggle ${c.isOpen?'btn-toggle-on':'btn-toggle-off'}" onclick="toggleStatus(${i})">${c.isOpen?'é–‹':'é—œ'}</button> <button class="btn btn-del" onclick="delCourse('elect',${i})">åˆª</button></td></tr>`)].join(''); }

        function loadGrades() { const sid=document.getElementById('g_stu').value; const t=document.getElementById('grade-body'); t.innerHTML=''; const s=studentDB.find(x=>x.id===sid); if(!s)return; s.courses.forEach(c=>{ t.innerHTML+=`<tr><td>${c.name}</td><td>${c.credit}</td><td><input type="number" id="sc-${c.id}" value="${c.score||''}" style="width:50px"></td></tr>`; }); }
        async function saveGrades() { const sid=document.getElementById('g_stu').value; const idx=studentDB.findIndex(x=>x.id===sid); studentDB[idx].courses=studentDB[idx].courses.map(c=>{const v=document.getElementById(`sc-${c.id}`).value; if(v)c.score=parseInt(v); return c;}); await saveToCloud(KEYS.STUDENTS, studentDB); alert("å­˜æª”"); }

        function updateSels() {
            const tea = document.getElementById('teacher-schedule-selector'); 
            const allC=[...fixedCourses,...electiveCourses]; 
            const ts=[...new Set(allC.map(c=>c.teacher).filter(x=>x))].sort(); 
            const savedT = tea.value; tea.innerHTML='<option value="">-- è«‹é¸æ“‡æ•™å®˜/æ•™æˆ --</option>'; ts.forEach(t=>tea.add(new Option(t,t))); tea.value = savedT;

            const stu = document.getElementById('g_stu'); stu.innerHTML='<option value="">-- é¸å­¸ç”Ÿ --</option>'; studentDB.forEach(s=>stu.add(new Option(s.name,s.id)));
            const cls = document.getElementById('batch-class'); const cs=[...new Set(studentDB.map(s=>s.classId).filter(x=>x))]; cls.innerHTML='<option value="">-- ç­ç´š --</option>'; cs.forEach(c=>cls.add(new Option(c,c)));
            const bco = document.getElementById('batch-course'); bco.innerHTML='<option value="">-- èª²ç¨‹ --</option>'; allC.forEach(c=>bco.add(new Option(c.name,c.id)));
        }

        async function resetSystem() { if(!confirm("é‡ç½®?"))return; const s=[{id:'11401',name:'æå¤§ç¶­',classId:'114-èˆªå¤ª',password:'1234',courses:[],careerTrack:'pilot'},{id:'11402',name:'ç‹å°ç¾',classId:'114-èˆªç®¡',password:'1234',courses:[],careerTrack:'ground'}]; const f=[{id:'AE101',name:'ç©ºæ°£å‹•åŠ›å­¸',credit:3,time:'ä¸€/3,4',location:'ç†å·¥ä¸€',teacher:'é™³å¿—è±ª',type:'å¿…ä¿®',isFixed:true}]; await saveToCloud(KEYS.STUDENTS,s); await saveToCloud(KEYS.FIXED,f); await saveToCloud(KEYS.ELECTIVE,[]); await saveToCloud(KEYS.RANKS, getDefaultRanks()); alert("å®Œæˆ"); refreshAll(); }
        function showLoading(s) { document.getElementById('loading').style.display=s?'flex':'none'; }
    </script>
</body>
</html>







