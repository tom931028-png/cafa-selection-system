<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å¸«ç®¡ç†ç³»çµ± | CAFA Admin</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* --- æ ¸å¿ƒä¸»é¡Œè‰²ç³» --- */
        :root { --admin-blue: #00308F; --admin-dark: #002266; --admin-gold: #FFD700; --admin-bg: #f4f7fa; }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: var(--admin-bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: #333; }
        
        /* --- å´é‚Šæ¬„ --- */
        .sidebar { width: 260px; background: linear-gradient(180deg, var(--admin-blue) 0%, var(--admin-dark) 100%); color: white; display: flex; flex-direction: column; padding-top: 25px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 100; transition: transform 0.3s; }
        .sidebar-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .menu-item { padding: 15px 25px; cursor: pointer; transition: 0.3s; color: rgba(255,255,255,0.8); display: flex; align-items: center; font-size: 15px; border-left: 5px solid transparent; }
        .menu-item:hover, .menu-item.active { background: rgba(0,0,0,0.2); border-left-color: var(--admin-gold); color: white; font-weight: bold; }
        .menu-item span { margin-right: 12px; font-size: 20px; }
        
        /* ç´…é»é€šçŸ¥ */
        .badge { background: #ff5252; color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px; margin-left: auto; font-weight: bold; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .badge.show { display: inline-block; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- ä¸»å…§å®¹å€ --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background-image: linear-gradient(to bottom, #eef2f7, #f4f7fa); position: relative; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); flex-wrap: wrap; gap: 10px; }
        .header-title { font-size: 24px; font-weight: bold; color: var(--admin-blue); border-left: 8px solid var(--admin-gold); padding-left: 15px; }

        .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-top: 4px solid var(--admin-blue); box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow-x: auto; transition: all 0.3s ease; position: relative; }
        .card-pending { border-top: 4px solid #ff9800; background: #fff8e1; }
        .card-pending h3 { color: #e65100; margin-top: 0; display: flex; align-items: center; gap: 10px; }
        
        /* --- ä¸»é¡Œæ¨£å¼ --- */
        .theme-controls { display: flex; align-items: center; gap: 8px; margin-left: auto; }
        .theme-btn { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid #ddd; transition: 0.2s; position: relative; }
        .theme-btn:hover { transform: scale(1.1); }
        .tb-white { background: white; } .tb-blue { background: #e3f2fd; } .tb-dark { background: #333; } .tb-warm { background: #fff8e1; }

        .card-theme-blue { background: linear-gradient(to bottom right, #f0f7ff, #dbeafe) !important; border-color: #1e88e5 !important; }
        .card-theme-blue::before { content: 'âœˆ'; position: absolute; font-size: 150px; color: rgba(0,0,0,0.03); bottom: 20px; right: 20px; pointer-events: none; transform: rotate(-15deg); z-index: 0; }
        .card-theme-dark { background: #2c3e50 !important; color: #ecf0f1 !important; border-color: #34495e !important; }
        .card-theme-dark th { background: #34495e !important; color: white !important; border-color: #465c71 !important; }
        .card-theme-dark td { border-color: #465c71 !important; }
        .card-theme-dark .schedule-table th:first-child, .card-theme-dark .schedule-table td:first-child { background-color: #34495e !important; color: #ecf0f1; border-color: #465c71; }
        .card-theme-dark select { background: #34495e; color: white; border-color: #555; }
        .card-theme-warm { background: #fffdeb !important; border-color: #fdd835 !important; }

        /* è¡¨æ ¼å„ªåŒ– */
        table { width: 100%; min-width: 600px; border-collapse: separate; border-spacing: 0; font-size: 14px; margin-top: 10px; }
        th { background-color: #f1f3f5; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        /* è¼¸å…¥èˆ‡æŒ‰éˆ• */
        input, select { width: 100%; padding: 10px; border: 2px solid #dae1e7; border-radius: 6px; box-sizing: border-box; }
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; color: white; display: inline-flex; align-items: center; justify-content: center; width: auto; margin-left: 5px; }
        .btn:hover { opacity: 0.9; }
        .btn-submit { background-color: var(--admin-blue); width: 100%; margin-left:0; margin-top:5px; } 
        .btn-add { background-color: #00695c; width: 100%; margin-left:0; } 
        .btn-del { background-color: #dc3545; padding: 6px 12px; font-size: 12px; }
        .btn-approve { background-color: #28a745; padding: 6px 12px; font-size: 12px; }
        .btn-print { background-color: #607d8b; }
        .btn-create { background-color: #28a745; margin-bottom: 15px; width: auto; padding: 10px 20px; }
        .rank-badge { padding: 5px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; display: inline-block; min-width: 60px; text-align: center; }
        
        /* æ‰¹æ¬¡æŒ‰éˆ•èˆ‡å·¥å…·åˆ— */
        .btn-batch-approve { background: linear-gradient(135deg, #28a745, #20c997); box-shadow: 0 4px 10px rgba(40,167,69,0.3); padding: 8px 20px; font-size: 14px; }
        .btn-batch-del { background: #ef5350; padding: 8px 15px; font-size: 14px; }
        
        /* Excel åŒ¯å…¥å€å¡Š */
        .import-section { background: #e8eaf6; padding: 15px; border-radius: 10px; border: 2px dashed #9fa8da; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .grade-import-section { background: #e0f2f1; border-color: #80cbc4; }
        .btn-import { background: #3f51b5; color: white; }
        .btn-template { background: #7986cb; color: white; }

        .checkbox-cell { width: 40px; text-align: center; }
        .status-pending { color: #d32f2f; font-weight: bold; background: #ffebee; padding: 4px 8px; border-radius: 12px; }
        .status-active { color: #2e7d32; font-weight: bold; background: #e8f5e9; padding: 4px 8px; border-radius: 12px; }

        .schedule-table { min-width: 800px; table-layout: fixed; border-collapse: collapse; }
        .schedule-table th, .schedule-table td { border: 1px solid #eee; text-align: center; }
        .schedule-table td { height: 60px; vertical-align: top; padding: 2px; }
        .course-block { padding: 4px; border-radius: 4px; color: white; font-size: 12px; margin-bottom: 2px; }
        .mobile-toggle { display: none; position: fixed; top: 10px; left: 10px; z-index: 200; background: var(--admin-blue); color: white; border: none; padding: 10px; border-radius: 5px; }

        @media (max-width: 768px) {
            .mobile-toggle { display: block; }
            .sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { padding: 60px 15px 15px 15px; }
            .header-bar { flex-direction: column; align-items: flex-start; gap: 10px; }
            .theme-controls { width: 100%; justify-content: flex-end; margin-top: 10px; }
            .import-section { flex-direction: column; align-items: stretch; text-align: center; }
        }

        @media print {
            .sidebar, .mobile-toggle, .btn, .theme-controls, .header-title::before, #pending-zone, .import-section, .batch-toolbar { display: none !important; }
            body, .main-content { margin: 0; padding: 0; background: white; overflow: visible; }
            .header-bar { box-shadow: none; border-bottom: 2px solid black; padding: 10px 0; margin-bottom: 20px; display: block; }
            .header-title { border: none; padding: 0; text-align: center; font-size: 24px; color: black; }
            .card { box-shadow: none; border: 1px solid #ccc; padding: 10px; page-break-inside: avoid; margin-bottom: 20px; }
            .card-theme-blue, .card-theme-dark, .card-theme-warm { background: white !important; color: black !important; border-color: #ccc !important; }
            .main-content > div { display: none; }
            .main-content > div[style*="display: block"] { display: block !important; }
            table { min-width: 100%; width: 100%; table-layout: auto; }
            th:first-child, td:first-child { display: none; }
        }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 999; }
    </style>
</head>
<body>
    <div id="loading"><h3>è³‡æ–™åŒæ­¥ä¸­...</h3></div>
    <button class="mobile-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')">â˜° é¸å–®</button>

    <div class="sidebar">
        <div class="sidebar-header"><h2>âœˆï¸ ç®¡ç†å¾Œå°</h2></div>
        <div class="menu-item active" onclick="switchTab('monitor')"><span>ğŸŒ</span> å…¨æ ¡ç›£æ§</div>
        <div class="menu-item" onclick="switchTab('schedule')"><span>ğŸ“…</span> æ•™å¸«èª²è¡¨</div>
        <div class="menu-item" onclick="switchTab('ranks')"><span>ğŸ†</span> çæ‡²è¨­å®š</div>
        <div class="menu-item" onclick="switchTab('students')">
            <span>ğŸ‘¥</span> å­¸ç”Ÿèˆ‡å¯©æ ¸
            <span id="pending-badge" class="badge">0</span>
        </div>
        <div class="menu-item" onclick="switchTab('courses')"><span>ğŸ‘¨â€ğŸ«</span> èª²ç¨‹ç®¡ç†</div>
        <div class="menu-item" onclick="switchTab('grades')"><span>ğŸ“</span> æˆç¸¾è¼¸å…¥</div>
    </div>

    <div class="main-content">
        <div id="monitor-view">
            <div class="header-bar"><div class="header-title">å…¨æ ¡ç›£æ§</div><button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å ±è¡¨</button></div>
            <div class="card">
                <table><thead><tr><th>å­¸è™Ÿ/å§“å</th><th>ç­ç´š</th><th>è·æ¶¯</th><th>GPA</th><th>ç‹€æ…‹</th></tr></thead><tbody id="student-list-body"></tbody></table>
            </div>
        </div>

        <div id="schedule-view" style="display: none;">
            <div class="header-bar">
                <div class="header-title">æ•™å¸«èª²è¡¨</div>
                <div style="display:flex; align-items:center; flex-wrap:wrap;">
                    <div class="theme-controls">
                        <span style="font-size:12px;margin-right:5px;color:#666;">é¢¨æ ¼:</span>
                        <div class="theme-btn tb-white" onclick="setTheme('white')" title="æ¨™æº–ç™½"></div>
                        <div class="theme-btn tb-blue" onclick="setTheme('blue')" title="ç©ºè»è—"></div>
                        <div class="theme-btn tb-warm" onclick="setTheme('warm')" title="è­·çœ¼é»ƒ"></div>
                        <div class="theme-btn tb-dark" onclick="setTheme('dark')" title="æ¥µç°¡é»‘"></div>
                    </div>
                    <button class="btn btn-print" onclick="window.print()" style="margin-left:15px;">ğŸ–¨ï¸ åˆ—å°</button>
                </div>
            </div>
            <div class="card" id="schedule-card">
                <select id="teacher-schedule-selector" onchange="renderTeacherSchedule()" style="margin-bottom:15px; padding:10px;">
                    <option value="">-- è«‹é¸æ“‡æ•™å®˜ --</option>
                </select>
                <h4 id="schedule-title" style="text-align:center;color:#00308F;">è«‹é¸æ“‡æ•™å®˜</h4>
                <div style="overflow-x:auto;">
                    <table class="schedule-table">
                        <thead><tr><th style="width:50px">ç¯€</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr></thead>
                        <tbody id="teacher-schedule-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="ranks-view" style="display: none;">
            <div class="header-bar"><div class="header-title">çæ‡²èˆ‡æ®µä½è¨­å®š</div></div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div>è«‹è¨­å®šå„æ®µä½çš„ GPA é–€æª»ï¼Œç³»çµ±å°‡è‡ªå‹•ä¾åˆ†æ•¸é«˜ä½æ’åºã€‚</div>
                    <button class="btn btn-create" onclick="addNewRankRow()">ï¼‹ æ–°å¢æ®µä½</button>
                </div>
                <table>
                    <thead><tr><th style="width:15%">æ®µä½åç¨±</th><th style="width:10%">æœ€ä½GPA</th><th style="width:10%">ä»£è¡¨è‰²</th><th style="width:10%">é è¦½</th><th>çå‹µå…§å®¹</th><th>æ‡²ç½°å…§å®¹</th><th style="width:50px">æ“ä½œ</th></tr></thead>
                    <tbody id="rank-rules-body"></tbody>
                </table>
                <button class="btn btn-submit" style="width:200px; margin-top:20px;" onclick="saveRankRules()">ğŸ’¾ å„²å­˜ä¸¦å¥—ç”¨è¨­å®š</button>
            </div>
        </div>

        <div id="students-view" style="display: none;">
            <div class="header-bar"><div class="header-title">å­¸ç”Ÿè³‡æ–™èˆ‡å¯©æ ¸</div></div>
            
            <div class="import-section">
                <div>
                    <strong>ğŸ“‚ æ‰¹æ¬¡åŒ¯å…¥å¸³è™Ÿ (Excel)</strong>
                    <div style="font-size:12px; color:#666; margin-top:5px;">è«‹ä¸Šå‚³ .xlsx æˆ– .csv æª”æ¡ˆï¼Œç³»çµ±å°‡è‡ªå‹•å»ºç«‹å¸³è™Ÿ (é è¨­ç‹€æ…‹ç‚ºæ­£å¸¸)ã€‚</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-template" onclick="downloadStudentTemplate()">ğŸ“¥ ä¸‹è¼‰å¸³è™Ÿç¯„æœ¬</button>
                    <button class="btn btn-import" onclick="document.getElementById('import-student-file').click()">ğŸ“¤ ä¸Šå‚³å¸³è™Ÿè¡¨</button>
                    <input type="file" id="import-student-file" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleStudentImport(event)">
                </div>
            </div>

            <div id="pending-zone" class="card card-pending" style="display:none;">
                <h3>âš ï¸ å¾…å¯©æ ¸ç”³è«‹ (Pending Requests)</h3>
                <div style="margin-bottom:10px; display:flex; gap:10px;">
                    <button class="btn btn-batch-approve" onclick="batchApprove()">âš¡ æ ¸å‡†é¸å–é …ç›®</button>
                    <button class="btn btn-batch-del" onclick="batchDelete()">ğŸ—‘ï¸ æ‹’çµ•/åˆªé™¤</button>
                </div>
                <div style="max-height:300px; overflow-y:auto;">
                    <table>
                        <thead><tr><th class="checkbox-cell"><input type="checkbox" onclick="toggleSelectAll(this, 'pending')"></th><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç­ç´š</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="pending-list-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>âœ… æ­£å¼å­¸å“¡åå–® (Active Students)</h3>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input id="s_id" placeholder="å­¸è™Ÿ" style="flex:1">
                    <input id="s_name" placeholder="å§“å" style="flex:1">
                    <input id="s_class" placeholder="ç­ç´š" style="flex:1">
                    <input id="s_pass" placeholder="å¯†ç¢¼" style="flex:1">
                    <button class="btn btn-add" style="flex:1" onclick="addStudent()">æ‰‹å‹•æ–°å¢</button>
                </div>
                <div style="max-height:500px; overflow-y:auto;">
                    <table>
                        <thead><tr><th class="checkbox-cell">#</th><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç­ç´š</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="active-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="courses-view" style="display:none;">
            <div class="header-bar"><div class="header-title">èª²ç¨‹ç®¡ç†</div></div>
            <div class="card">
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-bottom:15px;">
                    <select id="c_type"><option value="fixed">å¿…ä¿®</option><option value="elective">é¸ä¿®</option></select>
                    <input id="c_id" placeholder="ä»£ç¢¼">
                    <input id="c_name" placeholder="åç¨±">
                    <input id="c_cr" type="number" placeholder="å­¸åˆ†" value="2">
                    <input id="c_time" placeholder="æ™‚é–“ (ä¸€/3,4)">
                    <input id="c_tea" placeholder="æ•™å®˜">
                    <input id="c_max" type="number" placeholder="äººæ•¸" value="40" title="äººæ•¸ä¸Šé™">
                    <button class="btn btn-submit" onclick="addCourse()">ç™¼å¸ƒèª²ç¨‹</button>
                </div>
                <table id="course-table"><thead><tr><th>é¡åˆ¥</th><th>åç¨±</th><th>æ™‚é–“</th><th>äººæ•¸</th><th>æ“ä½œ</th></tr></thead><tbody id="course-list"></tbody></table>
            </div>
        </div>

        <div id="grades-view" style="display:none;">
            <div class="header-bar"><div class="header-title">æˆç¸¾ç®¡ç†</div></div>
            <div class="import-section grade-import-section">
                <div>
                    <strong>ğŸ“Š æ‰¹æ¬¡åŒ¯å…¥æˆç¸¾ (Excel)</strong>
                    <div style="font-size:12px; color:#00695c; margin-top:5px;">ç³»çµ±å°‡ä¾æ“šã€Œå­¸è™Ÿã€èˆ‡ã€Œèª²ç¨‹ä»£ç¢¼ã€è‡ªå‹•å¡«å…¥åˆ†æ•¸ã€‚</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-template" onclick="downloadGradeTemplate()">ğŸ“¥ ä¸‹è¼‰æˆç¸¾ç¯„æœ¬</button>
                    <button class="btn btn-import" style="background:#00695c;" onclick="document.getElementById('import-grade-file').click()">ğŸ“¤ ä¸Šå‚³æˆç¸¾è¡¨</button>
                    <input type="file" id="import-grade-file" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleGradeImport(event)">
                </div>
            </div>

            <div class="card">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <select id="g_stu" onchange="loadGrades()" style="flex:3"></select>
                    <button class="btn btn-submit" style="flex:1" onclick="saveGrades()">å„²å­˜å–®ç­†ä¿®æ”¹</button>
                </div>
                <table id="grade-table"><thead><tr><th>èª²ç¨‹</th><th>å­¸åˆ†</th><th>åˆ†æ•¸è¼¸å…¥</th></tr></thead><tbody id="grade-body"></tbody></table>
            </div>
        </div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud, listenToCloud } from './firebase-connect.js';
        const KEYS = { STUDENTS:'cafa_all_students_db', FIXED:'cafa_fixed_courses', ELECTIVE:'cafa_public_electives', RANKS:'cafa_rank_rules' };
        let studentDB=[], fixedCourses=[], electiveCourses=[], rankRules=[];

        window.onload = () => { 
            // å•Ÿå‹•å³æ™‚ç›£è½
            initAdminListeners();
            document.getElementById('loading').style.display='none'; 
            const savedTheme = localStorage.getItem('cafa_admin_theme'); 
            if(savedTheme) setTheme(savedTheme);
        };

        function initAdminListeners() {
            // ç›£è½å­¸ç”Ÿ (åŒ…å«è¨»å†Šèˆ‡é¸èª²è®Šå‹•)
            listenToCloud(KEYS.STUDENTS, (val) => {
                studentDB = val || [];
                renderMonitor();
                renderStudents(); 
                updateSels();
                // è‹¥æ­£åœ¨æˆç¸¾é é¢ï¼Œå³æ™‚åˆ·æ–°
                if(document.getElementById('grades-view').style.display === 'block') loadGrades();
            });

            // ç›£è½èª²ç¨‹
            listenToCloud(KEYS.FIXED, (val) => { fixedCourses = val || []; renderCourses(); renderTeacherSchedule(); updateSels(); });
            listenToCloud(KEYS.ELECTIVE, (val) => { electiveCourses = val || []; renderCourses(); renderTeacherSchedule(); updateSels(); });
            // ç›£è½è¦å‰‡
            listenToCloud(KEYS.RANKS, (val) => { rankRules = val || getDefaultRanks(); renderRankSettings(); });
        }

        window.setTheme = (t) => {
            const c = document.getElementById('schedule-card'); c.className = 'card';
            if(t !== 'white') c.classList.add(`card-theme-${t}`);
            localStorage.setItem('cafa_admin_theme', t);
            const title = document.getElementById('schedule-title');
            if(t === 'dark') title.style.color = '#fff'; else title.style.color = '#00308F';
        };
        
        window.switchTab = (id) => {
            ['monitor','schedule','ranks','students','courses','grades'].forEach(v=>document.getElementById(v+'-view').style.display='none');
            document.getElementById(id+'-view').style.display='block';
            document.querySelector('.sidebar').classList.remove('open');
            if(id === 'schedule') renderTeacherSchedule();
            if(id === 'ranks') renderRankSettings();
        };

        // ç¶å®šå…¨åŸŸå‡½å¼
        window.addStudent=addStudent; window.deleteStudent=deleteStudent; window.approveStudent=approveStudent;
        window.addCourse=addCourse; window.delCourse=delCourse; window.loadGrades=loadGrades; window.saveGrades=saveGrades; window.toggleStatus=toggleStatus;
        window.addNewRankRow=addNewRankRow; window.deleteRankRow=deleteRankRow; window.saveRankRules=saveRankRules; window.updateRankPreview=updateRankPreview; window.renderTeacherSchedule=renderTeacherSchedule;
        window.batchApprove=batchApprove; window.batchDelete=batchDelete; window.toggleSelectAll=toggleSelectAll;
        window.downloadStudentTemplate=downloadStudentTemplate; window.handleStudentImport=handleStudentImport;
        window.downloadGradeTemplate=downloadGradeTemplate; window.handleGradeImport=handleGradeImport;

        function renderRankSettings() {
            const t = document.getElementById('rank-rules-body'); t.innerHTML = '';
            rankRules.sort((a,b) => b.min - a.min);
            rankRules.forEach((r, i) => {
                t.innerHTML += `<tr class="rank-row"><td><input class="r-name" value="${r.name}" placeholder="åç¨±"></td><td><input class="r-min" type="number" value="${r.min}" style="width:60px"></td><td><input class="r-color" type="color" value="${r.color}" oninput="updateRankPreview(this)"></td><td><span class="rank-badge" style="background-color:${r.color};">${r.name}</span></td><td><input class="r-reward" value="${r.reward||''}" placeholder="ç„¡"></td><td><input class="r-punish" value="${r.punish||''}" placeholder="ç„¡"></td><td><button class="btn btn-del" onclick="deleteRankRow(this)">âœ•</button></td></tr>`;
            });
        }
        function addNewRankRow() {
            const t = document.getElementById('rank-rules-body');
            const row = document.createElement('tr'); row.className = 'rank-row';
            row.innerHTML = `<td><input class="r-name" value="æ–°æ®µä½" placeholder="åç¨±"></td><td><input class="r-min" type="number" value="60" style="width:60px"></td><td><input class="r-color" type="color" value="#cccccc" oninput="updateRankPreview(this)"></td><td><span class="rank-badge" style="background-color:#cccccc;">æ–°æ®µä½</span></td><td><input class="r-reward" placeholder="ç„¡"></td><td><input class="r-punish" placeholder="ç„¡"></td><td><button class="btn btn-del" onclick="deleteRankRow(this)">âœ•</button></td>`;
            t.insertBefore(row, t.firstChild);
        }
        function deleteRankRow(btn) { if(confirm("åˆªé™¤?")) btn.closest('tr').remove(); }
        function updateRankPreview(input) { const r = input.closest('tr'); const b = r.querySelector('.rank-badge'); const n = r.querySelector('.r-name'); b.style.backgroundColor = input.value; b.innerText = n.value; }
        async function saveRankRules() {
            const rows = document.querySelectorAll('.rank-row'); const newRules = [];
            rows.forEach(row => { const name = row.querySelector('.r-name').value; const min = parseInt(row.querySelector('.r-min').value); const color = row.querySelector('.r-color').value; const reward = row.querySelector('.r-reward').value; const punishment = row.querySelector('.r-punish').value; if(name && !isNaN(min)) newRules.push({ name, min, color, reward, punishment }); });
            newRules.sort((a,b) => b.min - a.min); 
            await saveToCloud(KEYS.RANKS, newRules); 
            alert("âœ… è¨­å®šå·²å„²å­˜ï¼"); 
        }

        function renderStudents() {
            const pendingList = studentDB.filter(s => s.status === 'pending');
            const activeList = studentDB.filter(s => s.status !== 'pending');
            
            const badge = document.getElementById('pending-badge');
            if(pendingList.length > 0) {
                badge.innerText = pendingList.length;
                badge.classList.add('show');
                document.getElementById('pending-zone').style.display = 'block';
            } else {
                badge.classList.remove('show');
                document.getElementById('pending-zone').style.display = 'none';
            }

            const pBody = document.getElementById('pending-list-body');
            pBody.innerHTML = pendingList.length === 0 ? '' : pendingList.map(s => `
                <tr style="background:white;">
                    <td class="checkbox-cell"><input type="checkbox" class="pending-checkbox" value="${s.id}"></td>
                    <td>${s.id}</td><td>${s.name}</td><td>${s.classId}</td>
                    <td><button class="btn btn-approve" onclick="approveStudent('${s.id}')">æ ¸å‡†</button></td>
                </tr>
            `).join('');

            const aBody = document.getElementById('active-list-body');
            aBody.innerHTML = activeList.map(s => `
                <tr>
                    <td>ğŸŸ¢</td>
                    <td>${s.id}</td><td>${s.name}</td><td>${s.classId}</td>
                    <td><button class="btn btn-del" onclick="deleteStudent('${s.id}')">åˆª</button></td>
                </tr>
            `).join('');
        }

        function toggleSelectAll(source, type) {
            const checkboxes = document.querySelectorAll(`.${type}-checkbox`);
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        async function batchApprove() {
            const checkboxes = document.querySelectorAll('.pending-checkbox:checked');
            if(checkboxes.length === 0) return alert("è«‹å…ˆå‹¾é¸è¦æ ¸å‡†çš„ç”³è«‹ï¼");
            let count = 0;
            checkboxes.forEach(cb => { const s = studentDB.find(x => x.id === cb.value); if(s) { s.status = 'active'; count++; } });
            if(count > 0) { await saveToCloud(KEYS.STUDENTS, studentDB); alert(`âœ… å·²ä¸€éµæ ¸å‡† ${count} ä½å­¸ç”Ÿï¼`); }
        }

        async function batchDelete() {
            const checkboxes = document.querySelectorAll('.pending-checkbox:checked');
            if(checkboxes.length === 0) return alert("è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„é …ç›®ï¼");
            if(!confirm(`ç¢ºå®šè¦æ‹’çµ•/åˆªé™¤é€™ ${checkboxes.length} ç­†ç”³è«‹å—ï¼Ÿ`)) return;
            const idsToDelete = Array.from(checkboxes).map(cb => cb.value);
            const newDB = studentDB.filter(s => !idsToDelete.includes(s.id));
            await saveToCloud(KEYS.STUDENTS, newDB); 
        }

        function downloadStudentTemplate() {
            const ws = XLSX.utils.aoa_to_sheet([["å­¸è™Ÿ","å§“å","ç­ç´š","å¯†ç¢¼"],["114001","ç‹å°æ˜","114-èˆªå¤ª","1234"],["114002","æå¤§è¯","114-èˆªç®¡","1234"]]);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "å­¸ç”Ÿåå–®");
            XLSX.writeFile(wb, "å­¸ç”Ÿå¸³è™Ÿç¯„æœ¬.xlsx");
        }

        function handleStudentImport(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                let addedCount = 0;
                jsonData.forEach(row => {
                    const id = String(row['å­¸è™Ÿ'] || row['id']).trim();
                    const name = String(row['å§“å'] || row['name']).trim();
                    const cls = String(row['ç­ç´š'] || row['classId']).trim();
                    const pwd = String(row['å¯†ç¢¼'] || row['password']).trim();
                    if(id && !studentDB.some(s => s.id === id)) {
                        studentDB.push({ id, name, classId: cls, password: pwd, status: 'active', courses: [], careerTrack: '', interests: [] });
                        addedCount++;
                    }
                });
                if(addedCount > 0) { await saveToCloud(KEYS.STUDENTS, studentDB); alert(`âœ… æˆåŠŸåŒ¯å…¥ ${addedCount} ç­†å­¸ç”Ÿè³‡æ–™ï¼`); } 
                else { alert("æ²’æœ‰æ–°å¢ä»»ä½•è³‡æ–™ (å¯èƒ½å­¸è™Ÿé‡è¤‡æˆ–æ ¼å¼éŒ¯èª¤)"); }
                document.getElementById('import-student-file').value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        function downloadGradeTemplate() {
            const ws = XLSX.utils.aoa_to_sheet([["å­¸è™Ÿ","èª²ç¨‹ä»£ç¢¼","åˆ†æ•¸"],["114001","C001","85"],["114001","C002","90"],["114002","C001","70"]]);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "æˆç¸¾åŒ¯å…¥");
            XLSX.writeFile(wb, "æˆç¸¾åŒ¯å…¥ç¯„æœ¬.xlsx");
        }

        function handleGradeImport(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                let updatedCount = 0;
                jsonData.forEach(row => {
                    const sid = String(row['å­¸è™Ÿ'] || row['Student_ID']).trim();
                    const cid = String(row['èª²ç¨‹ä»£ç¢¼'] || row['Course_ID']).trim();
                    const score = parseInt(row['åˆ†æ•¸'] || row['Score']);
                    
                    if(sid && cid && !isNaN(score)) {
                        const student = studentDB.find(s => s.id === sid);
                        if(student && student.courses) {
                            const course = student.courses.find(c => c.id === cid || c.name === cid);
                            if(course) {
                                course.score = score;
                                updatedCount++;
                            }
                        }
                    }
                });

                if(updatedCount > 0) { 
                    await saveToCloud(KEYS.STUDENTS, studentDB); 
                    alert(`âœ… æˆåŠŸåŒ¯å…¥/æ›´æ–°äº† ${updatedCount} ç­†æˆç¸¾è³‡æ–™ï¼`); 
                } else { 
                    alert("æœªæ›´æ–°ä»»ä½•æˆç¸¾ã€‚è«‹ç¢ºèªå­¸è™Ÿèˆ‡èª²ç¨‹ä»£ç¢¼æ˜¯å¦æ­£ç¢ºï¼Œä¸”å­¸ç”Ÿå·²é¸ä¿®è©²èª²ç¨‹ã€‚"); 
                }
                document.getElementById('import-grade-file').value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        async function addStudent() { const id=document.getElementById('s_id').value; const idx=studentDB.findIndex(s=>s.id===id); const obj={id, name:document.getElementById('s_name').value, classId:document.getElementById('s_class').value, password:document.getElementById('s_pass').value, status:'active', courses:[], totalCredits:0}; if(idx>-1){Object.assign(studentDB[idx], obj);}else{studentDB.push(obj);} await saveToCloud(KEYS.STUDENTS, studentDB); }
        async function deleteStudent(id) { if(confirm('åˆªé™¤?')){const newDB=studentDB.filter(s=>s.id!==id); await saveToCloud(KEYS.STUDENTS, newDB);} }
        async function approveStudent(id) { const idx = studentDB.findIndex(s=>s.id===id); if(idx > -1) { studentDB[idx].status = 'active'; await saveToCloud(KEYS.STUDENTS, studentDB); } }

        function renderTeacherSchedule() {
            const tea = document.getElementById('teacher-schedule-selector').value; const tbody = document.getElementById('teacher-schedule-body'); tbody.innerHTML = ''; 
            for(let i=1;i<=10;i++) tbody.innerHTML+=`<tr><td style="background:#f8f9fa; color:#333;">${i}</td><td id="t1-${i}"></td><td id="t2-${i}"></td><td id="t3-${i}"></td><td id="t4-${i}"></td><td id="t5-${i}"></td></tr>`;
            if(!tea) return document.getElementById('schedule-title').innerText = "è«‹é¸æ“‡æ•™å®˜"; document.getElementById('schedule-title').innerText = `ğŸ“… ${tea} æ•™å®˜èª²è¡¨`;
            [...fixedCourses,...electiveCourses].filter(c=>c.teacher===tea).forEach(c => { if(!c.time) return; let [d,p]=c.time.split('/'); const dMap={"ä¸€":1,"äºŒ":2,"ä¸‰":3,"å››":4,"äº”":5}; p.split(',').forEach(x => { let el = document.getElementById(`t${dMap[d]}-${x}`); if(el) el.innerHTML = `<div class="course-block" style="background:${c.isFixed?'#e65100':'#00308F'}">${c.name}<br>${c.location||''}</div>`; }); });
        }
        function renderMonitor() { const t = document.getElementById('student-list-body'); t.innerHTML=''; studentDB.forEach(s => { let tot=0, cr=0; (s.courses||[]).forEach(c => { if(c.score){ tot+=c.score*c.credit; cr+=c.credit; } }); let gpa = cr>0 ? (tot/cr).toFixed(1) : 0; t.innerHTML += `<tr><td>${s.name} (${s.id})</td><td>${s.classId||'-'}</td><td>${s.careerTrack==='pilot'?'é£›è¡Œ':'åœ°å‹¤'}</td><td>${gpa}</td><td>${(s.courses||[]).length} ç§‘</td></tr>`; }); }
        function getDefaultRanks() { return [{name:'ç‹è€…', min:90, color:'#ffe0b2', reward:'ç¦®åˆ¸', punishment:''}, {name:'é‘½çŸ³', min:80, color:'#b3e5fc', reward:'', punishment:''}, {name:'é»ƒé‡‘', min:70, color:'#fff9c4', reward:'', punishment:''}, {name:'ç™½éŠ€', min:60, color:'#f5f5f5', reward:'', punishment:''}, {name:'é’éŠ…', min:0, color:'#ffccbc', reward:'', punishment:''}]; }
        
        async function addCourse() { const t=document.getElementById('c_type').value; const max=parseInt(document.getElementById('c_max').value)||40; const c={id:document.getElementById('c_id').value, name:document.getElementById('c_name').value, credit:parseInt(document.getElementById('c_cr').value), time:document.getElementById('c_time').value, teacher:document.getElementById('c_tea').value, max:max, type:t==='fixed'?'å¿…ä¿®':'é¸ä¿®', isFixed:t==='fixed', isOpen:true}; 
            let newArr;
            if(t==='fixed') { newArr = [...fixedCourses, c]; await saveToCloud(KEYS.FIXED, newArr); }
            else { newArr = [...electiveCourses, c]; await saveToCloud(KEYS.ELECTIVE, newArr); }
        }
        async function delCourse(t,i) { 
            if(t==='fixed'){ const n=[...fixedCourses]; n.splice(i,1); await saveToCloud(KEYS.FIXED, n); }
            else { const n=[...electiveCourses]; n.splice(i,1); await saveToCloud(KEYS.ELECTIVE, n); }
        }
        async function toggleStatus(i) { 
            const n=[...electiveCourses]; n[i].isOpen=!n[i].isOpen; 
            await saveToCloud(KEYS.ELECTIVE, n); 
        }
        
        function renderCourses() { document.getElementById('course-list').innerHTML = [...fixedCourses.map((c,i)=>`<tr><td>å¿…ä¿®</td><td>${c.name}</td><td>${c.time}</td><td>-</td><td><button class="btn btn-del" onclick="delCourse('fixed',${i})">åˆª</button></td></tr>`), ...electiveCourses.map((c,i)=>`<tr><td>é¸ä¿®</td><td>${c.name}</td><td>${c.time}</td><td>${c.max||40}</td><td><button class="btn" onclick="toggleStatus(${i})" style="background:${c.isOpen?'green':'grey'};width:auto;margin-right:5px;">${c.isOpen?'é–‹':'é—œ'}</button><button class="btn btn-del" onclick="delCourse('elect',${i})">åˆª</button></td></tr>`)].join(''); }
        
        function loadGrades() { const sid=document.getElementById('g_stu').value; const t=document.getElementById('grade-body'); t.innerHTML=''; const s=studentDB.find(x=>x.id===sid); if(!s)return; s.courses.forEach(c=>{ t.innerHTML+=`<tr><td>${c.name}</td><td>${c.credit}</td><td><input type="number" id="sc-${c.id}" value="${c.score||''}" style="width:80px"></td></tr>`; }); }
        async function saveGrades() { const sid=document.getElementById('g_stu').value; const idx=studentDB.findIndex(x=>x.id===sid); 
            if(idx>-1) {
                const newCourses = studentDB[idx].courses.map(c=>{const v=document.getElementById(`sc-${c.id}`).value; if(v)c.score=parseInt(v); return c;}); 
                studentDB[idx].courses = newCourses;
                await saveToCloud(KEYS.STUDENTS, studentDB); 
                alert("æˆç¸¾å·²å„²å­˜");
            }
        }
        function updateSels() { const tea = document.getElementById('teacher-schedule-selector'); const ts=[...new Set([...fixedCourses,...electiveCourses].map(c=>c.teacher).filter(x=>x))].sort(); const savedT = tea.value; tea.innerHTML='<option value="">-- è«‹é¸æ“‡æ•™å®˜ --</option>'; ts.forEach(t=>tea.add(new Option(t,t))); tea.value = savedT; const stu = document.getElementById('g_stu'); const savedS = stu.value; stu.innerHTML='<option value="">-- è«‹é¸æ“‡å­¸ç”Ÿè¼¸å…¥æˆç¸¾ --</option>'; studentDB.forEach(s=>stu.add(new Option(`${s.id} ${s.name}`,s.id))); stu.value = savedS; }
    </script>
</body>
</html>





