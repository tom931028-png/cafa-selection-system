<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å¸«ç®¡ç†ç³»çµ± | CAFA Admin</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --admin-blue: #00308F; --admin-bg: #f4f7fa; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--admin-bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 250px; background: linear-gradient(180deg, #00308F, #002266); color: white; display: flex; flex-direction: column; padding-top: 20px; transition: transform 0.3s; z-index: 1000; }
        .menu-item { padding: 15px 20px; cursor: pointer; display: flex; align-items: center; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.2); font-weight: bold; border-left: 4px solid #FFD700; }
        .menu-item span { margin-right: 10px; font-size: 18px; }
        
        .main-content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        .header-bar { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-wrap: wrap; gap: 10px; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow-x: auto; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 600px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; white-space: nowrap; }
        th { background: #f8f9fa; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; margin-right: 5px; font-size: 14px; }
        .btn-blue { background: #00308F; } .btn-green { background: #28a745; } .btn-red { background: #dc3545; } .btn-orange { background: #e65100; }
        .badge { background: #ff5252; color: white; padding: 2px 6px; border-radius: 10px; font-size: 12px; margin-left: auto; display: none; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }

        .mobile-toggle { display: none; position: fixed; top: 10px; left: 10px; z-index: 2000; background: var(--admin-blue); color: white; border: none; padding: 10px; border-radius: 5px; }
        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .mobile-toggle { display: block; }
            .main-content { padding-top: 60px; }
            .header-bar { flex-direction: column; align-items: flex-start; }
        }
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 3000; flex-direction: column; }
    </style>
</head>
<body>
    <div id="loading"><h3>è³‡æ–™è®€å–ä¸­...</h3></div>
    <button class="mobile-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')">â˜° é¸å–®</button>

    <div class="sidebar">
        <div style="text-align:center; margin-bottom:20px;"><h2>âœˆï¸ ç®¡ç†å¾Œå°</h2></div>
        <div class="menu-item active" onclick="switchTab('monitor')"><span>ğŸŒ</span> å…¨æ ¡ç›£æ§ (æ’å)</div>
        <div class="menu-item" onclick="switchTab('schedule')"><span>ğŸ“…</span> æ•™å¸«èª²è¡¨</div>
        <div class="menu-item" onclick="switchTab('students')"><span>ğŸ‘¥</span> å­¸ç”Ÿç®¡ç† <span id="pending-badge" class="badge">0</span></div>
        <div class="menu-item" onclick="switchTab('courses')"><span>ğŸ‘¨â€ğŸ«</span> èª²ç¨‹ç®¡ç†</div>
        <div class="menu-item" onclick="switchTab('grades')"><span>ğŸ“</span> æˆç¸¾è¼¸å…¥</div>
        <div class="menu-item" onclick="location.href='index.html'" style="margin-top:auto; background:#333;"><span>ğŸšª</span> ç™»å‡º</div>
    </div>

    <div class="main-content">
        <div id="monitor-view">
            <div class="header-bar">
                <h3>ğŸ“Š å…¨æ ¡æˆç¸¾æ’åç›£æ§</h3>
                <div>
                    <button class="btn btn-orange" onclick="initDemoData()">âš¡ ç”Ÿæˆ 30 äººå…¨æ ¡å±•ç¤ºè³‡æ–™</button>
                    <button class="btn btn-blue" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å ±è¡¨</button>
                </div>
            </div>
            <div class="card">
                <table>
                    <thead><tr><th>æ’å</th><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç­ç´š</th><th>è·æ¶¯æ–¹å‘</th><th>GPA (å¹³å‡ç©åˆ†)</th><th>å·²ä¿®å­¸åˆ†</th></tr></thead>
                    <tbody id="monitor-list"></tbody>
                </table>
            </div>
        </div>

        <div id="schedule-view" style="display:none;">
            <div class="header-bar"><h3>ğŸ“… æ•™å¸«/æ•™å®˜ èª²è¡¨æŸ¥è©¢</h3></div>
            <div class="card">
                <select id="tea-sel" onchange="renderTeaSchedule()" style="padding:10px;"><option>è«‹é¸æ“‡æ•™å®˜</option></select>
                <div style="margin-top:15px; overflow-x:auto;">
                    <table border="1" style="border-collapse:collapse; width:100%; text-align:center; min-width:800px;">
                        <thead><tr style="background:#eee;"><th width="10%">ç¯€æ¬¡</th><th width="18%">ä¸€</th><th width="18%">äºŒ</th><th width="18%">ä¸‰</th><th width="18%">å››</th><th width="18%">äº”</th></tr></thead>
                        <tbody id="tea-schedule-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="students-view" style="display:none;">
            <div class="header-bar"><h3>ğŸ‘¥ å­¸ç”Ÿè³‡æ–™èˆ‡å¯©æ ¸</h3></div>
            <div class="card" style="background:#fff3e0; border-left:5px solid #ff9800; display:none;" id="pending-zone">
                <h4>âš ï¸ å¾…å¯©æ ¸è¨»å†Šç”³è«‹</h4>
                <div id="pending-list"></div>
            </div>
            <div class="card">
                <h4>âœ… æ­£å¼å­¸å“¡åå–®</h4>
                <div style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn btn-blue" onclick="document.getElementById('file-up').click()">ğŸ“‚ Excel åŒ¯å…¥å­¸ç”Ÿ</button>
                    <input type="file" id="file-up" hidden accept=".xlsx,.csv" onchange="handleImport(event)">
                    <button class="btn btn-green" onclick="downloadTemplate()">ğŸ“¥ ä¸‹è¼‰ Excel ç¯„æœ¬</button>
                </div>
                <table><thead><tr><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç­ç´š</th><th>å¯†ç¢¼</th><th>æ“ä½œ</th></tr></thead><tbody id="stu-list"></tbody></table>
            </div>
        </div>

        <div id="courses-view" style="display:none;">
            <div class="header-bar"><h3>ğŸ‘¨â€ğŸ« èª²ç¨‹è¨­å®š</h3></div>
            <div class="card">
                <h4>â• æ–°å¢/ç™¼å¸ƒèª²ç¨‹</h4>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:10px; align-items:end;">
                    <div><label>é¡åˆ¥</label><br><select id="c_type" style="width:100%"><option value="fixed">ğŸ”’ å¿…ä¿®</option><option value="elective">ğŸ“– é¸ä¿®</option></select></div>
                    <div><label>ä»£ç¢¼</label><br><input id="c_id" style="width:100%" placeholder="C101"></div>
                    <div><label>åç¨±</label><br><input id="c_name" style="width:100%" placeholder="ç©ºæ°£å‹•åŠ›å­¸"></div>
                    <div><label>æ™‚é–“</label><br><input id="c_time" style="width:100%" placeholder="ä¸€/1,2"></div>
                    <div><label>åœ°é»</label><br><input id="c_loc" style="width:100%" placeholder="301æ•™å®¤"></div>
                    <div><label>æ•™å®˜</label><br><input id="c_tea" style="width:100%" placeholder="ææ•™å®˜"></div>
                    <div><label>å­¸åˆ†</label><br><input id="c_cr" type="number" value="2" style="width:100%"></div>
                    <button class="btn btn-green" onclick="addCourse()">ç™¼å¸ƒ</button>
                </div>
            </div>
            <div class="card">
                <h4>ğŸ“š å·²é–‹èª²ç¨‹åˆ—è¡¨</h4>
                <table><thead><tr><th>é¡åˆ¥</th><th>ä»£ç¢¼</th><th>åç¨±</th><th>æ™‚é–“</th><th>æ•™å®˜</th><th>æ“ä½œ</th></tr></thead><tbody id="course-list"></tbody></table>
            </div>
        </div>

        <div id="grades-view" style="display:none;">
            <div class="header-bar"><h3>ğŸ“ æˆç¸¾è¼¸å…¥</h3></div>
            <div class="card">
                <div style="margin-bottom:15px; display:flex; gap:10px;">
                    <select id="g_stu" onchange="loadStuGrades()" style="padding:10px; flex:1;"><option value="">è«‹é¸æ“‡å­¸ç”Ÿ</option></select>
                    <button class="btn btn-blue" onclick="saveGrades()">ğŸ’¾ å„²å­˜æˆç¸¾</button>
                </div>
                <table id="grade-table"><thead><tr><th>èª²ç¨‹åç¨±</th><th>å­¸åˆ†</th><th>åˆ†æ•¸ (0-100)</th></tr></thead><tbody id="grade-body"><tr><td colspan="3" align="center" style="color:#999;">è«‹å…ˆé¸æ“‡å­¸ç”Ÿ</td></tr></tbody></table>
            </div>
        </div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud, listenToCloud } from './firebase-connect.js';
        const KEYS = { STUDENTS: 'cafa_all_students_db', FIXED: 'cafa_fixed_courses', ELECTIVE: 'cafa_public_electives' };
        let sDB = [], fC = [], eC = [];

        window.onload = () => {
            listenToCloud(KEYS.STUDENTS, v => { sDB = v || []; renderAll(); });
            listenToCloud(KEYS.FIXED, v => { fC = v || []; renderAll(); });
            listenToCloud(KEYS.ELECTIVE, v => { eC = v || []; renderAll(); });
            setTimeout(() => document.getElementById('loading').style.display = 'none', 1000);
        };

        // ============================================================
        // â˜…â˜…â˜… æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆ 30 äººå…¨æ ¡è³‡æ–™ï¼Œè®“æ’åæ›´çœŸå¯¦ â˜…â˜…â˜…
        // ============================================================
        window.initDemoData = async () => {
            if(!confirm("âš ï¸ é€™å°‡æœƒæ¸…ç©ºç¾æœ‰è³‡æ–™ï¼Œä¸¦ç”Ÿæˆ 30 ä½å­¸ç”Ÿã€éš¨æ©Ÿæˆç¸¾èˆ‡èª²ç¨‹ï¼\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ")) return;
            document.getElementById('loading').style.display = 'flex';

            // 1. è±å¯Œçš„èª²ç¨‹è³‡æ–™
            const demoFixed = [
                {id:'F101', name:'ç©ºæ°£å‹•åŠ›å­¸ I', credit:3, time:'ä¸€/1,2,3', teacher:'ææ•™å®˜', type:'å¿…ä¿®', isFixed:true, location:'èˆªå¤ªé¤¨3F', max:999},
                {id:'F102', name:'é£›æ©Ÿçµæ§‹å­¸', credit:2, time:'äºŒ/3,4', teacher:'ç‹æ•™æˆ', type:'å¿…ä¿®', isFixed:true, location:'æ©Ÿæ¢°é¤¨101', max:999},
                {id:'F103', name:'è»äº‹å€«ç†èˆ‡é ˜å°', credit:1, time:'äº”/1', teacher:'é™³è¼”å°é•·', type:'å¿…ä¿®', isFixed:true, location:'å¤§ç¦®å ‚', max:999}
            ];

            const demoElect = [
                {id:'E201', name:'é€²éšé£›è¡ŒåŸç†', credit:2, time:'ä¸‰/3,4', teacher:'å¼µå°‘æ ¡', type:'é¸ä¿®', isFixed:false, location:'é£›è¡Œæ¨¡æ“¬å®¤', isOpen:true, max:20},
                {id:'E202', name:'èˆªç©ºæ°£è±¡åˆ†æ', credit:2, time:'å››/1,2', teacher:'æ—åšå£«', type:'é¸ä¿®', isFixed:false, location:'æ°£è±¡ä¸­å¿ƒ', isOpen:true, max:40},
                {id:'E203', name:'å¯¦ç”¨èˆªç©ºè‹±æ–‡', credit:2, time:'ä¸€/7,8', teacher:'John Sir', type:'é¸ä¿®', isFixed:false, location:'èªè¨€æ•™å®¤', isOpen:true, max:30},
                {id:'E301', name:'å¾Œå‹¤è£œçµ¦ç®¡ç†', credit:2, time:'ä¸‰/1,2', teacher:'è¶™ä¸Šå°‰', type:'é¸ä¿®', isFixed:false, location:'ç®¡ç†å­¸é™¢', isOpen:true, max:50},
                {id:'E302', name:'ç™¼å‹•æ©Ÿç¶­ä¿®å¯¦å‹™', credit:3, time:'äº”/2,3,4', teacher:'é»‘æ‰‹æ•™å®˜', type:'é¸ä¿®', isFixed:false, location:'æ£šå» Aå€', isOpen:true, max:15},
                {id:'E401', name:'ç„¡äººæ©Ÿæˆ°è¡“æ‡‰ç”¨', credit:2, time:'äºŒ/1,2', teacher:'AIå°çµ„', type:'é¸ä¿®', isFixed:false, location:'ç„¡äººæ©Ÿå¯¦é©—å®¤', isOpen:true, max:20},
                {id:'E402', name:'Python ç¨‹å¼è¨­è¨ˆ', credit:3, time:'å››/2,3,4', teacher:'è³‡å·¥ç³»', type:'é¸ä¿®', isFixed:false, location:'é›»è…¦æ•™å®¤', isOpen:true, max:40}
            ];

            // 2. ç”Ÿæˆ 30 ä½å­¸ç”Ÿ
            const lastNames = ['å¼µ','æ','ç‹','è¶™','é™³','æ—','åŠ‰','é»ƒ','å³','è”¡'];
            const firstNames = ['å¤§','å°','é˜¿','å¿—','è±ª','å®','ç¾','é›…','å©·','å›','å‰','å¼·','æ˜','è¯','æ–‡'];
            let demoStudents = [];

            // ä½ çš„ä¸»è¦å¸³è™Ÿ
            demoStudents.push({
                id: '114001', name: 'å¼µé£›å®˜', classId: '114-ç”²', password: '1234', status: 'active',
                careerTrack: 'pilot', interests: ['ç„¡äººæ©Ÿ'],
                courses: [...demoFixed.map(c=>({...c, score: 92})), {...demoElect[0], score: 95}, {...demoElect[5], score: 88}] // æˆç¸¾å„ªç•°
            });

            // ç”Ÿæˆå…¶ä»– 29 äºº
            for(let i=2; i<=30; i++) {
                const id = '114' + (i<10?'00':'0') + i;
                const name = lastNames[Math.floor(Math.random()*lastNames.length)] + firstNames[Math.floor(Math.random()*firstNames.length)];
                
                // éš¨æ©Ÿé¸ä¿®
                let myElectives = [];
                demoElect.forEach(ec => { if(Math.random() > 0.6) myElectives.push({...ec, score: Math.floor(Math.random() * 41) + 60}); }); // 60-100åˆ†

                // éš¨æ©Ÿå¿…ä¿®æˆç¸¾
                let myFixed = demoFixed.map(fc => ({...fc, score: Math.floor(Math.random() * 41) + 60}));

                demoStudents.push({
                    id: id, name: name, classId: '114-' + (Math.random()>0.5?'ç”²':'ä¹™'), password: '1234', status: 'active',
                    careerTrack: Math.random()>0.5 ? 'pilot' : 'ground',
                    interests: [],
                    courses: [...myFixed, ...myElectives]
                });
            }

            await saveToCloud(KEYS.FIXED, demoFixed);
            await saveToCloud(KEYS.ELECTIVE, demoElect);
            await saveToCloud(KEYS.STUDENTS, demoStudents);
            
            document.getElementById('loading').style.display = 'none';
            alert("âœ… 30 äººå…¨æ ¡è³‡æ–™ç”Ÿæˆå®Œç•¢ï¼\n\nç¾åœ¨ã€Œæ’åã€å’Œã€Œèª²ç¨‹æ¨è–¦ã€éƒ½æœ‰è±å¯Œå…§å®¹äº†ï¼");
            location.reload();
        };

        // --- æ¸²æŸ“ ---
        function renderAll() {
            // ç›£æ§ (æ’å)
            const mBody = document.getElementById('monitor-list'); mBody.innerHTML='';
            
            // è¨ˆç®— GPA ä¸¦æ’åº
            let rankedList = sDB.filter(s=>s.status!=='pending').map(s => {
                let cr=0, tot=0; 
                (s.courses||[]).forEach(c=>{ cr+=parseInt(c.credit||0); if(c.score) tot+=c.score*c.credit; });
                return { ...s, gpa: cr>0 ? (tot/cr).toFixed(2) : 0, credits: cr };
            }).sort((a,b) => b.gpa - a.gpa); // GPA é«˜åˆ°ä½

            rankedList.forEach((s, idx) => {
                let rankIcon = '';
                if(idx===0) rankIcon = 'ğŸ¥‡'; else if(idx===1) rankIcon = 'ğŸ¥ˆ'; else if(idx===2) rankIcon = 'ğŸ¥‰'; else rankIcon = idx+1;
                
                mBody.innerHTML += `<tr>
                    <td><b>${rankIcon}</b></td>
                    <td>${s.id}</td><td>${s.name}</td><td>${s.classId}</td>
                    <td>${s.careerTrack==='pilot'?'âœˆï¸ é£›è¡Œ':'ğŸ› ï¸ åœ°å‹¤'}</td>
                    <td style="font-weight:bold; color:${s.gpa>=90?'#d84315':'#333'}">${s.gpa}</td>
                    <td>${s.credits}</td>
                </tr>`;
            });

            // å­¸ç”Ÿç®¡ç†
            const pZone = document.getElementById('pending-zone');
            const pStudents = sDB.filter(s=>s.status==='pending');
            if(pStudents.length > 0) {
                pZone.style.display='block'; document.getElementById('pending-badge').style.display='inline-block';
                document.getElementById('pending-badge').innerText = pStudents.length;
                document.getElementById('pending-list').innerHTML = pStudents.map(s => `<div style="padding:10px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between;"><span>${s.id} ${s.name}</span> <button class="btn btn-green" onclick="approve('${s.id}')">æ ¸å‡†</button></div>`).join('');
            } else { pZone.style.display='none'; document.getElementById('pending-badge').style.display='none'; }
            
            document.getElementById('stu-list').innerHTML = sDB.filter(s=>s.status!=='pending').map(s => `<tr><td>${s.id}</td><td>${s.name}</td><td>${s.classId}</td><td>${s.password}</td><td><button class="btn btn-red" onclick="delStu('${s.id}')">åˆªé™¤</button></td></tr>`).join('');

            // èª²ç¨‹åˆ—è¡¨
            document.getElementById('course-list').innerHTML = [...fC, ...eC].map((c,i) => `<tr><td>${c.isFixed?'ğŸ”’ å¿…ä¿®':'ğŸ“– é¸ä¿®'}</td><td>${c.id}</td><td>${c.name}</td><td>${c.time}</td><td>${c.teacher}</td><td><button class="btn btn-red" onclick="delCourse('${c.id}')">åˆªé™¤</button></td></tr>`).join('');
            updateSelects();
        }

        function updateSelects() {
            const tSel = document.getElementById('tea-sel');
            const teachers = [...new Set([...fC, ...eC].map(c=>c.teacher).filter(Boolean))];
            tSel.innerHTML = '<option value="">è«‹é¸æ“‡æ•™å®˜</option>' + teachers.map(t=>`<option value="${t}">${t}</option>`).join('');
            
            const gStu = document.getElementById('g_stu');
            gStu.innerHTML = '<option value="">è«‹é¸æ“‡å­¸ç”Ÿ</option>' + sDB.filter(s=>s.status!=='pending').map(s=>`<option value="${s.id}">${s.id} ${s.name}</option>`).join('');
        }

        window.approve = async (id) => { const u = sDB.find(s=>s.id===id); u.status='active'; u.courses = fC.map(c=>({...c})); await saveToCloud(KEYS.STUDENTS, sDB); };
        window.delStu = async (id) => { if(confirm("åˆªé™¤?")) await saveToCloud(KEYS.STUDENTS, sDB.filter(s=>s.id!==id)); };
        
        window.addCourse = async () => {
            const id=document.getElementById('c_id').value, name=document.getElementById('c_name').value, time=document.getElementById('c_time').value;
            if(!id||!name||!time) return alert("è³‡æ–™ä¸å®Œæ•´");
            const type=document.getElementById('c_type').value;
            const newC = { id, name, time, type:type==='fixed'?'å¿…ä¿®':'é¸ä¿®', isFixed:type==='fixed', teacher:document.getElementById('c_tea').value, location:document.getElementById('c_loc').value, credit:document.getElementById('c_cr').value, isOpen:true, max:40 };
            
            if(newC.isFixed) {
                fC.push(newC); await saveToCloud(KEYS.FIXED, fC);
                sDB.forEach(s => { if(!s.courses.some(c=>c.id===id)) s.courses.push({...newC}); });
                await saveToCloud(KEYS.STUDENTS, sDB);
            } else { eC.push(newC); await saveToCloud(KEYS.ELECTIVE, eC); }
            alert("ç™¼å¸ƒæˆåŠŸ"); renderAll();
        };

        window.delCourse = async (id) => { if(confirm("åˆªé™¤?")) { if(fC.some(c=>c.id===id)) await saveToCloud(KEYS.FIXED, fC.filter(c=>c.id!==id)); else await saveToCloud(KEYS.ELECTIVE, eC.filter(c=>c.id!==id)); }};
        window.loadStuGrades = () => { const sid = document.getElementById('g_stu').value; const s = sDB.find(x=>x.id===sid); const tb = document.getElementById('grade-body'); if(!s) return; tb.innerHTML = (s.courses||[]).map(c => `<tr><td>${c.name}</td><td>${c.credit}</td><td><input type="number" id="sc-${c.id}" value="${c.score||''}" style="width:60px"></td></tr>`).join(''); };
        window.saveGrades = async () => { const sid = document.getElementById('g_stu').value; const sIdx = sDB.findIndex(x=>x.id===sid); if(sIdx===-1) return; sDB[sIdx].courses.forEach(c => { const inp = document.getElementById(`sc-${c.id}`); if(inp && inp.value) c.score = parseInt(inp.value); }); await saveToCloud(KEYS.STUDENTS, sDB); alert("æˆç¸¾å·²å„²å­˜"); };
        
        window.handleImport = (e) => { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload = async(evt) => { try { const wb = XLSX.read(evt.target.result, {type:'array'}); const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); let cnt=0; data.forEach(row => { const id = String(row['å­¸è™Ÿ']||row['id']); if(id && !sDB.some(s=>s.id===id)) { sDB.push({ id, name:row['å§“å']||'æœªå‘½å', classId:row['ç­ç´š']||'', password:'1234', status:'active', courses:fC.map(c=>({...c})) }); cnt++; } }); await saveToCloud(KEYS.STUDENTS, sDB); alert(`åŒ¯å…¥ ${cnt} ç­†`); } catch(err) { alert("æ ¼å¼éŒ¯èª¤"); } }; r.readAsArrayBuffer(f); };
        window.downloadTemplate = () => XLSX.writeFile(XLSX.utils.book_new(), "template.xlsx");
        
        window.switchTab = (id) => { ['monitor','schedule','students','courses','grades'].forEach(i => document.getElementById(i+'-view').style.display='none'); document.getElementById(id+'-view').style.display='block'; document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active')); event.currentTarget.classList.add('active'); if(window.innerWidth <= 768) document.querySelector('.sidebar').classList.remove('open'); };
        
        window.renderTeaSchedule = () => {
            const t = document.getElementById('tea-sel').value; const tb = document.getElementById('tea-schedule-body'); tb.innerHTML=''; if(!t) return;
            const allC = [...fC, ...eC].filter(c=>c.teacher===t); const timeMap = {};
            allC.forEach(c => { if(!c.time) return; let [d, p] = c.time.split('/'); const dIdx = {'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5}[d]; if(!dIdx) return; p.split(',').forEach(sec => { if(!timeMap[sec]) timeMap[sec] = [null,null,null,null,null,null]; timeMap[sec][dIdx] = c; }); });
            for(let i=1; i<=8; i++) { let row = `<tr><td>ç¬¬${i}ç¯€</td>`; for(let d=1; d<=5; d++) { const c = timeMap[i]?.[d]; row += `<td style="background:${c? (c.isFixed?'#ffe0b2':'#b3e5fc'):''}; font-size:12px;">${c ? c.name+'<br>'+c.location : ''}</td>`; } row += '</tr>'; tb.innerHTML += row; }
        };
    </script>
</body>
</html>
