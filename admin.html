<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å¸«ç®¡ç†ç³»çµ± | CAFA Admin</title>
    <style>
        /* --- æ ¸å¿ƒä¸»é¡Œè‰²ç³» --- */
        :root { --admin-blue: #00308F; --admin-dark: #002266; --admin-gold: #FFD700; --admin-bg: #f4f7fa; }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: var(--admin-bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: #333; }
        
        /* --- å´é‚Šæ¬„ (RWD) --- */
        .sidebar { width: 260px; background: linear-gradient(180deg, var(--admin-blue) 0%, var(--admin-dark) 100%); color: white; display: flex; flex-direction: column; padding-top: 25px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 100; transition: transform 0.3s; }
        .sidebar-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .menu-item { padding: 15px 25px; cursor: pointer; transition: 0.3s; color: rgba(255,255,255,0.8); display: flex; align-items: center; font-size: 15px; border-left: 5px solid transparent; }
        .menu-item:hover, .menu-item.active { background: rgba(0,0,0,0.2); border-left-color: var(--admin-gold); color: white; font-weight: bold; }
        .menu-item span { margin-right: 12px; font-size: 20px; }
        
        /* --- ä¸»å…§å®¹å€ --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background-image: linear-gradient(to bottom, #eef2f7, #f4f7fa); position: relative; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header-title { font-size: 24px; font-weight: bold; color: var(--admin-blue); border-left: 8px solid var(--admin-gold); padding-left: 15px; }

        .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-top: 4px solid var(--admin-blue); box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow-x: auto; }
        
        /* è¡¨æ ¼å„ªåŒ– */
        table { width: 100%; min-width: 600px; border-collapse: separate; border-spacing: 0; font-size: 14px; margin-top: 10px; }
        th { background-color: #f1f3f5; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        /* è¼¸å…¥èˆ‡æŒ‰éˆ• */
        input, select { width: 100%; padding: 10px; border: 2px solid #dae1e7; border-radius: 6px; box-sizing: border-box; }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; color: white; display: inline-flex; align-items: center; justify-content: center; width: 100%; margin-top: 5px; }
        .btn:hover { opacity: 0.9; }
        .btn-submit { background-color: var(--admin-blue); } .btn-add { background-color: #00695c; } .btn-del { background-color: #dc3545; width: auto; }
        
        /* èª²è¡¨æ¨£å¼ */
        .schedule-table { min-width: 800px; table-layout: fixed; border-collapse: collapse; }
        .schedule-table th, .schedule-table td { border: 1px solid #eee; text-align: center; }
        .schedule-table td { height: 60px; vertical-align: top; padding: 2px; }
        .course-block { padding: 4px; border-radius: 4px; color: white; font-size: 12px; margin-bottom: 2px; }
        
        /* æ‰‹æ©Ÿç‰ˆ Toggle æŒ‰éˆ• */
        .mobile-toggle { display: none; position: fixed; top: 10px; left: 10px; z-index: 200; background: var(--admin-blue); color: white; border: none; padding: 10px; border-radius: 5px; }

        @media (max-width: 768px) {
            .mobile-toggle { display: block; }
            .sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { padding: 60px 15px 15px 15px; }
            .header-bar { flex-direction: column; align-items: flex-start; gap: 10px; }
            .form-row { flex-direction: column; }
        }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 999; }
    </style>
</head>
<body>
    <div id="loading"><h3>è³‡æ–™åŒæ­¥ä¸­...</h3></div>
    <button class="mobile-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')">â˜° é¸å–®</button>

    <div class="sidebar">
        <div class="sidebar-header"><h2>âœˆï¸ ç®¡ç†å¾Œå°</h2></div>
        <div class="menu-item active" onclick="switchTab('monitor')"><span>ğŸŒ</span> å…¨æ ¡ç›£æ§</div>
        <div class="menu-item" onclick="switchTab('schedule')"><span>ğŸ“…</span> æ•™å¸«èª²è¡¨</div>
        <div class="menu-item" onclick="switchTab('ranks')"><span>ğŸ†</span> çæ‡²è¨­å®š</div>
        <div class="menu-item" onclick="switchTab('students')"><span>ğŸ‘¥</span> å­¸ç”Ÿç®¡ç†</div>
        <div class="menu-item" onclick="switchTab('courses')"><span>ğŸ‘¨â€ğŸ«</span> èª²ç¨‹ç®¡ç†</div>
        <div class="menu-item" onclick="switchTab('grades')"><span>ğŸ“</span> æˆç¸¾è¼¸å…¥</div>
    </div>

    <div class="main-content">
        <div id="monitor-view">
            <div class="header-bar"><div class="header-title">å…¨æ ¡ç›£æ§</div></div>
            <div class="card">
                <table><thead><tr><th>å­¸è™Ÿ/å§“å</th><th>ç­ç´š</th><th>è·æ¶¯</th><th>GPA</th><th>ç‹€æ…‹</th></tr></thead><tbody id="student-list-body"></tbody></table>
            </div>
        </div>

        <div id="schedule-view" style="display: none;">
            <div class="header-bar"><div class="header-title">æ•™å¸«èª²è¡¨</div></div>
            <div class="card">
                <select id="teacher-schedule-selector" onchange="renderTeacherSchedule()" style="margin-bottom:15px; padding:10px;">
                    <option value="">-- è«‹é¸æ“‡æ•™å®˜ --</option>
                </select>
                <h4 id="schedule-title" style="text-align:center;color:#00308F;">è«‹é¸æ“‡æ•™å®˜</h4>
                <div style="overflow-x:auto;">
                    <table class="schedule-table">
                        <thead><tr><th style="width:50px">ç¯€</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr></thead>
                        <tbody id="teacher-schedule-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="ranks-view" style="display: none;">
            <div class="header-bar"><div class="header-title">çæ‡²è¦å‰‡</div></div>
            <div class="card">
                <table><thead><tr><th>ç‰Œä½</th><th>æœ€ä½åˆ†</th><th>é¡è‰²</th><th>çå‹µ</th><th>æ‡²ç½°</th></tr></thead><tbody id="rank-rules-body"></tbody></table>
                <button class="btn btn-submit" style="width:200px; margin-top:20px;" onclick="saveRankRules()">å„²å­˜è¨­å®š</button>
            </div>
        </div>

        <div id="students-view" style="display: none;">
            <div class="header-bar"><div class="header-title">å­¸ç”Ÿè³‡æ–™</div></div>
            <div class="card">
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px;">
                    <input id="s_id" placeholder="å­¸è™Ÿ" style="flex:1">
                    <input id="s_name" placeholder="å§“å" style="flex:1">
                    <input id="s_class" placeholder="ç­ç´š" style="flex:1">
                    <input id="s_pass" placeholder="å¯†ç¢¼" style="flex:1">
                    <button class="btn btn-add" style="flex:1" onclick="addStudent()">æ–°å¢/æ›´æ–°</button>
                </div>
                <div style="max-height:400px; overflow-y:auto;">
                    <table><thead><tr><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç­ç´š</th><th>æ“ä½œ</th></tr></thead><tbody id="account-list-body"></tbody></table>
                </div>
            </div>
        </div>

        <div id="courses-view" style="display:none;">
            <div class="header-bar"><div class="header-title">èª²ç¨‹ç®¡ç†</div></div>
            <div class="card">
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:10px; margin-bottom:15px;">
                    <select id="c_type"><option value="fixed">å¿…ä¿®</option><option value="elective">é¸ä¿®</option></select>
                    <input id="c_id" placeholder="ä»£ç¢¼">
                    <input id="c_name" placeholder="åç¨±">
                    <input id="c_cr" type="number" placeholder="å­¸åˆ†" value="2">
                    <input id="c_time" placeholder="æ™‚é–“ (ä¸€/3,4)">
                    <input id="c_tea" placeholder="æ•™å®˜">
                    <button class="btn btn-submit" onclick="addCourse()">ç™¼å¸ƒèª²ç¨‹</button>
                </div>
                <table id="course-table"><thead><tr><th>é¡åˆ¥</th><th>åç¨±</th><th>æ™‚é–“</th><th>æ“ä½œ</th></tr></thead><tbody id="course-list"></tbody></table>
            </div>
        </div>

        <div id="grades-view" style="display:none;">
            <div class="header-bar"><div class="header-title">æˆç¸¾ç®¡ç†</div></div>
            <div class="card">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <select id="g_stu" onchange="loadGrades()" style="flex:3"></select>
                    <button class="btn btn-submit" style="flex:1" onclick="saveGrades()">å„²å­˜æˆç¸¾</button>
                </div>
                <table id="grade-table"><thead><tr><th>èª²ç¨‹</th><th>å­¸åˆ†</th><th>åˆ†æ•¸è¼¸å…¥</th></tr></thead><tbody id="grade-body"></tbody></table>
            </div>
        </div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud } from './firebase-connect.js';
        const KEYS = { STUDENTS:'cafa_all_students_db', FIXED:'cafa_fixed_courses', ELECTIVE:'cafa_public_electives', RANKS:'cafa_rank_rules' };
        let studentDB=[], fixedCourses=[], electiveCourses=[], rankRules=[];

        window.onload = async () => { await refreshAll(); document.getElementById('loading').style.display='none'; setInterval(refreshAll, 10000); };
        
        window.switchTab = (id) => {
            ['monitor','schedule','ranks','students','courses','grades'].forEach(v=>document.getElementById(v+'-view').style.display='none');
            document.getElementById(id+'-view').style.display='block';
            document.querySelector('.sidebar').classList.remove('open'); // æ‰‹æ©Ÿç‰ˆè‡ªå‹•é—œé–‰é¸å–®
            if(id === 'schedule') renderTeacherSchedule();
        };

        // ç¶å®šå…¨åŸŸå‡½æ•¸
        window.saveRankRules=saveRankRules; window.renderTeacherSchedule=renderTeacherSchedule;
        window.addStudent=addStudent; window.deleteStudent=deleteStudent;
        window.addCourse=addCourse; window.delCourse=delCourse; window.loadGrades=loadGrades; window.saveGrades=saveGrades; window.toggleStatus=toggleStatus;

        async function refreshAll() {
            studentDB = (await loadFromCloud(KEYS.STUDENTS))||[];
            fixedCourses = (await loadFromCloud(KEYS.FIXED))||[];
            electiveCourses = (await loadFromCloud(KEYS.ELECTIVE))||[];
            rankRules = (await loadFromCloud(KEYS.RANKS))||[{name:'ç‹è€…', min:90, color:'#ffe0b2', reward:'', punishment:''}];
            
            renderMonitor(); renderRankSettings(); renderStudents(); renderCourses(); updateSels();
        }

        function renderTeacherSchedule() {
            const tea = document.getElementById('teacher-schedule-selector').value;
            const tbody = document.getElementById('teacher-schedule-body'); tbody.innerHTML = ''; 
            for(let i=1;i<=10;i++) tbody.innerHTML+=`<tr><td style="background:#f8f9fa;">${i}</td><td id="t1-${i}"></td><td id="t2-${i}"></td><td id="t3-${i}"></td><td id="t4-${i}"></td><td id="t5-${i}"></td></tr>`;
            
            if(!tea) return document.getElementById('schedule-title').innerText = "è«‹é¸æ“‡æ•™å®˜";
            document.getElementById('schedule-title').innerText = `ğŸ“… ${tea} æ•™å®˜èª²è¡¨`;
            
            [...fixedCourses,...electiveCourses].filter(c=>c.teacher===tea).forEach(c => {
                if(!c.time) return; 
                let [d,p]=c.time.split('/'); const dMap={"ä¸€":1,"äºŒ":2,"ä¸‰":3,"å››":4,"äº”":5};
                p.split(',').forEach(x => { 
                    let el = document.getElementById(`t${dMap[d]}-${x}`);
                    if(el) el.innerHTML = `<div class="course-block" style="background:${c.isFixed?'#e65100':'#00308F'}">${c.name}<br>${c.location||''}</div>`;
                });
            });
        }

        function renderMonitor() {
            const t = document.getElementById('student-list-body'); t.innerHTML='';
            studentDB.forEach(s => {
                let tot=0, cr=0; (s.courses||[]).forEach(c => { if(c.score){ tot+=c.score*c.credit; cr+=c.credit; } });
                let gpa = cr>0 ? (tot/cr).toFixed(1) : 0;
                t.innerHTML += `<tr><td>${s.name} (${s.id})</td><td>${s.classId||'-'}</td><td>${s.careerTrack==='pilot'?'é£›è¡Œ':'åœ°å‹¤'}</td><td>${gpa}</td><td>${(s.courses||[]).length} ç§‘</td></tr>`;
            });
        }

        function renderRankSettings() {
            const t = document.getElementById('rank-rules-body'); t.innerHTML='';
            rankRules.forEach((r, i) => { t.innerHTML += `<tr><td><input value="${r.name}" id="rk-n-${i}"></td><td><input type="number" value="${r.min}" id="rk-m-${i}" style="width:60px"></td><td><input type="color" value="${r.color}" id="rk-c-${i}"></td><td><input value="${r.reward}" id="rk-r-${i}"></td><td><input value="${r.punishment}" id="rk-p-${i}"></td></tr>`; });
        }
        async function saveRankRules() {
            rankRules = rankRules.map((r, i) => ({ name: document.getElementById(`rk-n-${i}`).value, min: parseInt(document.getElementById(`rk-m-${i}`).value), color: document.getElementById(`rk-c-${i}`).value, reward: document.getElementById(`rk-r-${i}`).value, punishment: document.getElementById(`rk-p-${i}`).value })).sort((a,b) => b.min - a.min);
            await saveToCloud(KEYS.RANKS, rankRules); alert("å·²å­˜");
        }

        async function addStudent() { const id=document.getElementById('s_id').value; const idx=studentDB.findIndex(s=>s.id===id); const obj={id, name:document.getElementById('s_name').value, classId:document.getElementById('s_class').value, password:document.getElementById('s_pass').value, dept:'-', courses:[], totalCredits:0}; if(idx>-1){Object.assign(studentDB[idx], obj);}else{studentDB.push(obj);} await saveToCloud(KEYS.STUDENTS, studentDB); renderStudents(); }
        async function deleteStudent(id) { if(confirm('åˆªé™¤?')){studentDB=studentDB.filter(s=>s.id!==id); await saveToCloud(KEYS.STUDENTS, studentDB); renderStudents();} }
        function renderStudents() { document.getElementById('account-list-body').innerHTML = studentDB.map(s=>`<tr><td>${s.id}</td><td>${s.name}</td><td>${s.classId}</td><td><button class="btn btn-del" onclick="deleteStudent('${s.id}')">åˆª</button></td></tr>`).join(''); }

        async function addCourse() { const t=document.getElementById('c_type').value; const c={id:document.getElementById('c_id').value, name:document.getElementById('c_name').value, credit:parseInt(document.getElementById('c_cr').value), time:document.getElementById('c_time').value, teacher:document.getElementById('c_tea').value, type:t==='fixed'?'å¿…ä¿®':'é¸ä¿®', isFixed:t==='fixed', isOpen:true}; if(t==='fixed')fixedCourses.push(c);else electiveCourses.push(c); await saveToCloud(KEYS.FIXED,fixedCourses); await saveToCloud(KEYS.ELECTIVE,electiveCourses); renderCourses(); }
        async function delCourse(t,i) { if(t==='fixed')fixedCourses.splice(i,1);else electiveCourses.splice(i,1); await saveToCloud(KEYS.FIXED,fixedCourses); await saveToCloud(KEYS.ELECTIVE,electiveCourses); renderCourses(); }
        async function toggleStatus(i) { electiveCourses[i].isOpen=!electiveCourses[i].isOpen; await saveToCloud(KEYS.ELECTIVE,electiveCourses); renderCourses(); }
        function renderCourses() { document.getElementById('course-list').innerHTML = [...fixedCourses.map((c,i)=>`<tr><td>å¿…ä¿®</td><td>${c.name}</td><td>${c.time}</td><td><button class="btn btn-del" onclick="delCourse('fixed',${i})">åˆª</button></td></tr>`), ...electiveCourses.map((c,i)=>`<tr><td>é¸ä¿®</td><td>${c.name}</td><td>${c.time}</td><td><button class="btn" onclick="toggleStatus(${i})" style="background:${c.isOpen?'green':'grey'};width:auto;margin-right:5px;">${c.isOpen?'é–‹':'é—œ'}</button><button class="btn btn-del" onclick="delCourse('elect',${i})">åˆª</button></td></tr>`)].join(''); }

        function loadGrades() { const sid=document.getElementById('g_stu').value; const t=document.getElementById('grade-body'); t.innerHTML=''; const s=studentDB.find(x=>x.id===sid); if(!s)return; s.courses.forEach(c=>{ t.innerHTML+=`<tr><td>${c.name}</td><td>${c.credit}</td><td><input type="number" id="sc-${c.id}" value="${c.score||''}" style="width:80px"></td></tr>`; }); }
        async function saveGrades() { const sid=document.getElementById('g_stu').value; const idx=studentDB.findIndex(x=>x.id===sid); studentDB[idx].courses=studentDB[idx].courses.map(c=>{const v=document.getElementById(`sc-${c.id}`).value; if(v)c.score=parseInt(v); return c;}); await saveToCloud(KEYS.STUDENTS, studentDB); alert("æˆç¸¾å·²å„²å­˜"); }

        function updateSels() {
            const tea = document.getElementById('teacher-schedule-selector'); 
            const ts=[...new Set([...fixedCourses,...electiveCourses].map(c=>c.teacher).filter(x=>x))].sort(); 
            const savedT = tea.value; tea.innerHTML='<option value="">-- è«‹é¸æ“‡æ•™å®˜ --</option>'; ts.forEach(t=>tea.add(new Option(t,t))); tea.value = savedT;
            const stu = document.getElementById('g_stu'); stu.innerHTML='<option value="">-- è«‹é¸æ“‡å­¸ç”Ÿè¼¸å…¥æˆç¸¾ --</option>'; studentDB.forEach(s=>stu.add(new Option(`${s.id} ${s.name}`,s.id)));
        }
    </script>
</body>
</html>
