<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å¸«ç®¡ç†ç³»çµ± | CAFA Admin</title>
    <style>
        :root { --admin-blue: #00308F; --admin-gold: #FFD700; --admin-bg: #f4f7fa; --admin-card-bg: #ffffff; }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: var(--admin-bg); margin: 0; padding: 30px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: var(--admin-card-bg); padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 48, 143, 0.1); border-top: 6px solid var(--admin-blue); }
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        .main-header h1 { margin: 0; color: var(--admin-blue); font-size: 28px; }
        h2 { color: var(--admin-blue); border-left: 5px solid var(--admin-gold); padding-left: 15px; margin-top: 0; font-size: 20px; }
        .section-box { margin-bottom: 40px; padding-bottom: 30px; border-bottom: 1px dashed #ccc; }
        .control-panel { background-color: #eef2f7; padding: 25px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dce4ec; }
        .student-panel { background-color: #e8f0fe; border-color: #bbdefb; }
        .batch-panel { background-color: #e0f2f1; border-color: #b2dfdb; }
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 150px; }
        label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 8px; color: #555; }
        input, select { width: 100%; padding: 10px; border: 2px solid #dae1e7; border-radius: 6px; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; width: 100%; }
        .btn:hover { filter: brightness(1.1); }
        .btn-add { background-color: #00695c; } .btn-batch { background-color: #00796b; font-size: 16px; padding: 15px; }
        .btn-course { background-color: var(--admin-blue); } .btn-del { background-color: #dc3545; width: auto; padding: 5px 10px; font-size: 12px; }
        .btn-reset { background-color: #607d8b; width: auto; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; margin-top: 15px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; background: white; }
        .tag-class { background: #673ab7; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 999; color: var(--admin-blue); font-size: 20px; }
    </style>
</head>
<body>
    <div id="loading" class="loading-overlay">è³‡æ–™è™•ç†ä¸­...</div>

    <div class="container">
        <div class="main-header">
            <h1>âœˆï¸ ç©ºè»å®˜æ ¡ - æ•™å®˜ç®¡ç†ç³»çµ±</h1>
            <button class="btn btn-reset" onclick="resetSystem()">âš ï¸ åˆå§‹åŒ–ç³»çµ±</button>
        </div>

        <div class="section-box">
            <h2>ğŸ‘¥ å­¸ç”Ÿèˆ‡ç­ç´šç®¡ç†</h2>
            <div class="control-panel student-panel">
                <div class="form-row">
                    <div class="form-group"><label>å­¸è™Ÿ</label><input type="text" id="s_id" placeholder="114001"></div>
                    <div class="form-group"><label>å§“å</label><input type="text" id="s_name" placeholder="å¼µå¤§å¸¥"></div>
                    <div class="form-group"><label>ç­ç´š (Class)</label><input type="text" id="s_class" placeholder="å¦‚: 114-èˆªå¤ª"></div>
                    <div class="form-group"><label>å¯†ç¢¼</label><input type="text" id="s_pass" placeholder="1234"></div>
                </div>
                <button class="btn btn-add" onclick="addStudent()">â• æ–°å¢ / æ›´æ–°å­¸ç”Ÿè³‡æ–™</button>
            </div>
            <table id="acc-table"><thead><tr><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç­ç´š</th><th>å¯†ç¢¼</th><th>æ“ä½œ</th></tr></thead><tbody id="account-list-body"></tbody></table>
        </div>

        <div class="section-box">
            <h2>ğŸ« ç­ç´šæ‰¹æ¬¡æ’èª² (å›ºå®šèª²ç¨‹çŒæª”)</h2>
            <div class="control-panel batch-panel">
                <p style="color:#004d40; font-size:14px; margin-bottom:15px;">
                    ğŸ’¡ èªªæ˜ï¼šé¸æ“‡ã€Œç­ç´šã€èˆ‡ã€Œèª²ç¨‹ã€ï¼Œç³»çµ±å°‡è‡ªå‹•æŠŠè©²èª²ç¨‹åŠ å…¥è©²ç­ç´š<b>æ‰€æœ‰å­¸ç”Ÿ</b>çš„èª²è¡¨ä¸­ã€‚
                    é€™èƒ½ç¢ºä¿å¿…ä¿®èª²çµ±ä¸€ï¼Œæ¸›å°‘å­¸ç”Ÿè¡å ‚èˆ‡åŠ é€€é¸ã€‚
                </p>
                <div class="form-row">
                    <div class="form-group">
                        <label>1. é¸æ“‡ç›®æ¨™ç­ç´š</label>
                        <select id="batch-class-selector"><option value="">-- è«‹é¸æ“‡ç­ç´š --</option></select>
                    </div>
                    <div class="form-group" style="flex:2">
                        <label>2. é¸æ“‡è¦çŒå…¥çš„èª²ç¨‹</label>
                        <select id="batch-course-selector"><option value="">-- è«‹é¸æ“‡èª²ç¨‹ --</option></select>
                    </div>
                </div>
                <button class="btn btn-batch" onclick="batchAssignCourse()">ğŸš€ åŸ·è¡Œæ‰¹æ¬¡çŒæª” (å…¨ç­åŒæ­¥)</button>
            </div>
        </div>

        <div class="section-box">
            <h2>ğŸ‘¨â€ğŸ« èª²ç¨‹è³‡æ–™åº«</h2>
            <div class="control-panel">
                <div class="form-row">
                    <div class="form-group"><label>å±¬æ€§</label><select id="c_type"><option value="fixed">ğŸ”’ å¿…ä¿®</option><option value="elective">ğŸ“– é¸ä¿®</option></select></div>
                    <div class="form-group"><label>ä»£ç¢¼</label><input type="text" id="c_id"></div>
                    <div class="form-group" style="flex:2"><label>åç¨±</label><input type="text" id="c_name"></div>
                    <div class="form-group"><label>æ™‚é–“</label><input type="text" id="c_time" placeholder="ä¸‰/5,6"></div>
                </div>
                <button class="btn btn-course" onclick="addNewCourse()">ğŸ“… ç™¼å¸ƒèª²ç¨‹</button>
            </div>
            <table id="course-table"><thead><tr><th>å±¬æ€§</th><th>åç¨±</th><th>æ™‚é–“</th><th>æ“ä½œ</th></tr></thead><tbody id="managed-list-body"></tbody></table>
        </div>
        
        <div>
            <h2>ğŸŒ å…¨æ ¡å­¸ç”Ÿé¸èª²ç›£æ§</h2>
            <table><thead><tr><th>å­¸è™Ÿ/å§“å</th><th>ç­ç´š</th><th>è·æ¶¯</th><th>ç¸½å­¸åˆ†</th><th>é¸èª²æ˜ç´°</th></tr></thead><tbody id="student-list-body"></tbody></table>
        </div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud } from './firebase-connect.js';
        const KEYS = { STUDENTS: 'cafa_all_students_db', FIXED: 'cafa_fixed_courses', ELECTIVE: 'cafa_public_electives' };
        let studentDB=[], fixedCourses=[], electiveCourses=[];

        window.onload = async function() { showLoading(true); await refreshAllData(); showLoading(false); setInterval(refreshAllData, 10000); };
        window.resetSystem = resetSystem; window.addStudent = addStudent; window.deleteStudent = deleteStudent;
        window.addNewCourse = addNewCourse; window.delCourse = delCourse; window.batchAssignCourse = batchAssignCourse;

        async function refreshAllData() {
            studentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            fixedCourses = (await loadFromCloud(KEYS.FIXED)) || [];
            electiveCourses = (await loadFromCloud(KEYS.ELECTIVE)) || [];
            renderAccountList(); renderManagedList(); renderStudentList(); updateSelectors();
        }

        // --- ç­ç´šæ‰¹æ¬¡çŒæª” (æ ¸å¿ƒæ–°åŠŸèƒ½) ---
        async function batchAssignCourse() {
            const classId = document.getElementById('batch-class-selector').value;
            const courseId = document.getElementById('batch-course-selector').value;
            
            if(!classId || !courseId) return alert("è«‹é¸æ“‡ç­ç´šèˆ‡èª²ç¨‹ï¼");
            
            // æ‰¾å‡ºèª²ç¨‹ç‰©ä»¶
            const allCourses = [...fixedCourses, ...electiveCourses];
            const targetCourse = allCourses.find(c => c.id === courseId);
            if(!targetCourse) return alert("èª²ç¨‹ä¸å­˜åœ¨");

            if(!confirm(`ç¢ºå®šè¦å°‡ã€${targetCourse.name}ã€‘åŠ å…¥ã€${classId}ã€‘æ‰€æœ‰å­¸ç”Ÿçš„èª²è¡¨å—ï¼Ÿ`)) return;

            showLoading(true);
            let updateCount = 0;

            // éæ­·æ‰€æœ‰å­¸ç”Ÿ
            studentDB.forEach(s => {
                if(s.classId === classId) {
                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰é€™é–€èª²ï¼Œé¿å…é‡è¤‡
                    if(!s.courses) s.courses = [];
                    const exists = s.courses.some(c => c.id === targetCourse.id);
                    
                    if(!exists) {
                        s.courses.push(targetCourse);
                        s.totalCredits = s.courses.reduce((a,b)=>a+b.credit,0);
                        updateCount++;
                    }
                }
            });

            if(updateCount > 0) {
                await saveToCloud(KEYS.STUDENTS, studentDB);
                alert(`âœ… æˆåŠŸï¼å·²ç‚º ${updateCount} ä½å­¸ç”ŸåŠ å…¥èª²ç¨‹ã€‚`);
                refreshAllData();
            } else {
                alert("âš ï¸ æ²’æœ‰å­¸ç”Ÿè¢«æ›´æ–° (å¯èƒ½è©²ç­ç´šç„¡äººï¼Œæˆ–æ‰€æœ‰äººéƒ½æœ‰é€™é–€èª²äº†)ã€‚");
            }
            showLoading(false);
        }

        // --- ä¸‹æ‹‰é¸å–®æ›´æ–° (è‡ªå‹•æŠ“å–ç¾æœ‰ç­ç´š) ---
        function updateSelectors() {
            const classSel = document.getElementById('batch-class-selector');
            const courseSel = document.getElementById('batch-course-selector');
            
            // 1. æå–æ‰€æœ‰ä¸é‡è¤‡çš„ç­ç´š
            const classes = [...new Set(studentDB.map(s => s.classId).filter(c => c))].sort();
            
            // ä¿æŒç›®å‰é¸æ“‡
            const savedClass = classSel.value;
            classSel.innerHTML = '<option value="">-- è«‹é¸æ“‡ç­ç´š --</option>';
            classes.forEach(c => classSel.add(new Option(c, c)));
            classSel.value = savedClass;

            // 2. æ›´æ–°èª²ç¨‹é¸å–®
            const savedCourse = courseSel.value;
            courseSel.innerHTML = '<option value="">-- è«‹é¸æ“‡èª²ç¨‹ --</option>';
            [...fixedCourses, ...electiveCourses].forEach(c => courseSel.add(new Option(`${c.name} (${c.type})`, c.id)));
            courseSel.value = savedCourse;
        }

        // --- å­¸ç”Ÿèˆ‡ç­ç´šç®¡ç† ---
        async function addStudent() {
            const id = document.getElementById('s_id').value.trim();
            const name = document.getElementById('s_name').value.trim();
            const cls = document.getElementById('s_class').value.trim(); // ç­ç´š
            const pass = document.getElementById('s_pass').value.trim();
            if(!id||!name||!cls||!pass) return alert("è³‡æ–™ä¸å®Œæ•´");

            const idx = studentDB.findIndex(s => s.id === id);
            const newStudent = { id, name, classId: cls, password: pass, dept: cls.split('-')[1]||cls, courses: [], totalCredits: 0, careerTrack: '', interests: [] };
            
            if(idx > -1) { 
                // æ›´æ–°æ™‚ä¿ç•™åŸæœ‰é¸èª²èˆ‡è·æ¶¯è³‡æ–™
                newStudent.courses = studentDB[idx].courses;
                newStudent.careerTrack = studentDB[idx].careerTrack;
                newStudent.interests = studentDB[idx].interests;
                studentDB[idx] = newStudent; 
            } else { 
                studentDB.push(newStudent); 
            }
            
            showLoading(true); await saveToCloud(KEYS.STUDENTS, studentDB); showLoading(false);
            document.querySelectorAll('#s_id,#s_name,#s_pass').forEach(i=>i.value='');
            renderAccountList();
        }

        // --- å…¶ä»–æ¨™æº–åŠŸèƒ½ ---
        async function resetSystem() {
            if(!confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) return;
            showLoading(true);
            const defStu = [
                {id:'114001', name:'æå¤§ç¶­', classId:'114-èˆªå¤ª', dept:'èˆªå¤ª', password:'1234', courses:[], careerTrack:'pilot', interests:['é«”èƒ½']},
                {id:'114002', name:'å¼µå°ç¾', classId:'114-èˆªç®¡', dept:'èˆªç®¡', password:'1234', courses:[], careerTrack:'ground', interests:['è³‡é›»']}
            ];
            const defFixed = [{id:'AE101', name:'ç©ºæ°£å‹•åŠ›å­¸', credit:3, time:'ä¸€/3,4', type:'å¿…ä¿®', isFixed:true}];
            await saveToCloud(KEYS.STUDENTS, defStu); await saveToCloud(KEYS.FIXED, defFixed); await saveToCloud(KEYS.ELECTIVE, []);
            alert("å·²åˆå§‹åŒ–"); refreshAllData(); showLoading(false);
        }
        
        async function deleteStudent(id) { if(confirm("åˆªé™¤?")) { studentDB=studentDB.filter(s=>s.id!==id); await saveToCloud(KEYS.STUDENTS, studentDB); renderAccountList(); } }
        function renderAccountList() {
            document.getElementById('account-list-body').innerHTML = studentDB.map(s => 
                `<tr><td>${s.id}</td><td>${s.name}</td><td><span class="tag-class">${s.classId||'æœªåˆ†ç­'}</span></td><td>${s.password}</td><td><button class="btn btn-del" onclick="deleteStudent('${s.id}')">åˆª</button></td></tr>`
            ).join('');
        }
        
        async function addNewCourse() {
            const t=document.getElementById('c_type').value; const id=document.getElementById('c_id').value; const n=document.getElementById('c_name').value;
            const time=document.getElementById('c_time').value;
            if(!id||!n) return alert("ç¼ºè³‡æ–™");
            const nc={id, name:n, credit:2, time, type:t==='fixed'?'å¿…ä¿®':'é¸ä¿®', isFixed:t==='fixed', isOpen:true, capacity:50, enrolled:0};
            if(t==='fixed') fixedCourses.push(nc); else electiveCourses.push(nc);
            showLoading(true); await saveToCloud(KEYS.FIXED, fixedCourses); await saveToCloud(KEYS.ELECTIVE, electiveCourses); showLoading(false); renderManagedList();
        }
        
        async function delCourse(t,i) { if(confirm("åˆª?")) { if(t==='fixed')fixedCourses.splice(i,1); else electiveCourses.splice(i,1); await saveToCloud(KEYS.FIXED, fixedCourses); await saveToCloud(KEYS.ELECTIVE, electiveCourses); renderManagedList(); } }
        function renderManagedList() {
            const t = document.getElementById('managed-list-body'); t.innerHTML='';
            [...fixedCourses, ...electiveCourses].forEach((c,i) => {
                t.innerHTML += `<tr><td>${c.type}</td><td>${c.name}</td><td>${c.time}</td><td><button class="btn btn-del" onclick="delCourse('${c.isFixed?'fixed':'elect'}',${i})">åˆª</button></td></tr>`;
            });
        }
        
        function renderStudentList() {
            document.getElementById('student-list-body').innerHTML = studentDB.map(s => 
                `<tr><td>${s.name}<br><small>${s.id}</small></td><td><span class="tag-class">${s.classId||'-'}</span></td><td>${s.careerTrack==='pilot'?'ğŸ¦…':'ğŸ› ï¸'}</td><td>${s.totalCredits||0}</td><td>${(s.courses||[]).map(c=>c.name).join(', ')}</td></tr>`
            ).join('');
        }
        function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
    </script>
</body>
</html>





