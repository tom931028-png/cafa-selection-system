<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å¸«ç®¡ç†ç³»çµ± | CAFA Admin</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* --- æ ¸å¿ƒä¸»é¡Œè‰²ç³» --- */
        :root { --admin-blue: #00308F; --admin-dark: #002266; --admin-gold: #FFD700; --admin-bg: #f4f7fa; }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: var(--admin-bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: #333; }
        
        /* --- å´é‚Šæ¬„ --- */
        .sidebar { width: 260px; background: linear-gradient(180deg, var(--admin-blue) 0%, var(--admin-dark) 100%); color: white; display: flex; flex-direction: column; padding-top: 25px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 100; transition: transform 0.3s; }
        .sidebar-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .menu-item { padding: 15px 25px; cursor: pointer; transition: 0.3s; color: rgba(255,255,255,0.8); display: flex; align-items: center; font-size: 15px; border-left: 5px solid transparent; }
        .menu-item:hover, .menu-item.active { background: rgba(0,0,0,0.2); border-left-color: var(--admin-gold); color: white; font-weight: bold; }
        .menu-item span { margin-right: 12px; font-size: 20px; }
        .badge { background: #ff5252; color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px; margin-left: auto; font-weight: bold; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .badge.show { display: inline-block; animation: pulse 2s infinite; }

        /* --- ä¸»å…§å®¹å€ --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background-image: linear-gradient(to bottom, #eef2f7, #f4f7fa); position: relative; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); flex-wrap: wrap; gap: 10px; }
        .header-title { font-size: 24px; font-weight: bold; color: var(--admin-blue); border-left: 8px solid var(--admin-gold); padding-left: 15px; }

        .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-top: 4px solid var(--admin-blue); box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow-x: auto; transition: all 0.3s ease; position: relative; }
        .card-pending { border-top: 4px solid #ff9800; background: #fff8e1; }
        
        /* --- èª²ç¨‹ç®¡ç†å„ªåŒ–æ¨£å¼ --- */
        .course-form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; align-items: end; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
        .form-group input:focus { border-color: var(--admin-blue); outline: none; }
        
        /* è¡¨æ ¼èˆ‡æŒ‰éˆ• */
        table { width: 100%; min-width: 600px; border-collapse: separate; border-spacing: 0; font-size: 14px; margin-top: 10px; }
        th { background-color: #f1f3f5; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; color: white; display: inline-flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-submit { background-color: var(--admin-blue); width: 100%; height: 42px; } 
        .btn-add { background-color: #00695c; } 
        .btn-del { background-color: #dc3545; padding: 6px 12px; font-size: 12px; }
        .btn-approve { background-color: #28a745; padding: 6px 12px; font-size: 12px; }
        .btn-print { background-color: #607d8b; }
        .btn-create { background-color: #28a745; margin-bottom: 15px; }
        .btn-sync { background-color: #e65100; margin-bottom: 10px; width: 100%; }

        /* Excel åŒ¯å…¥å€å¡Š */
        .import-section { background: #e8eaf6; padding: 15px; border-radius: 10px; border: 2px dashed #9fa8da; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .btn-import { background: #3f51b5; color: white; }
        .btn-template { background: #7986cb; color: white; }

        /* èª²è¡¨æ¨£å¼ */
        .schedule-table { min-width: 800px; table-layout: fixed; border-collapse: collapse; }
        .schedule-table th, .schedule-table td { border: 1px solid #eee; text-align: center; }
        .schedule-table td { height: 80px; vertical-align: top; padding: 2px; }
        .schedule-time-col { background:#f8f9fa; color:#666; font-size:12px; font-weight:bold; width:60px; vertical-align:middle !important; }
        .course-block { padding: 6px; border-radius: 6px; color: white; font-size: 12px; margin-bottom: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition:transform 0.2s; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .course-block:hover { transform: scale(1.02); z-index:10; position:relative; }
        
        .mobile-toggle { display: none; position: fixed; top: 10px; left: 10px; z-index: 200; background: var(--admin-blue); color: white; border: none; padding: 10px; border-radius: 5px; }

        /* ä¸»é¡Œåˆ‡æ› */
        .theme-controls { display: flex; align-items: center; gap: 8px; margin-left: auto; }
        .theme-btn { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid #ddd; }
        .card-theme-blue { background: linear-gradient(to bottom right, #f0f7ff, #dbeafe) !important; border-color: #1e88e5 !important; }
        .card-theme-dark { background: #2c3e50 !important; color: #ecf0f1 !important; border-color: #34495e !important; }
        .card-theme-dark th { background: #34495e !important; color: white !important; }
        .card-theme-dark select { background: #34495e; color: white; border-color: #555; }
        .card-theme-warm { background: #fffdeb !important; border-color: #fdd835 !important; }

        @media (max-width: 768px) {
            .mobile-toggle { display: block; }
            .sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { padding: 60px 15px 15px 15px; }
            .header-bar { flex-direction: column; align-items: flex-start; gap: 10px; }
            .course-form-grid { grid-template-columns: 1fr; }
        }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 999; }
    </style>
</head>
<body>
    <div id="loading"><h3>è³‡æ–™åŒæ­¥ä¸­...</h3></div>
    <button class="mobile-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')">â˜° é¸å–®</button>

    <div class="sidebar">
        <div class="sidebar-header"><h2>âœˆï¸ ç®¡ç†å¾Œå°</h2></div>
        <div class="menu-item active" onclick="switchTab('monitor')"><span>ğŸŒ</span> å…¨æ ¡ç›£æ§</div>
        <div class="menu-item" onclick="switchTab('schedule')"><span>ğŸ“…</span> æ•™å¸«èª²è¡¨</div>
        <div class="menu-item" onclick="switchTab('ranks')"><span>ğŸ†</span> çæ‡²è¨­å®š</div>
        <div class="menu-item" onclick="switchTab('students')">
            <span>ğŸ‘¥</span> å­¸ç”Ÿèˆ‡å¯©æ ¸
            <span id="pending-badge" class="badge">0</span>
        </div>
        <div class="menu-item" onclick="switchTab('courses')"><span>ğŸ‘¨â€ğŸ«</span> èª²ç¨‹ç®¡ç†</div>
        <div class="menu-item" onclick="switchTab('grades')"><span>ğŸ“</span> æˆç¸¾è¼¸å…¥</div>
    </div>

    <div class="main-content">
        <div id="monitor-view">
            <div class="header-bar"><div class="header-title">å…¨æ ¡ç›£æ§</div><button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å ±è¡¨</button></div>
            <div class="card">
                <table><thead><tr><th>å­¸è™Ÿ/å§“å</th><th>ç­ç´š</th><th>è·æ¶¯</th><th>GPA</th><th>ç‹€æ…‹</th></tr></thead><tbody id="student-list-body"></tbody></table>
            </div>
        </div>

        <div id="schedule-view" style="display: none;">
            <div class="header-bar">
                <div class="header-title">æ•™å¸«èª²è¡¨</div>
                <div style="display:flex; align-items:center; flex-wrap:wrap;">
                    <div class="theme-controls">
                        <span style="font-size:12px;margin-right:5px;color:#666;">é¢¨æ ¼:</span>
                        <div class="theme-btn tb-white" style="background:white" onclick="setTheme('white')"></div>
                        <div class="theme-btn tb-blue" style="background:#e3f2fd" onclick="setTheme('blue')"></div>
                        <div class="theme-btn tb-warm" style="background:#fff8e1" onclick="setTheme('warm')"></div>
                        <div class="theme-btn tb-dark" style="background:#333" onclick="setTheme('dark')"></div>
                    </div>
                    <button class="btn btn-print" onclick="window.print()" style="margin-left:15px;">ğŸ–¨ï¸ åˆ—å°</button>
                </div>
            </div>
            <div class="card" id="schedule-card">
                <select id="teacher-schedule-selector" onchange="renderTeacherSchedule()" style="margin-bottom:15px; padding:10px;">
                    <option value="">-- è«‹é¸æ“‡æ•™å®˜ --</option>
                </select>
                <h4 id="schedule-title" style="text-align:center;color:#00308F;">è«‹é¸æ“‡æ•™å®˜æŸ¥çœ‹èª²è¡¨</h4>
                <div style="overflow-x:auto;">
                    <table class="schedule-table">
                        <thead><tr><th style="width:60px">ç¯€æ¬¡</th><th>æ˜ŸæœŸä¸€</th><th>æ˜ŸæœŸäºŒ</th><th>æ˜ŸæœŸä¸‰</th><th>æ˜ŸæœŸå››</th><th>æ˜ŸæœŸäº”</th></tr></thead>
                        <tbody id="teacher-schedule-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="ranks-view" style="display: none;">
            <div class="header-bar"><div class="header-title">çæ‡²èˆ‡æ®µä½è¨­å®š</div></div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div>è«‹è¨­å®šå„æ®µä½çš„ GPA é–€æª»ï¼Œç³»çµ±å°‡è‡ªå‹•ä¾åˆ†æ•¸é«˜ä½æ’åºã€‚</div>
                    <button class="btn btn-create" onclick="addNewRankRow()">ï¼‹ æ–°å¢æ®µä½</button>
                </div>
                <table>
                    <thead><tr><th style="width:15%">æ®µä½åç¨±</th><th style="width:10%">æœ€ä½GPA</th><th style="width:10%">ä»£è¡¨è‰²</th><th style="width:10%">é è¦½</th><th>çå‹µå…§å®¹</th><th>æ‡²ç½°å…§å®¹</th><th style="width:50px">æ“ä½œ</th></tr></thead>
                    <tbody id="rank-rules-body"></tbody>
                </table>
                <button class="btn btn-submit" style="width:200px; margin-top:20px;" onclick="saveRankRules()">ğŸ’¾ å„²å­˜ä¸¦å¥—ç”¨è¨­å®š</button>
            </div>
        </div>

        <div id="students-view" style="display: none;">
            <div class="header-bar"><div class="header-title">å­¸ç”Ÿè³‡æ–™èˆ‡å¯©æ ¸</div></div>
            
            <div class="import-section">
                <div>
                    <strong>ğŸ“‚ æ‰¹æ¬¡åŒ¯å…¥å¸³è™Ÿ (Excel)</strong>
                    <div style="font-size:12px; color:#666; margin-top:5px;">è«‹ä¸Šå‚³ .xlsx æˆ– .csv æª”æ¡ˆï¼Œç³»çµ±å°‡è‡ªå‹•å»ºç«‹å¸³è™Ÿ (é è¨­ç‹€æ…‹ç‚ºæ­£å¸¸)ã€‚</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-template" onclick="downloadStudentTemplate()">ğŸ“¥ ä¸‹è¼‰å¸³è™Ÿç¯„æœ¬</button>
                    <button class="btn btn-import" onclick="document.getElementById('import-student-file').click()">ğŸ“¤ ä¸Šå‚³å¸³è™Ÿè¡¨</button>
                    <input type="file" id="import-student-file" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleStudentImport(event)">
                </div>
            </div>

            <div id="pending-zone" class="card card-pending" style="display:none;">
                <h3>âš ï¸ å¾…å¯©æ ¸ç”³è«‹ (Pending Requests)</h3>
                <div style="margin-bottom:10px; display:flex; gap:10px;">
                    <button class="btn btn-approve" onclick="batchApprove()">âš¡ æ‰¹æ¬¡æ ¸å‡†</button>
                    <button class="btn btn-del" onclick="batchDelete()">ğŸ—‘ï¸ æ‰¹æ¬¡åˆªé™¤</button>
                </div>
                <div style="max-height:300px; overflow-y:auto;">
                    <table>
                        <thead><tr><th class="checkbox-cell"><input type="checkbox" onclick="toggleSelectAll(this, 'pending')"></th><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç­ç´š</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="pending-list-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>âœ… æ­£å¼å­¸å“¡åå–®</h3>
                <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
                    <input id="s_id" placeholder="å­¸è™Ÿ" style="flex:1; min-width:100px;">
                    <input id="s_name" placeholder="å§“å" style="flex:1; min-width:100px;">
                    <input id="s_class" placeholder="ç­ç´š" style="flex:1; min-width:100px;">
                    <input id="s_pass" placeholder="å¯†ç¢¼" style="flex:1; min-width:100px;">
                    <button class="btn btn-add" style="flex:1; min-width:100px;" onclick="addStudent()">æ‰‹å‹•æ–°å¢</button>
                </div>
                <div style="max-height:500px; overflow-y:auto;">
                    <table>
                        <thead><tr><th>ç‹€æ…‹</th><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç­ç´š</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="active-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="courses-view" style="display:none;">
            <div class="header-bar"><div class="header-title">èª²ç¨‹ç®¡ç†</div></div>
            
            <div class="card" style="border-top-color:#28a745;">
                <h3 style="margin-top:0; color:#28a745;">â• æ–°å¢èª²ç¨‹</h3>
                <div class="course-form-grid">
                    <div class="form-group">
                        <label>èª²ç¨‹é¡åˆ¥</label>
                        <select id="c_type" onchange="toggleCourseForm(this.value)">
                            <option value="fixed">ğŸ”’ å¿…ä¿® (å…¨æ ¡å¼·åˆ¶)</option>
                            <option value="elective">ğŸ“– é¸ä¿® (è‡ªç”±é¸èª²)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>èª²ç¨‹ä»£ç¢¼</label>
                        <input id="c_id" placeholder="ä¾‹: C101">
                    </div>
                    <div class="form-group">
                        <label>èª²ç¨‹åç¨±</label>
                        <input id="c_name" placeholder="ä¾‹: é£›è¡ŒåŸç†">
                    </div>
                    <div class="form-group">
                        <label>å­¸åˆ†</label>
                        <input id="c_cr" type="number" value="2">
                    </div>
                    <div class="form-group">
                        <label>ä¸Šèª²æ™‚é–“ (ä¾‹: ä¸€/3,4)</label>
                        <input id="c_time" placeholder="æ˜ŸæœŸ/ç¯€æ¬¡">
                    </div>
                    <div class="form-group">
                        <label>æ•™å®˜å§“å</label>
                        <input id="c_tea" placeholder="ä¾‹: ç‹å¤§æ˜">
                    </div>
                    <div class="form-group">
                        <label>ä¸Šèª²åœ°é»</label>
                        <input id="c_loc" placeholder="ä¾‹: èˆªå¤ª 301">
                    </div>
                    <div class="form-group" id="group-max">
                        <label>äººæ•¸ä¸Šé™</label>
                        <input id="c_max" type="number" value="40">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-submit" onclick="addCourse()">ç™¼å¸ƒèª²ç¨‹</button>
                    </div>
                </div>
                <div style="margin-top:10px; font-size:12px; color:#d32f2f;">
                    * æ³¨æ„ï¼šç™¼å¸ƒã€Œå¿…ä¿®ã€èª²ç¨‹æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•å°‡è©²èª²ç¨‹åŠ å…¥æ‰€æœ‰å­¸ç”Ÿçš„èª²è¡¨ï¼Œè‹¥æœ‰é¸ä¿®è¡å ‚å°‡è‡ªå‹•ç§»é™¤é¸ä¿®èª²ã€‚
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“š ç¾æœ‰èª²ç¨‹åˆ—è¡¨</h3>
                <div id="sync-btn-container"></div>
                <div style="max-height:600px; overflow-y:auto;">
                    <table id="course-table"><thead><tr><th>é¡åˆ¥</th><th>åç¨± (ä»£ç¢¼)</th><th>æ™‚é–“</th><th>åœ°é»</th><th>æ•™å®˜</th><th>ç‹€æ…‹/äººæ•¸</th><th>æ“ä½œ</th></tr></thead><tbody id="course-list"></tbody></table>
                </div>
            </div>
        </div>

        <div id="grades-view" style="display:none;">
            <div class="header-bar"><div class="header-title">æˆç¸¾ç®¡ç†</div></div>
            <div class="import-section" style="background:#e0f2f1; border-color:#80cbc4;">
                <div><strong>ğŸ“Š æ‰¹æ¬¡åŒ¯å…¥æˆç¸¾ (Excel)</strong><div style="font-size:12px; color:#00695c; margin-top:5px;">å­¸è™Ÿ + èª²ç¨‹ä»£ç¢¼ + åˆ†æ•¸</div></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-template" onclick="downloadGradeTemplate()">ğŸ“¥ ç¯„æœ¬</button>
                    <button class="btn btn-import" style="background:#00695c;" onclick="document.getElementById('import-grade-file').click()">ğŸ“¤ ä¸Šå‚³</button>
                    <input type="file" id="import-grade-file" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleGradeImport(event)">
                </div>
            </div>

            <div class="card">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <select id="g_stu" onchange="loadGrades()" style="flex:3">
                        <option value="">-- è«‹å…ˆé¸æ“‡å­¸ç”Ÿ --</option>
                    </select>
                    <button class="btn btn-submit" style="flex:1" onclick="saveGrades()">ğŸ’¾ å„²å­˜æˆç¸¾</button>
                </div>
                <table id="grade-table"><thead><tr><th>èª²ç¨‹</th><th>å­¸åˆ†</th><th>åˆ†æ•¸è¼¸å…¥</th></tr></thead><tbody id="grade-body"><tr><td colspan="3" style="text-align:center; color:#999;">è«‹å…ˆé¸æ“‡å­¸ç”Ÿä»¥è¼‰å…¥èª²ç¨‹åˆ—è¡¨</td></tr></tbody></table>
            </div>
        </div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud, listenToCloud } from './firebase-connect.js';
        const KEYS = { STUDENTS:'cafa_all_students_db', FIXED:'cafa_fixed_courses', ELECTIVE:'cafa_public_electives', RANKS:'cafa_rank_rules' };
        let studentDB=[], fixedCourses=[], electiveCourses=[], rankRules=[];
        const TIME_SLOTS = ["08:10", "09:10", "10:10", "11:10", "13:30", "14:30", "15:30", "16:30", "17:30", "19:00"];

        window.onload = () => { 
            initAdminListeners();
            document.getElementById('loading').style.display='none'; 
            const savedTheme = localStorage.getItem('cafa_admin_theme'); if(savedTheme) setTheme(savedTheme);
        };

        function initAdminListeners() {
            listenToCloud(KEYS.STUDENTS, (val) => { 
                studentDB = val || []; 
                renderMonitor(); 
                renderStudents(); 
                updateSels(); 
                if(document.getElementById('schedule-view').style.display==='block') renderTeacherSchedule(); 
            });
            listenToCloud(KEYS.FIXED, (val) => { fixedCourses = val || []; renderCourses(); updateSels(); renderTeacherSchedule(); });
            listenToCloud(KEYS.ELECTIVE, (val) => { electiveCourses = val || []; renderCourses(); updateSels(); renderTeacherSchedule(); });
            listenToCloud(KEYS.RANKS, (val) => { rankRules = val || getDefaultRanks(); renderRankSettings(); });
        }

        window.renderTeacherSchedule = () => {
            const tea = document.getElementById('teacher-schedule-selector').value; 
            const tbody = document.getElementById('teacher-schedule-body'); 
            tbody.innerHTML = ''; 

            for(let i=1;i<=10;i++) {
                tbody.innerHTML += `<tr><td class="schedule-time-col">ç¬¬${i}ç¯€<br><span style="font-size:10px; font-weight:normal;">${TIME_SLOTS[i-1]}</span></td><td id="t1-${i}"></td><td id="t2-${i}"></td><td id="t3-${i}"></td><td id="t4-${i}"></td><td id="t5-${i}"></td></tr>`;
            }

            if(!tea) { document.getElementById('schedule-title').innerText = "è«‹é¸æ“‡æ•™å®˜æŸ¥çœ‹èª²è¡¨"; return; }
            document.getElementById('schedule-title').innerText = `ğŸ“… ${tea} æ•™å®˜èª²è¡¨`;

            const courses = [...fixedCourses, ...electiveCourses].filter(c => c.teacher === tea);
            
            const counts = {};
            studentDB.forEach(s => {
                if(s.courses) {
                    s.courses.forEach(sc => {
                        if(courses.some(c => c.id === sc.id)) { counts[sc.id] = (counts[sc.id] || 0) + 1; }
                    });
                }
            });

            courses.forEach(c => { 
                if(!c.time) return; 
                let cleanTime = c.time.replace(/\s/g, ''); 
                let [d, p] = cleanTime.split('/'); 
                
                if (!d || !p) return;

                const dMap = {"ä¸€":1, "äºŒ":2, "ä¸‰":3, "å››":4, "äº”":5}; 
                if(!dMap[d]) return;

                p.split(',').forEach(x => { 
                    let el = document.getElementById(`t${dMap[d]}-${x}`); 
                    if(el) {
                        if(el.innerHTML !== "") el.innerHTML += `<div style="border-top:1px solid rgba(255,255,255,0.3); margin-top:2px; padding-top:2px;"></div>`;
                        el.innerHTML += `
                            <div class="course-block" 
                                 style="background:${c.isFixed ? 'linear-gradient(135deg, #e65100, #ff9800)' : 'linear-gradient(135deg, #00308F, #1976d2)'}; cursor:pointer;" 
                                 onclick="alert('ã€èª²ç¨‹è©³æƒ…ã€‘\\nåç¨±ï¼š${c.name}\\nä»£ç¢¼ï¼š${c.id}\\nåœ°é»ï¼š${c.location||'æœªå®š'}\\né¸èª²äººæ•¸ï¼š${counts[c.id]||0} äºº')">
                                <div style="font-weight:bold; font-size:13px;">${c.name}</div>
                                <div style="font-size:11px; opacity:0.9;">${c.location||'ğŸ“ç„¡'}</div>
                            </div>`;
                    }
                }); 
            });
        };

        window.addCourse = async () => {
            const t = document.getElementById('c_type').value;
            const cid = document.getElementById('c_id').value.trim();
            const name = document.getElementById('c_name').value.trim();
            const time = document.getElementById('c_time').value.trim().replace(/\s/g, ''); 
            const teacher = document.getElementById('c_tea').value.trim();
            const location = document.getElementById('c_loc').value.trim();
            const credit = parseInt(document.getElementById('c_cr').value);
            const maxVal = parseInt(document.getElementById('c_max').value)||40;

            if(!cid || !name || !time) return alert("è«‹å¡«å¯«å®Œæ•´èª²ç¨‹è³‡è¨Š (ä»£ç¢¼ã€åç¨±ã€æ™‚é–“)ï¼");
            
            if([...fixedCourses, ...electiveCourses].some(c => c.id === cid)) return alert("èª²ç¨‹ä»£ç¢¼å·²å­˜åœ¨ï¼è«‹æ›´æ›ä»£ç¢¼ã€‚");

            const newCourse = {
                id: cid, name, credit, time, teacher, location,
                type: t==='fixed'?'å¿…ä¿®':'é¸ä¿®', 
                isFixed: t==='fixed', 
                isOpen: true,
                max: t==='fixed' ? 9999 : maxVal
            };

            let success = false;
            if(t === 'fixed') {
                if(!confirm(`âš ï¸ ç™¼å¸ƒå¿…ä¿®èª²ç¨‹ã€Œ${name}ã€\n\né€™å°‡æœƒå¼·åˆ¶åŠ å…¥åˆ°ã€Œæ‰€æœ‰ã€å­¸ç”Ÿçš„èª²è¡¨ä¸­ã€‚ç¢ºå®šå—ï¼Ÿ`)) return;
                
                const newFixed = [...fixedCourses, newCourse];
                success = await saveToCloud(KEYS.FIXED, newFixed);
                if (!success) return; // å¤±æ•—å°±åœ

                let affectedCount = 0;
                let conflictRemoved = 0;
                let currentDB = JSON.parse(JSON.stringify(studentDB));

                currentDB.forEach(s => {
                    if(!s.courses) s.courses = [];
                    if(!s.courses.some(c => c.id === cid)) {
                        s.courses = s.courses.filter(exist => {
                            const isConflict = checkTimeConflict(exist.time, newCourse.time);
                            if(isConflict && !exist.isFixed) { 
                                conflictRemoved++; 
                                return false; 
                            }
                            return true;
                        });
                        s.courses.push({ 
                            id: cid, name: name, credit: credit, time: time, 
                            isFixed: true, location: location, teacher: teacher 
                        });
                        affectedCount++;
                    }
                });

                success = await saveToCloud(KEYS.STUDENTS, currentDB);
                if (success) {
                    alert(`âœ… å¿…ä¿®ç™¼å¸ƒæˆåŠŸï¼\nå·²åŒæ­¥è‡³ ${affectedCount} ä½å­¸ç”Ÿï¼Œä¸¦è‡ªå‹•è§£æ±º ${conflictRemoved} å€‹é¸ä¿®è¡å ‚ã€‚`);
                }
            } else {
                const newElect = [...electiveCourses, newCourse];
                success = await saveToCloud(KEYS.ELECTIVE, newElect);
                if (success) {
                    alert("âœ… é¸ä¿®èª²ç¨‹å·²ç™¼å¸ƒï¼Œå­¸ç”Ÿç¾åœ¨å¯ä»¥åœ¨é¸èª²å€çœ‹åˆ°äº†ã€‚");
                }
            }
            
            if (success) {
                document.getElementById('c_id').value = '';
                document.getElementById('c_name').value = '';
                if(teacher) {
                    document.getElementById('teacher-schedule-selector').value = teacher;
                    switchTab('schedule');
                }
            }
        };

        window.syncFixedCoursesToAll = async () => {
            if(!confirm("ç¢ºå®šè¦å°‡ç›®å‰çš„ã€Œå¿…ä¿®èª²ç¨‹ã€å¼·åˆ¶åŒæ­¥çµ¦æ‰€æœ‰å­¸ç”Ÿå—ï¼Ÿ")) return;
            let updateCount = 0;
            let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];

            currentDB.forEach(s => {
                if(!s.courses) s.courses = [];
                fixedCourses.forEach(fc => {
                    if(!s.courses.some(c => c.id === fc.id)) {
                         s.courses = s.courses.filter(exist => !(!exist.isFixed && checkTimeConflict(exist.time, fc.time)));
                         s.courses.push({ id: fc.id, name: fc.name, credit: fc.credit, time: fc.time, isFixed: true, location: fc.location, teacher: fc.teacher });
                         updateCount++;
                    }
                });
            });

            if(updateCount > 0) {
                const success = await saveToCloud(KEYS.STUDENTS, currentDB);
                if (success) alert(`âœ… åŒæ­¥å®Œæˆï¼æ›´æ–°äº† ${updateCount} ç­†è³‡æ–™ã€‚`);
            } else {
                alert("æ‰€æœ‰å­¸ç”Ÿçš„è³‡æ–™å·²ç¶“æ˜¯æœ€æ–°çš„ã€‚");
            }
        };

        function checkTimeConflict(t1, t2) {
            if(!t1 || !t2) return false;
            let clean1 = t1.replace(/\s/g, ''), clean2 = t2.replace(/\s/g, '');
            let [d1, p1] = clean1.split('/'); let [d2, p2] = clean2.split('/');
            if(d1 !== d2) return false; 
            let pp1 = p1.split(','), pp2 = p2.split(',');
            return pp1.some(p => pp2.includes(p)); 
        }

        window.delCourse = async (type, idx) => {
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤èª²ç¨‹ï¼Ÿ")) return;
            let success;
            if(type === 'fixed') { const n = [...fixedCourses]; n.splice(idx, 1); success = await saveToCloud(KEYS.FIXED, n); } 
            else { const n = [...electiveCourses]; n.splice(idx, 1); success = await saveToCloud(KEYS.ELECTIVE, n); }
        };

        window.toggleStatus = async (idx) => {
            const n = [...electiveCourses]; n[idx].isOpen = !n[idx].isOpen;
            await saveToCloud(KEYS.ELECTIVE, n);
        };

        function renderCourses() {
            const t = document.getElementById('course-list');
            let html = '';
            document.getElementById('sync-btn-container').innerHTML = `<button class="btn btn-sync" onclick="syncFixedCoursesToAll()">ğŸ”„ å¼·åˆ¶åŒæ­¥å¿…ä¿®èª²çµ¦æ‰€æœ‰å­¸ç”Ÿ</button>`;
            
            fixedCourses.forEach((c, i) => {
                html += `<tr style="background:#fff3e0"><td><span style="color:#e65100;font-weight:bold">ğŸ”’ å¿…ä¿®</span></td><td>${c.name} (${c.id})</td><td>${c.time}</td><td>${c.location||'-'}</td><td>${c.teacher||'-'}</td><td>å…¨é«”</td><td><button class="btn btn-del" onclick="delCourse('fixed',${i})">åˆªé™¤</button></td></tr>`;
            });
            electiveCourses.forEach((c, i) => {
                html += `<tr><td><span style="color:#2e7d32;font-weight:bold">ğŸ“– é¸ä¿®</span></td><td>${c.name} (${c.id})</td><td>${c.time}</td><td>${c.location||'-'}</td><td>${c.teacher||'-'}</td><td><button class="btn" onclick="toggleStatus(${i})" style="background:${c.isOpen?'#28a745':'#9e9e9e'};padding:2px 8px;font-size:12px;">${c.isOpen?'é–‹å•Ÿä¸­':'å·²é—œé–‰'}</button> ${c.max}äºº</td><td><button class="btn btn-del" onclick="delCourse('elect',${i})">åˆªé™¤</button></td></tr>`;
            });
            t.innerHTML = html;
        }

        window.updateSels = () => { 
            const tea = document.getElementById('teacher-schedule-selector'); 
            const currentCourses = [...fixedCourses, ...electiveCourses];
            const ts = [...new Set(currentCourses.map(c=>c.teacher).filter(x=>x && x.trim() !== ''))].sort(); 
            
            const savedT = tea.value; 
            tea.innerHTML='<option value="">-- è«‹é¸æ“‡æ•™å®˜ --</option>'; 
            ts.forEach(t => tea.add(new Option(t,t))); 
            
            if(ts.includes(savedT)) {
                tea.value = savedT;
            } 
            
            const stu = document.getElementById('g_stu'); 
            const savedS = stu.value; 
            stu.innerHTML='<option value="">-- è«‹é¸æ“‡å­¸ç”Ÿè¼¸å…¥æˆç¸¾ --</option>'; 
            studentDB.forEach(s=>stu.add(new Option(`${s.id} ${s.name}`, s.id))); stu.value = savedS; 
        };

        window.toggleCourseForm = (v) => {
            const maxInput = document.getElementById('c_max');
            const group = document.getElementById('group-max');
            if(v === 'fixed') { maxInput.disabled = true; maxInput.value = 'å…¨æ ¡'; group.style.opacity = 0.5; }
            else { maxInput.disabled = false; maxInput.value = '40'; group.style.opacity = 1; }
        };

        window.setTheme = (t) => {
            const c = document.getElementById('schedule-card'); c.className = 'card';
            if(t !== 'white') c.classList.add(`card-theme-${t}`);
            localStorage.setItem('cafa_admin_theme', t);
            const title = document.getElementById('schedule-title');
            title.style.color = (t === 'dark') ? '#fff' : '#00308F';
        };

        window.switchTab = (id) => {
            ['monitor','schedule','ranks','students','courses','grades'].forEach(v=>document.getElementById(v+'-view').style.display='none');
            document.getElementById(id+'-view').style.display='block';
            document.querySelector('.sidebar').classList.remove('open');
            if(id === 'schedule') renderTeacherSchedule();
            if(id === 'ranks') renderRankSettings();
        };

        function renderRankSettings() {
            const t = document.getElementById('rank-rules-body'); t.innerHTML = '';
            rankRules.sort((a,b) => b.min - a.min);
            rankRules.forEach((r, i) => {
                t.innerHTML += `<tr class="rank-row"><td><input class="r-name" value="${r.name}" placeholder="åç¨±"></td><td><input class="r-min" type="number" value="${r.min}" style="width:60px"></td><td><input class="r-color" type="color" value="${r.color}" oninput="updateRankPreview(this)"></td><td><span class="rank-badge" style="background-color:${r.color};">${r.name}</span></td><td><input class="r-reward" value="${r.reward||''}" placeholder="ç„¡"></td><td><input class="r-punish" value="${r.punish||''}" placeholder="ç„¡"></td><td><button class="btn btn-del" onclick="deleteRankRow(this)">âœ•</button></td></tr>`;
            });
        }
        window.addNewRankRow = () => {
            const t = document.getElementById('rank-rules-body');
            const row = document.createElement('tr'); row.className = 'rank-row';
            row.innerHTML = `<td><input class="r-name" value="æ–°æ®µä½" placeholder="åç¨±"></td><td><input class="r-min" type="number" value="60" style="width:60px"></td><td><input class="r-color" type="color" value="#cccccc" oninput="updateRankPreview(this)"></td><td><span class="rank-badge" style="background-color:#cccccc;">æ–°æ®µä½</span></td><td><input class="r-reward" placeholder="ç„¡"></td><td><input class="r-punish" placeholder="ç„¡"></td><td><button class="btn btn-del" onclick="deleteRankRow(this)">âœ•</button></td>`;
            t.insertBefore(row, t.firstChild);
        };
        window.deleteRankRow = (btn) => { if(confirm("åˆªé™¤?")) btn.closest('tr').remove(); };
        window.updateRankPreview = (input) => { const r = input.closest('tr'); const b = r.querySelector('.rank-badge'); const n = r.querySelector('.r-name'); b.style.backgroundColor = input.value; b.innerText = n.value; };
        window.saveRankRules = async () => {
            const rows = document.querySelectorAll('.rank-row'); const newRules = [];
            rows.forEach(row => { const name = row.querySelector('.r-name').value; const min = parseInt(row.querySelector('.r-min').value); const color = row.querySelector('.r-color').value; const reward = row.querySelector('.r-reward').value; const punishment = row.querySelector('.r-punish').value; if(name && !isNaN(min)) newRules.push({ name, min, color, reward, punishment }); });
            newRules.sort((a,b) => b.min - a.min); 
            const success = await saveToCloud(KEYS.RANKS, newRules); 
            if(success) alert("âœ… è¨­å®šå·²å„²å­˜ï¼"); 
        };
        function getDefaultRanks() { return [{name:'ç‹è€…', min:90, color:'#ffe0b2', reward:'ç¦®åˆ¸', punishment:''}, {name:'é‘½çŸ³', min:80, color:'#b3e5fc', reward:'', punishment:''}, {name:'é»ƒé‡‘', min:70, color:'#fff9c4', reward:'', punishment:''}, {name:'ç™½éŠ€', min:60, color:'#f5f5f5', reward:'', punishment:''}, {name:'é’éŠ…', min:0, color:'#ffccbc', reward:'', punishment:''}]; }

        window.addStudent = async () => { 
            const id=document.getElementById('s_id').value; 
            if(studentDB.some(s=>s.id===id))return alert("é‡è¤‡"); 
            
            let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            
            const initCourses = fixedCourses.map(fc => ({ id: fc.id, name: fc.name, credit: fc.credit, time: fc.time, isFixed: true, location: fc.location, teacher: fc.teacher }));
            currentDB.push({id, name:document.getElementById('s_name').value, classId:document.getElementById('s_class').value, password:document.getElementById('s_pass').value, status:'active', courses:initCourses}); 
            await saveToCloud(KEYS.STUDENTS, currentDB); 
        };

        window.renderStudents = () => {
            const pendingList = studentDB.filter(s => s.status === 'pending');
            const activeList = studentDB.filter(s => s.status !== 'pending');
            const badge = document.getElementById('pending-badge');
            if(pendingList.length > 0) { badge.innerText = pendingList.length; badge.classList.add('show'); document.getElementById('pending-zone').style.display = 'block'; }
            else { badge.classList.remove('show'); document.getElementById('pending-zone').style.display = 'none'; }
            
            document.getElementById('pending-list-body').innerHTML = pendingList.length === 0 ? '' : pendingList.map(s => `<tr><td class="checkbox-cell"><input type="checkbox" class="pending-checkbox" value="${s.id}"></td><td>${s.id}</td><td>${s.name}</td><td>${s.classId}</td><td><button class="btn btn-approve" onclick="approveStudent('${s.id}')">æ ¸å‡†</button></td></tr>`).join('');
            document.getElementById('active-list-body').innerHTML = activeList.map(s => `<tr><td>ğŸŸ¢</td><td>${s.id}</td><td>${s.name}</td><td>${s.classId}</td><td><button class="btn btn-del" onclick="deleteStudent('${s.id}')">åˆª</button></td></tr>`).join('');
        };
        window.toggleSelectAll = (src, type) => { document.querySelectorAll(`.${type}-checkbox`).forEach(cb => cb.checked = src.checked); };
        
        window.batchApprove = async () => {
            const cbs = document.querySelectorAll('.pending-checkbox:checked'); if(cbs.length===0) return alert("æœªé¸å–");
            
            let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            const ids = Array.from(cbs).map(cb=>cb.value);
            
            ids.forEach(id => {
                const s = currentDB.find(x=>x.id===id); 
                if(s) s.status='active'; 
            });
            const success = await saveToCloud(KEYS.STUDENTS, currentDB); 
            if(success) alert(`âœ… å·²æ ¸å‡† ${cbs.length} äºº`);
        };

        window.batchDelete = async () => {
            const cbs = document.querySelectorAll('.pending-checkbox:checked'); if(cbs.length===0) return alert("æœªé¸å–");
            if(!confirm("ç¢ºå®šåˆªé™¤?")) return;
            
            let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            const ids = Array.from(cbs).map(cb=>cb.value);
            const newDB = currentDB.filter(s => !ids.includes(s.id));
            await saveToCloud(KEYS.STUDENTS, newDB);
        };
        
        window.downloadStudentTemplate = () => { const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["å­¸è™Ÿ","å§“å","ç­ç´š","å¯†ç¢¼"],["114001","æ¸¬è©¦ç”Ÿ","114-1","1234"]]), "ç¯„æœ¬"); XLSX.writeFile(wb, "å­¸ç”Ÿå¸³è™Ÿç¯„æœ¬.xlsx"); };
        
        // â˜…â˜…â˜… é—œéµä¿®å¾©ï¼šæª¢æŸ¥ saveToCloud å›å‚³å€¼ â˜…â˜…â˜…
        window.handleStudentImport = (e) => {
            const f = e.target.files[0]; 
            if(!f) return;

            const r = new FileReader(); 
            r.onload = async (e) => {
                try {
                    const d = new Uint8Array(e.target.result);
                    const wb = XLSX.read(d, {type: 'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    
                    if (json.length === 0) {
                        alert("Excel æª”æ¡ˆæ˜¯ç©ºçš„æˆ–æ ¼å¼ç„¡æ³•è®€å–ï¼");
                        return;
                    }

                    // åŒ¯å…¥å‰ï¼Œå…ˆå¾é›²ç«¯æŠ“æœ€æ–°çš„è³‡æ–™
                    let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
                    
                    let cnt = 0; 
                    const initCourses = fixedCourses.map(fc => ({ 
                        id: fc.id, name: fc.name, credit: fc.credit, time: fc.time, 
                        isFixed: true, location: fc.location, teacher: fc.teacher 
                    }));

                    json.forEach(row => { 
                        const idRaw = row['å­¸è™Ÿ'] || row['id'] || row['ID'];
                        const nameRaw = row['å§“å'] || row['name'] || row['Name'];
                        const classRaw = row['ç­ç´š'] || row['class'] || row['Class'];
                        const passRaw = row['å¯†ç¢¼'] || row['password'] || '1234';

                        if (idRaw) {
                            const id = String(idRaw).trim();
                            if (!currentDB.some(s => s.id === id)) { 
                                currentDB.push({ 
                                    id: id, 
                                    name: String(nameRaw || 'æœªå‘½å').trim(), 
                                    classId: String(classRaw || '').trim(), 
                                    password: String(passRaw).trim(), 
                                    status: 'active', 
                                    courses: [...initCourses] 
                                }); 
                                cnt++; 
                            }
                        }
                    });

                    if (cnt > 0) {
                        // â˜… é—œéµï¼šæª¢æŸ¥ saveToCloud æ˜¯å¦å›å‚³ true
                        const success = await saveToCloud(KEYS.STUDENTS, currentDB);
                        if (success) {
                            alert(`âœ… æˆåŠŸåŒ¯å…¥ ${cnt} ç­†æ–°å¸³è™Ÿï¼\n(å·²è‡ªå‹•å¸¶å…¥ç›®å‰çš„å¿…ä¿®èª²ç¨‹)`);
                        }
                    } else {
                        alert("âš ï¸ æ²’æœ‰æ–°å¢ä»»ä½•å¸³è™Ÿã€‚\nå¯èƒ½æ˜¯ Excel æ ¼å¼ä¸ç¬¦ï¼Œæˆ–å­¸è™Ÿå·²å…¨éƒ¨å­˜åœ¨ã€‚");
                    }
                    
                    document.getElementById('import-student-file').value = ''; 

                } catch (error) {
                    console.error(error);
                    alert("âŒ è™•ç† Excel æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚");
                }
            }; 
            r.readAsArrayBuffer(f);
        };

        window.downloadGradeTemplate = () => { const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["å­¸è™Ÿ","èª²ç¨‹ä»£ç¢¼","åˆ†æ•¸"],["114001","C101","85"]]), "ç¯„æœ¬"); XLSX.writeFile(wb, "æˆç¸¾ç¯„æœ¬.xlsx"); };
        
        window.handleGradeImport = (e) => {
            const f=e.target.files[0]; if(!f)return;
            const r=new FileReader(); r.onload=async(e)=>{
                const d=new Uint8Array(e.target.result), wb=XLSX.read(d,{type:'array'});
                const json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                let cnt=0; 
                let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
                
                json.forEach(r=>{
                    const sid=String(r['å­¸è™Ÿ']), cid=String(r['èª²ç¨‹ä»£ç¢¼']), sc=parseInt(r['åˆ†æ•¸']);
                    const s=currentDB.find(x=>x.id===sid);
                    if(s && s.courses){ const c=s.courses.find(x=>x.id===cid); if(c){c.score=sc; cnt++;} }
                });
                if(cnt>0) {
                    const success = await saveToCloud(KEYS.STUDENTS, currentDB);
                    if (success) alert(`æ›´æ–° ${cnt} ç­†æˆç¸¾`);
                } 
                document.getElementById('import-grade-file').value='';
            }; r.readAsArrayBuffer(f);
        };

        window.loadGrades = () => { 
            const sid=document.getElementById('g_stu').value; 
            const t=document.getElementById('grade-body'); t.innerHTML=''; 
            if(!sid) { t.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#999;">è«‹é¸æ“‡å­¸ç”Ÿ</td></tr>'; return; }
            const s=studentDB.find(x=>x.id===sid); 
            if(!s || !s.courses || s.courses.length === 0) { t.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#d32f2f;">æ­¤å­¸ç”Ÿå°šæœªé¸ä¿®ä»»ä½•èª²ç¨‹</td></tr>'; return; }
            s.courses.forEach(c=>{ 
                const safeId = c.id.replace(/[^a-zA-Z0-9-_]/g, '_');
                const val = (c.score === undefined || c.score === null) ? '' : c.score;
                t.innerHTML+=`<tr><td>${c.name} <span style="font-size:12px;color:#999">(${c.id})</span></td><td>${c.credit}</td><td><input type="number" id="sc-${safeId}" value="${val}" style="width:80px" placeholder="æœªè¼¸å…¥" data-cid="${c.id}"></td></tr>`; 
            }); 
        };

        window.saveGrades = async () => { 
            const sid=document.getElementById('g_stu').value; 
            if(!sid) return alert("è«‹å…ˆé¸æ“‡å­¸ç”Ÿï¼");
            
            let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            const idx=currentDB.findIndex(x=>x.id===sid); 
            
            if(idx>-1) { 
                const s = currentDB[idx];
                if(s.courses) {
                    s.courses.forEach(c => {
                        const safeId = c.id.replace(/[^a-zA-Z0-9-_]/g, '_');
                        const input = document.getElementById(`sc-${safeId}`);
                        if(input) {
                            const val = input.value.trim();
                            if(val === '') delete c.score; else c.score = parseInt(val);
                        }
                    });
                    const success = await saveToCloud(KEYS.STUDENTS, currentDB); 
                    if(success) alert(`âœ… å­¸ç”Ÿ ${s.name} çš„æˆç¸¾å·²å„²å­˜ï¼`); 
                }
            } else alert("æ‰¾ä¸åˆ°å­¸ç”Ÿè³‡æ–™");
        };

        window.deleteStudent = async (id) => { 
            if(confirm("åˆªé™¤?")){ 
                let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
                await saveToCloud(KEYS.STUDENTS, currentDB.filter(s=>s.id!==id)); 
            } 
        };
        window.approveStudent = async (id) => { 
            let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            const s=currentDB.find(x=>x.id===id); 
            if(s){ s.status='active'; await saveToCloud(KEYS.STUDENTS, currentDB); } 
        };
        
        window.renderMonitor = () => { const t = document.getElementById('student-list-body'); t.innerHTML=''; studentDB.forEach(s => { let tot=0, cr=0; (s.courses||[]).forEach(c => { if(c.score){ tot+=c.score*c.credit; cr+=c.credit; } }); let gpa = cr>0 ? (tot/cr).toFixed(1) : 0; t.innerHTML += `<tr><td>${s.name} (${s.id})</td><td>${s.classId||'-'}</td><td>${s.careerTrack==='pilot'?'é£›è¡Œ':'åœ°å‹¤'}</td><td>${gpa}</td><td>${(s.courses||[]).length} ç§‘</td></tr>`; }); };
    </script>
</body>
</html>
