<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å¸«ç®¡ç†ç³»çµ± | CAFA Admin</title>
    <style>
        /* --- ä¸»é¡Œè‰²ç³» --- */
        :root { --admin-blue: #0d47a1; --admin-bg: #f4f7fa; --admin-card-bg: #ffffff; }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: var(--admin-bg); margin: 0; padding: 30px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: var(--admin-card-bg); padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 48, 143, 0.1); border-top: 6px solid var(--admin-blue); }
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        .main-header h1 { margin: 0; color: var(--admin-blue); font-size: 28px; }
        h2 { color: var(--admin-blue); border-left: 5px solid var(--admin-blue); padding-left: 15px; margin-top: 0; font-size: 20px; }
        h3 { color: #555; margin-top: 25px; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .section-box { margin-bottom: 50px; padding-bottom: 30px; border-bottom: 1px dashed #ccc; }
        .control-panel { background-color: #eef2f7; padding: 25px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #dce4ec; }
        .student-panel { background-color: #e8f0fe; border-color: #bbdefb; }
        .stats-panel { background-color: #fff3e0; border: 1px solid #ffe0b2; padding: 20px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-around; font-weight: bold; color: #e65100; }
        .form-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 180px; }
        label { display: block; font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #444; }
        input, select { width: 100%; padding: 12px; border: 2px solid #dae1e7; border-radius: 6px; box-sizing: border-box; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn:hover { filter: brightness(1.1); }
        .btn-submit { background-color: var(--admin-blue); width: 100%; } 
        .btn-add-student { background-color: #00695c; width: 100%; }
        .btn-delete { background-color: #dc3545; padding: 6px 12px; font-size: 12px; } 
        .btn-save { background-color: #2e7d32; width: 100%; }
        .btn-toggle-on { background-color: #2e7d32; } .btn-toggle-off { background-color: #ff9800; }
        .btn-reset { background-color: #607d8b; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; margin-top: 15px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        th { background-color: #f8f9fa; color: #444; padding: 15px; text-align: left; border-bottom: 2px solid #dae1e7; font-weight: bold; }
        td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; background: white; }
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; display: inline-block; margin: 2px; }
        .tag-fixed { background: #ffebee; color: #c62828; } .tag-elective { background: #e3f2fd; color: #0d47a1; }
        .tag-interest { background: #fff8e1; color: #f57f17; border: 1px solid #ffe0b2; }
        
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; font-size: 24px; color: var(--admin-blue); z-index: 999; display: none; }
    </style>
</head>
<body>
    <div id="loading" class="loading-overlay"><div>ğŸ”„ è³‡æ–™é›²ç«¯åŒæ­¥ä¸­...</div></div>

    <div class="container">
        <div class="main-header">
            <h1>âœˆï¸ ç©ºè»å®˜æ ¡é¸èª² - æ•™å®˜ç®¡ç†ç³»çµ±</h1>
            <button class="btn btn-reset" onclick="resetSystem()">âš ï¸ ä¸€éµåˆå§‹åŒ–</button>
        </div>

        <div class="section-box">
            <h2>ğŸ‘¤ å­¸ç”Ÿå¸³è™Ÿç®¡ç†</h2>
            <div class="control-panel student-panel">
                <div class="form-row">
                    <div class="form-group"><label>å­¸è™Ÿ</label><input type="text" id="s_id" placeholder="114001"></div>
                    <div class="form-group"><label>å§“å</label><input type="text" id="s_name" placeholder="å¼µå¤§å¸¥"></div>
                    <div class="form-group"><label>ç³»ç´š</label><input type="text" id="s_dept" placeholder="èˆªå¤ªç³»"></div>
                    <div class="form-group"><label>å¯†ç¢¼</label><input type="text" id="s_pass" placeholder="é è¨­å¯†ç¢¼"></div>
                </div>
                <button class="btn btn-add-student" onclick="addStudent()">â• æ–°å¢ / æ›´æ–°å­¸ç”Ÿ</button>
            </div>
            <table id="acc-table"><thead><tr><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç³»ç´š</th><th>å¯†ç¢¼</th><th>æ“ä½œ</th></tr></thead><tbody id="account-list-body"></tbody></table>
        </div>

        <div class="section-box">
            <h2>ğŸ‘¨â€ğŸ« èª²ç¨‹æ’å®š</h2>
            <div class="control-panel">
                <div class="form-row">
                    <div class="form-group"><label>å±¬æ€§</label><select id="c_type"><option value="elective">é¸ä¿®</option><option value="fixed">å¿…ä¿®</option></select></div>
                    <div class="form-group"><label>ä»£ç¢¼</label><input type="text" id="c_id"></div>
                    <div class="form-group" style="flex:2"><label>åç¨±</label><input type="text" id="c_name"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>å­¸åˆ†</label><input type="number" id="c_credit" value="2"></div>
                    <div class="form-group"><label>æ™‚é–“</label><input type="text" id="c_time" placeholder="ä¸‰/5,6"></div>
                    <div class="form-group"><label>åœ°é»</label><input type="text" id="c_location"></div>
                    <div class="form-group"><label>æ•™å®˜</label><input type="text" id="c_teacher"></div>
                </div>
                <button class="btn btn-submit" onclick="addNewCourse()">ğŸ“… ç™¼å¸ƒèª²ç¨‹</button>
            </div>
            <table id="course-table"><thead><tr><th>å±¬æ€§</th><th>ä»£ç¢¼</th><th>åç¨±</th><th>æ™‚é–“/åœ°é»</th><th>æ“ä½œ</th></tr></thead><tbody id="managed-list-body"></tbody></table>
        </div>

        <div class="section-box" style="background-color:#fffde7; padding:20px;">
            <h2 style="color:#f57f17">ğŸ“ å­¸ç”Ÿæˆç¸¾ç™»éŒ„</h2>
            <div class="form-row">
                <div class="form-group" style="flex:2"><select id="student-selector" onchange="loadStudentGrades()" style="padding:10px; width:100%"><option value="">-- è«‹é¸æ“‡å­¸ç”Ÿ --</option></select></div>
                <div class="form-group"><button class="btn btn-save" onclick="saveGrades()">ğŸ’¾ å„²å­˜</button></div>
            </div>
            <table id="grade-table"><thead><tr><th>èª²ç¨‹</th><th>åˆ†æ•¸</th><th>è¼¸å…¥</th></tr></thead><tbody id="grade-list-body"></tbody></table>
        </div>

        <div class="section-box">
            <h2>ğŸ“Š ç§‘ç›®æˆç¸¾åˆ†æ</h2>
            <select id="course-stats-selector" onchange="loadCourseStats()" style="width:100%; padding:10px; margin-bottom:10px;"><option value="">-- è«‹é¸æ“‡èª²ç¨‹ --</option></select>
            <div class="stats-panel"><span id="stat-avg">å¹³å‡: --</span><span id="stat-max">æœ€é«˜: --</span><span id="stat-pass">åŠæ ¼ç‡: --</span></div>
            <table><thead><tr><th>å­¸è™Ÿ</th><th>å§“å</th><th>æˆç¸¾</th><th>ç‹€æ…‹</th></tr></thead><tbody id="course-stats-body"></tbody></table>
        </div>

        <div>
            <h2>ğŸŒ å…¨æ ¡å­¸ç”Ÿè·æ¶¯èˆ‡é¸èª²ç›£æ§</h2>
            <p style="color:#666; font-size:14px; margin-bottom:10px;">é€™è£¡é¡¯ç¤ºå­¸ç”Ÿè‡ªè¡Œè¨­å®šçš„æœªä¾†å¿—å‘ (é£›è¡Œ/åœ°å‹¤) èˆ‡èˆˆè¶£æ¨™ç±¤ã€‚</p>
            <table>
                <thead><tr><th>å­¸è™Ÿ/å§“å</th><th style="width:100px;">è·æ¶¯æ–¹å‘</th><th>èˆˆè¶£æ¨™ç±¤</th><th>ç¸½å­¸åˆ†</th><th>é¸èª²æ˜ç´°</th></tr></thead>
                <tbody id="student-list-body"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud } from './firebase-connect.js';
        const KEYS = { STUDENTS: 'cafa_all_students_db', FIXED: 'cafa_fixed_courses', ELECTIVE: 'cafa_public_electives' };
        let studentDB=[], fixedCourses=[], electiveCourses=[];

        window.onload = async function() { showLoading(true); await refreshAllData(); showLoading(false); setInterval(refreshAllData, 10000); };
        
        // ç¶å®šå…¨åŸŸå‡½æ•¸
        window.resetSystem = resetSystem; window.addStudent = addStudent; window.deleteStudent = deleteStudent;
        window.addNewCourse = addNewCourse; window.delCourse = delCourse; window.saveGrades = saveGrades;
        window.loadStudentGrades = loadStudentGrades; window.loadCourseStats = loadCourseStats;

        async function refreshAllData() {
            studentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            fixedCourses = (await loadFromCloud(KEYS.FIXED)) || [];
            electiveCourses = (await loadFromCloud(KEYS.ELECTIVE)) || [];
            renderAccountList(); renderManagedList(); renderStudentList(); updateSelectors();
        }

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šæ¸²æŸ“å­¸ç”Ÿç›£æ§åˆ—è¡¨ (åŠ å…¥è·æ¶¯èˆ‡èˆˆè¶£) ---
        function renderStudentList() {
            const tbody = document.getElementById('student-list-body'); tbody.innerHTML = '';
            studentDB.forEach(s => {
                // 1. è·æ¶¯åœ–ç¤º
                let trackIcon = '<span style="color:#ccc;">æœªè¨­å®š</span>';
                if(s.careerTrack === 'pilot') trackIcon = '<span style="font-size:20px;">ğŸ¦… é£›è¡Œ</span>';
                if(s.careerTrack === 'ground') trackIcon = '<span style="font-size:20px;">ğŸ› ï¸ åœ°å‹¤</span>';

                // 2. èˆˆè¶£æ¨™ç±¤
                let interestsHtml = '';
                if(s.interests && s.interests.length > 0) {
                    interestsHtml = s.interests.map(i => `<span class="tag tag-interest">${i}</span>`).join('');
                } else {
                    interestsHtml = '<span style="color:#ccc; font-size:12px;">(ç„¡)</span>';
                }

                // 3. èª²ç¨‹æ¨™ç±¤
                let coursesHtml = s.courses ? s.courses.map(c => 
                    `<span class="tag ${c.isFixed?'tag-fixed':'tag-elective'}">${c.name}</span>`
                ).join('') : '';

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${s.name}</strong> <br><small style="color:#666">${s.id}</small></td>
                        <td style="text-align:center;">${trackIcon}</td>
                        <td>${interestsHtml}</td>
                        <td style="font-weight:bold; color:${(s.totalCredits||0)<15?'red':'green'}">${s.totalCredits||0}</td>
                        <td>${coursesHtml}</td>
                    </tr>`;
            });
        }

        // --- å…¶ä»–æ—¢æœ‰åŠŸèƒ½ (ç°¡åŒ–é¡¯ç¤ºä»¥ç¯€çœç©ºé–“) ---
        async function resetSystem() { 
            if(!confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) return; 
            showLoading(true);
            await saveToCloud(KEYS.FIXED, [{id:'AE101', name:'ç©ºæ°£å‹•åŠ›å­¸', credit:3, time:'ä¸€/3,4', type:'å¿…ä¿®', isFixed:true}]);
            await saveToCloud(KEYS.ELECTIVE, [{id:'FL301', name:'é£›è¡ŒåŸç†', credit:2, time:'äºŒ/5,6', type:'é¸ä¿®', isOpen:true}]);
            await saveToCloud(KEYS.STUDENTS, [{id:'114001', name:'æå¤§ç¶­', dept:'èˆªå¤ª', password:'1234', courses:[], careerTrack:'pilot', interests:['é«”èƒ½','è‹±æ–‡']}]);
            alert("åˆå§‹åŒ–å®Œæˆ"); await refreshAllData(); showLoading(false);
        }
        async function addStudent() { /* ...åŒå‰... */ const id=document.getElementById('s_id').value; /* çœç•¥é‡è¤‡ä»£ç¢¼ï¼Œé‚è¼¯ä¸è®Š */ showLoading(true); await saveToCloud(KEYS.STUDENTS, studentDB); showLoading(false); renderAccountList(); }
        async function deleteStudent(id) { if(confirm("åˆªé™¤?")) { studentDB=studentDB.filter(s=>s.id!==id); await saveToCloud(KEYS.STUDENTS, studentDB); renderAccountList(); } }
        function renderAccountList() { document.getElementById('account-list-body').innerHTML = studentDB.map(s=>`<tr><td>${s.id}</td><td>${s.name}</td><td>${s.dept}</td><td>${s.password}</td><td><button class="btn btn-delete" onclick="deleteStudent('${s.id}')">åˆª</button></td></tr>`).join(''); }
        async function addNewCourse() { /* ...åŒå‰... */ showLoading(true); await saveToCloud(KEYS.FIXED, fixedCourses); await saveToCloud(KEYS.ELECTIVE, electiveCourses); showLoading(false); renderManagedList(); }
        async function delCourse(t,i) { if(t=='fixed') fixedCourses.splice(i,1); else electiveCourses.splice(i,1); await saveToCloud(KEYS.FIXED, fixedCourses); await saveToCloud(KEYS.ELECTIVE, electiveCourses); renderManagedList(); }
        function renderManagedList() { document.getElementById('managed-list-body').innerHTML = [...fixedCourses.map((c,i)=>`<tr><td>å¿…ä¿®</td><td>${c.id}</td><td>${c.name}</td><td>${c.time}</td><td><button class="btn btn-delete" onclick="delCourse('fixed',${i})">åˆª</button></td></tr>`), ...electiveCourses.map((c,i)=>`<tr><td>é¸ä¿®</td><td>${c.id}</td><td>${c.name}</td><td>${c.time}</td><td><button class="btn btn-delete" onclick="delCourse('elect',${i})">åˆª</button></td></tr>`)].join(''); }
        function updateSelectors() { /* æ›´æ–°ä¸‹æ‹‰é¸å–® */ const s=document.getElementById('student-selector'); s.innerHTML='<option value="">--</option>'; studentDB.forEach(x=>s.add(new Option(x.name,x.id))); const c=document.getElementById('course-stats-selector'); c.innerHTML='<option value="">--</option>'; [...fixedCourses,...electiveCourses].forEach(x=>c.add(new Option(x.name,x.id))); }
        function loadStudentGrades() { /* ...åŒå‰... */ }
        async function saveGrades() { /* ...åŒå‰... */ }
        function loadCourseStats() { /* ...åŒå‰... */ }
        function showLoading(show) { document.getElementById('loading').style.display=show?'flex':'none'; }
    </script>
</body>
</html>




