<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å¸«ç®¡ç†ç³»çµ± | CAFA Admin</title>
    <style>
        /* --- æ ¸å¿ƒä¸»é¡Œè‰²ç³» --- */
        :root {
            --admin-blue: #00308F;
            --admin-dark: #002266;
            --admin-gold: #FFD700;
            --admin-bg: #f4f7fa;
            --admin-card-bg: #ffffff;
        }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: var(--admin-bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: #333; }
        
        /* --- å´é‚Šæ¬„ --- */
        .sidebar { width: 260px; background: linear-gradient(180deg, var(--admin-blue) 0%, var(--admin-dark) 100%); color: white; display: flex; flex-direction: column; padding-top: 25px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); position: relative; z-index: 10; }
        .sidebar-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .menu-item { padding: 15px 25px; cursor: pointer; transition: 0.3s; color: rgba(255,255,255,0.8); display: flex; align-items: center; font-size: 15px; border-left: 5px solid transparent; }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { background: rgba(0,0,0,0.2); border-left-color: var(--admin-gold); color: white; font-weight: bold; }
        .menu-item span { margin-right: 12px; font-size: 20px; }
        .admin-info { margin-top: auto; padding: 20px; background: rgba(0,0,0,0.25); font-size: 13px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; }

        /* --- ä¸»å…§å®¹å€ --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background-image: linear-gradient(to bottom, #eef2f7, #f4f7fa); }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header-title { font-size: 24px; font-weight: bold; color: var(--admin-blue); border-left: 8px solid var(--admin-gold); padding-left: 15px; }

        .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-top: 4px solid var(--admin-blue); box-shadow: 0 5px 20px rgba(0,0,0,0.05); transition: 0.3s; }
        .card h3 { margin-top: 0; color: var(--admin-blue); border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 18px; }

        /* é¢æ¿èˆ‡è¡¨å–® */
        .control-panel { background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e9ecef; }
        .student-panel { background-color: #e3f2fd; border-color: #bbdefb; }
        .batch-panel { background-color: #e0f2f1; border-color: #b2dfdb; }
        .stats-panel { background-color: #fff8e1; border: 1px solid #ffe0b2; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-around; font-weight: bold; color: #e65100; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 150px; }
        label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select { width: 100%; padding: 10px; border: 2px solid #dae1e7; border-radius: 6px; transition: 0.3s; box-sizing: border-box; }

        /* æŒ‰éˆ• */
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; color: white; display: inline-flex; align-items: center; justify-content: center; width: 100%; }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-submit { background-color: var(--admin-blue); padding: 12px; } 
        .btn-add { background-color: #00695c; padding: 12px; }
        .btn-batch { background-color: #00796b; font-size: 15px; padding: 12px; }
        .btn-del { background-color: #dc3545; width: auto; padding: 5px 12px; font-size: 12px; } 
        .btn-save { background-color: #2e7d32; padding: 12px; }
        .btn-toggle { width: auto; font-size: 12px; padding: 5px 10px; } .btn-toggle-on { background-color: #2e7d32; } .btn-toggle-off { background-color: #ff9800; }
        .btn-reset { background-color: #546e7a; margin-top: 10px; }
        .btn-print { background: #607d8b; width: auto; margin-left: 10px; }

        /* è¡¨æ ¼èˆ‡æ¨™ç±¤ */
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; margin-top: 10px; }
        th { background-color: #f1f3f5; color: #495057; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: bold; }
        td { padding: 12px; border-bottom: 1px solid #eee; background: white; vertical-align: middle; }
        .tag { padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; display: inline-block; margin: 2px; }
        .tag-class { background: #673ab7; color: white; border-radius: 12px; }
        .tag-fixed { background: #ffebee; color: #c62828; } .tag-elective { background: #e3f2fd; color: #0d47a1; }
        .tag-interest { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }
        .score-input { width: 60px; text-align: center; border: 2px solid #ccc; padding: 5px; border-radius: 4px; }
        .score-fail { color: red; font-weight: bold; }

        /* --- èª²è¡¨æ¨£å¼ (Grid) --- */
        .schedule-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .schedule-table th { text-align: center; background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); padding: 10px; }
        .schedule-table td { height: 60px; border: 1px solid rgba(0,0,0,0.1); padding: 5px; vertical-align: top; text-align: center; }
        .course-block { padding: 5px; border-radius: 4px; color: white; font-size: 12px; margin-bottom: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .block-fixed { background: linear-gradient(135deg, #e65100, #ff9800); }
        .block-normal { background: linear-gradient(135deg, var(--admin-blue), #4a7bd1); }

        /* èƒŒæ™¯ä¸»é¡ŒæŒ‰éˆ• */
        .theme-controls { display: flex; gap: 10px; align-items: center; margin-right: auto; }
        .theme-btn { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #ddd; transition: 0.2s; }
        .theme-btn:hover { transform: scale(1.2); }
        .tb-white { background: white; } .tb-blue { background: #e3f2fd; } .tb-warm { background: #fff8e1; } .tb-dark { background: #333; }

        /* ä¸»é¡Œæ¨£å¼ */
        .card-theme-blue { background: linear-gradient(to bottom right, #f0f7ff, #dbeafe) !important; border-color: #1e88e5 !important; position: relative; }
        .card-theme-blue::before { content: 'âœˆ'; position: absolute; font-size: 200px; color: rgba(0,0,0,0.03); top: 50px; left: 100px; pointer-events: none; transform: rotate(-15deg); }
        .card-theme-warm { background: #fffdeb !important; border-color: #fdd835 !important; }
        .card-theme-dark { background: #2c3e50 !important; color: #ecf0f1 !important; border-color: #34495e !important; }
        .card-theme-dark th { background: #34495e !important; color: white !important; border-color: #465c71 !important; }
        .card-theme-dark td { border-color: #465c71 !important; }

        /* åˆ—å°æ¨£å¼ */
        @media print {
            @page { size: landscape; margin: 1cm; }
            .sidebar, .header-bar, .theme-controls, .btn { display: none !important; }
            .main-content { padding: 0; margin: 0; background: white; }
            body { background: white; height: auto; overflow: visible; }
            .card { box-shadow: none; border: 1px solid #ccc; margin: 0; padding: 10px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            /* å¼·åˆ¶ä¿®æ­£æš—é»‘æ¨¡å¼åˆ—å° */
            .card-theme-dark { background: white !important; color: black !important; border-color: #ccc !important; }
            .card-theme-dark th { background: #f8f9fa !important; color: black !important; }
        }

        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 18px; color: var(--admin-blue); z-index: 999; }
    </style>
</head>
<body>
    <div id="loading">
        <div style="font-size:40px; margin-bottom:10px;">â˜ï¸</div>
        <div>è³‡æ–™åŒæ­¥ä¸­...</div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>âœˆï¸ ç®¡ç†ç³»çµ±</h2>
            <div style="font-size:12px; opacity:0.7; margin-top:5px;">ç©ºè»å®˜æ ¡èª²å‹™çµ„</div>
        </div>
        
        <div class="menu-item active" onclick="switchTab('monitor')"><span>ğŸŒ</span> å…¨æ ¡ç›£æ§</div>
        <div class="menu-item" onclick="switchTab('schedule')"><span>ğŸ“…</span> æ•™å¸«èª²è¡¨</div> <div class="menu-item" onclick="switchTab('students')"><span>ğŸ‘¥</span> å­¸ç”Ÿèˆ‡ç­ç´š</div>
        <div class="menu-item" onclick="switchTab('courses')"><span>ğŸ‘¨â€ğŸ«</span> èª²ç¨‹ç®¡ç†</div>
        <div class="menu-item" onclick="switchTab('grades')"><span>ğŸ“</span> æˆç¸¾èˆ‡åˆ†æ</div>
        
        <div class="admin-info">
            <div>èº«åˆ†ï¼šæ•™å®˜/ç®¡ç†è€…</div>
            <button class="btn btn-reset" onclick="resetSystem()">âš ï¸ åˆå§‹åŒ–ç³»çµ±</button>
        </div>
    </div>

    <div class="main-content">
        
        <div id="monitor-view">
            <div class="header-bar"><div class="header-title">å…¨æ ¡å­¸ç”Ÿé¸èª²èˆ‡è·æ¶¯ç›£æ§</div></div>
            <div class="card">
                <h3>å­¸ç”Ÿç‹€æ…‹ç¸½è¦½</h3>
                <table><thead><tr><th style="width:180px;">å­¸è™Ÿ / å§“å</th><th>ç­ç´š</th><th style="width:100px;">è·æ¶¯</th><th>èˆˆè¶£</th><th style="width:60px;">å­¸åˆ†</th><th>é¸èª²æ˜ç´°</th></tr></thead><tbody id="student-list-body"></tbody></table>
            </div>
        </div>

        <div id="schedule-view" style="display: none;">
            <div class="header-bar">
                <div class="header-title">æ•™å¸«èª²è¡¨æŸ¥è©¢</div>
                <div class="theme-controls">
                    <span style="font-size:12px; color:#666; margin-left:20px;">èƒŒæ™¯:</span>
                    <div class="theme-btn tb-white" onclick="setTheme('white')"></div>
                    <div class="theme-btn tb-blue" onclick="setTheme('blue')"></div>
                    <div class="theme-btn tb-warm" onclick="setTheme('warm')"></div>
                    <div class="theme-btn tb-dark" onclick="setTheme('dark')"></div>
                </div>
                <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
            </div>
            
            <div class="card" id="teacher-schedule-card">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px;">
                    <h3>æŸ¥è©¢å°è±¡</h3>
                    <select id="teacher-schedule-selector" onchange="renderTeacherSchedule()" style="width:250px;">
                        <option value="">-- è«‹é¸æ“‡æ•™å®˜/æ•™æˆ --</option>
                    </select>
                </div>
                
                <h4 style="text-align:center; margin-bottom:10px;" id="schedule-title">è«‹å…ˆé¸æ“‡ä¸€ä½æ•™å®˜</h4>
                <table class="schedule-table">
                    <thead><tr><th style="width:60px;">ç¯€æ¬¡</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr></thead>
                    <tbody id="teacher-schedule-body"></tbody>
                </table>
            </div>
        </div>

        <div id="students-view" style="display: none;">
            <div class="header-bar"><div class="header-title">å­¸ç”Ÿå¸³è™Ÿèˆ‡ç­ç´šç®¡ç†</div></div>
            <div class="card">
                <h3>1. å­¸ç”Ÿå¸³è™Ÿç¶­è­·</h3>
                <div class="control-panel student-panel">
                    <div class="form-row">
                        <div class="form-group"><label>å­¸è™Ÿ</label><input type="text" id="s_id" placeholder="114001"></div>
                        <div class="form-group"><label>å§“å</label><input type="text" id="s_name" placeholder="å¼µå¤§å¸¥"></div>
                        <div class="form-group"><label>ç­ç´š</label><input type="text" id="s_class" placeholder="114-èˆªå¤ª"></div>
                        <div class="form-group"><label>å¯†ç¢¼</label><input type="text" id="s_pass" placeholder="1234"></div>
                    </div>
                    <button class="btn btn-add" onclick="addStudent()">â• æ–°å¢ / æ›´æ–°è³‡æ–™</button>
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table id="acc-table"><thead><tr><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç­ç´š</th><th>å¯†ç¢¼</th><th>æ“ä½œ</th></tr></thead><tbody id="account-list-body"></tbody></table>
                </div>
            </div>
            <div class="card">
                <h3>2. ç­ç´šæ‰¹æ¬¡æ’èª² (å›ºå®šèª²ç¨‹çŒæª”)</h3>
                <div class="control-panel batch-panel">
                    <div class="form-row">
                        <div class="form-group"><label>ç›®æ¨™ç­ç´š</label><select id="batch-class-selector"><option value="">-- è«‹é¸æ“‡ --</option></select></div>
                        <div class="form-group" style="flex:2"><label>çŒå…¥èª²ç¨‹</label><select id="batch-course-selector"><option value="">-- è«‹é¸æ“‡ --</option></select></div>
                    </div>
                    <button class="btn btn-batch" onclick="batchAssignCourse()">ğŸš€ åŸ·è¡Œæ‰¹æ¬¡çŒæª”</button>
                </div>
            </div>
        </div>

        <div id="courses-view" style="display: none;">
            <div class="header-bar"><div class="header-title">èª²ç¨‹æ’å®šèˆ‡ç™¼å¸ƒ</div></div>
            <div class="card">
                <h3>ç™¼å¸ƒæ–°èª²ç¨‹</h3>
                <div class="control-panel">
                    <div class="form-row">
                        <div class="form-group"><label>å±¬æ€§</label><select id="c_type"><option value="fixed">ğŸ”’ å¿…ä¿®</option><option value="elective">ğŸ“– é¸ä¿®</option></select></div>
                        <div class="form-group"><label>ä»£ç¢¼</label><input type="text" id="c_id"></div>
                        <div class="form-group" style="flex:2"><label>åç¨±</label><input type="text" id="c_name"></div>
                        <div class="form-group"><label>æ™‚é–“</label><input type="text" id="c_time" placeholder="ä¸‰/5,6"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>å­¸åˆ†</label><input type="number" id="c_credit" value="2"></div>
                        <div class="form-group"><label>åœ°é»</label><input type="text" id="c_location"></div>
                        <div class="form-group"><label>æ•™å®˜</label><input type="text" id="c_teacher"></div>
                        <div class="form-group"></div>
                    </div>
                    <button class="btn btn-submit" onclick="addNewCourse()">ğŸ“… ç™¼å¸ƒèª²ç¨‹</button>
                </div>
                <h3>å·²ç™¼å¸ƒèª²ç¨‹åˆ—è¡¨</h3>
                <table id="course-table"><thead><tr><th>å±¬æ€§</th><th>ä»£ç¢¼</th><th>åç¨±</th><th>æ™‚é–“ / åœ°é»</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody id="managed-list-body"></tbody></table>
            </div>
        </div>

        <div id="grades-view" style="display: none;">
            <div class="header-bar"><div class="header-title">æˆç¸¾ç®¡ç†èˆ‡æ•¸æ“šåˆ†æ</div></div>
            <div class="card">
                <h3>ğŸ“ å­¸ç”Ÿæˆç¸¾ç™»éŒ„</h3>
                <div class="form-row" style="align-items: flex-end;">
                    <div class="form-group" style="flex: 2;"><label>é¸æ“‡å­¸ç”Ÿ</label><select id="student-selector" onchange="loadStudentGrades()"><option value="">-- è®€å–ä¸­ --</option></select></div>
                    <div class="form-group"><button class="btn btn-save" onclick="saveGrades()">ğŸ’¾ å„²å­˜</button></div>
                </div>
                <table id="grade-table"><thead><tr><th>èª²ç¨‹</th><th>å­¸åˆ†</th><th>åˆ†æ•¸</th><th>è¼¸å…¥</th></tr></thead><tbody id="grade-list-body"><tr><td colspan="4" align="center">è«‹å…ˆé¸æ“‡å­¸ç”Ÿ</td></tr></tbody></table>
            </div>
            <div class="card">
                <h3>ğŸ“Š ç§‘ç›®æˆç¸¾åˆ†æ</h3>
                <div class="form-row"><div class="form-group"><select id="course-stats-selector" onchange="loadCourseStats()"><option value="">-- è«‹é¸æ“‡èª²ç¨‹ --</option></select></div></div>
                <div class="stats-panel"><span id="stat-avg">å¹³å‡: --</span><span id="stat-max">æœ€é«˜: --</span><span id="stat-pass">åŠæ ¼ç‡: --</span></div>
                <table><thead><tr><th>å­¸è™Ÿ</th><th>å§“å</th><th>æˆç¸¾</th><th>ç‹€æ…‹</th></tr></thead><tbody id="course-stats-body"></tbody></table>
            </div>
        </div>

    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud } from './firebase-connect.js';
        const KEYS = { STUDENTS: 'cafa_all_students_db', FIXED: 'cafa_fixed_courses', ELECTIVE: 'cafa_public_electives' };
        let studentDB=[], fixedCourses=[], electiveCourses=[];

        window.onload = async function() { showLoading(true); await refreshAllData(); showLoading(false); setInterval(refreshAllData, 10000); };
        
        window.switchTab = function(tabId) {
            ['monitor','schedule','students','courses','grades'].forEach(id => document.getElementById(id+'-view').style.display='none');
            document.getElementById(tabId+'-view').style.display='block';
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            const map={'monitor':0, 'schedule':1, 'students':2, 'courses':3, 'grades':4};
            document.querySelectorAll('.menu-item')[map[tabId]].classList.add('active');
        }

        window.setTheme = function(theme) {
            const card = document.getElementById('teacher-schedule-card');
            card.className = 'card';
            if(theme !== 'white') card.classList.add(`card-theme-${theme}`);
        }

        window.resetSystem = resetSystem; window.addStudent = addStudent; window.deleteStudent = deleteStudent; 
        window.batchAssignCourse = batchAssignCourse; window.addNewCourse = addNewCourse; window.delCourse = delCourse; 
        window.toggleStatus = toggleStatus; window.loadStudentGrades = loadStudentGrades; window.saveGrades = saveGrades; 
        window.loadCourseStats = loadCourseStats; window.renderTeacherSchedule = renderTeacherSchedule;

        async function refreshAllData() {
            studentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            fixedCourses = (await loadFromCloud(KEYS.FIXED)) || [];
            electiveCourses = (await loadFromCloud(KEYS.ELECTIVE)) || [];
            
            renderStudentList();
            renderAccountList();
            renderManagedList();
            updateSelectors();
            
            // å¦‚æœç›®å‰åœåœ¨èª²è¡¨é é¢ï¼Œåˆ·æ–°ä¸€ä¸‹æ•™å®˜æ¸…å–®
            if(document.getElementById('schedule-view').style.display === 'block') updateSelectors();
        }

        // --- æ•™å¸«èª²è¡¨ (æ ¸å¿ƒæ–°åŠŸèƒ½) ---
        function renderTeacherSchedule() {
            const teacher = document.getElementById('teacher-schedule-selector').value;
            const title = document.getElementById('schedule-title');
            const tbody = document.getElementById('teacher-schedule-body');
            tbody.innerHTML = '';

            // ç¹ªè£½ç©ºèª²è¡¨
            const times = ["08:10", "09:10", "10:10", "11:10", "13:30", "14:30", "15:30", "16:30", "17:30", "19:00"];
            for(let i=1;i<=10;i++) tbody.innerHTML+=`<tr><td style="background:#f8f9fa;">${i}</td><td id="t1-${i}"></td><td id="t2-${i}"></td><td id="t3-${i}"></td><td id="t4-${i}"></td><td id="t5-${i}"></td></tr>`;

            if(!teacher) { title.innerText = "è«‹å…ˆé¸æ“‡ä¸€ä½æ•™å®˜"; return; }
            title.innerText = `ã€${teacher}ã€‘æ•™å®˜æˆèª²è¡¨`;

            // æ‰¾å‡ºè©²æ•™å®˜çš„æ‰€æœ‰èª²ç¨‹
            const allC = [...fixedCourses, ...electiveCourses];
            const myC = allC.filter(c => c.teacher === teacher);

            const dMap={"ä¸€":1,"äºŒ":2,"ä¸‰":3,"å››":4,"äº”":5};
            myC.forEach(c => {
                if(!c.time) return;
                let [d,p] = c.time.split('/'); let dy = dMap[d];
                p.split(',').forEach(x => {
                    let el = document.getElementById(`t${dy}-${x}`);
                    if(el) el.innerHTML = `<div class="course-block ${c.isFixed?'block-fixed':'block-normal'}">${c.name}<br>${c.location||''}</div>`;
                });
            });
        }

        // --- å…¨æ ¡ç›£æ§ ---
        function renderStudentList() {
            const t = document.getElementById('student-list-body'); t.innerHTML='';
            studentDB.forEach(s => {
                let track = s.careerTrack === 'pilot' ? '<span style="color:#00308F;font-weight:bold">ğŸ¦… é£›è¡Œ</span>' : 
                            s.careerTrack === 'ground' ? '<span style="color:#e65100;font-weight:bold">ğŸ› ï¸ åœ°å‹¤</span>' : '<span style="color:#ccc">æœªå®š</span>';
                let ints = (s.interests||[]).map(i=>`<span class="tag tag-interest">${i}</span>`).join('');
                let courses = (s.courses||[]).map(c=>`<span class="tag ${c.isFixed?'tag-fixed':'tag-elective'}">${c.name}</span>`).join('');
                t.innerHTML += `<tr><td>${s.name}<br><small>${s.id}</small></td><td><span class="tag tag-class">${s.classId||'-'}</span></td><td>${track}</td><td>${ints}</td><td style="font-weight:bold">${s.totalCredits||0}</td><td>${courses}</td></tr>`;
            });
        }

        // --- å­¸ç”Ÿèˆ‡ç­ç´š ---
        async function addStudent() {
            const id=document.getElementById('s_id').value.trim(); const name=document.getElementById('s_name').value.trim();
            const cls=document.getElementById('s_class').value.trim(); const pass=document.getElementById('s_pass').value.trim();
            if(!id||!name||!cls||!pass) return alert("è³‡æ–™ä¸å…¨");
            const idx = studentDB.findIndex(s=>s.id===id);
            const obj = { id, name, classId:cls, password:pass, dept:cls.split('-')[1]||cls, courses:[], totalCredits:0, careerTrack:'', interests:[] };
            if(idx>-1) { obj.courses=studentDB[idx].courses; obj.careerTrack=studentDB[idx].careerTrack; obj.interests=studentDB[idx].interests; studentDB[idx]=obj; } 
            else { studentDB.push(obj); }
            showLoading(true); await saveToCloud(KEYS.STUDENTS, studentDB); showLoading(false); renderAccountList();
        }
        async function deleteStudent(id){ if(confirm("åˆªé™¤?")){studentDB=studentDB.filter(s=>s.id!==id); await saveToCloud(KEYS.STUDENTS,studentDB); renderAccountList();} }
        function renderAccountList(){ document.getElementById('account-list-body').innerHTML = studentDB.map(s=>`<tr><td>${s.id}</td><td>${s.name}</td><td>${s.classId||''}</td><td>${s.password}</td><td><button class="btn btn-del" onclick="deleteStudent('${s.id}')">åˆª</button></td></tr>`).join(''); }
        
        async function batchAssignCourse() {
            const cls=document.getElementById('batch-class-selector').value; const cid=document.getElementById('batch-course-selector').value;
            if(!cls||!cid) return alert("è«‹é¸æ“‡");
            const c=[...fixedCourses,...electiveCourses].find(x=>x.id===cid);
            if(!confirm(`å°‡ã€${c.name}ã€‘åŠ å…¥ã€${cls}ã€‘å…¨ç­?`)) return;
            showLoading(true); let cnt=0;
            studentDB.forEach(s=>{ if(s.classId===cls && !s.courses.some(x=>x.id===cid)){ s.courses.push(c); s.totalCredits=(s.totalCredits||0)+c.credit; cnt++; }});
            await saveToCloud(KEYS.STUDENTS, studentDB); alert(`æ›´æ–° ${cnt} äºº`); showLoading(false); refreshAllData();
        }

        // --- èª²ç¨‹ç®¡ç† ---
        async function addNewCourse() {
            const t=document.getElementById('c_type').value; const id=document.getElementById('c_id').value; const n=document.getElementById('c_name').value;
            const cr=parseInt(document.getElementById('c_credit').value); const ti=document.getElementById('c_time').value; const loc=document.getElementById('c_location').value; const te=document.getElementById('c_teacher').value;
            if(!id||!n) return alert("ç¼ºè³‡æ–™");
            const nc={id, name:n, credit:cr, time:ti, location:loc, teacher:te, type:t==='fixed'?'å¿…ä¿®':'é¸ä¿®', isFixed:t==='fixed', isOpen:true, capacity:50, enrolled:0};
            if(t==='fixed') fixedCourses.push(nc); else electiveCourses.push(nc);
            showLoading(true); await saveToCloud(KEYS.FIXED, fixedCourses); await saveToCloud(KEYS.ELECTIVE, electiveCourses); showLoading(false); renderManagedList();
        }
        async function delCourse(t,i) { if(confirm("åˆª?")) { if(t==='fixed')fixedCourses.splice(i,1);else electiveCourses.splice(i,1); await saveToCloud(KEYS.FIXED,fixedCourses); await saveToCloud(KEYS.ELECTIVE,electiveCourses); renderManagedList(); } }
        async function toggleStatus(i) { electiveCourses[i].isOpen=!electiveCourses[i].isOpen; await saveToCloud(KEYS.ELECTIVE,electiveCourses); renderManagedList(); }
        function renderManagedList() {
            const t = document.getElementById('managed-list-body'); t.innerHTML='';
            fixedCourses.forEach((c,i)=>t.innerHTML+=`<tr><td><span class="tag tag-fixed">å¿…ä¿®</span></td><td>${c.id}</td><td>${c.name}</td><td>${c.time}/${c.location}</td><td>å¼·åˆ¶</td><td><button class="btn btn-del" onclick="delCourse('fixed',${i})">åˆª</button></td></tr>`);
            electiveCourses.forEach((c,i)=>t.innerHTML+=`<tr><td><span class="tag tag-elective">é¸ä¿®</span></td><td>${c.id}</td><td>${c.name}</td><td>${c.time}/${c.location}</td><td><button class="btn btn-toggle ${c.isOpen?'btn-toggle-on':'btn-toggle-off'}" onclick="toggleStatus(${i})">${c.isOpen?'é–‹å•Ÿ':'é—œé–‰'}</button></td><td><button class="btn btn-del" onclick="delCourse('elect',${i})">åˆª</button></td></tr>`);
        }

        // --- é¸å–®æ›´æ–° (å«æ•™å®˜åå–®) ---
        function updateSelectors() {
            const cs = document.getElementById('batch-class-selector'); const css = document.getElementById('batch-course-selector');
            const ss = document.getElementById('student-selector'); const cstats = document.getElementById('course-stats-selector');
            const ts = document.getElementById('teacher-schedule-selector');
            
            // ç­ç´š
            const classes = [...new Set(studentDB.map(s=>s.classId).filter(x=>x))].sort();
            const savedCls = cs.value; cs.innerHTML='<option value="">-- è«‹é¸æ“‡ --</option>'; classes.forEach(c=>cs.add(new Option(c,c))); cs.value=savedCls;
            
            // èª²ç¨‹
            const allC = [...fixedCourses, ...electiveCourses];
            const savedC = css.value; css.innerHTML='<option value="">-- è«‹é¸æ“‡ --</option>'; allC.forEach(c=>css.add(new Option(c.name,c.id))); css.value=savedC;
            const savedS = cstats.value; cstats.innerHTML='<option value="">-- è«‹é¸æ“‡ --</option>'; allC.forEach(c=>cstats.add(new Option(c.name,c.id))); cstats.value=savedS;

            // å­¸ç”Ÿ
            const savedSt = ss.value; ss.innerHTML='<option value="">-- è«‹é¸æ“‡ --</option>'; studentDB.forEach(s=>ss.add(new Option(`${s.name} (${s.id})`, s.id))); ss.value=savedSt;

            // æ•™å®˜ (è‡ªå‹•æŠ“å–ä¸é‡è¤‡åå–®)
            const teachers = [...new Set(allC.map(c=>c.teacher).filter(x=>x))].sort();
            const savedT = ts.value; ts.innerHTML='<option value="">-- è«‹é¸æ“‡æ•™å®˜ --</option>'; teachers.forEach(t=>ts.add(new Option(t,t))); ts.value=savedT;
        }

        // --- æˆç¸¾èˆ‡åˆ†æ (åŒå‰) ---
        function loadStudentGrades() { /* é‚è¼¯åŒå‰ï¼Œçœç•¥é‡è¤‡ä»£ç¢¼ */ const sid=document.getElementById('student-selector').value; const t=document.getElementById('grade-list-body'); t.innerHTML=''; if(!sid)return; const s=studentDB.find(x=>x.id===sid); if(!s)return; s.courses.forEach(c=>{ let sc=(c.score!==undefined&&c.score!==null)?c.score:''; t.innerHTML+=`<tr><td>${c.name}</td><td>${c.credit}</td><td style="color:blue;font-weight:bold">${sc}</td><td><input type="number" id="score-${c.id}" value="${sc}" class="score-input"></td></tr>`; }); }
        async function saveGrades() { const sid=document.getElementById('student-selector').value; if(!sid)return; const idx=studentDB.findIndex(x=>x.id===sid); studentDB[idx].courses=studentDB[idx].courses.map(c=>{const v=document.getElementById(`score-${c.id}`).value; if(v!=='')c.score=parseInt(v); return c;}); await saveToCloud(KEYS.STUDENTS,studentDB); alert("å„²å­˜æˆåŠŸ"); loadStudentGrades(); }
        function loadCourseStats() { /* é‚è¼¯åŒå‰ï¼Œçœç•¥é‡è¤‡ä»£ç¢¼ */ const cid=document.getElementById('course-stats-selector').value; const t=document.getElementById('course-stats-body'); t.innerHTML=''; if(!cid)return; let recs=[]; studentDB.forEach(s=>{const c=s.courses.find(x=>x.id===cid); if(c)recs.push({id:s.id,name:s.name,score:c.score});}); if(!recs.length)return t.innerHTML='<tr><td colspan=4 align="center">ç„¡äººä¿®ç¿’</td></tr>'; let scs=recs.filter(r=>r.score).map(r=>parseInt(r.score)); if(scs.length){ document.getElementById('stat-avg').innerText=(scs.reduce((a,b)=>a+b,0)/scs.length).toFixed(1); document.getElementById('stat-max').innerText=Math.max(...scs); document.getElementById('stat-pass').innerText=Math.round((scs.filter(x=>x>=60).length/scs.length)*100)+'%'; } recs.forEach(r=>{ let sc=(r.score)?r.score:'-'; t.innerHTML+=`<tr><td>${r.id}</td><td>${r.name}</td><td>${sc}</td><td>${sc==='-'?'æœªè¼¸å…¥':(sc>=60?'åŠæ ¼':'ä¸åŠæ ¼')}</td></tr>`; }); }

        async function resetSystem() {
            if(!confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) return; showLoading(true);
            const defS = [{id:'11401',name:'æå¤§ç¶­',classId:'114-èˆªå¤ª',dept:'èˆªå¤ª',password:'1234',courses:[],careerTrack:'pilot',interests:['é«”èƒ½']}, {id:'11402',name:'ç‹å°ç¾',classId:'114-èˆªç®¡',dept:'èˆªç®¡',password:'1234',courses:[],careerTrack:'ground',interests:['è³‡é›»']}];
            const defF = [{id:'AE101',name:'ç©ºæ°£å‹•åŠ›å­¸',credit:3,time:'ä¸€/3,4',location:'ç†å·¥ä¸€',teacher:'é™³å¿—è±ª',type:'å¿…ä¿®',isFixed:true}];
            await saveToCloud(KEYS.STUDENTS,defS); await saveToCloud(KEYS.FIXED,defF); await saveToCloud(KEYS.ELECTIVE,[]);
            alert("åˆå§‹åŒ–å®Œæˆ"); refreshAllData(); showLoading(false);
        }
        function showLoading(s){document.getElementById('loading').style.display=s?'flex':'none';}
    </script>
</body>
</html>





