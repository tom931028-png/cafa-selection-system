{
type: uploaded file
fileName: tom931028-png/cafa-selection-system/cafa-selection-system-9f34500d989dd6b095655e50e619bf6828083fa3/dashboard.html
fullContent:
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¸èª²ä¸»ç³»çµ± | CAFA Student</title>
    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸ --- */
        :root { --cafa-blue-dark: #002266; --cafa-blue-main: #00308F; --cafa-blue-light: #4a7bd1; --cafa-gold: #FFD700; --bg-grey: #f0f2f5; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; margin: 0; background-color: var(--bg-grey); color: #333; display: flex; height: 100vh; overflow: hidden; }
        
        /* --- æ‰‹æ©Ÿç‰ˆæ¼¢å ¡é¸å–® --- */
        .mobile-menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 1100; background: var(--cafa-blue-main); color: white; border: none; padding: 10px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; font-size: 20px; }
        
        /* --- å´é‚Šæ¬„ --- */
        .sidebar { width: 260px; background: linear-gradient(180deg, var(--cafa-blue-main) 0%, var(--cafa-blue-dark) 100%); color: white; display: flex; flex-direction: column; padding-top: 25px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); position: relative; z-index: 1000; transition: transform 0.3s ease; }
        .sidebar-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .menu-item { padding: 15px 25px; cursor: pointer; transition: 0.2s; color: rgba(255,255,255,0.8); display: flex; align-items: center; font-size: 15px; }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { background: rgba(0,0,0,0.2); border-left: 5px solid var(--cafa-gold); color: white; font-weight: bold; }
        .menu-item span { margin-right: 12px; font-size: 18px; width: 25px; text-align: center; }
        
        /* --- æ’ä½å¡ --- */
        .rank-card { background: rgba(0,0,0,0.2); margin: 10px 15px; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .rank-name { font-size: 20px; font-weight: 800; color: var(--cafa-gold); text-shadow: 0 2px 4px rgba(0,0,0,0.3); margin: 5px 0; letter-spacing: 1px; }
        
        /* --- ä¸»å…§å®¹å€ --- */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; background-image: linear-gradient(to bottom, #eef2f7, #f4f7fa); position: relative; width: 100%; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); flex-wrap: wrap; gap: 10px; }
        .header-title { font-size: 22px; font-weight: bold; color: var(--cafa-blue-main); border-left: 6px solid var(--cafa-gold); padding-left: 12px; }
        
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-top: 3px solid var(--cafa-blue-light); box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow-x: auto; position: relative; transition: all 0.3s ease; }
        
        /* --- èˆˆè¶£æ¨™ç±¤èˆ‡è¼¸å…¥æ¡† --- */
        .interest-section { margin-bottom: 15px; }
        .interest-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .interest-tag { padding: 6px 14px; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; transition: 0.2s; background: white; font-size: 13px; color: #666; user-select: none; display: flex; align-items: center; }
        .interest-tag:hover { background: #f0f0f0; }
        .interest-tag.active { background: var(--cafa-gold); color: #002266; border-color: var(--cafa-gold); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tag-remove { margin-left: 5px; font-size: 14px; opacity: 0.6; padding: 0 4px; border-radius: 50%; }
        .tag-remove:hover { background: rgba(0,0,0,0.1); opacity: 1; }
        .custom-input-group { display: flex; gap: 8px; max-width: 400px; margin-top: 10px; }
        .custom-input-group input { flex: 1; padding: 8px 15px; border: 1px solid #ccc; border-radius: 20px; outline: none; font-size: 14px; }
        .btn-small-add { background: var(--cafa-blue-main); color: white; border: none; border-radius: 20px; padding: 0 15px; cursor: pointer; font-weight: bold; }

        /* --- è¡¨æ ¼èˆ‡å…ƒä»¶ --- */
        table { width: 100%; min-width: 600px; border-collapse: separate; border-spacing: 0; font-size: 14px; }
        th { background: #f8f9fa; color: var(--cafa-blue-dark); padding: 12px; text-align: left; border-bottom: 2px solid var(--cafa-blue-main); white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; white-space: nowrap; }
        .tag-compulsory { background: #e3f2fd; color: #0d47a1; } .tag-elective { background: #e8f5e9; color: #1b5e20; } .tag-fixed { background: #fff3e0; color: #e65100; }
        .btn { padding: 8px 16px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 14px; white-space: nowrap; }
        .btn-add { background: #28a745; color: white; } .btn-drop { background: #dc3545; color: white; }
        .btn-save { background: var(--cafa-blue-main); color: white; width: 100%; padding: 14px; margin-top:20px; font-size: 16px; box-shadow: 0 4px 10px rgba(0,48,143,0.3); }
        .btn-print { background: #607d8b; color: white; display: flex; align-items: center; gap: 5px; }

        /* --- è¦–è¦ºåŒ–èª²è¡¨ & ä¸»é¡Œæ¨£å¼ (Theme Styles) --- */
        .schedule-container { overflow-x: auto; margin: 0 -20px; padding: 0 20px; }
        .schedule-table { min-width: 700px; table-layout: fixed; border-collapse: separate; border-spacing: 0; border: 1px solid #eee; }
        .schedule-table th, .schedule-table td { text-align: center; border-right: 1px solid #eee; border-bottom: 1px solid #eee; }
        .schedule-table td { height: 75px; padding: 2px; vertical-align: middle; }
        .schedule-table th:first-child, .schedule-table td:first-child { position: sticky; left: 0; background-color: #f8f9fa; z-index: 5; box-shadow: 2px 0 5px rgba(0,0,0,0.05); width: 50px; font-weight: bold; color: #666; border-right: 2px solid #ddd; }
        .schedule-table th { z-index: 6; }
        .course-block { width: 100%; height: 100%; padding: 4px; border-radius: 6px; color: white; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.15); display: flex; flex-direction: column; justify-content: center; align-items: center; line-height: 1.3; }
        .block-fixed { background: linear-gradient(135deg, #e65100, #fb8c00); }
        .block-elective { background: linear-gradient(135deg, #00308F, #1976d2); }

        /* ä¸»é¡ŒæŒ‰éˆ•èˆ‡å®šç¾© */
        .theme-controls { display: flex; align-items: center; gap: 8px; }
        .theme-btn { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid #ddd; transition: 0.2s; position: relative; }
        .theme-btn:hover { transform: scale(1.1); }
        .tb-white { background: white; }
        .tb-blue { background: #e3f2fd; }
        .tb-dark { background: #333; }
        .tb-warm { background: #fff8e1; }

        /* 1. ç©ºè»è—ä¸»é¡Œ (å«æµ®æ°´å°) */
        .card-theme-blue { background: linear-gradient(to bottom right, #f0f7ff, #dbeafe) !important; border-color: #1e88e5 !important; }
        .card-theme-blue::before { content: 'âœˆ'; position: absolute; font-size: 150px; color: rgba(0,0,0,0.03); bottom: 20px; right: 20px; pointer-events: none; transform: rotate(-15deg); z-index: 0; }
        
        /* 2. æ¥µç°¡é»‘ä¸»é¡Œ */
        .card-theme-dark { background: #2c3e50 !important; color: #ecf0f1 !important; border-color: #34495e !important; }
        .card-theme-dark th { background: #34495e !important; color: white !important; border-color: #465c71 !important; }
        .card-theme-dark td { border-color: #465c71 !important; }
        .card-theme-dark .schedule-table th:first-child, .card-theme-dark .schedule-table td:first-child { background-color: #34495e !important; color: #ecf0f1; border-color: #465c71; }
        
        /* 3. æš–é™½é»ƒä¸»é¡Œ */
        .card-theme-warm { background: #fffdeb !important; border-color: #fdd835 !important; }

        /* --- AI Chat --- */
        .ai-fab { position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px; background: linear-gradient(45deg, #00308F, #0055ff); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 28px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 2000; transition: transform 0.2s; }
        .chat-window { position: fixed; bottom: 85px; right: 20px; width: 90%; max-width: 350px; height: 50vh; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); display: none; flex-direction: column; z-index: 2000; border: 1px solid rgba(0,0,0,0.05); overflow: hidden; }
        .chat-header { padding: 15px; background: var(--cafa-blue-main); color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; font-size: 14px; }
        .chat-msg { margin-bottom: 10px; max-width: 80%; padding: 8px 12px; border-radius: 12px; line-height: 1.4; word-wrap: break-word; }
        .msg-user { background: #e3f2fd; color: #00308F; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
        .msg-ai { background: white; color: #333; border: 1px solid #eee; align-self: flex-start; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .chat-input { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 10px; background: white; }
        .chat-input input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; }

        /* --- RWD --- */
        @media (max-width: 768px) {
            .mobile-menu-btn { display: block; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); width: 80%; max-width: 300px; }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; }
            .sidebar-overlay.show { display: block; }
            .main-content { padding: 70px 15px 15px 15px; }
            .header-bar { flex-direction: column; align-items: flex-start; }
            .theme-controls { display: flex; margin-top: 10px; } /* æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºä¸»é¡Œåˆ‡æ› */
            .rank-card { margin-top: 50px; }
            .card { padding: 15px; border-radius: 10px; }
        }

        /* --- åˆ—å°å°ˆç”¨æ¨£å¼ --- */
        @media print {
            .sidebar, .mobile-menu-btn, .ai-fab, .chat-window, .theme-controls, .btn, .header-title::before { display: none !important; }
            body, .main-content { margin: 0; padding: 0; background: white; overflow: visible; display: block; }
            .card { box-shadow: none; border: 1px solid #ccc; margin: 0; padding: 0; page-break-inside: avoid; }
            .header-bar { box-shadow: none; border-bottom: 2px solid #000; padding: 10px 0; margin-bottom: 20px; display: block; }
            .header-title { border: none; padding: 0; text-align: center; font-size: 24px; color: black; }
            #visual-view, #schedule-view { display: block !important; }
            #selection-view, #leaderboard-view, #career-view, #history-view { display: none !important; }
            .schedule-container { overflow: visible; margin: 0; padding: 0; }
            .schedule-table { min-width: 100%; width: 100%; table-layout: auto; }
            .schedule-table th, .schedule-table td { border: 1px solid #000; color: black; }
            .course-block { border: 1px solid #000; color: black; background: none !important; box-shadow: none; }
            .card::before { content: "ç©ºè»å®˜æ ¡ - å­¸ç”Ÿèª²è¡¨"; display: block; text-align: center; font-weight: bold; font-size: 18px; margin-bottom: 10px; }
            /* åˆ—å°æ™‚å¼·åˆ¶ç§»é™¤èƒŒæ™¯è‰²ï¼Œæ”¹ç‚ºç™½åº•é»‘å­—ï¼Œç¢ºä¿æ¸…æ™° */
            .card-theme-blue, .card-theme-dark, .card-theme-warm { background: white !important; color: black !important; }
            .card-theme-blue::before { display: none; } 
        }

        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 3000; color: var(--cafa-blue-main); flex-direction: column; }
    </style>
</head>
<body>
    <div id="loading"><div style="font-size:40px; margin-bottom:10px;">â˜ï¸</div><div>è³‡æ–™åŒæ­¥ä¸­...</div></div>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div style="text-align:right; padding:10px; display:none;" id="close-menu"><span onclick="toggleSidebar()" style="color:white; font-size:24px; cursor:pointer;">&times;</span></div>
        <div class="sidebar-header"><h2>âœˆï¸ CAFA</h2><p>Student Portal</p></div>
        
        <div class="rank-card">
            <div style="font-size:12px;color:#ccc">æˆ‘çš„æ’ä½ (Rank)</div>
            <div class="rank-name" id="my-rank-name">è¨ˆç®—ä¸­...</div>
            <div id="my-reward" class="rank-reward" style="font-size:13px; color:#a5d6a7; margin-top:5px;"></div>
            <div id="my-punish" class="rank-punish" style="font-size:13px; color:#ef9a9a;"></div>
        </div>

        <div class="menu-item active" onclick="switchTab('selection')"><span>ğŸ›’</span> åŠ é€€é¸èª²ç¨‹</div>
        <div class="menu-item" onclick="switchTab('schedule')"><span>ğŸ“…</span> å·²é¸æ¸…å–®</div>
        <div class="menu-item" onclick="switchTab('leaderboard')"><span>ğŸ†</span> è‹±é›„æ¦œ</div> 
        <div class="menu-item" onclick="switchTab('visual')"><span>ğŸ“Š</span> è¦–è¦ºåŒ–èª²è¡¨</div>
        <div class="menu-item" onclick="switchTab('career')"><span>ğŸ¯</span> è·æ¶¯èˆ‡æ¨è–¦</div>
        <div class="menu-item" onclick="switchTab('history')"><span>ğŸ“ˆ</span> æ­·å¹´æˆç¸¾</div>
        <div class="menu-item" onclick="logout()" style="margin-top:auto; border-top:1px solid rgba(255,255,255,0.1)"><span>ğŸšª</span> ç™»å‡ºç³»çµ±</div>
    </div>

    <div class="main-content">
        <div id="selection-view">
            <div class="header-bar"><div class="header-title">é–‹æ”¾é¸èª²</div><span id="credits" style="font-weight:bold;color:#00308F; font-size:14px;">è¨ˆç®—ä¸­...</span></div>
            <div class="card"><table style="width:100%"><tbody id="course-list"></tbody></table></div>
        </div>

        <div id="schedule-view" style="display:none">
            <div class="header-bar"><div class="header-title">æˆ‘çš„å·²é¸èª²ç¨‹</div><button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button></div>
            <div class="card"><table style="width:100%"><tbody id="my-courses"></tbody></table></div>
        </div>

        <div id="leaderboard-view" style="display:none">
            <div class="header-bar"><div class="header-title">ğŸ† å…¨æ ¡æ¦®è­½è‹±é›„æ¦œ</div></div>
            <div class="card">
                <p style="color:#666; font-size:13px; text-align:center; padding-bottom:10px; border-bottom:1px solid #eee;">ä¾ç…§å¹³å‡ç©åˆ†(GPA)æ’åºï¼Œåƒ…é¡¯ç¤ºæ’ä½ç¨±è™Ÿä»¥ä¿éšœéš±ç§ã€‚</p>
                <table><thead><tr><th width="15%">æ’å</th><th>ç­ç´š</th><th>å§“å</th><th>æ¦®è­½æ’ä½</th></tr></thead><tbody id="leaderboard-body"></tbody></table>
            </div>
        </div>

        <div id="visual-view" style="display:none">
            <div class="header-bar">
                <div class="header-title">é€±èª²è¡¨</div>
                <div class="theme-controls">
                    <button class="btn btn-print" onclick="window.print()" style="margin-right:10px;">ğŸ–¨ï¸ åˆ—å°</button>
                    <span style="font-size:12px;margin-right:5px;color:#666;">é¢¨æ ¼:</span>
                    <div class="theme-btn tb-white" onclick="setTheme('white')" title="æ¨™æº–ç™½"></div>
                    <div class="theme-btn tb-blue" onclick="setTheme('blue')" title="ç©ºè»è—"></div>
                    <div class="theme-btn tb-warm" onclick="setTheme('warm')" title="è­·çœ¼é»ƒ"></div>
                    <div class="theme-btn tb-dark" onclick="setTheme('dark')" title="æ¥µç°¡é»‘"></div>
                </div>
            </div>
            <div class="card" id="visual-card">
                <p style="text-align:center; font-size:12px; color:#999; margin-bottom:10px;" class="no-print">(æ‰‹æ©Ÿç‰ˆè«‹å·¦å³æ»‘å‹•æŸ¥çœ‹å®Œæ•´èª²è¡¨)</p>
                <div class="schedule-container">
                    <table class="schedule-table">
                        <thead><tr><th style="width:50px">ç¯€æ¬¡</th><th>æ˜ŸæœŸä¸€</th><th>æ˜ŸæœŸäºŒ</th><th>æ˜ŸæœŸä¸‰</th><th>æ˜ŸæœŸå››</th><th>æ˜ŸæœŸäº”</th></tr></thead>
                        <tbody id="visual-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="career-view" style="display:none">
            <div class="header-bar"><div class="header-title">è·æ¶¯èˆ‡æ¨è–¦ç³»çµ±</div></div>
            <div class="card">
                <h3>æ­¥é©Ÿ 1: è¨­å®šæœªä¾†å¿—å‘</h3>
                <div style="display:flex;gap:15px;margin-bottom:20px; flex-wrap:wrap;">
                    <button id="btn-track-pilot" class="btn" style="flex:1; padding:20px; border:2px solid #ddd; background:white; color:#333;" onclick="setTrack('pilot')">
                        <div style="font-size:24px;">ğŸ¦…</div><div>é£›è¡Œç”Ÿ (Pilot)</div>
                    </button>
                    <button id="btn-track-ground" class="btn" style="flex:1; padding:20px; border:2px solid #ddd; background:white; color:#333;" onclick="setTrack('ground')">
                        <div style="font-size:24px;">ğŸ› ï¸</div><div>åœ°å‹¤ç”Ÿ (Ground)</div>
                    </button>
                </div>
                <h3>æ­¥é©Ÿ 2: é¸æ“‡æˆ–æ–°å¢èˆˆè¶£</h3>
                <div class="interest-section">
                    <div style="font-size:12px; color:#666; margin-bottom:5px;">å¸¸è¦‹æ¨™ç±¤ (é»æ“Šé¸æ“‡):</div>
                    <div class="interest-container" id="preset-tags-container"></div>
                </div>
                <div class="interest-section">
                    <div style="font-size:12px; color:#666; margin-bottom:5px;">è‡ªå®šç¾©æ¨™ç±¤:</div>
                    <div class="interest-container" id="custom-tags-container"></div>
                    <div class="custom-input-group">
                        <input type="text" id="new-interest-input" placeholder="è¼¸å…¥å…¶ä»–èˆˆè¶£ (å¦‚: ç„¡äººæ©Ÿã€AI)">
                        <button class="btn-small-add" onclick="addCustomInterest()">ï¼‹ æ–°å¢</button>
                    </div>
                </div>
                <div id="rec-msg" style="color:var(--cafa-blue-main); font-weight:bold; margin-top:20px; border-top:1px solid #eee; padding-top:15px;"></div>
                <button class="btn btn-save" onclick="saveCareer()">ğŸ’¾ å„²å­˜æ‰€æœ‰è¨­å®š</button>
            </div>
            <div class="card">
                <h3>ğŸ¯ æ™ºèƒ½æ¨è–¦èª²ç¨‹</h3>
                <div id="rec-list-container" style="color:#666; font-size:14px;">è«‹è¨­å®šä¸Šæ–¹å¿—å‘èˆ‡èˆˆè¶£ï¼Œç³»çµ±å°‡è‡ªå‹•åˆ†æ...</div>
            </div>
        </div>

        <div id="history-view" style="display:none">
            <div class="header-bar"><div class="header-title">æ­·å¹´æˆç¸¾å–®</div></div>
            <div class="card" id="history-list"></div>
        </div>
    </div>

    <div class="ai-fab" onclick="toggleChat()">ğŸ¤–</div>
    <div class="chat-window" id="chat-win">
        <div class="chat-header">CAFA AI åŠ©æ•™ <span style="cursor:pointer" onclick="toggleChat()">âœ•</span></div>
        <div class="chat-body" id="chat-body"><div class="chat-msg msg-ai">åŒå­¸ä½ å¥½ï¼æˆ‘æ˜¯é¸èª²å°å¹«æ‰‹ã€‚ä½ å¯ä»¥å•æˆ‘ï¼šã€Œæ¨è–¦é¸ä»€éº¼èª²ï¼Ÿã€ã€ã€Œæˆ‘æœ‰å¹¾å­¸åˆ†ï¼Ÿã€</div></div>
        <div class="chat-input"><input id="chat-in" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="if(event.key=='Enter')send()"><button class="btn btn-add" style="width:auto; padding:0 15px;" onclick="send()">â¤</button></div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud, listenToCloud } from './firebase-connect.js';
        const KEYS = { STUDENTS:'cafa_all_students_db', FIXED:'cafa_fixed_courses', ELECTIVE:'cafa_public_electives', RANKS:'cafa_rank_rules' };
        
        let allC=[], myC=[], cur=null, sDB=[], rules=[];
        let fixedCourses = [], electiveCourses = [];
        const PRESET_TAGS = ['ç©ºæ°£å‹•åŠ›', 'æ©Ÿæ¢°', 'è‹±æ–‡', 'ç®¡ç†', 'ç¨‹å¼', 'æ°£è±¡', 'æ­·å²', 'å¿ƒç†'];
        const TIME_SLOTS = ["08:10", "09:10", "10:10", "11:10", "13:30", "14:30", "15:30", "16:30", "17:30", "19:00"];

        window.onload = () => {
            const u = sessionStorage.getItem('cafa_user'); 
            if(!u) return location.href='index.html';
            cur = JSON.parse(u);
            if(!cur.interests) cur.interests = []; 
            
            initListeners();
            
            const savedTheme = localStorage.getItem('cafa_theme');
            if(savedTheme) setTheme(savedTheme);
            document.getElementById('loading').style.display = 'none';
        };

        function initListeners() {
            listenToCloud(KEYS.STUDENTS, (val) => {
                sDB = val || [];
                // â˜… é—œéµä¿®æ­£ï¼šç•¶é›²ç«¯è³‡æ–™è®Šå‹•æ™‚ï¼Œå¼·åˆ¶æ›´æ–°ç•¶å‰ä½¿ç”¨è€…ç‹€æ…‹ï¼Œä¸¦åŒæ­¥åˆ° sessionStorage
                if(cur) {
                    const me = sDB.find(s => s.id === cur.id);
                    if(me) { 
                        cur = me; 
                        if(!cur.interests) cur.interests = [];
                        sessionStorage.setItem('cafa_user', JSON.stringify(cur)); // ä¿æŒåŒæ­¥
                    }
                }
                updateAllCourses(); // å­¸ç”Ÿç‹€æ…‹è®Šå‹•(å¦‚æˆç¸¾/é¸èª²)ä¹Ÿè¦è§¸ç™¼æ›´æ–°
            });

            // ç›£è½èª²ç¨‹è³‡æ–™åº«
            listenToCloud(KEYS.FIXED, (val) => { fixedCourses = val || []; updateAllCourses(); });
            listenToCloud(KEYS.ELECTIVE, (val) => { electiveCourses = val || []; updateAllCourses(); });
            listenToCloud(KEYS.RANKS, (val) => { rules = val || getDefaultRanks(); render(); });
        }

        function updateAllCourses() {
            allC = [...fixedCourses, ...electiveCourses];
            refreshMyCourses();
            render();
        }

        // --- â˜… ä¿®æ­£ï¼šæ›´å¼·å¥çš„åˆä½µé‚è¼¯ ---
        function refreshMyCourses() {
            if (cur && cur.courses && allC.length > 0) {
                myC = cur.courses.map(c_mini => {
                    // å˜—è©¦åœ¨æœ€æ–°çš„èª²ç¨‹åˆ—è¡¨ä¸­æ‰¾åˆ°å®Œæ•´è³‡è¨Š
                    const full = allC.find(f => f.id === c_mini.id);
                    if (full) {
                        // åˆä½µæœ€æ–°è³‡è¨Š (åœ°é»ã€æ™‚é–“) èˆ‡ å€‹äººè³‡è¨Š (åˆ†æ•¸)
                        return { ...full, score: c_mini.score };
                    } else {
                        // å¦‚æœæ‰¾ä¸åˆ° (å¯èƒ½è©²èª²ç¨‹å‰›è¢«ç®¡ç†å“¡åˆªé™¤)ï¼Œä¿ç•™èˆŠè³‡è¨Šé˜²æ­¢å ±éŒ¯
                        return { ...c_mini, name: c_mini.name + ' (å·²åœé–‹)', time: '', isFixed: c_mini.isFixed };
                    }
                });
            } else if (cur && cur.courses) {
                // å¦‚æœ allC é‚„æ²’è¼‰å…¥å®Œï¼Œæš«æ™‚ä½¿ç”¨å­¸ç”Ÿèº«ä¸Šçš„å¿«å–
                myC = cur.courses;
            } else {
                myC = [];
            }
        }

        // --- æ¸²æŸ“èˆ‡é‚è¼¯ ---
        window.setTheme = (t) => {
            const c = document.getElementById('visual-card');
            c.className = 'card'; 
            if(t !== 'white') c.classList.add(`card-theme-${t}`);
            localStorage.setItem('cafa_theme', t); 
        };

        function render() {
            let tot=0, cr=0; myC.forEach(c=>{if(c.score){tot+=parseInt(c.score)*parseInt(c.credit); cr+=parseInt(c.credit);}});
            let gpa = cr>0 ? (tot/cr).toFixed(1) : 0;
            let rank = rules.find(r=>gpa>=r.min) || rules[rules.length-1];
            if(cr===0) rank = {name:'æ–°é€²å­¸å“¡', color:'#ccc', reward:'-', punishment:'-'};
            document.getElementById('my-rank-name').innerText = rank.name; document.getElementById('my-rank-name').style.color = rank.color;
            document.getElementById('my-reward').innerText = rank.reward ? `ğŸ ${rank.reward}` : ''; document.getElementById('my-punish').innerText = rank.punishment ? `âš ï¸ ${rank.punishment}` : '';

            // è¨ˆç®—å„èª²ç¨‹ç•¶å‰äººæ•¸ (å³æ™‚å¾ sDB è¨ˆç®—)
            const counts = {};
            sDB.forEach(s => {
                if(s.courses) {
                    s.courses.forEach(c => {
                        counts[c.id] = (counts[c.id] || 0) + 1;
                    });
                }
            });

            // --- æ¸²æŸ“é¸èª²åˆ—è¡¨ ---
            const tb = document.getElementById('course-list'); tb.innerHTML='';
            
            if (allC.length === 0) {
                tb.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">è³‡æ–™è¼‰å…¥ä¸­æˆ–ç›®å‰æ²’æœ‰èª²ç¨‹...</td></tr>';
            } else {
                const sortedCourses = allC.sort((a,b) => (a.isFixed === b.isFixed) ? 0 : a.isFixed ? -1 : 1);
    
                sortedCourses.forEach(c => {
                    // åªæœ‰é–‹å•Ÿçš„èª²ç¨‹æ‰é¡¯ç¤ºï¼Œæˆ–æˆ‘å·²é¸çš„
                    if (!c.isOpen && !myC.some(x=>x.id===c.id)) return;

                    const has = myC.some(x=>x.id===c.id);
                    const current = counts[c.id] || 0;
                    const max = c.max || 999;
                    const isFull = current >= max;
    
                    let btnHtml = '';
                    if(c.isFixed) {
                         if(has) btnHtml = '<span style="color:#e65100;font-weight:bold;">å·²æ’å®š (å¿…ä¿®)</span>';
                         else btnHtml = '<span style="color:red;font-size:12px;">åŒæ­¥ä¸­...</span>';
                    } else {
                        if(has) {
                            btnHtml = '<button class="btn btn-drop" onclick="drop(\''+c.id+'\')">é€€é¸</button>';
                        } else if(isFull) {
                            btnHtml = '<button class="btn" style="background:#ccc;cursor:not-allowed;" disabled>ğŸš« é¡æ»¿</button>';
                        } else {
                            btnHtml = `<button class="btn btn-add" onclick="add('${c.id}')">åŠ é¸</button>`;
                        }
                    }
    
                    tb.innerHTML += `
                        <tr>
                            <td><span class="tag ${c.isFixed?'tag-fixed':'tag-elective'}">${c.isFixed?'å¿…ä¿®':'é¸ä¿®'}</span></td>
                            <td>
                                <div style="font-weight:bold;">${c.name}</div>
                                <div style="font-size:12px;color:#666;">${c.time} | ${c.credit}å­¸åˆ† | ${c.location||''} | <span style="color:${isFull?'red':'#00308F'}">${current} / ${max} äºº</span></div>
                            </td>
                            <td style="text-align:right;">${btnHtml}</td>
                        </tr>`;
                });
            }

            const mtb = document.getElementById('my-courses'); mtb.innerHTML='';
            myC.forEach(c => { mtb.innerHTML += `<tr><td><span class="tag ${c.isFixed?'tag-fixed':'tag-elective'}">${c.isFixed?'å¿…ä¿®':'é¸ä¿®'}</span></td><td><div style="font-weight:bold;">${c.name}</div><div style="font-size:12px;color:#666;">${c.location||''}</div></td><td>${c.time}</td><td style="text-align:right;">${c.isFixed ? 'ğŸ”’' : `<button class="btn btn-drop" onclick="drop('${c.id}')">é€€</button>`}</td></tr>`; });
            document.getElementById('credits').innerText = `å·²é¸å­¸åˆ†: ${myC.reduce((a,b)=>a+parseInt(b.credit||0),0)}`;

            renderLeaderboard(); renderGrid();
            let hHTML = '<table style="width:100%"><thead><tr><th>èª²ç¨‹</th><th>å­¸åˆ†</th><th>åˆ†æ•¸</th></tr></thead><tbody>';
            let hasScore = false; myC.forEach(c=>{if(c.score){hasScore=true; hHTML+=`<tr><td>${c.name}</td><td>${c.credit}</td><td style="color:${c.score<60?'red':'green'}">${c.score}</td></tr>`;}});
            document.getElementById('history-list').innerHTML = hasScore ? hHTML+'</tbody></table>' : '<div style="text-align:center;padding:20px;color:#999">å°šç„¡æˆç¸¾ç´€éŒ„</div>';
            renderRecommendations();
            updateTrackUI(); 
            renderInterestTags();
        }

        window.setTrack = (t) => { cur.careerTrack = t; updateTrackUI(); renderRecommendations(); };
        function renderInterestTags() {
            const pCont = document.getElementById('preset-tags-container'), cCont = document.getElementById('custom-tags-container');
            pCont.innerHTML = ''; cCont.innerHTML = '';
            PRESET_TAGS.forEach(tag => { const isActive = cur.interests.includes(tag); pCont.innerHTML += `<div class="interest-tag ${isActive?'active':''}" onclick="toggleInterest('${tag}')">${tag}</div>`; });
            const customTags = cur.interests.filter(i => !PRESET_TAGS.includes(i));
            if(customTags.length === 0) cCont.innerHTML = '<span style="font-size:12px;color:#999;padding:5px;">å°šç„¡è‡ªå®šç¾©æ¨™ç±¤</span>';
            customTags.forEach(tag => { cCont.innerHTML += `<div class="interest-tag active" onclick="toggleInterest('${tag}')">${tag} <span class="tag-remove">âœ•</span></div>`; });
        }
        window.toggleInterest = (tag) => { if(cur.interests.includes(tag)) cur.interests = cur.interests.filter(t => t !== tag); else cur.interests.push(tag); renderInterestTags(); updateTrackUI(); renderRecommendations(); };
        window.addCustomInterest = () => { const input = document.getElementById('new-interest-input'), val = input.value.trim(); if(!val) return; if(cur.interests.includes(val)) return alert("å·²å­˜åœ¨"); cur.interests.push(val); input.value = ''; renderInterestTags(); updateTrackUI(); renderRecommendations(); };

        function updateTrackUI() {
            const t = cur.careerTrack;
            const b1 = document.getElementById('btn-track-pilot'), b2 = document.getElementById('btn-track-ground');
            b1.style.borderColor='#ddd'; b1.style.background='white'; b2.style.borderColor='#ddd'; b2.style.background='white';
            if(t === 'pilot') { b1.style.borderColor='#00308F'; b1.style.background='#e3f2fd'; }
            if(t === 'ground') { b2.style.borderColor='#e65100'; b2.style.background='#fff3e0'; }
            document.getElementById('rec-msg').innerText = `ç•¶å‰è¨­å®šï¼š${t==='pilot'?'é£›è¡Œç”Ÿ':'åœ°å‹¤ç”Ÿ'} (å·²è¨­å®š ${cur.interests.length} å€‹èˆˆè¶£)`;
        }

        function renderRecommendations() {
            const container = document.getElementById('rec-list-container');
            if(!cur.careerTrack) return;
            let keywords = cur.careerTrack === 'pilot' ? ['ç©ºæ°£', 'é£›è¡Œ', 'è‹±æ–‡', 'æ°£è±¡'] : ['ç®¡ç†', 'å¾Œå‹¤', 'æ©Ÿæ¢°', 'ç¶­ä¿®'];
            if(cur.interests && cur.interests.length > 0) keywords = [...keywords, ...cur.interests];
            const recs = allC.filter(c => { if(myC.some(m => m.id === c.id)) return false; return keywords.some(k => c.name.includes(k)); });
            if(recs.length === 0) container.innerHTML = `<div style="padding:10px;text-align:center;">ç„¡ç¬¦åˆæ¨è–¦ã€‚</div>`;
            else container.innerHTML = recs.map(c => `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;"><div><div style="font-weight:bold; color:var(--cafa-blue-main);">â˜… æ¨è–¦ï¼š${c.name}</div><div style="font-size:12px; color:#666;">${c.time} | ${c.credit}å­¸åˆ†</div></div><button class="btn btn-add" onclick="add('${c.id}')">åŠ é¸</button></div>`).join('');
        }

        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('show'); };
        window.switchTab = (id) => {
            ['selection','schedule','leaderboard','visual','career','history'].forEach(v=>document.getElementById(v+'-view').style.display='none');
            document.getElementById(id+'-view').style.display='block';
            document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active'));
            const map={'selection':0,'schedule':1,'leaderboard':2,'visual':3,'career':4,'history':5};
            if(document.querySelectorAll('.menu-item')[map[id]]) document.querySelectorAll('.menu-item')[map[id]].classList.add('active');
            if(window.innerWidth <= 768) window.toggleSidebar();
        };

        window.logout = () => { sessionStorage.removeItem('cafa_user'); location.href='index.html'; };
        
        window.add = async (id) => { 
            // é‡æ–°æŠ“å–æœ€æ–°çš„å­¸ç”Ÿè³‡æ–™ï¼Œé¿å…è¦†è“‹åˆ¥äººçš„æ›´å‹•
            let freshDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            let meIndex = freshDB.findIndex(s => s.id === cur.id);
            if (meIndex === -1) return alert("ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æ‚¨çš„å¸³è™Ÿ");

            const c = allC.find(x=>x.id===id); 
            // æª¢æŸ¥äººæ•¸
            let currentCount = 0;
            freshDB.forEach(s => { if(s.courses && s.courses.some(sc => sc.id === id)) currentCount++; });
            if(currentCount >= (c.max || 999)) return alert("ä¾†æ™šäº†ä¸€æ­¥ï¼è©²èª²ç¨‹å‰›å‰›é¡æ»¿äº†ã€‚");
            
            // æª¢æŸ¥è¡å ‚ (ä½¿ç”¨æœ€æ–°çš„ myC)
            if(checkConflict(c)) return alert("è¡å ‚ï¼è©²æ™‚æ®µå·²æœ‰èª²ç¨‹ã€‚"); 

            // å¯«å…¥è³‡æ–™åº«
            if (!freshDB[meIndex].courses) freshDB[meIndex].courses = [];
            freshDB[meIndex].courses.push({id: c.id, name: c.name, credit: c.credit, time: c.time, isFixed: false});
            
            await saveToCloud(KEYS.STUDENTS, freshDB); 
            alert("åŠ é¸æˆåŠŸï¼"); 
            // ä»‹é¢æœƒè‡ªå‹•é€é listenToCloud æ›´æ–°ï¼Œä¸éœ€æ‰‹å‹• reload
        };
        
        window.drop = async (id) => { 
            if(!confirm("ç¢ºå®šé€€é¸?"))return; 
            
            // åŒæ¨£å…ˆæŠ“æœ€æ–° DB
            let freshDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            let meIndex = freshDB.findIndex(s => s.id === cur.id);
            if (meIndex === -1) return;

            if (freshDB[meIndex].courses) {
                freshDB[meIndex].courses = freshDB[meIndex].courses.filter(x => x.id !== id);
                await saveToCloud(KEYS.STUDENTS, freshDB); 
            }
        };

        window.saveCareer = async () => { 
            let freshDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            let meIndex = freshDB.findIndex(s => s.id === cur.id);
            if (meIndex === -1) return;

            freshDB[meIndex].careerTrack = cur.careerTrack; 
            freshDB[meIndex].interests = cur.interests; 
            await saveToCloud(KEYS.STUDENTS, freshDB); 
            alert("è¨­å®šå·²å„²å­˜ï¼"); 
        };

        function checkConflict(n) { 
            if(!n.time)return false; 
            let [d1,p1]=n.time.replace(/\s/g, '').split('/'); 
            let pp1=p1.split(','); 
            return myC.some(o=>{
                if(!o.time)return false; 
                let [d2,p2]=o.time.replace(/\s/g, '').split('/'); 
                return d1===d2 && pp1.some(p=>p2.split(',').includes(p)); 
            }); 
        }
        
        function renderGrid() {
            const t = document.getElementById('visual-body'); t.innerHTML='';
            const dMap={"ä¸€":1,"äºŒ":2,"ä¸‰":3,"å››":4,"äº”":5};
            for(let i=1;i<=10;i++) {
                t.innerHTML += `<tr><td style="font-size:14px;">${i}<div style="font-size:10px; color:#999; margin-top:2px;">${TIME_SLOTS[i-1]}</div></td><td id="c1-${i}"></td><td id="c2-${i}"></td><td id="c3-${i}"></td><td id="c4-${i}"></td><td id="c5-${i}"></td></tr>`;
            }
            myC.forEach(c => {
                if(!c.time) return; 
                let cleanTime = c.time.replace(/\s/g, '');
                let [d,p]=cleanTime.split('/'); 
                let dy=dMap[d];
                if (!dy || !p) return;
                p.split(',').forEach(x => { 
                    let el=document.getElementById(`c${dy}-${x}`); 
                    if(el) el.innerHTML=`<div class="course-block ${c.isFixed?'block-fixed':'block-elective'}"><div style="font-weight:bold;">${c.name}</div><div style="opacity:0.9; font-size:11px;">${c.location||'ç„¡åœ°é»'}</div></div>`; 
                });
            });
        }
        
        function renderLeaderboard() {
            const lbBody = document.getElementById('leaderboard-body'); lbBody.innerHTML = '';
            let list = sDB.map(s => {
                let sTot=0, sCr=0; (s.courses||[]).forEach(c=>{if(c.score){sTot+=parseInt(c.score)*parseInt(c.credit); sCr+=parseInt(c.credit);}});
                let sGpa = sCr>0 ? (sTot/sCr) : -1;
                let sRank = rules.find(r=>sGpa>=r.min) || rules[rules.length-1];
                if(sCr===0) sRank = {name:'æ–°é€²å­¸å“¡', color:'#eee'};
                return { name: s.name, classId: s.classId||s.dept||'-', rank: sRank, gpa: sGpa, id: s.id };
            });
            list.sort((a,b) => b.gpa - a.gpa);
            list.forEach((d, i) => {
                let rowClass = d.id === cur.id ? 'background:#fff8e1;' : '';
                let badge = `<span style="background:${d.rank.color};padding:4px 8px;border-radius:12px;font-size:12px;font-weight:bold;">${d.rank.name}</span>`;
                if(d.gpa === -1) badge = '<span style="color:#ccc;font-size:12px;">å°šç„¡æˆç¸¾</span>';
                lbBody.innerHTML += `<tr style="${rowClass}"><td>${i+1}</td><td><span class="tag tag-fixed">${d.classId}</span></td><td style="font-weight:bold">${d.name}</td><td>${badge}</td></tr>`;
            });
        }
        function getDefaultRanks() { return [{name:'ç‹è€…', min:90, color:'#ffe0b2', reward:'ç¦®åˆ¸', punishment:''}, {name:'é‘½çŸ³', min:80, color:'#b3e5fc', reward:'', punishment:''}, {name:'é»ƒé‡‘', min:70, color:'#fff9c4', reward:'', punishment:''}, {name:'ç™½éŠ€', min:60, color:'#f5f5f5', reward:'', punishment:''}, {name:'é’éŠ…', min:0, color:'#ffccbc', reward:'', punishment:''}]; }

        // --- AI Chat ---
        window.toggleChat = () => {
            const w = document.getElementById('chat-win');
            w.style.display = w.style.display === 'none' || w.style.display === '' ? 'flex' : 'none';
        };

        window.send = function() { 
            const i=document.getElementById('chat-in'); const txt=i.value.trim(); if(!txt)return; 
            const b=document.getElementById('chat-body'); b.innerHTML+=`<div class="chat-msg msg-user">${txt}</div>`; i.value=''; b.scrollTop=b.scrollHeight;
            
            setTimeout(()=>{
                let r="è«‹æ´½æ•™å‹™è™•";
                if(txt.includes("æ’ä½")||txt.includes("ç­‰ç´š")||txt.includes("åˆ†æ•¸")) {
                    let tot=0, cr=0; myC.forEach(c=>{if(c.score){tot+=parseInt(c.score)*parseInt(c.credit); cr+=parseInt(c.credit);}});
                    let gpa = cr>0 ? (tot/cr).toFixed(1) : 0;
                    r = `ä½ ç›®å‰çš„ GPA æ˜¯ ${gpa} åˆ†ã€‚`;
                }
                else if(txt.includes("å­¸åˆ†")) {
                    r=`ä½ ç›®å‰å·²é¸äº† ${myC.reduce((a,b)=>a+parseInt(b.credit||0),0)} å­¸åˆ†ã€‚`;
                }
                else if(txt.includes("æ¨è–¦")||txt.includes("é¸ä»€éº¼")||txt.includes("ä¸çŸ¥é“é¸")) {
                    if(cur.careerTrack) {
                        r = `æ—¢ç„¶ä½ æƒ³ç•¶ã€Œ${cur.careerTrack==='pilot'?'é£›è¡Œå“¡':'åœ°å‹¤äººå“¡'}ã€ï¼Œæ¨è–¦ä½ å»è·æ¶¯æ¨è–¦å€çœ‹çœ‹ï¼`;
                    } else {
                        r = "è«‹å…ˆå»ã€Œè·æ¶¯èˆ‡æ¨è–¦ã€é é¢è¨­å®šä½ çš„å¿—å‘ï¼Œæˆ‘æ‰èƒ½çµ¦ä½ å»ºè­°å–”ï¼";
                    }
                }
                else { 
                    const c = allC.find(x => txt.includes(x.name) || (x.id && txt.includes(x.id))); 
                    if(c) {
                        let currentCount = 0;
                        sDB.forEach(s => { if(s.courses && s.courses.some(sc => sc.id === c.id)) currentCount++; });
                        r = `ã€Œ${c.name}ã€åœ¨ ${c.time} ä¸Šèª²ï¼Œæ˜¯ ${c.credit} å­¸åˆ†ã€‚ç›®å‰ ${currentCount}/${c.max||'ç„¡é™'} äººé¸ä¿®ã€‚`;
                    } else if (txt.includes("ä½ å¥½") || txt.includes("å—¨")) {
                        r = "ä½ å¥½ï¼æœ‰ä»€éº¼é¸èª²å•é¡Œéƒ½å¯ä»¥å•æˆ‘å–”ï¼";
                    }
                }
                b.innerHTML+=`<div class="chat-msg msg-ai">${r}</div>`; b.scrollTop=b.scrollHeight;
            }, 600); 
        };
    </script>
</body>
</html>
}

### 2. ä¿®æ”¹ `admin.html` (ç®¡ç†ç«¯)
**ä¿®æ­£é‡é»ï¼š**
* **å¼·åˆ¶æ›´æ–°å­¸ç”Ÿç‹€æ…‹ï¼š** åœ¨ `addCourse` å‡½å¼ä¸­ï¼Œæ–°å¢å¿…ä¿®èª²æ™‚ï¼Œæœƒç¢ºä¿ä½¿ç”¨æœ€æ–°çš„ `studentDB` å‰¯æœ¬ï¼Œä¸¦å°‡æ–°èª²ç¨‹æ¨é€åˆ°æ¯ä½å­¸ç”Ÿçš„ `courses` é™£åˆ—ä¸­ã€‚é€™ç¢ºä¿äº†å­¸ç”Ÿç™»å…¥æ™‚èƒ½çœ‹åˆ°è¢«å¼·è¿«åŠ å…¥çš„èª²ç¨‹ã€‚
* **ç­‰å¾…å¯«å…¥å®Œæˆï¼š** ä½¿ç”¨ `await` ç¢ºä¿è³‡æ–™å®Œå…¨å¯«å…¥ Firebase å¾Œæ‰è·³å‡ºæˆåŠŸè¦–çª—ï¼Œé¿å…çœ‹èµ·ä¾†æˆåŠŸä½†å¯¦éš›é‚„æ²’å¯«å…¥çš„ç‹€æ³ã€‚

```html
{
type: uploaded file
fileName: tom931028-png/cafa-selection-system/cafa-selection-system-9f34500d989dd6b095655e50e619bf6828083fa3/admin.html
fullContent:
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å¸«ç®¡ç†ç³»çµ± | CAFA Admin</title>
    <script src="[https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js](https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js)"></script>
    <style>
        /* --- æ ¸å¿ƒä¸»é¡Œè‰²ç³» --- */
        :root { --admin-blue: #00308F; --admin-dark: #002266; --admin-gold: #FFD700; --admin-bg: #f4f7fa; }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: var(--admin-bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: #333; }
        
        /* --- å´é‚Šæ¬„ --- */
        .sidebar { width: 260px; background: linear-gradient(180deg, var(--admin-blue) 0%, var(--admin-dark) 100%); color: white; display: flex; flex-direction: column; padding-top: 25px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 100; transition: transform 0.3s; }
        .sidebar-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .menu-item { padding: 15px 25px; cursor: pointer; transition: 0.3s; color: rgba(255,255,255,0.8); display: flex; align-items: center; font-size: 15px; border-left: 5px solid transparent; }
        .menu-item:hover, .menu-item.active { background: rgba(0,0,0,0.2); border-left-color: var(--admin-gold); color: white; font-weight: bold; }
        .menu-item span { margin-right: 12px; font-size: 20px; }
        .badge { background: #ff5252; color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px; margin-left: auto; font-weight: bold; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .badge.show { display: inline-block; animation: pulse 2s infinite; }

        /* --- ä¸»å…§å®¹å€ --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background-image: linear-gradient(to bottom, #eef2f7, #f4f7fa); position: relative; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); flex-wrap: wrap; gap: 10px; }
        .header-title { font-size: 24px; font-weight: bold; color: var(--admin-blue); border-left: 8px solid var(--admin-gold); padding-left: 15px; }

        .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-top: 4px solid var(--admin-blue); box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow-x: auto; transition: all 0.3s ease; position: relative; }
        .card-pending { border-top: 4px solid #ff9800; background: #fff8e1; }
        
        /* --- èª²ç¨‹ç®¡ç†å„ªåŒ–æ¨£å¼ --- */
        .course-form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; align-items: end; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
        .form-group input:focus { border-color: var(--admin-blue); outline: none; }
        
        /* è¡¨æ ¼èˆ‡æŒ‰éˆ• */
        table { width: 100%; min-width: 600px; border-collapse: separate; border-spacing: 0; font-size: 14px; margin-top: 10px; }
        th { background-color: #f1f3f5; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; color: white; display: inline-flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-submit { background-color: var(--admin-blue); width: 100%; height: 42px; } 
        .btn-add { background-color: #00695c; } 
        .btn-del { background-color: #dc3545; padding: 6px 12px; font-size: 12px; }
        .btn-approve { background-color: #28a745; padding: 6px 12px; font-size: 12px; }
        .btn-print { background-color: #607d8b; }
        .btn-create { background-color: #28a745; margin-bottom: 15px; }
        .btn-sync { background-color: #e65100; margin-bottom: 10px; width: 100%; }

        /* Excel åŒ¯å…¥å€å¡Š */
        .import-section { background: #e8eaf6; padding: 15px; border-radius: 10px; border: 2px dashed #9fa8da; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .btn-import { background: #3f51b5; color: white; }
        .btn-template { background: #7986cb; color: white; }

        /* èª²è¡¨æ¨£å¼ (å¼·åŒ–ç‰ˆ) */
        .schedule-table { min-width: 800px; table-layout: fixed; border-collapse: collapse; }
        .schedule-table th, .schedule-table td { border: 1px solid #eee; text-align: center; }
        .schedule-table td { height: 80px; vertical-align: top; padding: 2px; }
        .schedule-time-col { background:#f8f9fa; color:#666; font-size:12px; font-weight:bold; width:60px; vertical-align:middle !important; }
        .course-block { padding: 6px; border-radius: 6px; color: white; font-size: 12px; margin-bottom: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition:transform 0.2s; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .course-block:hover { transform: scale(1.02); z-index:10; position:relative; }
        
        .mobile-toggle { display: none; position: fixed; top: 10px; left: 10px; z-index: 200; background: var(--admin-blue); color: white; border: none; padding: 10px; border-radius: 5px; }

        /* ä¸»é¡Œåˆ‡æ› */
        .theme-controls { display: flex; align-items: center; gap: 8px; margin-left: auto; }
        .theme-btn { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid #ddd; }
        .card-theme-blue { background: linear-gradient(to bottom right, #f0f7ff, #dbeafe) !important; border-color: #1e88e5 !important; }
        .card-theme-dark { background: #2c3e50 !important; color: #ecf0f1 !important; border-color: #34495e !important; }
        .card-theme-dark th { background: #34495e !important; color: white !important; }
        .card-theme-dark select { background: #34495e; color: white; border-color: #555; }
        .card-theme-warm { background: #fffdeb !important; border-color: #fdd835 !important; }

        @media (max-width: 768px) {
            .mobile-toggle { display: block; }
            .sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { padding: 60px 15px 15px 15px; }
            .header-bar { flex-direction: column; align-items: flex-start; gap: 10px; }
            .course-form-grid { grid-template-columns: 1fr; }
        }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 999; }
    </style>
</head>
<body>
    <div id="loading"><h3>è³‡æ–™åŒæ­¥ä¸­...</h3></div>
    <button class="mobile-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')">â˜° é¸å–®</button>

    <div class="sidebar">
        <div class="sidebar-header"><h2>âœˆï¸ ç®¡ç†å¾Œå°</h2></div>
        <div class="menu-item active" onclick="switchTab('monitor')"><span>ğŸŒ</span> å…¨æ ¡ç›£æ§</div>
        <div class="menu-item" onclick="switchTab('schedule')"><span>ğŸ“…</span> æ•™å¸«èª²è¡¨</div>
        <div class="menu-item" onclick="switchTab('ranks')"><span>ğŸ†</span> çæ‡²è¨­å®š</div>
        <div class="menu-item" onclick="switchTab('students')">
            <span>ğŸ‘¥</span> å­¸ç”Ÿèˆ‡å¯©æ ¸
            <span id="pending-badge" class="badge">0</span>
        </div>
        <div class="menu-item" onclick="switchTab('courses')"><span>ğŸ‘¨â€ğŸ«</span> èª²ç¨‹ç®¡ç†</div>
        <div class="menu-item" onclick="switchTab('grades')"><span>ğŸ“</span> æˆç¸¾è¼¸å…¥</div>
    </div>

    <div class="main-content">
        <div id="monitor-view">
            <div class="header-bar"><div class="header-title">å…¨æ ¡ç›£æ§</div><button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å ±è¡¨</button></div>
            <div class="card">
                <table><thead><tr><th>å­¸è™Ÿ/å§“å</th><th>ç­ç´š</th><th>è·æ¶¯</th><th>GPA</th><th>ç‹€æ…‹</th></tr></thead><tbody id="student-list-body"></tbody></table>
            </div>
        </div>

        <div id="schedule-view" style="display: none;">
            <div class="header-bar">
                <div class="header-title">æ•™å¸«èª²è¡¨</div>
                <div style="display:flex; align-items:center; flex-wrap:wrap;">
                    <div class="theme-controls">
                        <span style="font-size:12px;margin-right:5px;color:#666;">é¢¨æ ¼:</span>
                        <div class="theme-btn tb-white" style="background:white" onclick="setTheme('white')"></div>
                        <div class="theme-btn tb-blue" style="background:#e3f2fd" onclick="setTheme('blue')"></div>
                        <div class="theme-btn tb-warm" style="background:#fff8e1" onclick="setTheme('warm')"></div>
                        <div class="theme-btn tb-dark" style="background:#333" onclick="setTheme('dark')"></div>
                    </div>
                    <button class="btn btn-print" onclick="window.print()" style="margin-left:15px;">ğŸ–¨ï¸ åˆ—å°</button>
                </div>
            </div>
            <div class="card" id="schedule-card">
                <select id="teacher-schedule-selector" onchange="renderTeacherSchedule()" style="margin-bottom:15px; padding:10px;">
                    <option value="">-- è«‹é¸æ“‡æ•™å®˜ --</option>
                </select>
                <h4 id="schedule-title" style="text-align:center;color:#00308F;">è«‹é¸æ“‡æ•™å®˜æŸ¥çœ‹èª²è¡¨</h4>
                <div style="overflow-x:auto;">
                    <table class="schedule-table">
                        <thead><tr><th style="width:60px">ç¯€æ¬¡</th><th>æ˜ŸæœŸä¸€</th><th>æ˜ŸæœŸäºŒ</th><th>æ˜ŸæœŸä¸‰</th><th>æ˜ŸæœŸå››</th><th>æ˜ŸæœŸäº”</th></tr></thead>
                        <tbody id="teacher-schedule-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="ranks-view" style="display: none;">
            <div class="header-bar"><div class="header-title">çæ‡²èˆ‡æ®µä½è¨­å®š</div></div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div>è«‹è¨­å®šå„æ®µä½çš„ GPA é–€æª»ï¼Œç³»çµ±å°‡è‡ªå‹•ä¾åˆ†æ•¸é«˜ä½æ’åºã€‚</div>
                    <button class="btn btn-create" onclick="addNewRankRow()">ï¼‹ æ–°å¢æ®µä½</button>
                </div>
                <table>
                    <thead><tr><th style="width:15%">æ®µä½åç¨±</th><th style="width:10%">æœ€ä½GPA</th><th style="width:10%">ä»£è¡¨è‰²</th><th style="width:10%">é è¦½</th><th>çå‹µå…§å®¹</th><th>æ‡²ç½°å…§å®¹</th><th style="width:50px">æ“ä½œ</th></tr></thead>
                    <tbody id="rank-rules-body"></tbody>
                </table>
                <button class="btn btn-submit" style="width:200px; margin-top:20px;" onclick="saveRankRules()">ğŸ’¾ å„²å­˜ä¸¦å¥—ç”¨è¨­å®š</button>
            </div>
        </div>

        <div id="students-view" style="display: none;">
            <div class="header-bar"><div class="header-title">å­¸ç”Ÿè³‡æ–™èˆ‡å¯©æ ¸</div></div>
            
            <div class="import-section">
                <div>
                    <strong>ğŸ“‚ æ‰¹æ¬¡åŒ¯å…¥å¸³è™Ÿ (Excel)</strong>
                    <div style="font-size:12px; color:#666; margin-top:5px;">è«‹ä¸Šå‚³ .xlsx æˆ– .csv æª”æ¡ˆï¼Œç³»çµ±å°‡è‡ªå‹•å»ºç«‹å¸³è™Ÿ (é è¨­ç‹€æ…‹ç‚ºæ­£å¸¸)ã€‚</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-template" onclick="downloadStudentTemplate()">ğŸ“¥ ä¸‹è¼‰å¸³è™Ÿç¯„æœ¬</button>
                    <button class="btn btn-import" onclick="document.getElementById('import-student-file').click()">ğŸ“¤ ä¸Šå‚³å¸³è™Ÿè¡¨</button>
                    <input type="file" id="import-student-file" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleStudentImport(event)">
                </div>
            </div>

            <div id="pending-zone" class="card card-pending" style="display:none;">
                <h3>âš ï¸ å¾…å¯©æ ¸ç”³è«‹ (Pending Requests)</h3>
                <div style="margin-bottom:10px; display:flex; gap:10px;">
                    <button class="btn btn-approve" onclick="batchApprove()">âš¡ æ‰¹æ¬¡æ ¸å‡†</button>
                    <button class="btn btn-del" onclick="batchDelete()">ğŸ—‘ï¸ æ‰¹æ¬¡åˆªé™¤</button>
                </div>
                <div style="max-height:300px; overflow-y:auto;">
                    <table>
                        <thead><tr><th class="checkbox-cell"><input type="checkbox" onclick="toggleSelectAll(this, 'pending')"></th><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç­ç´š</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="pending-list-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>âœ… æ­£å¼å­¸å“¡åå–®</h3>
                <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
                    <input id="s_id" placeholder="å­¸è™Ÿ" style="flex:1; min-width:100px;">
                    <input id="s_name" placeholder="å§“å" style="flex:1; min-width:100px;">
                    <input id="s_class" placeholder="ç­ç´š" style="flex:1; min-width:100px;">
                    <input id="s_pass" placeholder="å¯†ç¢¼" style="flex:1; min-width:100px;">
                    <button class="btn btn-add" style="flex:1; min-width:100px;" onclick="addStudent()">æ‰‹å‹•æ–°å¢</button>
                </div>
                <div style="max-height:500px; overflow-y:auto;">
                    <table>
                        <thead><tr><th>ç‹€æ…‹</th><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç­ç´š</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="active-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="courses-view" style="display:none;">
            <div class="header-bar"><div class="header-title">èª²ç¨‹ç®¡ç†</div></div>
            
            <div class="card" style="border-top-color:#28a745;">
                <h3 style="margin-top:0; color:#28a745;">â• æ–°å¢èª²ç¨‹</h3>
                <div class="course-form-grid">
                    <div class="form-group">
                        <label>èª²ç¨‹é¡åˆ¥</label>
                        <select id="c_type" onchange="toggleCourseForm(this.value)">
                            <option value="fixed">ğŸ”’ å¿…ä¿® (å…¨æ ¡å¼·åˆ¶)</option>
                            <option value="elective">ğŸ“– é¸ä¿® (è‡ªç”±é¸èª²)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>èª²ç¨‹ä»£ç¢¼</label>
                        <input id="c_id" placeholder="ä¾‹: C101">
                    </div>
                    <div class="form-group">
                        <label>èª²ç¨‹åç¨±</label>
                        <input id="c_name" placeholder="ä¾‹: é£›è¡ŒåŸç†">
                    </div>
                    <div class="form-group">
                        <label>å­¸åˆ†</label>
                        <input id="c_cr" type="number" value="2">
                    </div>
                    <div class="form-group">
                        <label>ä¸Šèª²æ™‚é–“ (ä¾‹: ä¸€/3,4)</label>
                        <input id="c_time" placeholder="æ˜ŸæœŸ/ç¯€æ¬¡">
                    </div>
                    <div class="form-group">
                        <label>æ•™å®˜å§“å</label>
                        <input id="c_tea" placeholder="ä¾‹: ç‹å¤§æ˜">
                    </div>
                    <div class="form-group">
                        <label>ä¸Šèª²åœ°é»</label>
                        <input id="c_loc" placeholder="ä¾‹: èˆªå¤ª 301">
                    </div>
                    <div class="form-group" id="group-max">
                        <label>äººæ•¸ä¸Šé™</label>
                        <input id="c_max" type="number" value="40">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-submit" onclick="addCourse()">ç™¼å¸ƒèª²ç¨‹</button>
                    </div>
                </div>
                <div style="margin-top:10px; font-size:12px; color:#d32f2f;">
                    * æ³¨æ„ï¼šç™¼å¸ƒã€Œå¿…ä¿®ã€èª²ç¨‹æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•å°‡è©²èª²ç¨‹åŠ å…¥æ‰€æœ‰å­¸ç”Ÿçš„èª²è¡¨ï¼Œè‹¥æœ‰é¸ä¿®è¡å ‚å°‡è‡ªå‹•ç§»é™¤é¸ä¿®èª²ã€‚
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“š ç¾æœ‰èª²ç¨‹åˆ—è¡¨</h3>
                <div id="sync-btn-container"></div>
                <div style="max-height:600px; overflow-y:auto;">
                    <table id="course-table"><thead><tr><th>é¡åˆ¥</th><th>åç¨± (ä»£ç¢¼)</th><th>æ™‚é–“</th><th>åœ°é»</th><th>æ•™å®˜</th><th>ç‹€æ…‹/äººæ•¸</th><th>æ“ä½œ</th></tr></thead><tbody id="course-list"></tbody></table>
                </div>
            </div>
        </div>

        <div id="grades-view" style="display:none;">
            <div class="header-bar"><div class="header-title">æˆç¸¾ç®¡ç†</div></div>
            <div class="import-section" style="background:#e0f2f1; border-color:#80cbc4;">
                <div><strong>ğŸ“Š æ‰¹æ¬¡åŒ¯å…¥æˆç¸¾ (Excel)</strong><div style="font-size:12px; color:#00695c; margin-top:5px;">å­¸è™Ÿ + èª²ç¨‹ä»£ç¢¼ + åˆ†æ•¸</div></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-template" onclick="downloadGradeTemplate()">ğŸ“¥ ç¯„æœ¬</button>
                    <button class="btn btn-import" style="background:#00695c;" onclick="document.getElementById('import-grade-file').click()">ğŸ“¤ ä¸Šå‚³</button>
                    <input type="file" id="import-grade-file" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleGradeImport(event)">
                </div>
            </div>

            <div class="card">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <select id="g_stu" onchange="loadGrades()" style="flex:3">
                        <option value="">-- è«‹å…ˆé¸æ“‡å­¸ç”Ÿ --</option>
                    </select>
                    <button class="btn btn-submit" style="flex:1" onclick="saveGrades()">ğŸ’¾ å„²å­˜æˆç¸¾</button>
                </div>
                <table id="grade-table"><thead><tr><th>èª²ç¨‹</th><th>å­¸åˆ†</th><th>åˆ†æ•¸è¼¸å…¥</th></tr></thead><tbody id="grade-body"><tr><td colspan="3" style="text-align:center; color:#999;">è«‹å…ˆé¸æ“‡å­¸ç”Ÿä»¥è¼‰å…¥èª²ç¨‹åˆ—è¡¨</td></tr></tbody></table>
            </div>
        </div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud, listenToCloud } from './firebase-connect.js';
        const KEYS = { STUDENTS:'cafa_all_students_db', FIXED:'cafa_fixed_courses', ELECTIVE:'cafa_public_electives', RANKS:'cafa_rank_rules' };
        let studentDB=[], fixedCourses=[], electiveCourses=[], rankRules=[];
        const TIME_SLOTS = ["08:10", "09:10", "10:10", "11:10", "13:30", "14:30", "15:30", "16:30", "17:30", "19:00"];

        window.onload = () => { 
            initAdminListeners();
            document.getElementById('loading').style.display='none'; 
            const savedTheme = localStorage.getItem('cafa_admin_theme'); if(savedTheme) setTheme(savedTheme);
        };

        function initAdminListeners() {
            listenToCloud(KEYS.STUDENTS, (val) => { 
                studentDB = val || []; 
                renderMonitor(); 
                renderStudents(); 
                updateSels(); 
                if(document.getElementById('schedule-view').style.display==='block') renderTeacherSchedule(); 
            });
            listenToCloud(KEYS.FIXED, (val) => { fixedCourses = val || []; renderCourses(); updateSels(); renderTeacherSchedule(); });
            listenToCloud(KEYS.ELECTIVE, (val) => { electiveCourses = val || []; renderCourses(); updateSels(); renderTeacherSchedule(); });
            listenToCloud(KEYS.RANKS, (val) => { rankRules = val || getDefaultRanks(); renderRankSettings(); });
        }

        // --- â˜… ä¿®æ­£ 1ï¼šæ›´å¼·å¤§çš„æ•™å¸«èª²è¡¨æ¸²æŸ“ ---
        window.renderTeacherSchedule = () => {
            const tea = document.getElementById('teacher-schedule-selector').value; 
            const tbody = document.getElementById('teacher-schedule-body'); 
            tbody.innerHTML = ''; 

            for(let i=1;i<=10;i++) {
                tbody.innerHTML += `<tr><td class="schedule-time-col">ç¬¬${i}ç¯€<br><span style="font-size:10px; font-weight:normal;">${TIME_SLOTS[i-1]}</span></td><td id="t1-${i}"></td><td id="t2-${i}"></td><td id="t3-${i}"></td><td id="t4-${i}"></td><td id="t5-${i}"></td></tr>`;
            }

            if(!tea) { document.getElementById('schedule-title').innerText = "è«‹é¸æ“‡æ•™å®˜æŸ¥çœ‹èª²è¡¨"; return; }
            document.getElementById('schedule-title').innerText = `ğŸ“… ${tea} æ•™å®˜èª²è¡¨`;

            const courses = [...fixedCourses, ...electiveCourses].filter(c => c.teacher === tea);
            
            // è¨ˆç®—é¸èª²äººæ•¸
            const counts = {};
            studentDB.forEach(s => {
                if(s.courses) {
                    s.courses.forEach(sc => {
                        if(courses.some(c => c.id === sc.id)) { counts[sc.id] = (counts[sc.id] || 0) + 1; }
                    });
                }
            });

            courses.forEach(c => { 
                if(!c.time) return; 
                let cleanTime = c.time.replace(/\s/g, ''); 
                let [d, p] = cleanTime.split('/'); 
                
                if (!d || !p) return;

                const dMap = {"ä¸€":1, "äºŒ":2, "ä¸‰":3, "å››":4, "äº”":5}; 
                if(!dMap[d]) return;

                p.split(',').forEach(x => { 
                    let el = document.getElementById(`t${dMap[d]}-${x}`); 
                    if(el) {
                        if(el.innerHTML !== "") el.innerHTML += `<div style="border-top:1px solid rgba(255,255,255,0.3); margin-top:2px; padding-top:2px;"></div>`;
                        el.innerHTML += `
                            <div class="course-block" 
                                 style="background:${c.isFixed ? 'linear-gradient(135deg, #e65100, #ff9800)' : 'linear-gradient(135deg, #00308F, #1976d2)'}; cursor:pointer;" 
                                 onclick="alert('ã€èª²ç¨‹è©³æƒ…ã€‘\\nåç¨±ï¼š${c.name}\\nä»£ç¢¼ï¼š${c.id}\\nåœ°é»ï¼š${c.location||'æœªå®š'}\\né¸èª²äººæ•¸ï¼š${counts[c.id]||0} äºº')">
                                <div style="font-weight:bold; font-size:13px;">${c.name}</div>
                                <div style="font-size:11px; opacity:0.9;">${c.location||'ğŸ“ç„¡'}</div>
                            </div>`;
                    }
                }); 
            });
        };

        // --- â˜… ä¿®æ­£ 2ï¼šç™¼å¸ƒå¿…ä¿®èª²æ™‚ï¼Œæ›´å¼·åˆ¶åœ°å¯«å…¥å­¸ç”Ÿè³‡æ–™ï¼Œä¸”ç­‰å¾…å¯«å…¥å®Œæˆ ---
        window.addCourse = async () => {
            const t = document.getElementById('c_type').value;
            const cid = document.getElementById('c_id').value.trim();
            const name = document.getElementById('c_name').value.trim();
            const time = document.getElementById('c_time').value.trim().replace(/\s/g, ''); 
            const teacher = document.getElementById('c_tea').value.trim();
            const location = document.getElementById('c_loc').value.trim();
            const credit = parseInt(document.getElementById('c_cr').value);
            const maxVal = parseInt(document.getElementById('c_max').value)||40;

            if(!cid || !name || !time) return alert("è«‹å¡«å¯«å®Œæ•´èª²ç¨‹è³‡è¨Š (ä»£ç¢¼ã€åç¨±ã€æ™‚é–“)ï¼");
            
            if([...fixedCourses, ...electiveCourses].some(c => c.id === cid)) return alert("èª²ç¨‹ä»£ç¢¼å·²å­˜åœ¨ï¼è«‹æ›´æ›ä»£ç¢¼ã€‚");

            const newCourse = {
                id: cid, name, credit, time, teacher, location,
                type: t==='fixed'?'å¿…ä¿®':'é¸ä¿®', 
                isFixed: t==='fixed', 
                isOpen: true,
                max: t==='fixed' ? 9999 : maxVal
            };

            if(t === 'fixed') {
                if(!confirm(`âš ï¸ ç™¼å¸ƒå¿…ä¿®èª²ç¨‹ã€Œ${name}ã€\n\né€™å°‡æœƒå¼·åˆ¶åŠ å…¥åˆ°ã€Œæ‰€æœ‰ã€å­¸ç”Ÿçš„èª²è¡¨ä¸­ã€‚ç¢ºå®šå—ï¼Ÿ`)) return;
                
                // 1. å…ˆå­˜èª²ç¨‹åº«
                const newFixed = [...fixedCourses, newCourse];
                await saveToCloud(KEYS.FIXED, newFixed);

                // 2. å¼·åˆ¶åŒæ­¥çµ¦æ‰€æœ‰å­¸ç”Ÿ (ä½¿ç”¨ç•¶å‰æœ€æ–°çš„ studentDB)
                let affectedCount = 0;
                let conflictRemoved = 0;
                
                // å¿…é ˆä½¿ç”¨æ·±æ‹·è²ï¼Œé¿å…ä¿®æ”¹åˆ°åŸåƒç…§
                // é‡è¦ï¼šç¢ºä¿ä½¿ç”¨æœ€æ–°çš„ studentDB (å·²ç”± listener æ›´æ–°)
                let currentDB = JSON.parse(JSON.stringify(studentDB));

                currentDB.forEach(s => {
                    if(!s.courses) s.courses = [];
                    // åªæœ‰ç•¶å­¸ç”Ÿé‚„æ²’æœ‰é€™é–€èª²æ™‚æ‰åŠ 
                    if(!s.courses.some(c => c.id === cid)) {
                        // ç§»é™¤è¡å ‚çš„ã€Œé¸ä¿®ã€èª² (å¿…ä¿®ä¸ç§»é™¤å¿…ä¿®)
                        s.courses = s.courses.filter(exist => {
                            const isConflict = checkTimeConflict(exist.time, newCourse.time);
                            if(isConflict && !exist.isFixed) { 
                                conflictRemoved++; 
                                return false; // ç§»é™¤è©²é¸ä¿®
                            }
                            return true;
                        });
                        // åŠ å…¥æ–°å¿…ä¿®
                        s.courses.push({ 
                            id: cid, 
                            name: name,
                            credit: credit, 
                            time: time, 
                            isFixed: true, 
                            location: location, 
                            teacher: teacher 
                        });
                        affectedCount++;
                    }
                });

                // 3. å¯«å›å­¸ç”Ÿè³‡æ–™åº« (ä½¿ç”¨ await ç¢ºä¿å¯«å…¥å®Œæˆ)
                await saveToCloud(KEYS.STUDENTS, currentDB);
                alert(`âœ… å¿…ä¿®ç™¼å¸ƒæˆåŠŸï¼\nå·²åŒæ­¥è‡³ ${affectedCount} ä½å­¸ç”Ÿï¼Œä¸¦è‡ªå‹•è§£æ±º ${conflictRemoved} å€‹é¸ä¿®è¡å ‚ã€‚`);
            } else {
                const newElect = [...electiveCourses, newCourse];
                await saveToCloud(KEYS.ELECTIVE, newElect);
                alert("âœ… é¸ä¿®èª²ç¨‹å·²ç™¼å¸ƒï¼Œå­¸ç”Ÿç¾åœ¨å¯ä»¥åœ¨é¸èª²å€çœ‹åˆ°äº†ã€‚");
            }
            
            document.getElementById('c_id').value = '';
            document.getElementById('c_name').value = '';
            if(teacher) {
                document.getElementById('teacher-schedule-selector').value = teacher;
                switchTab('schedule');
            }
        };

        window.syncFixedCoursesToAll = async () => {
            if(!confirm("ç¢ºå®šè¦å°‡ç›®å‰çš„ã€Œå¿…ä¿®èª²ç¨‹ã€å¼·åˆ¶åŒæ­¥çµ¦æ‰€æœ‰å­¸ç”Ÿå—ï¼Ÿ")) return;
            let updateCount = 0;
            // é‡æ–°è®€å–ç¢ºä¿æœ€æ–°
            let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];

            currentDB.forEach(s => {
                if(!s.courses) s.courses = [];
                fixedCourses.forEach(fc => {
                    if(!s.courses.some(c => c.id === fc.id)) {
                         s.courses = s.courses.filter(exist => !(!exist.isFixed && checkTimeConflict(exist.time, fc.time)));
                         s.courses.push({ id: fc.id, name: fc.name, credit: fc.credit, time: fc.time, isFixed: true, location: fc.location, teacher: fc.teacher });
                         updateCount++;
                    }
                });
            });

            if(updateCount > 0) {
                await saveToCloud(KEYS.STUDENTS, currentDB);
                alert(`âœ… åŒæ­¥å®Œæˆï¼æ›´æ–°äº† ${updateCount} ç­†è³‡æ–™ã€‚`);
            } else {
                alert("æ‰€æœ‰å­¸ç”Ÿçš„è³‡æ–™å·²ç¶“æ˜¯æœ€æ–°çš„ã€‚");
            }
        };

        function checkTimeConflict(t1, t2) {
            if(!t1 || !t2) return false;
            let clean1 = t1.replace(/\s/g, ''), clean2 = t2.replace(/\s/g, '');
            let [d1, p1] = clean1.split('/'); let [d2, p2] = clean2.split('/');
            if(d1 !== d2) return false; 
            let pp1 = p1.split(','), pp2 = p2.split(',');
            return pp1.some(p => pp2.includes(p)); 
        }

        window.delCourse = async (type, idx) => {
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤èª²ç¨‹ï¼Ÿ")) return;
            if(type === 'fixed') { const n = [...fixedCourses]; n.splice(idx, 1); await saveToCloud(KEYS.FIXED, n); } 
            else { const n = [...electiveCourses]; n.splice(idx, 1); await saveToCloud(KEYS.ELECTIVE, n); }
        };

        window.toggleStatus = async (idx) => {
            const n = [...electiveCourses]; n[idx].isOpen = !n[idx].isOpen;
            await saveToCloud(KEYS.ELECTIVE, n);
        };

        function renderCourses() {
            const t = document.getElementById('course-list');
            let html = '';
            document.getElementById('sync-btn-container').innerHTML = `<button class="btn btn-sync" onclick="syncFixedCoursesToAll()">ğŸ”„ å¼·åˆ¶åŒæ­¥å¿…ä¿®èª²çµ¦æ‰€æœ‰å­¸ç”Ÿ</button>`;
            
            fixedCourses.forEach((c, i) => {
                html += `<tr style="background:#fff3e0"><td><span style="color:#e65100;font-weight:bold">ğŸ”’ å¿…ä¿®</span></td><td>${c.name} (${c.id})</td><td>${c.time}</td><td>${c.location||'-'}</td><td>${c.teacher||'-'}</td><td>å…¨é«”</td><td><button class="btn btn-del" onclick="delCourse('fixed',${i})">åˆªé™¤</button></td></tr>`;
            });
            electiveCourses.forEach((c, i) => {
                html += `<tr><td><span style="color:#2e7d32;font-weight:bold">ğŸ“– é¸ä¿®</span></td><td>${c.name} (${c.id})</td><td>${c.time}</td><td>${c.location||'-'}</td><td>${c.teacher||'-'}</td><td><button class="btn" onclick="toggleStatus(${i})" style="background:${c.isOpen?'#28a745':'#9e9e9e'};padding:2px 8px;font-size:12px;">${c.isOpen?'é–‹å•Ÿä¸­':'å·²é—œé–‰'}</button> ${c.max}äºº</td><td><button class="btn btn-del" onclick="delCourse('elect',${i})">åˆªé™¤</button></td></tr>`;
            });
            t.innerHTML = html;
        }

        window.updateSels = () => { 
            const tea = document.getElementById('teacher-schedule-selector'); 
            const currentCourses = [...fixedCourses, ...electiveCourses];
            const ts = [...new Set(currentCourses.map(c=>c.teacher).filter(x=>x && x.trim() !== ''))].sort(); 
            
            const savedT = tea.value; 
            tea.innerHTML='<option value="">-- è«‹é¸æ“‡æ•™å®˜ --</option>'; 
            ts.forEach(t => tea.add(new Option(t,t))); 
            
            if(ts.includes(savedT)) {
                tea.value = savedT;
            } 
            
            const stu = document.getElementById('g_stu'); 
            const savedS = stu.value; 
            stu.innerHTML='<option value="">-- è«‹é¸æ“‡å­¸ç”Ÿè¼¸å…¥æˆç¸¾ --</option>'; 
            studentDB.forEach(s=>stu.add(new Option(`${s.id} ${s.name}`, s.id))); stu.value = savedS; 
        };

        // --- å…¶ä»– UI é‚è¼¯ ---
        window.toggleCourseForm = (v) => {
            const maxInput = document.getElementById('c_max');
            const group = document.getElementById('group-max');
            if(v === 'fixed') { maxInput.disabled = true; maxInput.value = 'å…¨æ ¡'; group.style.opacity = 0.5; }
            else { maxInput.disabled = false; maxInput.value = '40'; group.style.opacity = 1; }
        };

        window.setTheme = (t) => {
            const c = document.getElementById('schedule-card'); c.className = 'card';
            if(t !== 'white') c.classList.add(`card-theme-${t}`);
            localStorage.setItem('cafa_admin_theme', t);
            const title = document.getElementById('schedule-title');
            title.style.color = (t === 'dark') ? '#fff' : '#00308F';
        };

        window.switchTab = (id) => {
            ['monitor','schedule','ranks','students','courses','grades'].forEach(v=>document.getElementById(v+'-view').style.display='none');
            document.getElementById(id+'-view').style.display='block';
            document.querySelector('.sidebar').classList.remove('open');
            if(id === 'schedule') renderTeacherSchedule();
            if(id === 'ranks') renderRankSettings();
        };

        // Rank
        function renderRankSettings() {
            const t = document.getElementById('rank-rules-body'); t.innerHTML = '';
            rankRules.sort((a,b) => b.min - a.min);
            rankRules.forEach((r, i) => {
                t.innerHTML += `<tr class="rank-row"><td><input class="r-name" value="${r.name}" placeholder="åç¨±"></td><td><input class="r-min" type="number" value="${r.min}" style="width:60px"></td><td><input class="r-color" type="color" value="${r.color}" oninput="updateRankPreview(this)"></td><td><span class="rank-badge" style="background-color:${r.color};">${r.name}</span></td><td><input class="r-reward" value="${r.reward||''}" placeholder="ç„¡"></td><td><input class="r-punish" value="${r.punish||''}" placeholder="ç„¡"></td><td><button class="btn btn-del" onclick="deleteRankRow(this)">âœ•</button></td></tr>`;
            });
        }
        window.addNewRankRow = () => {
            const t = document.getElementById('rank-rules-body');
            const row = document.createElement('tr'); row.className = 'rank-row';
            row.innerHTML = `<td><input class="r-name" value="æ–°æ®µä½" placeholder="åç¨±"></td><td><input class="r-min" type="number" value="60" style="width:60px"></td><td><input class="r-color" type="color" value="#cccccc" oninput="updateRankPreview(this)"></td><td><span class="rank-badge" style="background-color:#cccccc;">æ–°æ®µä½</span></td><td><input class="r-reward" placeholder="ç„¡"></td><td><input class="r-punish" placeholder="ç„¡"></td><td><button class="btn btn-del" onclick="deleteRankRow(this)">âœ•</button></td>`;
            t.insertBefore(row, t.firstChild);
        };
        window.deleteRankRow = (btn) => { if(confirm("åˆªé™¤?")) btn.closest('tr').remove(); };
        window.updateRankPreview = (input) => { const r = input.closest('tr'); const b = r.querySelector('.rank-badge'); const n = r.querySelector('.r-name'); b.style.backgroundColor = input.value; b.innerText = n.value; };
        window.saveRankRules = async () => {
            const rows = document.querySelectorAll('.rank-row'); const newRules = [];
            rows.forEach(row => { const name = row.querySelector('.r-name').value; const min = parseInt(row.querySelector('.r-min').value); const color = row.querySelector('.r-color').value; const reward = row.querySelector('.r-reward').value; const punishment = row.querySelector('.r-punish').value; if(name && !isNaN(min)) newRules.push({ name, min, color, reward, punishment }); });
            newRules.sort((a,b) => b.min - a.min); await saveToCloud(KEYS.RANKS, newRules); alert("âœ… è¨­å®šå·²å„²å­˜ï¼"); 
        };
        function getDefaultRanks() { return [{name:'ç‹è€…', min:90, color:'#ffe0b2', reward:'ç¦®åˆ¸', punishment:''}, {name:'é‘½çŸ³', min:80, color:'#b3e5fc', reward:'', punishment:''}, {name:'é»ƒé‡‘', min:70, color:'#fff9c4', reward:'', punishment:''}, {name:'ç™½éŠ€', min:60, color:'#f5f5f5', reward:'', punishment:''}, {name:'é’éŠ…', min:0, color:'#ffccbc', reward:'', punishment:''}]; }

        window.addStudent = async () => { 
            const id=document.getElementById('s_id').value; 
            if(studentDB.some(s=>s.id===id))return alert("é‡è¤‡"); 
            
            // æ¯æ¬¡æ–°å¢éƒ½å¾é›²ç«¯æ‹‰ä¸€æ¬¡æœ€æ–°è³‡æ–™ï¼Œé¿å… overwriting
            let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            
            const initCourses = fixedCourses.map(fc => ({ id: fc.id, name: fc.name, credit: fc.credit, time: fc.time, isFixed: true, location: fc.location, teacher: fc.teacher }));
            currentDB.push({id, name:document.getElementById('s_name').value, classId:document.getElementById('s_class').value, password:document.getElementById('s_pass').value, status:'active', courses:initCourses}); 
            await saveToCloud(KEYS.STUDENTS, currentDB); 
        };

        window.renderStudents = () => {
            const pendingList = studentDB.filter(s => s.status === 'pending');
            const activeList = studentDB.filter(s => s.status !== 'pending');
            const badge = document.getElementById('pending-badge');
            if(pendingList.length > 0) { badge.innerText = pendingList.length; badge.classList.add('show'); document.getElementById('pending-zone').style.display = 'block'; }
            else { badge.classList.remove('show'); document.getElementById('pending-zone').style.display = 'none'; }
            
            document.getElementById('pending-list-body').innerHTML = pendingList.length === 0 ? '' : pendingList.map(s => `<tr><td class="checkbox-cell"><input type="checkbox" class="pending-checkbox" value="${s.id}"></td><td>${s.id}</td><td>${s.name}</td><td>${s.classId}</td><td><button class="btn btn-approve" onclick="approveStudent('${s.id}')">æ ¸å‡†</button></td></tr>`).join('');
            document.getElementById('active-list-body').innerHTML = activeList.map(s => `<tr><td>ğŸŸ¢</td><td>${s.id}</td><td>${s.name}</td><td>${s.classId}</td><td><button class="btn btn-del" onclick="deleteStudent('${s.id}')">åˆª</button></td></tr>`).join('');
        };
        window.toggleSelectAll = (src, type) => { document.querySelectorAll(`.${type}-checkbox`).forEach(cb => cb.checked = src.checked); };
        window.batchApprove = async () => {
            const cbs = document.querySelectorAll('.pending-checkbox:checked'); if(cbs.length===0) return alert("æœªé¸å–");
            
            let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            const ids = Array.from(cbs).map(cb=>cb.value);
            
            ids.forEach(id => {
                const s = currentDB.find(x=>x.id===id); 
                if(s) s.status='active'; 
            });
            await saveToCloud(KEYS.STUDENTS, currentDB); alert(`âœ… å·²æ ¸å‡† ${cbs.length} äºº`);
        };
        window.batchDelete = async () => {
            const cbs = document.querySelectorAll('.pending-checkbox:checked'); if(cbs.length===0) return alert("æœªé¸å–");
            if(!confirm("ç¢ºå®šåˆªé™¤?")) return;
            
            let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            const ids = Array.from(cbs).map(cb=>cb.value);
            const newDB = currentDB.filter(s => !ids.includes(s.id));
            await saveToCloud(KEYS.STUDENTS, newDB);
        };
        
        window.downloadStudentTemplate = () => { const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["å­¸è™Ÿ","å§“å","ç­ç´š","å¯†ç¢¼"],["114001","æ¸¬è©¦ç”Ÿ","114-1","1234"]]), "ç¯„æœ¬"); XLSX.writeFile(wb, "å­¸ç”Ÿå¸³è™Ÿç¯„æœ¬.xlsx"); };
        window.handleStudentImport = (e) => {
            const f=e.target.files[0]; if(!f)return;
            const r=new FileReader(); r.onload=async(e)=>{
                const d=new Uint8Array(e.target.result), wb=XLSX.read(d,{type:'array'});
                const json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                let cnt=0; 
                let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];

                const initCourses = fixedCourses.map(fc => ({ id: fc.id, name: fc.name, credit: fc.credit, time: fc.time, isFixed: true, location: fc.location, teacher: fc.teacher }));
                json.forEach(r=>{ 
                    const id=String(r['å­¸è™Ÿ']||r['id']).trim(); 
                    if(id && !currentDB.some(s=>s.id===id)) { 
                        currentDB.push({ id, name:String(r['å§“å']||r['name']), classId:String(r['ç­ç´š']||''), password:String(r['å¯†ç¢¼']||'1234'), status:'active', courses:[...initCourses] }); 
                        cnt++; 
                    }
                });
                if(cnt>0) await saveToCloud(KEYS.STUDENTS, currentDB); alert(`åŒ¯å…¥ ${cnt} ç­†ï¼Œå·²å¸¶å…¥å¿…ä¿®`); document.getElementById('import-student-file').value='';
            }; r.readAsArrayBuffer(f);
        };
        window.downloadGradeTemplate = () => { const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["å­¸è™Ÿ","èª²ç¨‹ä»£ç¢¼","åˆ†æ•¸"],["114001","C101","85"]]), "ç¯„æœ¬"); XLSX.writeFile(wb, "æˆç¸¾ç¯„æœ¬.xlsx"); };
        window.handleGradeImport = (e) => {
            const f=e.target.files[0]; if(!f)return;
            const r=new FileReader(); r.onload=async(e)=>{
                const d=new Uint8Array(e.target.result), wb=XLSX.read(d,{type:'array'});
                const json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                let cnt=0; 
                let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
                
                json.forEach(r=>{
                    const sid=String(r['å­¸è™Ÿ']), cid=String(r['èª²ç¨‹ä»£ç¢¼']), sc=parseInt(r['åˆ†æ•¸']);
                    const s=currentDB.find(x=>x.id===sid);
                    if(s && s.courses){ const c=s.courses.find(x=>x.id===cid); if(c){c.score=sc; cnt++;} }
                });
                if(cnt>0) await saveToCloud(KEYS.STUDENTS, currentDB); alert(`æ›´æ–° ${cnt} ç­†æˆç¸¾`); document.getElementById('import-grade-file').value='';
            }; r.readAsArrayBuffer(f);
        };
        window.loadGrades = () => { 
            const sid=document.getElementById('g_stu').value; 
            const t=document.getElementById('grade-body'); t.innerHTML=''; 
            if(!sid) { t.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#999;">è«‹é¸æ“‡å­¸ç”Ÿ</td></tr>'; return; }
            const s=studentDB.find(x=>x.id===sid); 
            if(!s || !s.courses || s.courses.length === 0) { t.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#d32f2f;">æ­¤å­¸ç”Ÿå°šæœªé¸ä¿®ä»»ä½•èª²ç¨‹</td></tr>'; return; }
            s.courses.forEach(c=>{ 
                const safeId = c.id.replace(/[^a-zA-Z0-9-_]/g, '_');
                const val = (c.score === undefined || c.score === null) ? '' : c.score;
                t.innerHTML+=`<tr><td>${c.name} <span style="font-size:12px;color:#999">(${c.id})</span></td><td>${c.credit}</td><td><input type="number" id="sc-${safeId}" value="${val}" style="width:80px" placeholder="æœªè¼¸å…¥" data-cid="${c.id}"></td></tr>`; 
            }); 
        };
        window.saveGrades = async () => { 
            const sid=document.getElementById('g_stu').value; 
            if(!sid) return alert("è«‹å…ˆé¸æ“‡å­¸ç”Ÿï¼");
            
            let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            const idx=currentDB.findIndex(x=>x.id===sid); 
            
            if(idx>-1) { 
                const s = currentDB[idx];
                if(s.courses) {
                    s.courses.forEach(c => {
                        const safeId = c.id.replace(/[^a-zA-Z0-9-_]/g, '_');
                        const input = document.getElementById(`sc-${safeId}`);
                        if(input) {
                            const val = input.value.trim();
                            if(val === '') delete c.score; else c.score = parseInt(val);
                        }
                    });
                    await saveToCloud(KEYS.STUDENTS, currentDB); 
                    alert(`âœ… å­¸ç”Ÿ ${s.name} çš„æˆç¸¾å·²å„²å­˜ï¼`); 
                }
            } else alert("æ‰¾ä¸åˆ°å­¸ç”Ÿè³‡æ–™");
        };

        window.deleteStudent = async (id) => { 
            if(confirm("åˆªé™¤?")){ 
                let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
                await saveToCloud(KEYS.STUDENTS, currentDB.filter(s=>s.id!==id)); 
            } 
        };
        window.approveStudent = async (id) => { 
            let currentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            const s=currentDB.find(x=>x.id===id); 
            if(s){ s.status='active'; await saveToCloud(KEYS.STUDENTS, currentDB); } 
        };
        
        window.renderMonitor = () => { const t = document.getElementById('student-list-body'); t.innerHTML=''; studentDB.forEach(s => { let tot=0, cr=0; (s.courses||[]).forEach(c => { if(c.score){ tot+=c.score*c.credit; cr+=c.credit; } }); let gpa = cr>0 ? (tot/cr).toFixed(1) : 0; t.innerHTML += `<tr><td>${s.name} (${s.id})</td><td>${s.classId||'-'}</td><td>${s.careerTrack==='pilot'?'é£›è¡Œ':'åœ°å‹¤'}</td><td>${gpa}</td><td>${(s.courses||[]).length} ç§‘</td></tr>`; }); };
    </script>
</body>
</html>
