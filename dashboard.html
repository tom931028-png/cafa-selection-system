<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¸èª²ä¸»ç³»çµ± (é›²ç«¯ç‰ˆ) | CAFA Student</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; margin: 0; background-color: #f4f7fa; color: #333; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 250px; background-color: #00308F; color: white; display: flex; flex-direction: column; padding-top: 20px; }
        .sidebar-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.2); margin-bottom: 20px; }
        .menu-item { padding: 15px 25px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; font-size: 15px; }
        .menu-item:hover, .menu-item.active { background-color: #0044CC; border-left: 4px solid #FFD700; }
        .student-info { margin-top: auto; padding: 20px; background-color: #002266; font-size: 13px; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header-title { font-size: 24px; font-weight: bold; color: #00308F; border-left: 5px solid #00308F; padding-left: 15px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #555; }
        .tag { padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .tag-compulsory { background: #e3f2fd; color: #0d47a1; } .tag-elective { background: #e8f5e9; color: #1b5e20; } .tag-fixed { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .btn { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 13px; }
        .btn-add { background: #28a745; color: white; } .btn-drop { background: #dc3545; color: white; } .btn-disabled { background: #ccc; cursor: not-allowed; color: #666; }
        .schedule-table { text-align: center; table-layout: fixed; }
        .schedule-table td { height: 80px; border: 1px solid #ccc; vertical-align: middle; padding: 5px; background: #fff; }
        .schedule-table th { background: #00308F; color: white; border: 1px solid #ccc; }
        .course-block { padding: 5px; border-radius: 4px; color: white; height: 100%; display: flex; flex-direction: column; justify-content: center; font-size: 12px; }
        .block-fixed { background-color: #c62828; } .block-normal { background-color: #1976d2; }
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; font-size: 24px; color: #00308F; z-index: 999; }
    </style>
</head>
<body>
    <div id="loading">é›²ç«¯è³‡æ–™åŒæ­¥ä¸­...</div>
    <div class="sidebar">
        <div class="sidebar-header"><h2>CAFA é¸èª²ç³»çµ±</h2><p>114å­¸å¹´åº¦ ç¬¬1å­¸æœŸ</p></div>
        <div class="menu-item active" onclick="switchTab('selection')">ğŸ›’ åŠ é€€é¸èª²ç¨‹</div>
        <div class="menu-item" onclick="switchTab('schedule')">ğŸ“… å·²é¸æ¸…å–®</div>
        <div class="menu-item" onclick="switchTab('visual')">ğŸ“Š å¯è¦–åŒ–èª²è¡¨</div>
        <div class="menu-item" onclick="logout()">ğŸšª ç™»å‡ºç³»çµ±</div>
        <div class="student-info" id="user-info-box">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="main-content">
        <div id="selection-view">
            <div class="header-bar"><div class="header-title">é–‹æ”¾é¸èª²æ¸…å–®</div><span style="color:#00308F;font-weight:bold;">å·²é¸å­¸åˆ†ï¼š<span id="current-credits">0</span></span></div>
            <div class="card"><table style="width:100%"><thead><tr><th>é¸åˆ¥</th><th>èª²è™Ÿ</th><th>èª²ç¨‹åç¨±</th><th>å­¸åˆ†</th><th>æ™‚é–“</th><th>åé¡</th><th>æ“ä½œ</th></tr></thead><tbody id="course-list-body"></tbody></table></div>
        </div>
        <div id="schedule-view" style="display: none;">
            <div class="header-bar"><div class="header-title">å·²é¸èª²ç¨‹åˆ—è¡¨</div></div>
            <div class="card"><table style="width:100%"><thead><tr><th>é¸åˆ¥</th><th>èª²ç¨‹åç¨±</th><th>å­¸åˆ†</th><th>æ™‚é–“</th><th>åœ°é»</th><th>æ“ä½œ</th></tr></thead><tbody id="my-course-body"></tbody></table></div>
        </div>
        <div id="visual-view" style="display: none;">
            <div class="header-bar"><div class="header-title">é€±èª²è¡¨æª¢è¦–</div><button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button></div>
            <div class="card"><table class="schedule-table" style="width:100%"><thead><tr><th style="width:80px;">ç¯€æ¬¡</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr></thead><tbody id="visual-schedule-body"></tbody></table></div>
        </div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud } from './firebase-connect.js';

        const KEYS = { STUDENTS: 'cafa_all_students_db', FIXED: 'cafa_fixed_courses', ELECTIVE: 'cafa_public_electives' };
        let allCourses = [], myCourses = [], currentUser = null, studentDB = [];

        window.logout = function() { sessionStorage.removeItem('cafa_user'); window.location.href='index.html'; }
        window.switchTab = switchTab;
        window.add = add;
        window.drop = drop;

        window.onload = async function() {
            const userStr = sessionStorage.getItem('cafa_user');
            if(!userStr) { window.location.href='index.html'; return; }
            currentUser = JSON.parse(userStr);
            document.getElementById('user-info-box').innerHTML = `å­¸è™Ÿï¼š${currentUser.id}<br>å§“åï¼š${currentUser.name}<br>ç³»ç´šï¼š${currentUser.dept}`;

            await syncData();
            document.getElementById('loading').style.display = 'none';
        };

        async function syncData() {
            studentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            const me = studentDB.find(s => s.id === currentUser.id);
            if(me) { currentUser = me; myCourses = me.courses || []; }
            
            allCourses = [];
            const elect = (await loadFromCloud(KEYS.ELECTIVE)) || [];
            elect.forEach(c => { c.capacity=50; c.enrolled=0; allCourses.push(c); });
            
            const fixed = (await loadFromCloud(KEYS.FIXED)) || [];
            fixed.forEach(c => {
                if(!myCourses.some(mc=>mc.id===c.id)) { myCourses.push(c); saveMyData(); }
            });

            renderCourseList(); generateGrid();
        }

        async function saveMyData() {
            const idx = studentDB.findIndex(s => s.id === currentUser.id);
            if(idx > -1) {
                studentDB[idx].courses = myCourses;
                studentDB[idx].totalCredits = myCourses.reduce((s,c)=>s+c.credit,0);
                await saveToCloud(KEYS.STUDENTS, studentDB);
            }
        }

        function renderCourseList() {
            const tbody = document.getElementById('course-list-body'); tbody.innerHTML='';
            allCourses.forEach(c => {
                const isSel = myCourses.some(mc=>mc.id===c.id);
                const isOpen = c.isOpen !== false;
                let btn = isSel ? `<button class="btn btn-disabled" disabled>å·²é¸</button>` : 
                          !isOpen ? `<button class="btn btn-disabled" disabled>â›” æš«åœ</button>` :
                          `<button class="btn btn-add" onclick="add('${c.id}')">åŠ é¸</button>`;
                const tag = c.type==='å¿…ä¿®'?'tag-compulsory':'tag-elective';
                tbody.innerHTML += `<tr><td><span class="tag ${tag}">${c.type}</span></td><td>${c.id}</td><td>${c.name}</td><td>${c.credit}</td><td>${c.time}</td><td>${c.enrolled}/${c.capacity}</td><td>${btn}</td></tr>`;
            });
            document.getElementById('current-credits').innerText = myCourses.reduce((s,c)=>s+c.credit,0);
        }

        async function add(id) {
            const c = allCourses.find(x=>x.id===id);
            myCourses.push(c); await saveMyData(); renderCourseList(); 
        }
        async function drop(id) {
            if(!confirm("é€€é¸ï¼Ÿ")) return;
            myCourses = myCourses.filter(c=>c.id!==id); await saveMyData(); renderCourseList(); 
        }

        function switchTab(tab) {
            ['selection','schedule','visual'].forEach(v => document.getElementById(v+'-view').style.display='none');
            document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
            if(tab==='selection') { document.getElementById('selection-view').style.display='block'; renderCourseList(); }
            if(tab==='schedule') { document.getElementById('schedule-view').style.display='block'; renderMySchedule(); }
            if(tab==='visual') { document.getElementById('visual-view').style.display='block'; generateGrid(); }
        }

        function renderMySchedule() {
            const tbody = document.getElementById('my-course-body'); tbody.innerHTML='';
            myCourses.forEach(c => {
                let isFixed = c.isFixed===true;
                tbody.innerHTML += `<tr><td><span class="tag ${isFixed?'tag-fixed':'tag-elective'}">${c.type}</span></td><td>${c.name}</td><td>${c.credit}</td><td>${c.time}</td><td>${c.location||''}</td><td>${isFixed?'ğŸ”’':`<button class="btn btn-drop" onclick="drop('${c.id}')">é€€</button>`}</td></tr>`;
            });
        }
        function generateGrid() {
            // ç°¡åŒ–ç‰ˆèª²è¡¨æ¸²æŸ“
            const t = document.getElementById('visual-schedule-body'); t.innerHTML='';
            const times = ["08:10", "09:10", "10:10", "11:10", "13:30", "14:30", "15:30", "16:30", "17:30", "19:00"];
            for(let i=1;i<=10;i++) t.innerHTML+=`<tr><td style="background:#f0f0f0;">${i}</td><td id="c1-${i}"></td><td id="c2-${i}"></td><td id="c3-${i}"></td><td id="c4-${i}"></td><td id="c5-${i}"></td></tr>`;
            
            const dayMap = {"ä¸€":1,"äºŒ":2,"ä¸‰":3,"å››":4,"äº”":5};
            myCourses.forEach(c => {
                if(!c.time) return;
                let [dayStr, pStr] = c.time.split('/');
                let day = dayMap[dayStr];
                pStr.split(',').forEach(p => {
                    let el = document.getElementById(`c${day}-${p}`);
                    if(el) el.innerHTML = `<div class="course-block ${c.isFixed?'block-fixed':'block-normal'}">${c.name}</div>`;
                });
            });
        }
    </script>
</body>
</html>

