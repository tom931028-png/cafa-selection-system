<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¸èª²ä¸»ç³»çµ± | CAFA Student</title>
    <style>
        :root { --cafa-blue-dark: #002266; --cafa-blue-main: #00308F; --cafa-blue-light: #4a7bd1; --cafa-gold: #FFD700; --bg-grey: #f0f2f5; }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; margin: 0; background-color: var(--bg-grey); color: #333; display: flex; height: 100vh; overflow: hidden; }
        
        /* å´é‚Šæ¬„èˆ‡ä¸»è¦æ¨£å¼ (ä¿æŒåŸæ¨£) */
        .sidebar { width: 260px; background: linear-gradient(180deg, var(--cafa-blue-main) 0%, var(--cafa-blue-dark) 100%); color: white; display: flex; flex-direction: column; padding-top: 25px; }
        .sidebar-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .menu-item { padding: 15px 30px; cursor: pointer; transition: 0.3s; color: rgba(255,255,255,0.8); display: flex; align-items: center; }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { background: rgba(0,0,0,0.2); border-left: 4px solid var(--cafa-gold); color: white; font-weight: bold; }
        .menu-item span { margin-right: 12px; font-size: 18px; }
        .student-info { margin-top: auto; padding: 25px; background: rgba(0,0,0,0.25); font-size: 13px; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background-image: linear-gradient(to bottom, #eef2f7, #f4f7fa); }
        
        /* é é¢å…ƒä»¶æ¨£å¼ */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header-title { font-size: 24px; font-weight: bold; color: var(--cafa-blue-main); border-left: 8px solid var(--cafa-gold); padding-left: 15px; }
        .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-top: 3px solid var(--cafa-blue-light); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* è¡¨æ ¼èˆ‡æŒ‰éˆ• */
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; }
        th { background: #f8f9fa; color: var(--cafa-blue-dark); padding: 15px; text-align: left; border-bottom: 2px solid var(--cafa-blue-main); }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .tag-compulsory { background: #e3f2fd; color: #0d47a1; } .tag-elective { background: #e8f5e9; color: #1b5e20; } .tag-fixed { background: #fff3e0; color: #e65100; }
        .btn { padding: 8px 16px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-add { background: #28a745; color: white; } .btn-drop { background: #dc3545; color: white; } .btn-save { background: var(--cafa-blue-main); color: white; width: 100%; padding: 12px; margin-top:20px; }
        
        /* è·æ¶¯èˆ‡æ¨è–¦ */
        .career-option { display: flex; gap: 20px; }
        .radio-card { flex: 1; border: 2px solid #eee; padding: 20px; border-radius: 10px; cursor: pointer; text-align: center; }
        .radio-card.selected { border-color: var(--cafa-blue-main); background: #e3f2fd; }
        .interest-tags { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        .interest-check { display: none; }
        .interest-label { padding: 8px 16px; background: #eee; border-radius: 20px; cursor: pointer; }
        .interest-check:checked + .interest-label { background: var(--cafa-gold); color: black; font-weight: bold; }
        
        /* --- ğŸ¤– AI èŠå¤©è¦–çª—æ¨£å¼ (æ–°å¢) --- */
        .ai-fab {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
            background: linear-gradient(135deg, #00308F, #0055ff); color: white;
            border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center; font-size: 30px;
            cursor: pointer; z-index: 1000; transition: transform 0.3s;
        }
        .ai-fab:hover { transform: scale(1.1); }
        
        .chat-window {
            position: fixed; bottom: 100px; right: 30px; width: 350px; height: 500px;
            background: white; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            display: none; flex-direction: column; overflow: hidden; z-index: 1000;
            border: 1px solid #ddd;
        }
        .chat-header { background: var(--cafa-blue-main); color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; display: flex; flex-direction: column; gap: 10px; }
        .chat-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 10px; background: white; }
        .chat-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        .chat-send { background: var(--cafa-blue-main); color: white; border: none; padding: 0 15px; border-radius: 20px; cursor: pointer; }
        
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 14px; line-height: 1.4; }
        .msg-ai { background: white; border: 1px solid #ddd; align-self: flex-start; color: #333; }
        .msg-user { background: var(--cafa-blue-main); color: white; align-self: flex-end; }
        
        /* Loading */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 999; }
    </style>
</head>
<body>
    <div id="loading">é›²ç«¯è³‡æ–™åŒæ­¥ä¸­...</div>
    
    <div class="sidebar">
        <div class="sidebar-header"><h2>âœˆï¸ CAFA é¸èª²</h2><p>114-1 å­¸æœŸ</p></div>
        <div class="menu-item active" onclick="switchTab('selection')"><span>ğŸ›’</span> åŠ é€€é¸èª²ç¨‹</div>
        <div class="menu-item" onclick="switchTab('schedule')"><span>ğŸ“…</span> å·²é¸æ¸…å–®</div>
        <div class="menu-item" onclick="switchTab('career')"><span>ğŸ¯</span> è·æ¶¯èˆ‡æ¨è–¦</div>
        <div class="menu-item" onclick="switchTab('history')"><span>ğŸ“ˆ</span> æ­·å¹´æˆç¸¾</div>
        <div class="menu-item" onclick="logout()" style="margin-top:auto"><span>ğŸšª</span> ç™»å‡º</div>
        <div class="student-info" id="user-info-box">...</div>
    </div>

    <div class="main-content">
        <div id="selection-view">
            <div class="header-bar"><div class="header-title">é–‹æ”¾é¸èª²</div><span id="current-credits"></span></div>
            <div class="card"><table style="width:100%"><tbody id="course-list-body"></tbody></table></div>
        </div>
        <div id="schedule-view" style="display:none">
            <div class="header-bar"><div class="header-title">å·²é¸èª²ç¨‹</div></div>
            <div class="card"><table style="width:100%"><tbody id="my-course-body"></tbody></table></div>
        </div>
        <div id="career-view" style="display:none">
            <div class="header-bar"><div class="header-title">è·æ¶¯è¦åŠƒ</div></div>
            <div class="card">
                <h3>1. æœªä¾†æ–¹å‘</h3>
                <div class="career-option">
                    <div class="radio-card" id="track-pilot" onclick="selectTrack('pilot')">ğŸ¦… é£›è¡Œç”Ÿ</div>
                    <div class="radio-card" id="track-ground" onclick="selectTrack('ground')">ğŸ› ï¸ åœ°å‹¤ç”Ÿ</div>
                </div>
                <h3>2. èˆˆè¶£æ¨™ç±¤</h3>
                <div class="interest-tags">
                    <input type="checkbox" id="i1" class="interest-check" value="ç†å·¥"><label for="i1" class="interest-label">ğŸ“ ç†å·¥</label>
                    <input type="checkbox" id="i2" class="interest-check" value="è³‡é›»"><label for="i2" class="interest-label">ğŸ’» è³‡é›»</label>
                    <input type="checkbox" id="i3" class="interest-check" value="å¤–èª"><label for="i3" class="interest-label">ğŸŒ å¤–èª</label>
                    <input type="checkbox" id="i4" class="interest-check" value="é«”èƒ½"><label for="i4" class="interest-label">ğŸ’ª é«”èƒ½</label>
                </div>
                <button class="btn btn-save" onclick="saveCareer()">ğŸ’¾ å„²å­˜è¨­å®š</button>
            </div>
            <div class="card" id="rec-area"><h3>â­ èª²ç¨‹æ¨è–¦</h3><div id="rec-list"></div></div>
        </div>
        <div id="history-view" style="display:none">
            <div class="header-bar"><div class="header-title">æˆç¸¾æŸ¥è©¢</div></div>
            <div class="card" id="history-content"></div>
        </div>
    </div>

    <div class="ai-fab" onclick="toggleChat()">ğŸ¤–</div>
    <div class="chat-window" id="chat-window">
        <div class="chat-header">ğŸ¤– èª²å‹™ AI å°å¹«æ‰‹ <span style="cursor:pointer" onclick="toggleChat()">âœ–</span></div>
        <div class="chat-body" id="chat-body">
            <div class="msg msg-ai">åŒå­¸ä½ å¥½ï¼æˆ‘æ˜¯é¸èª² AI åŠ©ç†ã€‚ä½ å¯ä»¥å•æˆ‘é—œæ–¼é¸èª²è¦å®šã€è¡å ‚å•é¡Œï¼Œæˆ–æ˜¯è·æ¶¯å»ºè­°å–”ï¼</div>
        </div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chat-input" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="chat-send" onclick="sendMessage()">â¤</button>
        </div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud } from './firebase-connect.js';
        const KEYS = { STUDENTS: 'cafa_all_students_db', FIXED: 'cafa_fixed_courses', ELECTIVE: 'cafa_public_electives' };
        let allCourses=[], myCourses=[], currentUser=null, studentDB=[], selectedTrack=null;

        window.logout = function() { sessionStorage.removeItem('cafa_user'); window.location.href='index.html'; }
        window.switchTab = switchTab; window.add = add; window.drop = drop; 
        window.selectTrack = selectTrack; window.saveCareer = saveCareer;
        window.toggleChat = toggleChat; window.sendMessage = sendMessage;

        window.onload = async function() {
            const u = sessionStorage.getItem('cafa_user');
            if(!u) { window.location.href='index.html'; return; }
            currentUser = JSON.parse(u);
            document.getElementById('user-info-box').innerHTML = `${currentUser.name}<br>${currentUser.dept}`;
            document.getElementById('loading').style.display='flex';
            await syncData();
            document.getElementById('loading').style.display='none';
            if(currentUser.careerTrack) selectTrack(currentUser.careerTrack);
            if(currentUser.interests) currentUser.interests.forEach(v => { const c=document.querySelector(`.interest-check[value="${v}"]`); if(c)c.checked=true; });
            genRec();
        };

        async function syncData() {
            studentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            const me = studentDB.find(s => s.id === currentUser.id);
            if(me) { currentUser = me; myCourses = me.courses || []; }
            allCourses = [];
            const el = (await loadFromCloud(KEYS.ELECTIVE))||[]; el.forEach(c=>{c.capacity=50;c.enrolled=0;allCourses.push(c)});
            const fi = (await loadFromCloud(KEYS.FIXED))||[];
            let dirty = false;
            fi.forEach(c => { if(!myCourses.some(m=>m.id===c.id)) { myCourses.push(c); dirty=true; } });
            if(dirty) await saveMyData();
            render();
        }
        async function saveMyData() {
            const i = studentDB.findIndex(s => s.id === currentUser.id);
            if(i>-1) { studentDB[i].courses=myCourses; studentDB[i].totalCredits=myCourses.reduce((a,b)=>a+b.credit,0); await saveToCloud(KEYS.STUDENTS, studentDB); }
        }
        function render() {
            const tb = document.getElementById('course-list-body'); tb.innerHTML='';
            allCourses.forEach(c => {
                const has = myCourses.some(m=>m.id===c.id);
                tb.innerHTML+=`<tr><td><span class="tag tag-elective">é¸ä¿®</span></td><td>${c.name}</td><td>${c.time}</td><td>${has?'<button class="btn btn-disabled" disabled>å·²é¸</button>':`<button class="btn btn-add" onclick="add('${c.id}')">åŠ é¸</button>`}</td></tr>`;
            });
            const mtb = document.getElementById('my-course-body'); mtb.innerHTML='';
            myCourses.forEach(c => {
                mtb.innerHTML+=`<tr><td><span class="tag ${c.isFixed?'tag-fixed':'tag-elective'}">${c.isFixed?'å¿…ä¿®':'é¸ä¿®'}</span></td><td>${c.name}</td><td>${c.time}</td><td>${c.isFixed?'ğŸ”’':`<button class="btn btn-drop" onclick="drop('${c.id}')">é€€é¸</button>`}</td></tr>`;
            });
            document.getElementById('current-credits').innerText = 'å·²é¸: ' + myCourses.reduce((a,b)=>a+b.credit,0);
            
            // Render History
            let hHtml = '';
            myCourses.forEach(c => { if(c.score) hHtml += `<div>${c.name}: ${c.score}åˆ†</div>`; });
            document.getElementById('history-content').innerHTML = hHtml || 'å°šç„¡æˆç¸¾';
        }
        
        async function add(id) {
            const c = allCourses.find(x=>x.id===id);
            if(checkConflict(c)) return alert("è¡å ‚ï¼");
            myCourses.push(c); await saveMyData(); render();
        }
        async function drop(id) { if(confirm("é€€é¸?")) { myCourses=myCourses.filter(x=>x.id!==id); await saveMyData(); render(); } }
        function checkConflict(nc) {
            if(!nc.time) return false;
            let [d1,p1]=nc.time.split('/'); let pp1=p1.split(',');
            return myCourses.some(oc => {
                if(!oc.time) return false;
                let [d2,p2]=oc.time.split('/'); let pp2=p2.split(',');
                return d1===d2 && pp1.some(p=>pp2.includes(p));
            });
        }
        
        // --- è·æ¶¯ ---
        function selectTrack(t) { selectedTrack=t; document.querySelectorAll('.radio-card').forEach(x=>x.classList.remove('selected')); document.getElementById('track-'+t).classList.add('selected'); }
        async function saveCareer() {
            if(!selectedTrack) return alert("è«‹é¸æ–¹å‘");
            const ints = Array.from(document.querySelectorAll('.interest-check:checked')).map(x=>x.value);
            const i = studentDB.findIndex(s => s.id === currentUser.id);
            if(i>-1) { studentDB[i].careerTrack=selectedTrack; studentDB[i].interests=ints; await saveToCloud(KEYS.STUDENTS, studentDB); currentUser=studentDB[i]; alert("å„²å­˜æˆåŠŸ"); genRec(); }
        }
        function genRec() {
            if(!currentUser.careerTrack) return;
            const kw = currentUser.careerTrack==='pilot'?['é£›è¡Œ','ç©ºæ°£','é«”è‚²','è‹±æ–‡']:['è³‡å®‰','ç¶­ä¿®','ç„¡äººæ©Ÿ'];
            const rec = allCourses.filter(c => kw.some(k=>c.name.includes(k)) && !myCourses.some(m=>m.id===c.id));
            document.getElementById('rec-list').innerHTML = rec.length ? rec.map(c=>`<div>ğŸ‘‰ <b>${c.name}</b> (æ¨è–¦)</div>`).join('') : 'ç›®å‰ç„¡ç‰¹å®šæ¨è–¦';
        }

        function switchTab(t) {
            ['selection','schedule','career','history'].forEach(x=>document.getElementById(x+'-view').style.display='none');
            document.getElementById(t+'-view').style.display='block';
        }

        // --- ğŸ¤– AI èŠå¤©æ©Ÿå™¨äººé‚è¼¯ ---
        function toggleChat() {
            const win = document.getElementById('chat-window');
            win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;
            
            addMsg(text, 'user');
            input.value = '';
            
            // æ¨¡æ“¬ AI æ€è€ƒå»¶é²
            setTimeout(() => {
                const response = getAIResponse(text);
                addMsg(response, 'ai');
            }, 600);
        }

        function addMsg(text, type) {
            const body = document.getElementById('chat-body');
            const div = document.createElement('div');
            div.className = `msg msg-${type}`;
            div.innerText = text;
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }

        // ğŸ§  ç°¡æ˜“é—œéµå­—è¦å‰‡åº« (Rule-based AI)
        function getAIResponse(q) {
            q = q.toLowerCase();
            if(q.includes('å¿…ä¿®') && (q.includes('é€€') || q.includes('ä¸æƒ³'))) return "æ ¹æ“šå®˜æ ¡è¦å®šï¼Œã€ç­å®šå¿…ä¿®ã€‘èª²ç¨‹æ˜¯ç„¡æ³•é€€é¸çš„å–”ï¼é€™æ˜¯ç‚ºäº†ç¢ºä¿ä½ çš„åŸºæœ¬å­¸èƒ½ã€‚";
            if(q.includes('é¸ä¿®') && q.includes('å­¸åˆ†')) return "é¸ä¿®èª²ç¨‹çš„å­¸åˆ†é€šå¸¸ç‚º 2-3 å­¸åˆ†ï¼Œè«‹æ³¨æ„ä½ çš„ç¸½å­¸åˆ†æ˜¯å¦é”åˆ°æœ€ä½é–€æª» (15å­¸åˆ†)ã€‚";
            if(q.includes('é£›è¡Œ') || q.includes('é£›å®˜')) return "æƒ³æˆç‚ºé£›è¡Œç”Ÿå—ï¼Ÿå»ºè­°ä½ å¤šé¸ä¿®ã€Œç©ºæ°£å‹•åŠ›å­¸ã€ã€ã€Œé£›è¡ŒåŸç†ã€ä»¥åŠåŠ å¼·è‹±æ–‡èƒ½åŠ›ï¼";
            if(q.includes('åœ°å‹¤') || q.includes('ç¶­ä¿®')) return "åœ°å‹¤ç™¼å±•ä¹Ÿæ˜¯å¾ˆæ£’çš„é¸æ“‡ï¼æ¨è–¦ä½ é¸ä¿®ã€Œè³‡è¨Šå®‰å…¨ã€ã€ã€Œç„¡äººæ©Ÿæ¦‚è«–ã€ç­‰èª²ç¨‹ã€‚";
            if(q.includes('è¡å ‚') || q.includes('è¡çª')) return "å¦‚æœç™¼ç”Ÿè¡å ‚ï¼Œç³»çµ±æœƒè‡ªå‹•é˜»æ“‹åŠ é¸ã€‚ä½ å¿…é ˆå…ˆé€€æ‰åŸæœ¬æ™‚é–“é‡ç–Šçš„èª²ï¼Œæ‰èƒ½åŠ é¸æ–°çš„å–”ã€‚";
            if(q.includes('ä½ å¥½') || q.includes('hi')) return "ä½ å¥½å‘€ï¼æˆ‘æ˜¯ä½ çš„èª²å‹™å°å¹«æ‰‹ï¼Œæœ‰ä»€éº¼é¸èª²å•é¡Œéƒ½å¯ä»¥å•æˆ‘ï¼";
            if(q.includes('æˆç¸¾') || q.includes('å¹¾åˆ†')) return "ä½ å¯ä»¥åœ¨ã€Œæ­·å¹´æˆç¸¾ã€åˆ†é æŸ¥è©¢ä½ çš„åˆ†æ•¸ã€‚å¦‚æœæœ‰ç–‘å•ï¼Œè«‹ç›´æ¥æ‰¾ä»»èª²æ•™å®˜ç¢ºèªã€‚";
            
            return "é€™å€‹å•é¡Œæœ‰é»æ·±å¥§... ğŸ¤” å»ºè­°ä½ ç›´æ¥æ´½è©¢æ•™å‹™è™•èª²å‹™çµ„ï¼Œæˆ–æ˜¯æ›å€‹æ–¹å¼å•æˆ‘é—œæ–¼ã€Œé¸èª²ã€ã€ã€Œå­¸åˆ†ã€æˆ–ã€Œè·æ¶¯ã€çš„å•é¡Œï¼Ÿ";
        }
    </script>
</body>
</html>




