<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¸èª²ä¸»ç³»çµ± | CAFA Student</title>
    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸ --- */
        :root { --cafa-blue-dark: #002266; --cafa-blue-main: #00308F; --cafa-blue-light: #4a7bd1; --cafa-gold: #FFD700; --bg-grey: #f0f2f5; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; margin: 0; background-color: var(--bg-grey); color: #333; display: flex; height: 100vh; overflow: hidden; }
        
        /* --- æ‰‹æ©Ÿç‰ˆæ¼¢å ¡é¸å–®æŒ‰éˆ• --- */
        .mobile-menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 1100; background: var(--cafa-blue-main); color: white; border: none; padding: 10px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; font-size: 20px; }
        
        /* --- å´é‚Šæ¬„ (å„ªåŒ–ç‰ˆ) --- */
        .sidebar { width: 260px; background: linear-gradient(180deg, var(--cafa-blue-main) 0%, var(--cafa-blue-dark) 100%); color: white; display: flex; flex-direction: column; padding-top: 25px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); position: relative; z-index: 1000; transition: transform 0.3s ease; }
        .sidebar-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .menu-item { padding: 15px 25px; cursor: pointer; transition: 0.2s; color: rgba(255,255,255,0.8); display: flex; align-items: center; font-size: 15px; }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { background: rgba(0,0,0,0.2); border-left: 5px solid var(--cafa-gold); color: white; font-weight: bold; }
        .menu-item span { margin-right: 12px; font-size: 18px; width: 25px; text-align: center; }
        
        /* --- æ’ä½å¡ (å€‹äºº) --- */
        .rank-card { background: rgba(0,0,0,0.2); margin: 10px 15px; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .rank-name { font-size: 20px; font-weight: 800; color: var(--cafa-gold); text-shadow: 0 2px 4px rgba(0,0,0,0.3); margin: 5px 0; letter-spacing: 1px; }
        
        /* --- ä¸»å…§å®¹å€ (RWD) --- */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; background-image: linear-gradient(to bottom, #eef2f7, #f4f7fa); position: relative; width: 100%; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); flex-wrap: wrap; gap: 10px; }
        .header-title { font-size: 22px; font-weight: bold; color: var(--cafa-blue-main); border-left: 6px solid var(--cafa-gold); padding-left: 12px; }
        
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-top: 3px solid var(--cafa-blue-light); box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow-x: auto; /* è®“è¡¨æ ¼å¯æ»‘å‹• */ }
        
        /* --- è¡¨æ ¼èˆ‡æ¨™ç±¤ --- */
        table { width: 100%; min-width: 600px; /* å¼·åˆ¶è¡¨æ ¼æœ€å°å¯¬åº¦ï¼Œè§¸ç™¼æ»‘å‹• */ border-collapse: separate; border-spacing: 0; font-size: 14px; }
        th { background: #f8f9fa; color: var(--cafa-blue-dark); padding: 12px; text-align: left; border-bottom: 2px solid var(--cafa-blue-main); white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; white-space: nowrap; }
        .tag-compulsory { background: #e3f2fd; color: #0d47a1; } .tag-elective { background: #e8f5e9; color: #1b5e20; } .tag-fixed { background: #fff3e0; color: #e65100; }
        
        /* --- æŒ‰éˆ• --- */
        .btn { padding: 8px 16px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 14px; white-space: nowrap; }
        .btn:active { transform: scale(0.95); }
        .btn-add { background: #28a745; color: white; } .btn-drop { background: #dc3545; color: white; }
        .btn-save { background: var(--cafa-blue-main); color: white; width: 100%; padding: 14px; margin-top:20px; font-size: 16px; box-shadow: 0 4px 10px rgba(0,48,143,0.3); }

        /* --- èª²è¡¨ (Grid System) --- */
        .schedule-table { min-width: 800px; table-layout: fixed; }
        .schedule-table th { text-align: center; }
        .schedule-table td { height: 60px; padding: 2px; text-align: center; vertical-align: top; border: 1px solid #eee; }
        .course-block { padding: 4px; border-radius: 6px; color: white; font-size: 11px; margin-bottom: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.15); line-height: 1.3; overflow: hidden; height: 95%; display: flex; flex-direction: column; justify-content: center; }
        .block-fixed { background: linear-gradient(135deg, #e65100, #ff9800); }
        .block-normal { background: linear-gradient(135deg, var(--cafa-blue-main), var(--cafa-blue-light)); }

        /* --- AI Chat (æµ®å‹•æŒ‰éˆ•) --- */
        .ai-fab { position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px; background: linear-gradient(45deg, #00308F, #0055ff); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 28px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 2000; transition: transform 0.2s; }
        .ai-fab:active { transform: scale(0.9); }
        .chat-window { position: fixed; bottom: 85px; right: 20px; width: 90%; max-width: 350px; height: 50vh; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); display: none; flex-direction: column; z-index: 2000; border: 1px solid rgba(0,0,0,0.05); overflow: hidden; }
        .chat-header { padding: 15px; background: var(--cafa-blue-main); color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; font-size: 14px; }
        .chat-msg { margin-bottom: 10px; max-width: 80%; padding: 8px 12px; border-radius: 12px; line-height: 1.4; word-wrap: break-word; }
        .msg-user { background: #e3f2fd; color: #00308F; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
        .msg-ai { background: white; color: #333; border: 1px solid #eee; align-self: flex-start; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .chat-input { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 10px; background: white; }
        .chat-input input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; }

        /* --- RWD Media Queries (é—œéµå„ªåŒ–) --- */
        @media (max-width: 768px) {
            .mobile-menu-btn { display: block; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); width: 80%; max-width: 300px; }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; }
            .sidebar-overlay.show { display: block; }
            
            .main-content { padding: 70px 15px 15px 15px; /* ä¸Šæ–¹ç•™çµ¦æ¼¢å ¡é¸å–® */ }
            .header-bar { flex-direction: column; align-items: flex-start; }
            .theme-controls { display: none; /* æ‰‹æ©Ÿç‰ˆéš±è—ä¸»é¡Œåˆ‡æ›ä»¥ç¯€çœç©ºé–“ */ }
            .rank-card { margin-top: 50px; /* é¿é–‹é—œé–‰æŒ‰éˆ• */ }
            
            /* å¡ç‰‡å„ªåŒ– */
            .card { padding: 15px; border-radius: 10px; }
        }

        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 3000; color: var(--cafa-blue-main); flex-direction: column; }
    </style>
</head>
<body>
    <div id="loading">
        <div style="font-size:40px; margin-bottom:10px;">â˜ï¸</div>
        <div>è³‡æ–™åŒæ­¥ä¸­...</div>
    </div>

    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div style="text-align:right; padding:10px; display:none;" id="close-menu"><span onclick="toggleSidebar()" style="color:white; font-size:24px; cursor:pointer;">&times;</span></div>
        <div class="sidebar-header"><h2>âœˆï¸ CAFA</h2><p>Student Portal</p></div>
        
        <div class="rank-card">
            <div style="font-size:12px;color:#ccc">æˆ‘çš„æ’ä½ (Rank)</div>
            <div class="rank-name" id="my-rank-name">è¨ˆç®—ä¸­...</div>
            <div id="my-reward" class="rank-reward" style="font-size:13px; color:#a5d6a7; margin-top:5px;"></div>
            <div id="my-punish" class="rank-punish" style="font-size:13px; color:#ef9a9a;"></div>
        </div>

        <div class="menu-item active" onclick="switchTab('selection')"><span>ğŸ›’</span> åŠ é€€é¸èª²ç¨‹</div>
        <div class="menu-item" onclick="switchTab('schedule')"><span>ğŸ“…</span> å·²é¸æ¸…å–®</div>
        <div class="menu-item" onclick="switchTab('leaderboard')"><span>ğŸ†</span> è‹±é›„æ¦œ</div> 
        <div class="menu-item" onclick="switchTab('visual')"><span>ğŸ“Š</span> è¦–è¦ºåŒ–èª²è¡¨</div>
        <div class="menu-item" onclick="switchTab('career')"><span>ğŸ¯</span> è·æ¶¯èˆ‡æ¨è–¦</div>
        <div class="menu-item" onclick="switchTab('history')"><span>ğŸ“ˆ</span> æ­·å¹´æˆç¸¾</div>
        <div class="menu-item" onclick="logout()" style="margin-top:auto; border-top:1px solid rgba(255,255,255,0.1)"><span>ğŸšª</span> ç™»å‡ºç³»çµ±</div>
    </div>

    <div class="main-content">
        <div id="selection-view">
            <div class="header-bar"><div class="header-title">é–‹æ”¾é¸èª²</div><span id="credits" style="font-weight:bold;color:#00308F; font-size:14px;">è¨ˆç®—ä¸­...</span></div>
            <div class="card"><table style="width:100%"><tbody id="course-list"></tbody></table></div>
        </div>

        <div id="schedule-view" style="display:none">
            <div class="header-bar"><div class="header-title">æˆ‘çš„å·²é¸èª²ç¨‹</div></div>
            <div class="card"><table style="width:100%"><tbody id="my-courses"></tbody></table></div>
        </div>

        <div id="leaderboard-view" style="display:none">
            <div class="header-bar"><div class="header-title">ğŸ† å…¨æ ¡æ¦®è­½è‹±é›„æ¦œ</div></div>
            <div class="card">
                <p style="color:#666; font-size:13px; text-align:center; padding-bottom:10px; border-bottom:1px solid #eee;">
                    èªªæ˜ï¼šä¾ç…§å¹³å‡ç©åˆ†(GPA)æ’åºï¼Œåƒ…é¡¯ç¤ºæ’ä½ç¨±è™Ÿä»¥ä¿éšœéš±ç§ã€‚
                </p>
                <table>
                    <thead><tr><th width="15%">æ’å</th><th>ç­ç´š</th><th>å§“å</th><th>æ¦®è­½æ’ä½</th></tr></thead>
                    <tbody id="leaderboard-body"></tbody>
                </table>
            </div>
        </div>

        <div id="visual-view" style="display:none">
            <div class="header-bar">
                <div class="header-title">é€±èª²è¡¨</div>
                <div class="theme-controls">
                    <span style="font-size:12px;margin:0 10px;">èƒŒæ™¯:</span>
                    <div class="theme-btn tb-white" onclick="setTheme('white')"></div>
                    <div class="theme-btn tb-blue" onclick="setTheme('blue')"></div>
                    <div class="theme-btn tb-dark" onclick="setTheme('dark')"></div>
                </div>
            </div>
            <div class="card" id="visual-card">
                <table class="schedule-table">
                    <thead><tr><th style="width:40px">ç¯€</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr></thead>
                    <tbody id="visual-body"></tbody>
                </table>
            </div>
        </div>

        <div id="career-view" style="display:none">
            <div class="header-bar"><div class="header-title">è·æ¶¯èˆ‡æ¨è–¦ç³»çµ±</div></div>
            <div class="card">
                <h3>æ­¥é©Ÿ 1: è¨­å®šä½ çš„æœªä¾†å¿—å‘</h3>
                <div style="display:flex;gap:15px;margin-bottom:20px; flex-wrap:wrap;">
                    <button id="btn-track-pilot" class="btn" style="flex:1; padding:20px; border:2px solid #ddd; background:white; color:#333;" onclick="setTrack('pilot')">
                        <div style="font-size:24px;">ğŸ¦…</div>
                        <div>é£›è¡Œç”Ÿ (Pilot)</div>
                        <div style="font-size:11px;color:#999;margin-top:5px;">é‡è¦–ç©ºæ°£å‹•åŠ›å­¸ã€è‹±æ–‡</div>
                    </button>
                    <button id="btn-track-ground" class="btn" style="flex:1; padding:20px; border:2px solid #ddd; background:white; color:#333;" onclick="setTrack('ground')">
                        <div style="font-size:24px;">ğŸ› ï¸</div>
                        <div>åœ°å‹¤ç”Ÿ (Ground)</div>
                        <div style="font-size:11px;color:#999;margin-top:5px;">é‡è¦–æ©Ÿæ¢°çµæ§‹ã€ç®¡ç†</div>
                    </button>
                </div>
                <div id="rec-msg" style="color:var(--cafa-blue-main); font-weight:bold; text-align:center; margin-bottom:10px;">å°šæœªè¨­å®š</div>
                <button class="btn btn-save" onclick="saveCareer()">ğŸ’¾ å„²å­˜è·æ¶¯è¨­å®š</button>
            </div>
            <div class="card">
                <h3>ğŸ¯ ç³»çµ±æ¨è–¦èª²ç¨‹</h3>
                <div id="rec-list-container" style="color:#666; font-size:14px;">è«‹å…ˆé¸æ“‡è·æ¶¯æ–¹å‘ï¼Œç³»çµ±å°‡è‡ªå‹•åˆ†æ...</div>
            </div>
        </div>

        <div id="history-view" style="display:none">
            <div class="header-bar"><div class="header-title">æ­·å¹´æˆç¸¾å–®</div></div>
            <div class="card" id="history-list"></div>
        </div>
    </div>

    <div class="ai-fab" onclick="toggleChat()">ğŸ¤–</div>
    <div class="chat-window" id="chat-win">
        <div class="chat-header">CAFA AI åŠ©æ•™ <span style="cursor:pointer" onclick="toggleChat()">âœ•</span></div>
        <div class="chat-body" id="chat-body">
            <div class="chat-msg msg-ai">åŒå­¸ä½ å¥½ï¼æˆ‘æ˜¯é¸èª²å°å¹«æ‰‹ã€‚ä½ å¯ä»¥å•æˆ‘ï¼š<br>ã€Œæ¨è–¦é¸ä»€éº¼èª²ï¼Ÿã€<br>ã€Œç©ºæ°£å‹•åŠ›å­¸åœ¨ä»€éº¼æ™‚å€™ï¼Ÿã€<br>ã€Œæˆ‘æœ‰å¹¾å­¸åˆ†ï¼Ÿã€</div>
        </div>
        <div class="chat-input">
            <input id="chat-in" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="if(event.key=='Enter')send()">
            <button class="btn btn-add" style="width:auto; padding:0 15px;" onclick="send()">â¤</button>
        </div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud } from './firebase-connect.js';
        const KEYS = { STUDENTS:'cafa_all_students_db', FIXED:'cafa_fixed_courses', ELECTIVE:'cafa_public_electives', RANKS:'cafa_rank_rules' };
        
        // å…¨åŸŸè®Šæ•¸
        let allC=[], myC=[], cur=null, sDB=[], rules=[];
        let isPilot = false;

        // --- åˆå§‹åŒ– ---
        window.onload = async () => {
            const u = sessionStorage.getItem('cafa_user'); 
            if(!u) return location.href='index.html';
            cur = JSON.parse(u);
            
            try {
                await sync();
            } catch (e) {
                console.error(e);
                alert("ç¶²è·¯ä¸ç©©ï¼Œè«‹é‡æ–°æ•´ç†");
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        };

        // --- æ ¸å¿ƒåŒæ­¥ (é‚è¼¯ä¿®æ­£ï¼šæ¸…é™¤å¹½éˆèª²ç¨‹) ---
        async function sync() {
            // 1. è¼‰å…¥è³‡æ–™
            sDB = (await loadFromCloud(KEYS.STUDENTS))||[];
            rules = (await loadFromCloud(KEYS.RANKS))||getDefaultRanks();
            const fixed = (await loadFromCloud(KEYS.FIXED))||[];
            const elective = (await loadFromCloud(KEYS.ELECTIVE))||[];
            
            // åˆä½µæ‰€æœ‰èª²ç¨‹è³‡æ–™åº«
            allC = [...fixed, ...elective];

            // 2. æ‰¾åˆ°è‡ªå·±ä¸¦æ›´æ–°
            const me = sDB.find(s=>s.id===cur.id); 
            if(me){ 
                cur = me; 
                // BUG FIX: éæ¿¾æ‰å·²ç¶“ä¸å­˜åœ¨æ–¼å­¸æ ¡èª²è¡¨ä¸­çš„èª²ç¨‹ (å¹½éˆèª²ç¨‹)
                myC = (me.courses||[]).filter(my => allC.some(school => school.id === my.id));
                // å¦‚æœæœ‰åˆªé™¤å¹½éˆèª²ç¨‹ï¼Œé †ä¾¿æ›´æ–°å›è³‡æ–™åº«
                if(myC.length !== (me.courses||[]).length) {
                    await save(); 
                    console.log("å·²è‡ªå‹•æ¸…é™¤ç„¡æ•ˆèª²ç¨‹");
                }
            } else {
                myC = []; // é é˜²éŒ¯èª¤
            }

            render();
            updateTrackUI();
        }

        // --- ç•«é¢æ¸²æŸ“ ---
        function render() {
            // 1. æ’ä½è¨ˆç®— (GPA)
            let tot=0, cr=0; 
            myC.forEach(c => {
                if(c.score !== undefined && c.score !== null && c.score !== "") {
                    tot += parseInt(c.score) * parseInt(c.credit); 
                    cr += parseInt(c.credit);
                }
            });
            let gpa = cr>0 ? (tot/cr).toFixed(1) : 0;
            let rank = rules.find(r => gpa >= r.min) || rules[rules.length-1];
            if(cr===0) rank = {name:'æ–°é€²å­¸å“¡', color:'#ccc', reward:'-', punishment:'-'};
            
            document.getElementById('my-rank-name').innerText = rank.name;
            document.getElementById('my-rank-name').style.color = rank.color;
            document.getElementById('my-reward').innerText = rank.reward ? `ğŸ ${rank.reward}` : '';
            document.getElementById('my-punish').innerText = rank.punishment ? `âš ï¸ ${rank.punishment}` : '';

            // 2. èª²ç¨‹åˆ—è¡¨ (åŠ é€€é¸)
            const tb = document.getElementById('course-list'); tb.innerHTML='';
            // åªé¡¯ç¤ºé¸ä¿®ï¼Œå¿…ä¿®é€šå¸¸æ˜¯æ•™å®˜çŒæª”
            const electiveOnly = allC.filter(c => !c.isFixed && c.isOpen);
            
            if(electiveOnly.length === 0) tb.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:#999;">ç›®å‰ç„¡é–‹æ”¾é¸ä¿®èª²ç¨‹</td></tr>';

            electiveOnly.forEach(c => {
                const has = myC.some(x=>x.id===c.id);
                tb.innerHTML += `
                    <tr>
                        <td><span class="tag tag-elective">é¸ä¿®</span></td>
                        <td>
                            <div style="font-weight:bold;">${c.name}</div>
                            <div style="font-size:12px;color:#666;">${c.time} | ${c.credit}å­¸åˆ†</div>
                        </td>
                        <td style="text-align:right;">
                            ${has ? '<span style="color:green;font-weight:bold;">å·²é¸</span>' : `<button class="btn btn-add" onclick="add('${c.id}')">åŠ é¸</button>`}
                        </td>
                    </tr>`;
            });

            // 3. æˆ‘çš„èª²è¡¨æ¸…å–®
            const mtb = document.getElementById('my-courses'); mtb.innerHTML='';
            if(myC.length === 0) mtb.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:#999;">å°šæœªé¸èª²</td></tr>';
            
            myC.forEach(c => {
                mtb.innerHTML += `
                    <tr>
                        <td><span class="tag ${c.isFixed?'tag-fixed':'tag-elective'}">${c.isFixed?'å¿…ä¿®':'é¸ä¿®'}</span></td>
                        <td>
                            <div style="font-weight:bold;">${c.name}</div>
                            <div style="font-size:12px;color:#666;">${c.location||'åœ°é»æœªå®š'}</div>
                        </td>
                        <td>${c.time}</td>
                        <td style="text-align:right;">
                            ${c.isFixed ? '<span style="opacity:0.5">ğŸ”’</span>' : `<button class="btn btn-drop" onclick="drop('${c.id}')">é€€é¸</button>`}
                        </td>
                    </tr>`;
            });
            document.getElementById('credits').innerText = `å·²é¸å­¸åˆ†: ${myC.reduce((a,b)=>a+parseInt(b.credit||0),0)}`;

            // 4. è‹±é›„æ¦œ (æ’åé‚è¼¯)
            renderLeaderboard();

            // 5. è¦–è¦ºåŒ–é€±èª²è¡¨
            renderGrid();

            // 6. æ­·å¹´æˆç¸¾
            let hHTML = '<table style="width:100%"><thead><tr><th>èª²ç¨‹</th><th>å­¸åˆ†</th><th>åˆ†æ•¸</th></tr></thead><tbody>';
            let hasScore = false;
            myC.forEach(c => {
                if(c.score) {
                    hasScore = true;
                    let color = c.score < 60 ? 'red' : 'green';
                    hHTML += `<tr><td>${c.name}</td><td>${c.credit}</td><td style="color:${color};font-weight:bold;">${c.score}</td></tr>`;
                }
            });
            hHTML += '</tbody></table>';
            document.getElementById('history-list').innerHTML = hasScore ? hHTML : '<div style="text-align:center;padding:20px;color:#999">å°šç„¡æˆç¸¾ç´€éŒ„</div>';
            
            // 7. æ¨è–¦èª²ç¨‹åˆ—è¡¨
            renderRecommendations();
        }

        // --- è·æ¶¯èˆ‡æ¨è–¦ç³»çµ± ---
        window.setTrack = (t) => {
            cur.careerTrack = t; 
            updateTrackUI();
            renderRecommendations(); // ç«‹å³åˆ·æ–°æ¨è–¦
        };
        
        function updateTrackUI() {
            const t = cur.careerTrack;
            const b1 = document.getElementById('btn-track-pilot');
            const b2 = document.getElementById('btn-track-ground');
            b1.style.borderColor = '#ddd'; b1.style.background = 'white';
            b2.style.borderColor = '#ddd'; b2.style.background = 'white';

            if(t === 'pilot') {
                b1.style.borderColor = '#00308F'; b1.style.background = '#e3f2fd';
                document.getElementById('rec-msg').innerText = "ç•¶å‰ç›®æ¨™ï¼šé£›è¡Œç”Ÿ (Pilot)";
            } else if(t === 'ground') {
                b2.style.borderColor = '#e65100'; b2.style.background = '#fff3e0';
                document.getElementById('rec-msg').innerText = "ç•¶å‰ç›®æ¨™ï¼šåœ°å‹¤ç”Ÿ (Ground)";
            }
        }

        function renderRecommendations() {
            const container = document.getElementById('rec-list-container');
            if(!cur.careerTrack) return;
            
            // ç°¡å–®çš„é—œéµå­—æ¨è–¦é‚è¼¯
            const keywords = cur.careerTrack === 'pilot' ? ['ç©ºæ°£', 'é£›è¡Œ', 'è‹±æ–‡', 'æ°£è±¡'] : ['ç®¡ç†', 'å¾Œå‹¤', 'æ©Ÿæ¢°', 'ç¶­ä¿®', 'è£œçµ¦'];
            
            const recs = allC.filter(c => {
                // æ’é™¤å·²é¸çš„
                if(myC.some(m => m.id === c.id)) return false;
                // æª¢æŸ¥åç¨±æ˜¯å¦åŒ…å«é—œéµå­—
                return keywords.some(k => c.name.includes(k));
            });

            if(recs.length === 0) {
                container.innerHTML = `<div style="padding:10px;text-align:center;">ç›®å‰æ²’æœ‰é‡å°ã€Œ${cur.careerTrack==='pilot'?'é£›è¡Œ':'åœ°å‹¤'}ã€çš„é¡å¤–æ¨è–¦é¸ä¿®èª²ã€‚</div>`;
            } else {
                container.innerHTML = recs.map(c => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                        <div>
                            <div style="font-weight:bold; color:var(--cafa-blue-main);">â˜… æ¨è–¦ï¼š${c.name}</div>
                            <div style="font-size:12px; color:#666;">${c.time} | ${c.credit}å­¸åˆ†</div>
                        </div>
                        <button class="btn btn-add" onclick="add('${c.id}')">åŠ é¸</button>
                    </div>
                `).join('');
            }
        }

        // --- AI Chat é‚è¼¯ (æœ¬åœ°ç«¯ NLP) ---
        window.send = function() { 
            const input = document.getElementById('chat-in');
            const txt = input.value.trim();
            if(!txt) return; 
            
            // User Message
            const body = document.getElementById('chat-body');
            body.innerHTML += `<div class="chat-msg msg-user">${txt}</div>`;
            input.value = '';
            body.scrollTop = body.scrollHeight;

            // AI Logic
            setTimeout(() => {
                let reply = "æŠ±æ­‰ï¼Œæˆ‘ä¸å¤ªç†è§£ã€‚æ‚¨å¯ä»¥å•æˆ‘é—œæ–¼ã€Œèª²ç¨‹æ™‚é–“ã€ã€ã€Œå­¸åˆ†ã€æˆ–ã€Œæ¨è–¦ã€çš„å•é¡Œã€‚";
                
                // 1. æŸ¥è©¢èª²ç¨‹æ™‚é–“ (e.g., "ç©ºæ°£å‹•åŠ›å­¸ä»€éº¼æ™‚å€™?")
                const courseQuery = allC.find(c => txt.includes(c.name) || (txt.includes("ä»€éº¼æ™‚å€™") && c.name.includes(txt.replace("ä»€éº¼æ™‚å€™","").trim())));
                
                if (txt.includes("æ’ä½") || txt.includes("ç­‰ç´š")) {
                    reply = "æ’ä½æ˜¯æ ¹æ“šä½ çš„ GPA æ±ºå®šçš„ï¼90åˆ†ä»¥ä¸Šæ˜¯ç‹è€…ï¼Œ80åˆ†æ˜¯é‘½çŸ³ï¼Œç¹¼çºŒåŠ æ²¹ï¼";
                } else if (txt.includes("å­¸åˆ†")) {
                    const total = myC.reduce((a,b)=>a+parseInt(b.credit||0),0);
                    reply = `ä½ ç›®å‰å·²é¸äº† ${total} å­¸åˆ†ã€‚`;
                } else if (txt.includes("æ¨è–¦") || txt.includes("é¸ä»€éº¼")) {
                     reply = cur.careerTrack ? `æ—¢ç„¶ä½ æ˜¯${cur.careerTrack==='pilot'?'é£›è¡Œ':'åœ°å‹¤'}ç”Ÿï¼Œæˆ‘å»ºè­°ä½ åƒè€ƒã€Œè·æ¶¯æ¨è–¦ã€åˆ†é ä¸­çš„èª²ç¨‹ï¼` : "è«‹å…ˆåˆ°ã€Œè·æ¶¯èˆ‡æ¨è–¦ã€è¨­å®šä½ çš„å¿—å‘ï¼Œæˆ‘æ‰èƒ½çµ¦ä½ å»ºè­°å–”ï¼";
                } else if (courseQuery) {
                    reply = `ã€Œ${courseQuery.name}ã€çš„æ™‚é–“æ˜¯ ${courseQuery.time}ï¼Œåœ°é»åœ¨ ${courseQuery.location||'æœªå®š'}ï¼Œæ˜¯${courseQuery.credit}å­¸åˆ†çš„${courseQuery.type}èª²ã€‚`;
                } else if (txt.includes("ä½ å¥½") || txt.includes("å—¨")) {
                    reply = "å—¨ï¼æˆ‘æ˜¯ CAFA AI åŠ©æ•™ï¼Œé¸èª²ä¸Šæœ‰ä»€éº¼å•é¡Œå—ï¼Ÿ";
                }

                body.innerHTML += `<div class="chat-msg msg-ai">${reply}</div>`; 
                body.scrollTop = body.scrollHeight;
            }, 600); 
        };

        // --- å·¥å…·å‡½å¼ ---
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            sb.classList.toggle('open');
            ov.classList.toggle('show');
        };
        
        window.switchTab = (id) => {
            ['selection','schedule','leaderboard','visual','career','history'].forEach(v=>document.getElementById(v+'-view').style.display='none');
            document.getElementById(id+'-view').style.display='block';
            document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active'));
            const map={'selection':0,'schedule':1,'leaderboard':2,'visual':3,'career':4,'history':5};
            if(document.querySelectorAll('.menu-item')[map[id]]) document.querySelectorAll('.menu-item')[map[id]].classList.add('active');
            
            // æ‰‹æ©Ÿç‰ˆè‡ªå‹•æ”¶åˆé¸å–®
            if(window.innerWidth <= 768) window.toggleSidebar();
        };

        window.logout = () => { sessionStorage.removeItem('cafa_user'); location.href='index.html'; };
        
        // --- æ ¸å¿ƒé‚è¼¯ (åŠ é€€é¸ã€å­˜æª”) ---
        window.add = async (id) => { 
            const c = allC.find(x=>x.id===id); 
            if(checkConflict(c)) return alert("è¡å ‚ï¼è©²æ™‚æ®µå·²æœ‰èª²ç¨‹ã€‚"); 
            myC.push(c); 
            await save(); 
            alert("åŠ é¸æˆåŠŸï¼");
            render(); 
        };
        
        window.drop = async (id) => { 
            if(!confirm("ç¢ºå®šè¦é€€é¸é€™é–€èª²å—ï¼Ÿ")) return;
            myC = myC.filter(x=>x.id!==id); 
            await save(); 
            render(); 
        };
        
        window.saveCareer = async () => {
            await save();
            alert("è·æ¶¯å¿—å‘å·²å„²å­˜ï¼AI å°‡ç‚ºæ‚¨é‡æ–°è¨ˆç®—æ¨è–¦èª²ç¨‹ã€‚");
        };

        async function save() { 
            const idx = sDB.findIndex(s=>s.id===cur.id); 
            if(idx>-1){
                sDB[idx].courses = myC; 
                sDB[idx].careerTrack = cur.careerTrack; 
                await saveToCloud(KEYS.STUDENTS, sDB);
            } 
        }

        // è¡å ‚æª¢æŸ¥ (æ”¯æ´ "ä¸€/3,4" æ ¼å¼)
        function checkConflict(newCourse) { 
            if(!newCourse.time) return false; 
            let [d1, p1] = newCourse.time.split('/'); 
            let periods1 = p1.split(','); 
            
            return myC.some(existing => {
                if(!existing.time) return false; 
                let [d2, p2] = existing.time.split('/'); 
                let periods2 = p2.split(','); 
                // åŒä¸€å¤© ä¸” ç¯€æ¬¡æœ‰é‡ç–Š
                return d1 === d2 && periods1.some(p => periods2.includes(p)); 
            }); 
        }

        function renderGrid() {
            const t = document.getElementById('visual-body'); t.innerHTML='';
            const dMap={"ä¸€":1,"äºŒ":2,"ä¸‰":3,"å››":4,"äº”":5};
            for(let i=1;i<=10;i++) {
                t.innerHTML += `<tr>
                    <td style="background:#f8f9fa;font-size:12px;">${i}</td>
                    <td id="c1-${i}"></td><td id="c2-${i}"></td><td id="c3-${i}"></td><td id="c4-${i}"></td><td id="c5-${i}"></td>
                </tr>`;
            }
            myC.forEach(c => {
                if(!c.time) return; let [d,p]=c.time.split('/'); let dy=dMap[d];
                p.split(',').forEach(x => { 
                    let el=document.getElementById(`c${dy}-${x}`); 
                    if(el) el.innerHTML=`<div class="course-block ${c.isFixed?'block-fixed':'block-normal'}">${c.name}<br>${c.location||''}</div>`; 
                });
            });
        }
        
        function renderLeaderboard() {
            const lbBody = document.getElementById('leaderboard-body'); lbBody.innerHTML = '';
            let list = sDB.map(s => {
                let sTot=0, sCr=0; (s.courses||[]).forEach(c=>{if(c.score){sTot+=parseInt(c.score)*parseInt(c.credit); sCr+=parseInt(c.credit);}});
                let sGpa = sCr>0 ? (sTot/sCr) : -1;
                let sRank = rules.find(r=>sGpa>=r.min) || rules[rules.length-1];
                if(sCr===0) sRank = {name:'æ–°é€²å­¸å“¡', color:'#eee'};
                return { name: s.name, classId: s.classId||s.dept||'-', rank: sRank, gpa: sGpa, id: s.id };
            });
            list.sort((a,b) => b.gpa - a.gpa);
            list.forEach((d, i) => {
                let rowClass = d.id === cur.id ? 'background:#fff8e1;' : '';
                let badge = `<span style="background:${d.rank.color};padding:4px 8px;border-radius:12px;font-size:12px;font-weight:bold;">${d.rank.name}</span>`;
                if(d.gpa === -1) badge = '<span style="color:#ccc;font-size:12px;">å°šç„¡æˆç¸¾</span>';
                lbBody.innerHTML += `<tr style="${rowClass}">
                    <td>${i+1}</td><td><span class="tag tag-fixed">${d.classId}</span></td><td style="font-weight:bold">${d.name}</td><td>${badge}</td>
                </tr>`;
            });
        }

        // é è¨­ Rank è¦å‰‡
        function getDefaultRanks() { return [{name:'ç‹è€…', min:90, color:'#ffe0b2', reward:'ç¦®åˆ¸', punishment:''}, {name:'é‘½çŸ³', min:80, color:'#b3e5fc', reward:'', punishment:''}, {name:'é»ƒé‡‘', min:70, color:'#fff9c4', reward:'', punishment:''}, {name:'ç™½éŠ€', min:60, color:'#f5f5f5', reward:'', punishment:''}, {name:'é’éŠ…', min:0, color:'#ffccbc', reward:'', punishment:''}]; }
    </script>
</body>
</html>
