<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¸èª²ä¸»ç³»çµ± | CAFA Student</title>
    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸ --- */
        :root { --cafa-blue-dark: #002266; --cafa-blue-main: #00308F; --cafa-blue-light: #4a7bd1; --cafa-gold: #FFD700; --bg-grey: #f0f2f5; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; margin: 0; background-color: var(--bg-grey); color: #333; display: flex; height: 100vh; overflow: hidden; }
        
        /* --- æ‰‹æ©Ÿç‰ˆæ¼¢å ¡é¸å–®æŒ‰éˆ• --- */
        .mobile-menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 1100; background: var(--cafa-blue-main); color: white; border: none; padding: 10px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; font-size: 20px; }
        
        /* --- å´é‚Šæ¬„ --- */
        .sidebar { width: 260px; background: linear-gradient(180deg, var(--cafa-blue-main) 0%, var(--cafa-blue-dark) 100%); color: white; display: flex; flex-direction: column; padding-top: 25px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); position: relative; z-index: 1000; transition: transform 0.3s ease; }
        .sidebar-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .menu-item { padding: 15px 25px; cursor: pointer; transition: 0.2s; color: rgba(255,255,255,0.8); display: flex; align-items: center; font-size: 15px; }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { background: rgba(0,0,0,0.2); border-left: 5px solid var(--cafa-gold); color: white; font-weight: bold; }
        .menu-item span { margin-right: 12px; font-size: 18px; width: 25px; text-align: center; }
        
        /* --- æ’ä½å¡ --- */
        .rank-card { background: rgba(0,0,0,0.2); margin: 10px 15px; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .rank-name { font-size: 20px; font-weight: 800; color: var(--cafa-gold); text-shadow: 0 2px 4px rgba(0,0,0,0.3); margin: 5px 0; letter-spacing: 1px; }
        
        /* --- ä¸»å…§å®¹å€ --- */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; background-image: linear-gradient(to bottom, #eef2f7, #f4f7fa); position: relative; width: 100%; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); flex-wrap: wrap; gap: 10px; }
        .header-title { font-size: 22px; font-weight: bold; color: var(--cafa-blue-main); border-left: 6px solid var(--cafa-gold); padding-left: 12px; }
        
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-top: 3px solid var(--cafa-blue-light); box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow-x: auto; }
        
        /* --- èˆˆè¶£æ¨™ç±¤èˆ‡è¼¸å…¥æ¡† (æ–°) --- */
        .interest-section { margin-bottom: 15px; }
        .interest-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .interest-tag { padding: 6px 14px; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; transition: 0.2s; background: white; font-size: 13px; color: #666; user-select: none; display: flex; align-items: center; }
        .interest-tag:hover { background: #f0f0f0; }
        .interest-tag.active { background: var(--cafa-gold); color: #002266; border-color: var(--cafa-gold); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tag-remove { margin-left: 5px; font-size: 14px; opacity: 0.6; padding: 0 4px; border-radius: 50%; }
        .tag-remove:hover { background: rgba(0,0,0,0.1); opacity: 1; }

        .custom-input-group { display: flex; gap: 8px; max-width: 400px; margin-top: 10px; }
        .custom-input-group input { flex: 1; padding: 8px 15px; border: 1px solid #ccc; border-radius: 20px; outline: none; font-size: 14px; }
        .custom-input-group input:focus { border-color: var(--cafa-blue-main); }
        .btn-small-add { background: var(--cafa-blue-main); color: white; border: none; border-radius: 20px; padding: 0 15px; cursor: pointer; font-weight: bold; }

        /* --- è¡¨æ ¼èˆ‡å…ƒä»¶ --- */
        table { width: 100%; min-width: 600px; border-collapse: separate; border-spacing: 0; font-size: 14px; }
        th { background: #f8f9fa; color: var(--cafa-blue-dark); padding: 12px; text-align: left; border-bottom: 2px solid var(--cafa-blue-main); white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; white-space: nowrap; }
        .tag-compulsory { background: #e3f2fd; color: #0d47a1; } .tag-elective { background: #e8f5e9; color: #1b5e20; } .tag-fixed { background: #fff3e0; color: #e65100; }
        
        .btn { padding: 8px 16px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 14px; white-space: nowrap; }
        .btn:active { transform: scale(0.95); }
        .btn-add { background: #28a745; color: white; } .btn-drop { background: #dc3545; color: white; }
        .btn-save { background: var(--cafa-blue-main); color: white; width: 100%; padding: 14px; margin-top:20px; font-size: 16px; box-shadow: 0 4px 10px rgba(0,48,143,0.3); }

        /* --- èª²è¡¨ --- */
        .schedule-table { min-width: 800px; table-layout: fixed; }
        .schedule-table th { text-align: center; }
        .schedule-table td { height: 60px; padding: 2px; text-align: center; vertical-align: top; border: 1px solid #eee; }
        .course-block { padding: 4px; border-radius: 6px; color: white; font-size: 11px; margin-bottom: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.15); line-height: 1.3; overflow: hidden; height: 95%; display: flex; flex-direction: column; justify-content: center; }
        .block-fixed { background: linear-gradient(135deg, #e65100, #ff9800); }
        .block-normal { background: linear-gradient(135deg, var(--cafa-blue-main), var(--cafa-blue-light)); }

        /* --- AI Chat --- */
        .ai-fab { position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px; background: linear-gradient(45deg, #00308F, #0055ff); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 28px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 2000; transition: transform 0.2s; }
        .chat-window { position: fixed; bottom: 85px; right: 20px; width: 90%; max-width: 350px; height: 50vh; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); display: none; flex-direction: column; z-index: 2000; border: 1px solid rgba(0,0,0,0.05); overflow: hidden; }
        .chat-header { padding: 15px; background: var(--cafa-blue-main); color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; font-size: 14px; }
        .chat-msg { margin-bottom: 10px; max-width: 80%; padding: 8px 12px; border-radius: 12px; line-height: 1.4; word-wrap: break-word; }
        .msg-user { background: #e3f2fd; color: #00308F; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
        .msg-ai { background: white; color: #333; border: 1px solid #eee; align-self: flex-start; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .chat-input { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 10px; background: white; }
        .chat-input input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; }

        /* --- RWD --- */
        @media (max-width: 768px) {
            .mobile-menu-btn { display: block; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); width: 80%; max-width: 300px; }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; }
            .sidebar-overlay.show { display: block; }
            .main-content { padding: 70px 15px 15px 15px; }
            .header-bar { flex-direction: column; align-items: flex-start; }
            .theme-controls { display: none; }
            .rank-card { margin-top: 50px; }
            .card { padding: 15px; border-radius: 10px; }
        }

        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 3000; color: var(--cafa-blue-main); flex-direction: column; }
    </style>
</head>
<body>
    <div id="loading"><div style="font-size:40px; margin-bottom:10px;">â˜ï¸</div><div>è³‡æ–™åŒæ­¥ä¸­...</div></div>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div style="text-align:right; padding:10px; display:none;" id="close-menu"><span onclick="toggleSidebar()" style="color:white; font-size:24px; cursor:pointer;">&times;</span></div>
        <div class="sidebar-header"><h2>âœˆï¸ CAFA</h2><p>Student Portal</p></div>
        
        <div class="rank-card">
            <div style="font-size:12px;color:#ccc">æˆ‘çš„æ’ä½ (Rank)</div>
            <div class="rank-name" id="my-rank-name">è¨ˆç®—ä¸­...</div>
            <div id="my-reward" class="rank-reward" style="font-size:13px; color:#a5d6a7; margin-top:5px;"></div>
            <div id="my-punish" class="rank-punish" style="font-size:13px; color:#ef9a9a;"></div>
        </div>

        <div class="menu-item active" onclick="switchTab('selection')"><span>ğŸ›’</span> åŠ é€€é¸èª²ç¨‹</div>
        <div class="menu-item" onclick="switchTab('schedule')"><span>ğŸ“…</span> å·²é¸æ¸…å–®</div>
        <div class="menu-item" onclick="switchTab('leaderboard')"><span>ğŸ†</span> è‹±é›„æ¦œ</div> 
        <div class="menu-item" onclick="switchTab('visual')"><span>ğŸ“Š</span> è¦–è¦ºåŒ–èª²è¡¨</div>
        <div class="menu-item" onclick="switchTab('career')"><span>ğŸ¯</span> è·æ¶¯èˆ‡æ¨è–¦</div>
        <div class="menu-item" onclick="switchTab('history')"><span>ğŸ“ˆ</span> æ­·å¹´æˆç¸¾</div>
        <div class="menu-item" onclick="logout()" style="margin-top:auto; border-top:1px solid rgba(255,255,255,0.1)"><span>ğŸšª</span> ç™»å‡ºç³»çµ±</div>
    </div>

    <div class="main-content">
        <div id="selection-view">
            <div class="header-bar"><div class="header-title">é–‹æ”¾é¸èª²</div><span id="credits" style="font-weight:bold;color:#00308F; font-size:14px;">è¨ˆç®—ä¸­...</span></div>
            <div class="card"><table style="width:100%"><tbody id="course-list"></tbody></table></div>
        </div>

        <div id="schedule-view" style="display:none">
            <div class="header-bar"><div class="header-title">æˆ‘çš„å·²é¸èª²ç¨‹</div></div>
            <div class="card"><table style="width:100%"><tbody id="my-courses"></tbody></table></div>
        </div>

        <div id="leaderboard-view" style="display:none">
            <div class="header-bar"><div class="header-title">ğŸ† å…¨æ ¡æ¦®è­½è‹±é›„æ¦œ</div></div>
            <div class="card">
                <p style="color:#666; font-size:13px; text-align:center; padding-bottom:10px; border-bottom:1px solid #eee;">ä¾ç…§å¹³å‡ç©åˆ†(GPA)æ’åºï¼Œåƒ…é¡¯ç¤ºæ’ä½ç¨±è™Ÿä»¥ä¿éšœéš±ç§ã€‚</p>
                <table><thead><tr><th width="15%">æ’å</th><th>ç­ç´š</th><th>å§“å</th><th>æ¦®è­½æ’ä½</th></tr></thead><tbody id="leaderboard-body"></tbody></table>
            </div>
        </div>

        <div id="visual-view" style="display:none">
            <div class="header-bar">
                <div class="header-title">é€±èª²è¡¨</div>
                <div class="theme-controls">
                    <span style="font-size:12px;margin:0 10px;">èƒŒæ™¯:</span>
                    <div class="theme-btn tb-white" onclick="setTheme('white')"></div><div class="theme-btn tb-blue" onclick="setTheme('blue')"></div><div class="theme-btn tb-dark" onclick="setTheme('dark')"></div>
                </div>
            </div>
            <div class="card" id="visual-card">
                <table class="schedule-table"><thead><tr><th style="width:40px">ç¯€</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr></thead><tbody id="visual-body"></tbody></table>
            </div>
        </div>

        <div id="career-view" style="display:none">
            <div class="header-bar"><div class="header-title">è·æ¶¯èˆ‡æ¨è–¦ç³»çµ±</div></div>
            <div class="card">
                <h3>æ­¥é©Ÿ 1: è¨­å®šæœªä¾†å¿—å‘</h3>
                <div style="display:flex;gap:15px;margin-bottom:20px; flex-wrap:wrap;">
                    <button id="btn-track-pilot" class="btn" style="flex:1; padding:20px; border:2px solid #ddd; background:white; color:#333;" onclick="setTrack('pilot')">
                        <div style="font-size:24px;">ğŸ¦…</div><div>é£›è¡Œç”Ÿ (Pilot)</div>
                    </button>
                    <button id="btn-track-ground" class="btn" style="flex:1; padding:20px; border:2px solid #ddd; background:white; color:#333;" onclick="setTrack('ground')">
                        <div style="font-size:24px;">ğŸ› ï¸</div><div>åœ°å‹¤ç”Ÿ (Ground)</div>
                    </button>
                </div>

                <h3>æ­¥é©Ÿ 2: é¸æ“‡æˆ–æ–°å¢èˆˆè¶£</h3>
                <div class="interest-section">
                    <div style="font-size:12px; color:#666; margin-bottom:5px;">å¸¸è¦‹æ¨™ç±¤ (é»æ“Šé¸æ“‡):</div>
                    <div class="interest-container" id="preset-tags-container">
                        </div>
                </div>
                
                <div class="interest-section">
                    <div style="font-size:12px; color:#666; margin-bottom:5px;">è‡ªå®šç¾©æ¨™ç±¤:</div>
                    <div class="interest-container" id="custom-tags-container">
                        </div>
                    <div class="custom-input-group">
                        <input type="text" id="new-interest-input" placeholder="è¼¸å…¥å…¶ä»–èˆˆè¶£ (å¦‚: ç„¡äººæ©Ÿã€AI)">
                        <button class="btn-small-add" onclick="addCustomInterest()">ï¼‹ æ–°å¢</button>
                    </div>
                </div>

                <div id="rec-msg" style="color:var(--cafa-blue-main); font-weight:bold; margin-top:20px; border-top:1px solid #eee; padding-top:15px;"></div>
                <button class="btn btn-save" onclick="saveCareer()">ğŸ’¾ å„²å­˜æ‰€æœ‰è¨­å®š</button>
            </div>
            <div class="card">
                <h3>ğŸ¯ æ™ºèƒ½æ¨è–¦èª²ç¨‹</h3>
                <div id="rec-list-container" style="color:#666; font-size:14px;">è«‹è¨­å®šä¸Šæ–¹å¿—å‘èˆ‡èˆˆè¶£ï¼Œç³»çµ±å°‡è‡ªå‹•åˆ†æ...</div>
            </div>
        </div>

        <div id="history-view" style="display:none">
            <div class="header-bar"><div class="header-title">æ­·å¹´æˆç¸¾å–®</div></div>
            <div class="card" id="history-list"></div>
        </div>
    </div>

    <div class="ai-fab" onclick="toggleChat()">ğŸ¤–</div>
    <div class="chat-window" id="chat-win">
        <div class="chat-header">CAFA AI åŠ©æ•™ <span style="cursor:pointer" onclick="toggleChat()">âœ•</span></div>
        <div class="chat-body" id="chat-body"><div class="chat-msg msg-ai">åŒå­¸ä½ å¥½ï¼æˆ‘æ˜¯é¸èª²å°å¹«æ‰‹ã€‚ä½ å¯ä»¥å•æˆ‘ï¼šã€Œæ¨è–¦é¸ä»€éº¼èª²ï¼Ÿã€ã€ã€Œæˆ‘æœ‰å¹¾å­¸åˆ†ï¼Ÿã€</div></div>
        <div class="chat-input"><input id="chat-in" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="if(event.key=='Enter')send()"><button class="btn btn-add" style="width:auto; padding:0 15px;" onclick="send()">â¤</button></div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud } from './firebase-connect.js';
        const KEYS = { STUDENTS:'cafa_all_students_db', FIXED:'cafa_fixed_courses', ELECTIVE:'cafa_public_electives', RANKS:'cafa_rank_rules' };
        
        let allC=[], myC=[], cur=null, sDB=[], rules=[];
        const PRESET_TAGS = ['ç©ºæ°£å‹•åŠ›', 'æ©Ÿæ¢°', 'è‹±æ–‡', 'ç®¡ç†', 'ç¨‹å¼', 'æ°£è±¡', 'æ­·å²', 'å¿ƒç†'];

        window.onload = async () => {
            const u = sessionStorage.getItem('cafa_user'); 
            if(!u) return location.href='index.html';
            cur = JSON.parse(u);
            if(!cur.interests) cur.interests = []; 
            
            try { await sync(); } catch (e) { console.error(e); alert("é€£ç·šç•°å¸¸"); } finally { document.getElementById('loading').style.display = 'none'; }
        };

        async function sync() {
            sDB = (await loadFromCloud(KEYS.STUDENTS))||[];
            rules = (await loadFromCloud(KEYS.RANKS))||getDefaultRanks();
            allC = [...((await loadFromCloud(KEYS.FIXED))||[]), ...((await loadFromCloud(KEYS.ELECTIVE))||[])];

            const me = sDB.find(s=>s.id===cur.id); 
            if(me){ 
                cur = me; 
                if(!cur.interests) cur.interests = [];
                myC = (me.courses||[]).filter(my => allC.some(school => school.id === my.id));
            }
            render();
            updateTrackUI();
            renderInterestTags(); // æ¸²æŸ“æ¨™ç±¤
        }

        function render() {
            // Rank
            let tot=0, cr=0; myC.forEach(c=>{if(c.score){tot+=parseInt(c.score)*parseInt(c.credit); cr+=parseInt(c.credit);}});
            let gpa = cr>0 ? (tot/cr).toFixed(1) : 0;
            let rank = rules.find(r=>gpa>=r.min) || rules[rules.length-1];
            if(cr===0) rank = {name:'æ–°é€²å­¸å“¡', color:'#ccc', reward:'-', punishment:'-'};
            document.getElementById('my-rank-name').innerText = rank.name; document.getElementById('my-rank-name').style.color = rank.color;
            document.getElementById('my-reward').innerText = rank.reward ? `ğŸ ${rank.reward}` : ''; document.getElementById('my-punish').innerText = rank.punishment ? `âš ï¸ ${rank.punishment}` : '';

            // Courses
            const tb = document.getElementById('course-list'); tb.innerHTML='';
            allC.filter(c => !c.isFixed && c.isOpen).forEach(c => {
                const has = myC.some(x=>x.id===c.id);
                tb.innerHTML += `<tr><td><span class="tag tag-elective">é¸ä¿®</span></td><td><div style="font-weight:bold;">${c.name}</div><div style="font-size:12px;color:#666;">${c.time} | ${c.credit}å­¸åˆ†</div></td><td style="text-align:right;">${has ? '<span style="color:green;font-weight:bold;">å·²é¸</span>' : `<button class="btn btn-add" onclick="add('${c.id}')">åŠ é¸</button>`}</td></tr>`;
            });

            // My List
            const mtb = document.getElementById('my-courses'); mtb.innerHTML='';
            myC.forEach(c => {
                mtb.innerHTML += `<tr><td><span class="tag ${c.isFixed?'tag-fixed':'tag-elective'}">${c.isFixed?'å¿…ä¿®':'é¸ä¿®'}</span></td><td><div style="font-weight:bold;">${c.name}</div><div style="font-size:12px;color:#666;">${c.location||''}</div></td><td>${c.time}</td><td style="text-align:right;">${c.isFixed ? 'ğŸ”’' : `<button class="btn btn-drop" onclick="drop('${c.id}')">é€€</button>`}</td></tr>`;
            });
            document.getElementById('credits').innerText = `å·²é¸å­¸åˆ†: ${myC.reduce((a,b)=>a+parseInt(b.credit||0),0)}`;

            renderLeaderboard(); renderGrid();
            
            let hHTML = '<table style="width:100%"><thead><tr><th>èª²ç¨‹</th><th>å­¸åˆ†</th><th>åˆ†æ•¸</th></tr></thead><tbody>';
            let hasScore = false; myC.forEach(c=>{if(c.score){hasScore=true; hHTML+=`<tr><td>${c.name}</td><td>${c.credit}</td><td style="color:${c.score<60?'red':'green'}">${c.score}</td></tr>`;}});
            document.getElementById('history-list').innerHTML = hasScore ? hHTML+'</tbody></table>' : '<div style="text-align:center;padding:20px;color:#999">å°šç„¡æˆç¸¾ç´€éŒ„</div>';
            
            renderRecommendations();
        }

        // --- è·æ¶¯èˆ‡èˆˆè¶£ç³»çµ± (å‡ç´šç‰ˆ) ---
        window.setTrack = (t) => { cur.careerTrack = t; updateTrackUI(); renderRecommendations(); };
        
        // æ¸²æŸ“æ¨™ç±¤ä»‹é¢
        function renderInterestTags() {
            const pCont = document.getElementById('preset-tags-container');
            const cCont = document.getElementById('custom-tags-container');
            pCont.innerHTML = ''; cCont.innerHTML = '';

            // 1. æ¸²æŸ“å¸¸è¦‹é è¨­æ¨™ç±¤
            PRESET_TAGS.forEach(tag => {
                const isActive = cur.interests.includes(tag);
                pCont.innerHTML += `<div class="interest-tag ${isActive?'active':''}" onclick="toggleInterest('${tag}')">${tag}</div>`;
            });

            // 2. æ¸²æŸ“ä½¿ç”¨è€…è‡ªè¨‚æ¨™ç±¤ (æ’é™¤é è¨­çš„)
            const customTags = cur.interests.filter(i => !PRESET_TAGS.includes(i));
            if(customTags.length === 0) cCont.innerHTML = '<span style="font-size:12px;color:#999;padding:5px;">å°šç„¡è‡ªå®šç¾©æ¨™ç±¤</span>';
            
            customTags.forEach(tag => {
                cCont.innerHTML += `<div class="interest-tag active" onclick="toggleInterest('${tag}')">${tag} <span class="tag-remove">âœ•</span></div>`;
            });
        }

        // æ–°å¢/åˆªé™¤ èˆˆè¶£é‚è¼¯
        window.toggleInterest = (tag) => {
            if(cur.interests.includes(tag)) {
                cur.interests = cur.interests.filter(t => t !== tag);
            } else {
                cur.interests.push(tag);
            }
            renderInterestTags();
            updateTrackUI();
            renderRecommendations();
        };

        // æ–°å¢è‡ªå®šç¾©æŒ‰éˆ•é‚è¼¯
        window.addCustomInterest = () => {
            const input = document.getElementById('new-interest-input');
            const val = input.value.trim();
            if(!val) return;
            if(cur.interests.includes(val)) return alert("æ­¤èˆˆè¶£å·²ç¶“åœ¨æ¸…å–®ä¸­å›‰ï¼");
            
            cur.interests.push(val);
            input.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
            renderInterestTags();
            updateTrackUI();
            renderRecommendations();
        };

        function updateTrackUI() {
            const t = cur.careerTrack;
            const b1 = document.getElementById('btn-track-pilot'), b2 = document.getElementById('btn-track-ground');
            b1.style.borderColor='#ddd'; b1.style.background='white'; b2.style.borderColor='#ddd'; b2.style.background='white';
            if(t === 'pilot') { b1.style.borderColor='#00308F'; b1.style.background='#e3f2fd'; }
            if(t === 'ground') { b2.style.borderColor='#e65100'; b2.style.background='#fff3e0'; }
            
            const count = cur.interests.length;
            document.getElementById('rec-msg').innerText = `ç•¶å‰è¨­å®šï¼š${t==='pilot'?'é£›è¡Œç”Ÿ':'åœ°å‹¤ç”Ÿ'} (å·²è¨­å®š ${count} å€‹èˆˆè¶£é—œéµå­—)`;
        }

        function renderRecommendations() {
            const container = document.getElementById('rec-list-container');
            if(!cur.careerTrack) return;
            
            // åŸºç¤é—œéµå­—
            let keywords = cur.careerTrack === 'pilot' ? ['ç©ºæ°£', 'é£›è¡Œ', 'è‹±æ–‡', 'æ°£è±¡'] : ['ç®¡ç†', 'å¾Œå‹¤', 'æ©Ÿæ¢°', 'ç¶­ä¿®'];
            // åŠ ä¸Šä½¿ç”¨è€…é¸çš„èˆˆè¶£æ¨™ç±¤
            if(cur.interests && cur.interests.length > 0) {
                keywords = [...keywords, ...cur.interests];
            }
            
            const recs = allC.filter(c => {
                if(myC.some(m => m.id === c.id)) return false;
                // åªè¦èª²ç¨‹åç¨±åŒ…å«ä»»ä¸€é—œéµå­—
                return keywords.some(k => c.name.includes(k));
            });

            if(recs.length === 0) {
                container.innerHTML = `<div style="padding:10px;text-align:center;">æ ¹æ“šæ‚¨çš„ã€Œ${cur.interests.join('ã€')}ã€ç­‰èˆˆè¶£ï¼Œç›®å‰æ²’æœ‰ç›¸ç¬¦çš„é¸ä¿®èª²ã€‚</div>`;
            } else {
                container.innerHTML = recs.map(c => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                        <div><div style="font-weight:bold; color:var(--cafa-blue-main);">â˜… æ¨è–¦ï¼š${c.name}</div><div style="font-size:12px; color:#666;">${c.time} | ${c.credit}å­¸åˆ†</div></div>
                        <button class="btn btn-add" onclick="add('${c.id}')">åŠ é¸</button>
                    </div>`).join('');
            }
        }

        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('show'); };
        window.switchTab = (id) => {
            ['selection','schedule','leaderboard','visual','career','history'].forEach(v=>document.getElementById(v+'-view').style.display='none');
            document.getElementById(id+'-view').style.display='block';
            document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active'));
            const map={'selection':0,'schedule':1,'leaderboard':2,'visual':3,'career':4,'history':5};
            if(document.querySelectorAll('.menu-item')[map[id]]) document.querySelectorAll('.menu-item')[map[id]].classList.add('active');
            if(window.innerWidth <= 768) window.toggleSidebar();
        };

        window.logout = () => { sessionStorage.removeItem('cafa_user'); location.href='index.html'; };
        
        window.add = async (id) => { const c=allC.find(x=>x.id===id); if(checkConflict(c))return alert("è¡å ‚ï¼"); myC.push(c); await save(); alert("åŠ é¸æˆåŠŸ"); render(); };
        window.drop = async (id) => { if(!confirm("ç¢ºå®šé€€é¸?"))return; myC=myC.filter(x=>x.id!==id); await save(); render(); };
        
        window.saveCareer = async () => { await save(); alert("è·æ¶¯èˆ‡èˆˆè¶£è¨­å®šå·²å„²å­˜ï¼"); };
        async function save() { const idx = sDB.findIndex(s=>s.id===cur.id); if(idx>-1){ sDB[idx].courses=myC; sDB[idx].careerTrack=cur.careerTrack; sDB[idx].interests=cur.interests; await saveToCloud(KEYS.STUDENTS, sDB); } }

        function checkConflict(n) { if(!n.time)return false; let [d1,p1]=n.time.split('/'); let pp1=p1.split(','); return myC.some(o=>{if(!o.time)return false; let [d2,p2]=o.time.split('/'); return d1===d2 && pp1.some(p=>p2.split(',').includes(p)); }); }
        
        function renderGrid() {
            const t = document.getElementById('visual-body'); t.innerHTML='';
            const dMap={"ä¸€":1,"äºŒ":2,"ä¸‰":3,"å››":4,"äº”":5};
            for(let i=1;i<=10;i++) t.innerHTML += `<tr><td style="background:#f8f9fa;font-size:12px;">${i}</td><td id="c1-${i}"></td><td id="c2-${i}"></td><td id="c3-${i}"></td><td id="c4-${i}"></td><td id="c5-${i}"></td></tr>`;
            myC.forEach(c => { if(!c.time)return; let [d,p]=c.time.split('/'); let dy=dMap[d]; p.split(',').forEach(x => { let el=document.getElementById(`c${dy}-${x}`); if(el) el.innerHTML=`<div class="course-block ${c.isFixed?'block-fixed':'block-normal'}">${c.name}<br>${c.location||''}</div>`; }); });
        }
        
        function renderLeaderboard() {
            const lbBody = document.getElementById('leaderboard-body'); lbBody.innerHTML = '';
            let list = sDB.map(s => {
                let sTot=0, sCr=0; (s.courses||[]).forEach(c=>{if(c.score){sTot+=parseInt(c.score)*parseInt(c.credit); sCr+=parseInt(c.credit);}});
                let sGpa = sCr>0 ? (sTot/sCr) : -1;
                let sRank = rules.find(r=>sGpa>=r.min) || rules[rules.length-1];
                if(sCr===0) sRank = {name:'æ–°é€²å­¸å“¡', color:'#eee'};
                return { name: s.name, classId: s.classId||s.dept||'-', rank: sRank, gpa: sGpa, id: s.id };
            });
            list.sort((a,b) => b.gpa - a.gpa);
            list.forEach((d, i) => {
                let rowClass = d.id === cur.id ? 'background:#fff8e1;' : '';
                let badge = `<span style="background:${d.rank.color};padding:4px 8px;border-radius:12px;font-size:12px;font-weight:bold;">${d.rank.name}</span>`;
                if(d.gpa === -1) badge = '<span style="color:#ccc;font-size:12px;">å°šç„¡æˆç¸¾</span>';
                lbBody.innerHTML += `<tr style="${rowClass}"><td>${i+1}</td><td><span class="tag tag-fixed">${d.classId}</span></td><td style="font-weight:bold">${d.name}</td><td>${badge}</td></tr>`;
            });
        }
        function getDefaultRanks() { return [{name:'ç‹è€…', min:90, color:'#ffe0b2', reward:'ç¦®åˆ¸', punishment:''}, {name:'é‘½çŸ³', min:80, color:'#b3e5fc', reward:'', punishment:''}, {name:'é»ƒé‡‘', min:70, color:'#fff9c4', reward:'', punishment:''}, {name:'ç™½éŠ€', min:60, color:'#f5f5f5', reward:'', punishment:''}, {name:'é’éŠ…', min:0, color:'#ffccbc', reward:'', punishment:''}]; }

        // Chat
        window.send = function() { 
            const i=document.getElementById('chat-in'); const txt=i.value.trim(); if(!txt)return; 
            const b=document.getElementById('chat-body'); b.innerHTML+=`<div class="chat-msg msg-user">${txt}</div>`; i.value=''; b.scrollTop=b.scrollHeight;
            setTimeout(()=>{
                let r="è«‹æ´½æ•™å‹™è™•";
                if(txt.includes("æ’ä½")||txt.includes("ç­‰ç´š")) r="æ’ä½æ˜¯æ ¹æ“šä½ çš„ GPA æ±ºå®šçš„ï¼90åˆ†ä»¥ä¸Šæ˜¯ç‹è€…ã€‚";
                else if(txt.includes("å­¸åˆ†")) r=`ä½ ç›®å‰å·²é¸äº† ${myC.reduce((a,b)=>a+parseInt(b.credit||0),0)} å­¸åˆ†ã€‚`;
                else if(txt.includes("æ¨è–¦")||txt.includes("é¸ä»€éº¼")) r=cur.careerTrack?`å»ºè­°åƒè€ƒã€Œè·æ¶¯æ¨è–¦ã€é é¢ï¼Œæˆ‘ä¹Ÿæœƒæ ¹æ“šä½ çš„èˆˆè¶£æ¨™ç±¤ã€Œ${cur.interests.join('ã€')}ã€ä¾†æ‰¾èª²ï¼`:"è«‹å…ˆè¨­å®šå¿—å‘èˆ‡èˆˆè¶£ï¼";
                else { const c=allC.find(x=>txt.includes(x.name)); if(c) r=`ã€Œ${c.name}ã€åœ¨${c.time}ï¼Œæ˜¯${c.credit}å­¸åˆ†ã€‚`; }
                b.innerHTML+=`<div class="chat-msg msg-ai">${r}</div>`; b.scrollTop=b.scrollHeight;
            },600); 
        };
    </script>
</body>
</html>
