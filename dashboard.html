<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¸èª²ä¸»ç³»çµ± | CAFA Student</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; margin: 0; background-color: #f4f7fa; color: #333; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 250px; background-color: #00308F; color: white; display: flex; flex-direction: column; padding-top: 20px; }
        .sidebar-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.2); margin-bottom: 20px; }
        .menu-item { padding: 15px 25px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; font-size: 15px; }
        .menu-item:hover, .menu-item.active { background-color: #0044CC; border-left: 4px solid #FFD700; }
        .student-info { margin-top: auto; padding: 20px; background-color: #002266; font-size: 13px; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header-title { font-size: 24px; font-weight: bold; color: #00308F; border-left: 5px solid #00308F; padding-left: 15px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
        
        /* è¡¨æ ¼èˆ‡æ¨™ç±¤ */
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #555; }
        .tag { padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .tag-compulsory { background: #e3f2fd; color: #0d47a1; } 
        .tag-elective { background: #e8f5e9; color: #1b5e20; } 
        .tag-fixed { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        
        /* æŒ‰éˆ• */
        .btn { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 13px; }
        .btn-add { background: #28a745; color: white; } 
        .btn-drop { background: #dc3545; color: white; } 
        .btn-print { background: #6c757d; color: white; }
        .btn-disabled { background: #ccc; cursor: not-allowed; color: #666; }

        /* å¯è¦–åŒ–èª²è¡¨ */
        .schedule-table { text-align: center; table-layout: fixed; }
        .schedule-table td { height: 80px; border: 1px solid #ccc; vertical-align: middle; padding: 5px; background: #fff; }
        .schedule-table th { background: #00308F; color: white; border: 1px solid #ccc; }
        .course-block { padding: 5px; border-radius: 4px; color: white; height: 100%; display: flex; flex-direction: column; justify-content: center; font-size: 12px; }
        .block-fixed { background-color: #c62828; } .block-normal { background-color: #1976d2; }

        /* æˆç¸¾å–® */
        .semester-title { background-color: #e3f2fd; padding: 10px; font-weight: bold; color: #0d47a1; margin-top: 20px; border-radius: 4px; }
        .score-high { color: green; font-weight: bold; } .score-fail { color: red; font-weight: bold; }
        .gpa-box { background: #333; color: #FFD700; padding: 15px; border-radius: 8px; display: inline-block; margin-bottom: 20px; font-size: 18px; }

        @media print { .sidebar, .btn, .header-bar input { display: none !important; } .main-content { padding: 0; } .card { box-shadow: none; border:none; } }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header"><h2>CAFA é¸èª²ç³»çµ±</h2><p>114å­¸å¹´åº¦ ç¬¬1å­¸æœŸ</p></div>
        <div class="menu-item active" onclick="switchTab('selection')">ğŸ›’ åŠ é€€é¸èª²ç¨‹</div>
        <div class="menu-item" onclick="switchTab('schedule')">ğŸ“… å·²é¸æ¸…å–®</div>
        <div class="menu-item" onclick="switchTab('visual')">ğŸ“Š å¯è¦–åŒ–èª²è¡¨</div>
        <div class="menu-item" onclick="switchTab('history')">ğŸ“ˆ æ­·å¹´æˆç¸¾</div>
        <div class="menu-item" onclick="window.location.href='index.html'">ğŸšª ç™»å‡ºç³»çµ±</div>
        <div class="student-info">å­¸è™Ÿï¼š1140052<br>å§“åï¼šæå¤§ç¶­ å­¸ç”Ÿ<br>ç³»ç´šï¼šèˆªå¤ªç³»ä¸‰å¹´ç´š</div>
    </div>

    <div class="main-content">
        <div id="selection-view">
            <div class="header-bar"><div class="header-title">é–‹æ”¾é¸èª²æ¸…å–®</div><span style="color:#00308F;font-weight:bold;">å·²é¸å­¸åˆ†ï¼š<span id="current-credits">0</span></span></div>
            <div class="card"><table style="width:100%"><thead><tr><th>é¸åˆ¥</th><th>èª²è™Ÿ</th><th>èª²ç¨‹åç¨±</th><th>å­¸åˆ†</th><th>æ™‚é–“</th><th>åé¡</th><th>æ“ä½œ</th></tr></thead><tbody id="course-list-body"></tbody></table></div>
        </div>
        <div id="schedule-view" style="display: none;">
            <div class="header-bar"><div class="header-title">å·²é¸èª²ç¨‹åˆ—è¡¨</div></div>
            <div class="card"><table style="width:100%"><thead><tr><th>é¸åˆ¥</th><th>èª²ç¨‹åç¨±</th><th>å­¸åˆ†</th><th>æ™‚é–“</th><th>åœ°é»</th><th>æ“ä½œ</th></tr></thead><tbody id="my-course-body"></tbody></table></div>
        </div>
        <div id="visual-view" style="display: none;">
            <div class="header-bar"><div class="header-title">é€±èª²è¡¨æª¢è¦–</div><button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button></div>
            <div class="card"><table class="schedule-table" style="width:100%"><thead><tr><th style="width:80px;">ç¯€æ¬¡</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr></thead><tbody id="visual-schedule-body"></tbody></table></div>
        </div>
        <div id="history-view" style="display: none;">
            <div class="header-bar"><div class="header-title">æ­·å¹´æˆç¸¾æŸ¥è©¢</div><button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°æˆç¸¾å–®</button></div>
            <div class="gpa-box">ç¸½å¹³å‡ (GPA): <span id="total-gpa">--</span></div>
            <div id="history-content"></div>
        </div>
    </div>

    <script>
        let allCourses = [];
        let myCourses = [];
        const currentUser = { id: "1140052", name: "æå¤§ç¶­", dept: "èˆªå¤ªç³»ä¸‰å¹´ç´š" };
        const mockHistory = [
            { semester: "112å­¸å¹´åº¦ ç¬¬2å­¸æœŸ", courses: [{ name: "å¾®ç©åˆ†(äºŒ)", credit: 3, score: 85, type: "å¿…ä¿®" }, { name: "æ™®é€šç‰©ç†", credit: 3, score: 78, type: "å¿…ä¿®" }] },
            { semester: "113å­¸å¹´åº¦ ç¬¬1å­¸æœŸ", courses: [{ name: "å·¥ç¨‹æ•¸å­¸", credit: 3, score: 68, type: "å¿…ä¿®" }] }
        ];

        window.onload = function() { 
            allCourses = []; 
            loadFixedCourses(); loadPublicElectives(); syncFromCloud(); 
            renderCourseList(); saveToCloud(); generateEmptyScheduleGrid();
        };

        function syncFromCloud() {
            let db = JSON.parse(localStorage.getItem('cafa_all_students_db')) || [];
            let me = db.find(s => s.id === currentUser.id);
            if (me && me.courses) {
                me.courses.forEach(cloudCourse => {
                    let localCourse = myCourses.find(c => c.id === cloudCourse.id);
                    if (localCourse) localCourse.score = cloudCourse.score; // åŒæ­¥æˆç¸¾
                    else myCourses.push(cloudCourse); // åŒæ­¥æ–°å¢çš„èª²ç¨‹
                });
            }
        }
        
        function loadPublicElectives() {
            const d = localStorage.getItem('cafa_public_electives');
            if(d) JSON.parse(d).forEach(c => { c.capacity=50; c.enrolled=0; allCourses.push(c); });
        }
        function loadFixedCourses() {
            const d = localStorage.getItem('cafa_fixed_courses');
            if(d) JSON.parse(d).forEach(c => { if(!myCourses.some(mc=>mc.id===c.id)) myCourses.push(c); });
        }

        function renderCourseList() {
            const tbody = document.getElementById('course-list-body'); tbody.innerHTML='';
            allCourses.forEach(c => {
                const isSelected = myCourses.some(mc=>mc.id===c.id);
                const isOpen = (c.isOpen !== false); // é è¨­ç‚º true
                
                let btnHtml = '';
                if(isSelected) btnHtml = `<button class="btn btn-disabled" disabled>å·²é¸</button>`;
                else if(!isOpen) btnHtml = `<button class="btn btn-disabled" disabled>â›” æš«åœé¸èª²</button>`;
                else btnHtml = `<button class="btn btn-add" onclick="add('${c.id}')">åŠ é¸</button>`;

                const tagClass = c.type==='å¿…ä¿®'?'tag-compulsory':'tag-elective';
                tbody.innerHTML += `<tr><td><span class="tag ${tagClass}">${c.type}</span></td><td>${c.id}</td><td>${c.name}</td><td>${c.credit}</td><td>${c.time}</td><td>${c.enrolled}/${c.capacity}</td><td>${btnHtml}</td></tr>`;
            });
            document.getElementById('current-credits').innerText = myCourses.reduce((s,c)=>s+c.credit,0);
        }

        function saveToCloud() {
            let db = JSON.parse(localStorage.getItem('cafa_all_students_db')) || [];
            const data = { id: currentUser.id, name: currentUser.name, dept: currentUser.dept, courses: myCourses, totalCredits: myCourses.reduce((s,c)=>s+c.credit,0), lastUpdate: new Date().toLocaleString() };
            const idx = db.findIndex(s => s.id === currentUser.id);
            if(idx>-1) db[idx]=data; else db.push(data);
            localStorage.setItem('cafa_all_students_db', JSON.stringify(db));
        }

        function renderMySchedule() {
            const tbody = document.getElementById('my-course-body'); tbody.innerHTML='';
            myCourses.forEach(c => {
                let isFixed = c.isFixed===true;
                tbody.innerHTML += `<tr><td><span class="tag ${isFixed?'tag-fixed':(c.type==='å¿…ä¿®'?'tag-compulsory':'tag-elective')}">${c.type}</span></td><td>${c.name}</td><td>${c.credit}</td><td>${c.time}</td><td>${c.location||''}</td><td>${isFixed?'<span style="color:red">ğŸ”’</span>':`<button class="btn btn-drop" onclick="drop('${c.id}')">é€€</button>`}</td></tr>`;
            });
        }
        function add(id) { 
            const c=allCourses.find(x=>x.id===id); 
            if(checkTime(c)) { alert("è¡å ‚ï¼"); return; }
            myCourses.push(c); saveToCloud(); renderCourseList(); renderMySchedule(); 
        }
        function drop(id) { if(confirm("é€€é¸?")) { myCourses=myCourses.filter(c=>c.id!==id); saveToCloud(); renderCourseList(); renderMySchedule(); } }
        
        function checkTime(newC) {
             if(!newC.time) return false;
             let [d1, p1] = newC.time.split('/');
             let periods1 = p1.split(',');
             for(let oldC of myCourses) {
                 if(!oldC.time) continue;
                 let [d2, p2] = oldC.time.split('/');
                 if(d1 === d2 && periods1.some(p => p2.split(',').includes(p))) return true;
             }
             return false;
        }

        function generateEmptyScheduleGrid() {
            const t = document.getElementById('visual-schedule-body'); t.innerHTML='';
            const times = ["08:10", "09:10", "10:10", "11:10", "13:30", "14:30", "15:30", "16:30", "17:30", "19:00"];
            for(let i=1;i<=10;i++) t.innerHTML+=`<tr><td style="background:#f0f0f0;font-size:12px;">ç¬¬${i}ç¯€<br>${times[i-1]}</td><td id="c1-${i}"></td><td id="c2-${i}"></td><td id="c3-${i}"></td><td id="c4-${i}"></td><td id="c5-${i}"></td></tr>`;
        }
        function renderVisual() {
            generateEmptyScheduleGrid();
            const dayMap = {"ä¸€":1,"äºŒ":2,"ä¸‰":3,"å››":4,"äº”":5};
            myCourses.forEach(c => {
                if(!c.time) return;
                let [dayStr, pStr] = c.time.split('/');
                let day = dayMap[dayStr];
                pStr.split(',').forEach(p => {
                    let el = document.getElementById(`c${day}-${p}`);
                    if(el) el.innerHTML = `<div class="course-block ${c.isFixed?'block-fixed':'block-normal'}">${c.name}<br><small>${c.location||''}</small></div>`;
                });
            });
        }
        function renderHistory() {
            const container = document.getElementById('history-content'); container.innerHTML = '';
            let totalScore=0, totalCredits=0;
            mockHistory.forEach(sem => {
                let html = `<div class="card"><div class="semester-title">${sem.semester}</div><table><thead><tr><th>èª²ç¨‹</th><th>å­¸åˆ†</th><th>æˆç¸¾</th></tr></thead><tbody>`;
                sem.courses.forEach(c => { totalScore+=c.score*c.credit; totalCredits+=c.credit; html+=`<tr><td>${c.name}</td><td>${c.credit}</td><td class="${c.score<60?'score-fail':'score-high'}">${c.score}</td></tr>`; });
                html+=`</tbody></table></div>`; container.innerHTML+=html;
            });
            const currentGraded = myCourses.filter(c => c.score !== undefined && c.score !== null && c.score !== '');
            if(currentGraded.length>0) {
                let html = `<div class="card"><div class="semester-title">æœ¬å­¸æœŸ</div><table><thead><tr><th>èª²ç¨‹</th><th>å­¸åˆ†</th><th>æˆç¸¾</th></tr></thead><tbody>`;
                currentGraded.forEach(c => { let s=parseInt(c.score); totalScore+=s*c.credit; totalCredits+=c.credit; html+=`<tr><td>${c.name}</td><td>${c.credit}</td><td class="${s<60?'score-fail':'score-high'}">${s}</td></tr>`; });
                html+=`</tbody></table></div>`; container.innerHTML = html + container.innerHTML;
            }
            document.getElementById('total-gpa').innerText = totalCredits>0 ? (totalScore/totalCredits).toFixed(2) : "0.0";
        }
        function switchTab(tab) {
            ['selection','schedule','visual','history'].forEach(v => document.getElementById(v+'-view').style.display='none');
            document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
            if(tab==='selection') { document.getElementById('selection-view').style.display='block'; renderCourseList(); }
            if(tab==='schedule') { document.getElementById('schedule-view').style.display='block'; renderMySchedule(); }
            if(tab==='visual') { document.getElementById('visual-view').style.display='block'; renderVisual(); }
            if(tab==='history') { syncFromCloud(); document.getElementById('history-view').style.display='block'; renderHistory(); }
        }
    </script>
</body>
</html>