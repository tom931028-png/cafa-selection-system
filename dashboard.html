<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¸èª²ä¸»ç³»çµ± | CAFA Student</title>
    <style>
        /* --- ä¸»é¡Œèˆ‡åŸºç¤æ¨£å¼ --- */
        :root { --cafa-blue-dark: #002266; --cafa-blue-main: #00308F; --cafa-blue-light: #4a7bd1; --cafa-gold: #FFD700; --bg-grey: #f0f2f5; }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; margin: 0; background-color: var(--bg-grey); color: #333; display: flex; height: 100vh; overflow: hidden; }
        
        /* å´é‚Šæ¬„ */
        .sidebar { width: 260px; background: linear-gradient(180deg, var(--cafa-blue-main) 0%, var(--cafa-blue-dark) 100%); color: white; display: flex; flex-direction: column; padding-top: 25px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .sidebar-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .menu-item { padding: 15px 30px; cursor: pointer; transition: 0.3s; color: rgba(255,255,255,0.8); display: flex; align-items: center; }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { background: rgba(0,0,0,0.2); border-left: 4px solid var(--cafa-gold); color: white; font-weight: bold; }
        .menu-item span { margin-right: 12px; font-size: 18px; }
        
        /* æ’ä½å¡ (å€‹äºº) */
        .rank-card { background: rgba(0,0,0,0.2); margin: 10px 15px; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .rank-name { font-size: 18px; font-weight: bold; color: var(--cafa-gold); text-shadow: 0 2px 4px rgba(0,0,0,0.3); margin: 5px 0; }
        .rank-reward { font-size: 12px; color: #a5d6a7; margin-top: 5px; } 
        .rank-punish { font-size: 12px; color: #ef9a9a; }

        /* ä¸»å…§å®¹ */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background-image: linear-gradient(to bottom, #eef2f7, #f4f7fa); }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header-title { font-size: 24px; font-weight: bold; color: var(--cafa-blue-main); border-left: 8px solid var(--cafa-gold); padding-left: 15px; }
        .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; border-top: 3px solid var(--cafa-blue-light); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* è¡¨æ ¼ */
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; }
        th { background: #f8f9fa; color: var(--cafa-blue-dark); padding: 15px; text-align: left; border-bottom: 2px solid var(--cafa-blue-main); }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .tag-compulsory { background: #e3f2fd; color: #0d47a1; } .tag-elective { background: #e8f5e9; color: #1b5e20; } .tag-fixed { background: #fff3e0; color: #e65100; }
        
        /* æŒ‰éˆ• */
        .btn { padding: 8px 16px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn:hover { transform: translateY(-1px); }
        .btn-add { background: #28a745; color: white; } .btn-drop { background: #dc3545; color: white; }
        .btn-save { background: var(--cafa-blue-main); color: white; width: 100%; padding: 12px; margin-top:20px; }
        .btn-print { background: #607d8b; color: white; margin-left: 10px; }

        /* è‹±é›„æ¦œå°ˆç”¨æ¨£å¼ */
        .rank-badge-display { padding: 6px 12px; border-radius: 20px; font-weight: bold; color: #333; display: inline-block; min-width: 80px; text-align: center; border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .row-me { background-color: #fff8e1; border-left: 5px solid var(--cafa-gold); } /* å¼·èª¿è‡ªå·± */
        .rank-icon { font-size: 20px; margin-right: 10px; }

        /* å…¶ä»–ä»‹é¢å…ƒä»¶ */
        .career-option { display: flex; gap: 20px; margin-bottom: 20px; }
        .radio-card { flex: 1; border: 2px solid #eee; padding: 20px; border-radius: 10px; cursor: pointer; text-align: center; transition: 0.3s; }
        .radio-card.selected { border-color: var(--cafa-blue-main); background: #e3f2fd; box-shadow: 0 0 0 2px var(--cafa-blue-main); }
        .interest-tags { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        .interest-check { display: none; }
        .interest-label { padding: 8px 16px; background: #eee; border-radius: 20px; cursor: pointer; }
        .interest-check:checked + .interest-label { background: var(--cafa-gold); color: black; font-weight: bold; }

        /* èª²è¡¨ */
        .schedule-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .schedule-table th { text-align: center; background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); padding: 10px; }
        .schedule-table td { height: 60px; border: 1px solid rgba(0,0,0,0.1); padding: 5px; vertical-align: top; text-align: center; }
        .course-block { padding: 5px; border-radius: 4px; color: white; font-size: 12px; margin-bottom: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .block-fixed { background: linear-gradient(135deg, #e65100, #ff9800); }
        .block-normal { background: linear-gradient(135deg, var(--cafa-blue-main), var(--cafa-blue-light)); }
        
        /* èƒŒæ™¯åˆ‡æ›ç´ */
        .theme-controls { display: flex; gap: 10px; align-items: center; margin-right: auto; }
        .theme-btn { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #ddd; }
        .tb-white { background: white; } .tb-blue { background: #e3f2fd; } .tb-warm { background: #fff8e1; } .tb-dark { background: #333; }
        .card-theme-blue { background: linear-gradient(to bottom right, #f0f7ff, #dbeafe) !important; border-color: #1e88e5 !important; position: relative; }
        .card-theme-blue::before { content: 'âœˆ'; position: absolute; font-size: 200px; color: rgba(0,0,0,0.03); top: 50px; left: 100px; pointer-events: none; transform: rotate(-15deg); }
        .card-theme-warm { background: #fffdeb !important; border-color: #fdd835 !important; }
        .card-theme-dark { background: #2c3e50 !important; color: #ecf0f1 !important; border-color: #34495e !important; }
        .card-theme-dark th { background: #34495e !important; color: white !important; }
        .card-theme-dark td { border-color: #465c71 !important; }

        /* AI Chat */
        .ai-fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #00308F; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 999; }
        .chat-window { position: fixed; bottom: 100px; right: 30px; width: 320px; height: 450px; background: white; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); display: none; flex-direction: column; z-index: 999; border: 1px solid #ddd; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; }
        .chat-input { padding: 10px; border-top: 1px solid #eee; display: flex; }
        .chat-input input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 20px; }

        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 999; color: var(--cafa-blue-main); flex-direction: column; }
        
        @media print { .sidebar, .header-bar, .ai-fab, .chat-window, .theme-controls, .btn { display: none !important; } .main-content { padding: 0; background: white; } body { background: white; } .card { box-shadow: none; border: 1px solid #ccc; -webkit-print-color-adjust: exact; } .card-theme-dark { background: white !important; color: black !important; } .card-theme-dark th { background: #f8f9fa !important; color: black !important; } }
    </style>
</head>
<body>
    <div id="loading">
        <div style="font-size:40px; margin-bottom:10px;">â˜ï¸</div>
        <div>è³‡æ–™åŒæ­¥ä¸­...</div>
    </div>
    
    <div class="sidebar">
        <div class="sidebar-header"><h2>âœˆï¸ CAFA</h2><p>Student Portal</p></div>
        
        <div class="rank-card">
            <div style="font-size:12px;color:#ccc">æˆ‘çš„æ’ä½ (Rank)</div>
            <div class="rank-name" id="my-rank-name">è¨ˆç®—ä¸­...</div>
            <div id="my-reward" class="rank-reward"></div>
            <div id="my-punish" class="rank-punish"></div>
        </div>

        <div class="menu-item active" onclick="switchTab('selection')"><span>ğŸ›’</span> åŠ é€€é¸èª²ç¨‹</div>
        <div class="menu-item" onclick="switchTab('schedule')"><span>ğŸ“…</span> å·²é¸æ¸…å–®</div>
        <div class="menu-item" onclick="switchTab('leaderboard')"><span>ğŸ†</span> è‹±é›„æ¦œ</div> <div class="menu-item" onclick="switchTab('visual')"><span>ğŸ“Š</span> å¯è¦–åŒ–èª²è¡¨</div>
        <div class="menu-item" onclick="switchTab('career')"><span>ğŸ¯</span> è·æ¶¯èˆ‡æ¨è–¦</div>
        <div class="menu-item" onclick="switchTab('history')"><span>ğŸ“ˆ</span> æ­·å¹´æˆç¸¾</div>
        <div class="menu-item" onclick="logout()" style="margin-top:auto"><span>ğŸšª</span> ç™»å‡º</div>
    </div>

    <div class="main-content">
        <div id="selection-view">
            <div class="header-bar"><div class="header-title">é–‹æ”¾é¸èª²</div><span id="credits" style="font-weight:bold;color:#00308F"></span></div>
            <div class="card"><table style="width:100%"><tbody id="course-list"></tbody></table></div>
        </div>

        <div id="schedule-view" style="display:none">
            <div class="header-bar"><div class="header-title">æˆ‘çš„èª²è¡¨</div></div>
            <div class="card"><table style="width:100%"><tbody id="my-courses"></tbody></table></div>
        </div>

        <div id="leaderboard-view" style="display:none">
            <div class="header-bar"><div class="header-title">ğŸ† å…¨æ ¡æ¦®è­½è‹±é›„æ¦œ</div></div>
            <div class="card">
                <p style="color:#666; font-size:13px; text-align:center;">
                    èªªæ˜ï¼šæ­¤åˆ—è¡¨ä¾ç…§æ’ä½é«˜ä½æ’åºï¼Œåƒ…é¡¯ç¤ºæ¦®è­½ä½éšï¼Œä¸å…¬é–‹å…·é«”åˆ†æ•¸ï¼Œä»¥ä¿éšœåŒå­¸éš±ç§ã€‚
                </p>
                <table>
                    <thead><tr><th width="10%">æ’å</th><th>ç­ç´š</th><th>å§“å</th><th>æ¦®è­½æ’ä½</th></tr></thead>
                    <tbody id="leaderboard-body"></tbody>
                </table>
            </div>
        </div>

        <div id="visual-view" style="display:none">
            <div class="header-bar">
                <div class="header-title">é€±èª²è¡¨</div>
                <div class="theme-controls">
                    <span style="font-size:12px;margin:0 10px;">èƒŒæ™¯:</span>
                    <div class="theme-btn tb-white" onclick="setTheme('white')"></div>
                    <div class="theme-btn tb-blue" onclick="setTheme('blue')"></div>
                    <div class="theme-btn tb-warm" onclick="setTheme('warm')"></div>
                    <div class="theme-btn tb-dark" onclick="setTheme('dark')"></div>
                </div>
                <button class="btn btn-print" onclick="window.print()">åˆ—å°</button>
            </div>
            <div class="card" id="visual-card">
                <div style="text-align:center;font-weight:bold;font-size:18px;margin-bottom:10px;">114-1 èª²è¡¨</div>
                <table class="schedule-table">
                    <thead><tr><th style="width:60px">ç¯€</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr></thead>
                    <tbody id="visual-body"></tbody>
                </table>
            </div>
        </div>

        <div id="career-view" style="display:none">
            <div class="header-bar"><div class="header-title">è·æ¶¯è¦åŠƒ</div></div>
            <div class="card">
                <h3>æ–¹å‘é¸æ“‡</h3>
                <div style="display:flex;gap:10px;margin-bottom:15px;">
                    <button class="btn btn-add" onclick="setTrack('pilot')">ğŸ¦… é£›è¡Œç”Ÿ</button>
                    <button class="btn btn-add" style="background:#e65100" onclick="setTrack('ground')">ğŸ› ï¸ åœ°å‹¤ç”Ÿ</button>
                </div>
                <div id="rec-msg" style="color:#666"></div>
                <button class="btn btn-save" onclick="saveCareer()">ğŸ’¾ å„²å­˜</button>
            </div>
            <div class="card"><h3>æ¨è–¦èª²ç¨‹</h3><div id="rec-list"></div></div>
        </div>

        <div id="history-view" style="display:none">
            <div class="header-bar"><div class="header-title">æˆç¸¾</div></div>
            <div class="card" id="history-list"></div>
        </div>
    </div>

    <div class="ai-fab" onclick="toggleChat()">ğŸ¤–</div>
    <div class="chat-window" id="chat-win">
        <div style="padding:10px;background:#00308F;color:white;font-weight:bold">AI å°å¹«æ‰‹ <span style="float:right;cursor:pointer" onclick="toggleChat()">X</span></div>
        <div class="chat-body" id="chat-body">ä½ å¥½ï¼é¸èª²æˆ–æ’ä½å•é¡Œéƒ½å¯ä»¥å•æˆ‘å–”ï¼</div>
        <div class="chat-input"><input id="chat-in" onkeypress="if(event.key=='Enter')send()"><button onclick="send()">â¤</button></div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud } from './firebase-connect.js';
        const KEYS = { STUDENTS:'cafa_all_students_db', FIXED:'cafa_fixed_courses', ELECTIVE:'cafa_public_electives', RANKS:'cafa_rank_rules' };
        let allC=[], myC=[], cur=null, sDB=[], rules=[];

        window.onload = async () => {
            const u = sessionStorage.getItem('cafa_user'); 
            if(!u) return location.href='index.html';
            cur = JSON.parse(u);
            
            try {
                await sync();
            } catch (e) {
                console.error(e);
                alert("è³‡æ–™è¼‰å…¥ç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
            } finally {
                // âš ï¸ é—œéµä¿®æ­£ï¼šç¢ºä¿è®€å–ç•«é¢ä¸€å®šæœƒé—œé–‰
                document.getElementById('loading').style.display = 'none';
            }
        };
        
        window.switchTab = (id) => {
            ['selection','schedule','leaderboard','visual','career','history'].forEach(v=>document.getElementById(v+'-view').style.display='none');
            document.getElementById(id+'-view').style.display='block';
            document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active'));
            const map={'selection':0,'schedule':1,'leaderboard':2,'visual':3,'career':4,'history':5};
            document.querySelectorAll('.menu-item')[map[id]].classList.add('active');
        };

        window.logout = () => { sessionStorage.removeItem('cafa_user'); location.href='index.html'; };
        window.setTheme = (t) => { const c=document.getElementById('visual-card'); c.className='card'; if(t!=='white')c.classList.add(`card-theme-${t}`); };
        
        // åŠŸèƒ½ç¶å®š
        window.add=add; window.drop=drop; window.setTrack=setTrack; window.saveCareer=saveCareer; 
        window.toggleChat=toggleChat; window.send=send;

        async function sync() {
            sDB = (await loadFromCloud(KEYS.STUDENTS))||[];
            const me = sDB.find(s=>s.id===cur.id); if(me){ cur=me; myC=me.courses||[]; }
            const el = (await loadFromCloud(KEYS.ELECTIVE))||[]; allC=[]; el.forEach(c=>{c.capacity=50;c.enrolled=0;allC.push(c)});
            rules = (await loadFromCloud(KEYS.RANKS))||getDefaultRanks();
            render();
        }
        
        function getDefaultRanks() {
            return [
                {name:'ç‹è€… (Challenger)', min:90, color:'#ffe0b2', reward:'ç¦®åˆ¸', punishment:''},
                {name:'é‘½çŸ³ (Diamond)', min:80, color:'#b3e5fc', reward:'', punishment:''},
                {name:'é»ƒé‡‘ (Gold)', min:70, color:'#fff9c4', reward:'', punishment:''},
                {name:'ç™½éŠ€ (Silver)', min:60, color:'#f5f5f5', reward:'', punishment:''},
                {name:'é’éŠ… (Bronze)', min:0, color:'#ffccbc', reward:'', punishment:''}
            ];
        }

        async function save() { const i=sDB.findIndex(s=>s.id===cur.id); if(i>-1){sDB[i].courses=myC; sDB[i].careerTrack=cur.careerTrack; await saveToCloud(KEYS.STUDENTS, sDB);} }

        function render() {
            // 1. My Rank
            let tot=0, cr=0; myC.forEach(c=>{if(c.score){tot+=c.score*c.credit; cr+=c.credit;}});
            let gpa = cr>0 ? (tot/cr).toFixed(1) : 0;
            let rank = rules.find(r=>gpa>=r.min) || rules[rules.length-1];
            if(cr===0) rank = {name:'æ–°é€²å­¸å“¡', color:'#ccc', reward:'-', punishment:'-'};
            
            document.getElementById('my-rank-name').innerText = rank.name;
            document.getElementById('my-rank-name').style.color = rank.color;
            document.getElementById('my-reward').innerText = rank.reward ? `ğŸ ${rank.reward}` : '';
            document.getElementById('my-punish').innerText = rank.punishment ? `âš ï¸ ${rank.punishment}` : '';

            // 2. Leaderboard Logic (æ ¸å¿ƒæ–°åŠŸèƒ½)
            const lbBody = document.getElementById('leaderboard-body');
            lbBody.innerHTML = '';
            
            // è¨ˆç®—æ‰€æœ‰äººçš„æ’ä½ (ä½†ä¸å­˜åˆ†æ•¸)
            let leaderboardData = sDB.map(s => {
                let sTot=0, sCr=0; (s.courses||[]).forEach(c=>{if(c.score){sTot+=c.score*c.credit; sCr+=c.credit;}});
                let sGpa = sCr>0 ? (sTot/sCr) : -1; // -1 ä»£è¡¨ç„¡æˆç¸¾
                let sRank = rules.find(r=>sGpa>=r.min) || rules[rules.length-1];
                if(sCr===0) sRank = {name:'æ–°é€²å­¸å“¡', color:'#eee'};
                return { name: s.name, classId: s.classId||s.dept||'-', rank: sRank, gpa: sGpa, id: s.id };
            });

            // æ’åºï¼šæœ‰æˆç¸¾çš„æ’å‰é¢ï¼ŒGPA é«˜çš„æ’å‰é¢
            leaderboardData.sort((a,b) => b.gpa - a.gpa);

            leaderboardData.forEach((d, index) => {
                // å¦‚æœæ˜¯è‡ªå·±ï¼ŒåŠ äº®é¡¯ç¤º
                let rowClass = d.id === cur.id ? 'row-me' : '';
                let rankIcon = '';
                if(index===0) rankIcon='ğŸ‘‘ '; else if(index===1) rankIcon='ğŸ¥ˆ '; else if(index===2) rankIcon='ğŸ¥‰ ';
                
                let badge = `<span class="rank-badge-display" style="background:${d.rank.color}">${d.rank.name}</span>`;
                if(d.gpa === -1) badge = '<span style="color:#ccc">å°šç„¡æˆç¸¾</span>';

                lbBody.innerHTML += `
                    <tr class="${rowClass}">
                        <td style="font-weight:bold; color:#666;">${rankIcon}#${index+1}</td>
                        <td><span class="tag tag-fixed" style="background:#673ab7;color:white;">${d.classId}</span></td>
                        <td style="font-weight:bold;">${d.name}</td>
                        <td>${badge}</td>
                    </tr>
                `;
            });

            // 3. Courses List
            const tb = document.getElementById('course-list'); tb.innerHTML='';
            allC.forEach(c => {
                const has = myC.some(x=>x.id===c.id);
                tb.innerHTML+=`<tr><td><span class="tag tag-elective">é¸ä¿®</span></td><td>${c.id}</td><td>${c.name}</td><td>${c.credit}</td><td>${c.time}</td><td>${has?'å·²é¸':`<button class="btn btn-add" onclick="add('${c.id}')">åŠ é¸</button>`}</td></tr>`;
            });
            
            // 4. My Courses
            const mtb = document.getElementById('my-courses'); mtb.innerHTML='';
            myC.forEach(c => {
                mtb.innerHTML+=`<tr><td><span class="tag ${c.isFixed?'tag-fixed':'tag-elective'}">${c.isFixed?'å¿…ä¿®':'é¸ä¿®'}</span></td><td>${c.name}</td><td>${c.credit}</td><td>${c.time}</td><td>${c.location||''}</td><td>${c.isFixed?'ğŸ”’':`<button class="btn btn-drop" onclick="drop('${c.id}')">é€€</button>`}</td></tr>`;
            });
            document.getElementById('credits').innerText = 'å·²é¸å­¸åˆ†: '+myC.reduce((a,b)=>a+b.credit,0);
            
            // 5. Grid & History
            renderGrid();
            let h=''; myC.filter(c=>c.score).forEach(c=>h+=`<div><b>${c.name}</b>: ${c.score}</div>`);
            document.getElementById('history-list').innerHTML = h||'<div style="text-align:center;padding:20px;color:#999">å°šç„¡æˆç¸¾</div>';
            document.getElementById('rec-msg').innerText = cur.careerTrack ? `æ–¹å‘ï¼š${cur.careerTrack==='pilot'?'é£›è¡Œ':'åœ°å‹¤'}` : 'è«‹é¸æ“‡';
        }

        // åŸºæœ¬æ“ä½œ
        async function add(id) { const c=allC.find(x=>x.id===id); if(check(c))return alert("è¡å ‚"); myC.push(c); await save(); render(); }
        async function drop(id) { if(confirm("é€€?")){myC=myC.filter(x=>x.id!==id); await save(); render();} }
        function check(n) { if(!n.time)return false; let [d1,p1]=n.time.split('/'); let pp1=p1.split(','); return myC.some(o=>{if(!o.time)return false; let [d2,p2]=o.time.split('/'); let pp2=p2.split(','); return d1===d2 && pp1.some(p=>pp2.includes(p)); }); }
        
        async function setTrack(t) { cur.careerTrack=t; await save(); alert("å·²è¨­å®š"); render(); }
        async function saveCareer() { alert("èˆˆè¶£å·²å„²å­˜"); } // ç°¡åŒ–å±•ç¤º

        // Grid
        function renderGrid() {
            const t = document.getElementById('visual-body'); t.innerHTML='';
            const dMap={"ä¸€":1,"äºŒ":2,"ä¸‰":3,"å››":4,"äº”":5};
            for(let i=1;i<=10;i++) t.innerHTML+=`<tr><td style="background:#f8f9fa;">${i}</td><td id="c1-${i}"></td><td id="c2-${i}"></td><td id="c3-${i}"></td><td id="c4-${i}"></td><td id="c5-${i}"></td></tr>`;
            myC.forEach(c => {
                if(!c.time) return; let [d,p]=c.time.split('/'); let dy=dMap[d];
                p.split(',').forEach(x => { let el=document.getElementById(`c${dy}-${x}`); if(el) el.innerHTML=`<div class="course-block ${c.isFixed?'block-fixed':'block-normal'}">${c.name}</div>`; });
            });
        }

        // Chat
        function toggleChat() { const w=document.getElementById('chat-win'); w.style.display=w.style.display==='flex'?'none':'flex'; }
        function send() { 
            const i=document.getElementById('chat-in'); if(!i.value)return; 
            const b=document.getElementById('chat-body'); b.innerHTML+=`<div>Q: ${i.value}</div>`; 
            setTimeout(()=>{
                let r="è«‹æ´½æ•™å‹™è™•";
                if(i.value.includes("æ’ä½")) r="æ’ä½æ˜¯æ ¹æ“šä½ çš„å¹³å‡æˆç¸¾(GPA)è¨ˆç®—çš„ï¼Œ90åˆ†ä»¥ä¸Šæ˜¯ç‹è€…å–”ï¼";
                b.innerHTML+=`<div>A: ${r}</div>`; b.scrollTop=b.scrollHeight;
            },500); 
            i.value=''; 
        }
    </script>
</body>
</html>







