<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¸èª²ç³»çµ± | Student</title>
    <style>
        :root { --main: #00308F; --bg: #f0f2f5; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 250px; background: var(--main); color: white; padding-top: 20px; display: flex; flex-direction: column; }
        .menu-item { padding: 15px; cursor: pointer; transition: 0.2s; }
        .menu-item.active, .menu-item:hover { background: rgba(255,255,255,0.2); font-weight: bold; border-left: 5px solid gold; }
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-add { background: #28a745; } .btn-drop { background: #dc3545; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td, th { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .chat-btn { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--main); border-radius: 50%; color: white; font-size: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .chat-win { position: fixed; bottom: 90px; right: 20px; width: 300px; height: 400px; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: none; flex-direction: column; overflow: hidden; }
        .chat-body { flex: 1; padding: 10px; overflow-y: auto; background: #f9f9f9; }
        .msg { padding: 8px; margin: 5px; border-radius: 5px; font-size: 14px; max-width: 80%; }
        .msg-ai { background: white; border: 1px solid #ddd; align-self: flex-start; }
        .msg-me { background: #dbeafe; align-self: flex-end; margin-left: auto; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div style="text-align:center; margin-bottom:20px;"><h2>âœˆï¸ CAFA</h2></div>
        <div class="menu-item active" onclick="switchTab('selection')">ğŸ›’ åŠ é€€é¸</div>
        <div class="menu-item" onclick="switchTab('schedule')">ğŸ“… æˆ‘çš„èª²è¡¨</div>
        <div class="menu-item" onclick="switchTab('grades')">ğŸ† æˆç¸¾èˆ‡æ’ä½</div>
        <div class="menu-item" onclick="switchTab('career')">ğŸ¯ è·æ¶¯æ¨è–¦</div>
        <div class="menu-item" onclick="logout()" style="margin-top:auto;">ğŸšª ç™»å‡º</div>
    </div>

    <div class="main">
        <h2 id="welcome-msg">Welcome</h2>
        
        <div id="selection-view">
            <div class="card">
                <h3>é–‹æ”¾é¸èª²åˆ—è¡¨</h3>
                <div id="course-list">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <div id="schedule-view" style="display:none">
            <div class="card">
                <h3>å·²é¸èª²ç¨‹</h3>
                <table><thead><tr><th>åç¨±</th><th>æ™‚é–“</th><th>åœ°é»</th><th>å­¸åˆ†</th><th>æ“ä½œ</th></tr></thead><tbody id="my-list"></tbody></table>
            </div>
        </div>

        <div id="grades-view" style="display:none">
            <div class="card">
                <h3>ğŸ–ï¸ å€‹äººæˆ°ç¸¾</h3>
                <h1 id="my-rank" style="color:gold; text-shadow: 1px 1px 2px black;">è¨ˆç®—ä¸­...</h1>
                <p>ç›®å‰ GPA: <span id="my-gpa">-</span></p>
                <table><thead><tr><th>èª²ç¨‹</th><th>å­¸åˆ†</th><th>åˆ†æ•¸</th></tr></thead><tbody id="score-list"></tbody></table>
            </div>
        </div>

        <div id="career-view" style="display:none">
            <div class="card">
                <h3>ğŸ¯ è·æ¶¯è·¯å¾‘è¨­å®š</h3>
                <p>è«‹é¸æ“‡ä½ çš„ç›®æ¨™ï¼Œç³»çµ±å°‡æ¨è–¦é©åˆçš„é¸ä¿®èª²ã€‚</p>
                <button class="btn" style="background:#00308F; width:45%; padding:20px;" onclick="setTrack('pilot')">âœˆï¸ é£›è¡Œç”Ÿ</button>
                <button class="btn" style="background:#e65100; width:45%; padding:20px;" onclick="setTrack('ground')">ğŸ› ï¸ åœ°å‹¤ç”Ÿ</button>
                <div id="rec-area" style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;"></div>
            </div>
        </div>
    </div>

    <div class="chat-btn" onclick="toggleChat()">ğŸ¤–</div>
    <div class="chat-win" id="chat-win">
        <div style="background:var(--main); color:white; padding:10px;">CAFA åŠ©æ•™</div>
        <div class="chat-body" id="chat-body"><div class="msg msg-ai">åŒå­¸ä½ å¥½ï¼æƒ³å•ä»€éº¼ï¼Ÿ<br>è©¦è©¦ï¼šã€Œæ¨è–¦èª²ç¨‹ã€æˆ–ã€Œæˆ‘çš„å­¸åˆ†ã€</div></div>
        <div style="padding:10px; display:flex;"><input id="chat-in" style="flex:1;" onkeypress="if(event.key=='Enter')sendMsg()"><button onclick="sendMsg()">â¤</button></div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud, listenToCloud } from './firebase-connect.js';
        const KEYS = { STUDENTS: 'cafa_all_students_db', FIXED: 'cafa_fixed_courses', ELECTIVE: 'cafa_public_electives' };
        
        let curUser = JSON.parse(sessionStorage.getItem('cafa_user'));
        let allCourses = [], sDB = [];

        if(!curUser) location.href = 'index.html';
        document.getElementById('welcome-msg').innerText = `Welcome, ${curUser.name}`;

        window.onload = () => {
            listenToCloud(KEYS.STUDENTS, v => { 
                sDB = v || [];
                // å³æ™‚æ›´æ–°ç•¶å‰ä½¿ç”¨è€…è³‡æ–™
                const me = sDB.find(s=>s.id === curUser.id);
                if(me) { curUser = me; render(); }
            });
            listenToCloud(KEYS.FIXED, v => { updateCourses(v, 'fixed'); });
            listenToCloud(KEYS.ELECTIVE, v => { updateCourses(v, 'elect'); });
        };

        let fC=[], eC=[];
        function updateCourses(data, type) {
            if(type==='fixed') fC = data||[]; else eC = data||[];
            allCourses = [...fC, ...eC];
            render();
        }

        function render() {
            // Render Selection
            const list = document.getElementById('course-list'); list.innerHTML = '';
            const myIds = (curUser.courses||[]).map(c=>c.id);
            
            allCourses.forEach(c => {
                if(!c.isOpen && !myIds.includes(c.id)) return;
                const isMy = myIds.includes(c.id);
                const btn = c.isFixed ? '<span style="color:orange">å¿…ä¿®</span>' : (isMy ? `<button class="btn btn-drop" onclick="drop('${c.id}')">é€€é¸</button>` : `<button class="btn btn-add" onclick="add('${c.id}')">åŠ é¸</button>`);
                
                // è¨ˆç®—äººæ•¸
                let count = 0; sDB.forEach(s=>(s.courses||[]).forEach(sc=>{if(sc.id===c.id) count++}));
                
                list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${c.name}</b> <span style="font-size:12px; color:#666;">${c.time} | ${c.teacher} | ${count}/${c.max||99}äºº</span></div>
                    <div>${btn}</div>
                </div>`;
            });

            // Render My Schedule & Grades
            const myT = document.getElementById('my-list'); myT.innerHTML='';
            const scT = document.getElementById('score-list'); scT.innerHTML='';
            let tot=0, cr=0;

            (curUser.courses||[]).forEach(c => {
                const info = allCourses.find(x=>x.id===c.id) || c; // ç›¡é‡æ‰¾æœ€æ–°è³‡è¨Š
                myT.innerHTML += `<tr><td>${info.name}</td><td>${info.time}</td><td>${info.location||'-'}</td><td>${info.credit}</td><td>${c.isFixed?'ğŸ”’':`<button class="btn btn-drop" onclick="drop('${c.id}')">é€€</button>`}</td></tr>`;
                
                if(c.score) {
                    scT.innerHTML += `<tr><td>${info.name}</td><td>${info.credit}</td><td>${c.score}</td></tr>`;
                    tot += c.score * info.credit; cr += parseInt(info.credit);
                }
            });

            // Update GPA & Rank
            const gpa = cr>0 ? (tot/cr).toFixed(1) : 0;
            document.getElementById('my-gpa').innerText = gpa;
            let rank = 'æ–°é€²å­¸å“¡';
            if(gpa >= 90) rank = 'ğŸ‘‘ ç‹è€…é£›è¡Œå“¡';
            else if(gpa >= 80) rank = 'ğŸ’ é‘½çŸ³èè‹±';
            else if(gpa >= 70) rank = 'ğŸ¥‡ é»ƒé‡‘æˆ°å£«';
            document.getElementById('my-rank').innerText = rank;

            // Update Career Rec
            renderRec();
        }

        // Actions
        window.add = async(id) => {
            const c = allCourses.find(x=>x.id===id);
            // æª¢æŸ¥è¡å ‚
            if(curUser.courses.some(my => checkConflict(my.time, c.time))) return alert("è¡å ‚äº†ï¼");
            
            curUser.courses.push({id:c.id, name:c.name, credit:c.credit, time:c.time, isFixed:false});
            await updateMe(); alert("åŠ é¸æˆåŠŸ");
        };

        window.drop = async(id) => {
            if(!confirm("ç¢ºå®šé€€é¸?")) return;
            curUser.courses = curUser.courses.filter(c=>c.id!==id);
            await updateMe();
        };

        window.setTrack = async(t) => {
            curUser.careerTrack = t; await updateMe(); alert("å¿—å‘å·²æ›´æ–°ï¼Œè«‹çœ‹ä¸‹æ–¹æ¨è–¦");
        };

        async function updateMe() {
            const idx = sDB.findIndex(s=>s.id===curUser.id);
            if(idx>-1) { sDB[idx] = curUser; await saveToCloud(KEYS.STUDENTS, sDB); }
        }

        function checkConflict(t1, t2) {
            if(!t1 || !t2) return false;
            let [d1,p1]=t1.split('/'); let [d2,p2]=t2.split('/');
            if(d1!==d2) return false;
            return p1.split(',').some(p=>p2.split(',').includes(p));
        }

        function renderRec() {
            if(!curUser.careerTrack) return;
            const keywords = curUser.careerTrack==='pilot' ? ['é£›è¡Œ','æ°£è±¡','è‹±æ–‡'] : ['ç¶­ä¿®','ç®¡ç†','ç¨‹å¼'];
            const recs = allCourses.filter(c => !c.isFixed && keywords.some(k=>c.name.includes(k)) && !curUser.courses.some(m=>m.id===c.id));
            document.getElementById('rec-area').innerHTML = '<h4>ç‚ºæ‚¨æ¨è–¦ï¼š</h4>' + (recs.length ? recs.map(c=>`<div>ğŸ‘‰ ${c.name} (${c.time})</div>`).join('') : 'æš«ç„¡æ¨è–¦');
        }

        // Chat
        window.toggleChat = () => { const w=document.getElementById('chat-win'); w.style.display = w.style.display==='flex'?'none':'flex'; };
        window.sendMsg = () => {
            const i=document.getElementById('chat-in'); const txt=i.value; if(!txt)return;
            const b=document.getElementById('chat-body');
            b.innerHTML += `<div class="msg msg-me">${txt}</div>`;
            i.value='';
            setTimeout(() => {
                let r = "é€™å€‹å•é¡Œå¤ªæ·±å¥§äº†...";
                if(txt.includes("æ¨è–¦")) r = "ä¾æ“šä½ çš„å¿—å‘ï¼Œæˆ‘æ¨è–¦ä½ é¸ä¿®ç„¡äººæ©Ÿæˆ–ç¨‹å¼è¨­è¨ˆèª²ç¨‹ï¼";
                else if(txt.includes("å­¸åˆ†")) r = `ä½ ç›®å‰ä¿®äº† ${curUser.courses.reduce((a,c)=>a+parseInt(c.credit),0)} å­¸åˆ†ã€‚`;
                else if(txt.includes("å—¨")) r = "ä½ å¥½ï¼æˆ‘æ˜¯é¸èª²å°å¹«æ‰‹ã€‚";
                b.innerHTML += `<div class="msg msg-ai">${r}</div>`;
                b.scrollTop = b.scrollHeight;
            }, 500);
        };

        window.switchTab = (id) => {
            ['selection','schedule','grades','career'].forEach(v=>document.getElementById(v+'-view').style.display='none');
            document.getElementById(id+'-view').style.display='block';
            document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };
        window.logout = () => location.href='index.html';
    </script>
</body>
</html>
