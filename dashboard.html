<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¸èª²ä¸»ç³»çµ± | CAFA Student</title>
    <style>
        /* --- ä¸»é¡Œ CSS è®Šæ•¸ --- */
        :root {
            --cafa-blue-dark: #002266;
            --cafa-blue-main: #00308F;
            --cafa-blue-light: #4a7bd1;
            --cafa-gold: #FFD700;
            --bg-grey: #f0f2f5;
        }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; margin: 0; background-color: var(--bg-grey); color: #333; display: flex; height: 100vh; overflow: hidden; }
        
        /* å´é‚Šæ¬„ç¾åŒ– */
        .sidebar { 
            width: 260px; 
            /* ä½¿ç”¨è—è‰²æ¼¸å±¤èƒŒæ™¯ */
            background: linear-gradient(180deg, var(--cafa-blue-main) 0%, var(--cafa-blue-dark) 100%); 
            color: white; display: flex; flex-direction: column; padding-top: 25px; 
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        /* åŠ å…¥ä¸€å€‹ subtle çš„èƒŒæ™¯æµ®æ°´å° (é¸ç”¨) */
        .sidebar::after {
            content: 'âœˆ'; /* å¯ä»¥æ›æˆæ ¡å¾½åœ–ç‰‡ */
            position: absolute;
            bottom: -50px;
            right: -50px;
            font-size: 200px;
            color: rgba(255,255,255,0.05);
            transform: rotate(-20deg);
            pointer-events: none;
        }

        .sidebar-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .sidebar-header h2 { margin: 0; font-size: 22px; letter-spacing: 1px; font-weight: 800; color: var(--cafa-gold); text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .sidebar-header p { color: rgba(255,255,255,0.7); margin-top: 5px; font-size: 14px; }
        
        .menu-item { padding: 15px 30px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; font-size: 15px; border-left: 4px solid transparent; color: rgba(255,255,255,0.8); }
        .menu-item:hover { background-color: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { background-color: rgba(0,0,0,0.2); border-left: 4px solid var(--cafa-gold); color: white; font-weight: bold; }
        .menu-item span { margin-right: 12px; font-size: 18px; } /* icon ç©ºé–“ */

        .student-info { margin-top: auto; padding: 25px; background: rgba(0,0,0,0.25); font-size: 13px; border-top: 1px solid rgba(255,255,255,0.1); line-height: 1.6; }

        /* ä¸»å…§å®¹å€ */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background-image: linear-gradient(to bottom, #eef2f7, #f4f7fa); }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header-title { font-size: 24px; font-weight: bold; color: var(--cafa-blue-main); display: flex; align-items: center; }
        /* æ¨™é¡Œå‰çš„è—è‰²ç›´ç·šæ”¹æˆé‡‘è‰²ç¿…è†€æ„è±¡çš„è£é£¾ */
        .header-title::before { content: ''; display: inline-block; width: 8px; height: 24px; background: var(--cafa-gold); margin-right: 15px; border-radius: 4px; transform: skewX(-15deg); }

        .card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 25px; border-top: 3px solid var(--cafa-blue-light); }
        
        /* è¡¨æ ¼ç¾åŒ– */
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; }
        th { background-color: #f8f9fa; color: var(--cafa-blue-dark); font-weight: bold; padding: 15px; text-align: left; border-bottom: 2px solid var(--cafa-blue-main); }
        td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover td { background-color: #f0f5ff; }

        /* æ¨™ç±¤èˆ‡æŒ‰éˆ• */
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; letter-spacing: 0.5px; }
        .tag-compulsory { background: #e3f2fd; color: #0d47a1; border: 1px solid #bbdefb; } 
        .tag-elective { background: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; } 
        .tag-fixed { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }
        
        .btn { padding: 8px 16px; border-radius: 30px; border: none; cursor: pointer; font-size: 13px; font-weight: bold; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn-add { background: linear-gradient(45deg, #28a745, #34ce57); color: white; } 
        .btn-drop { background: linear-gradient(45deg, #dc3545, #e4606d); color: white; } 
        .btn-print { background: linear-gradient(45deg, #6c757d, #868e96); color: white; } 
        .btn-disabled { background: #e9ecef; cursor: not-allowed; color: #adb5bd; box-shadow: none; transform: none !important; }

        /* èª²è¡¨èˆ‡æˆç¸¾ */
        .schedule-table th { background: var(--cafa-blue-main); color: white; text-align: center; border: 1px solid rgba(255,255,255,0.2); }
        .schedule-table td { border: 1px solid #eee; text-align: center; }
        .course-block { padding: 5px; border-radius: 6px; color: white; height: 90%; display: flex; flex-direction: column; justify-content: center; font-size: 13px; box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
        .block-fixed { background: linear-gradient(135deg, #c62828, #e53935); } /* å¿…ä¿®ç´… */
        .block-normal { background: linear-gradient(135deg, var(--cafa-blue-main), var(--cafa-blue-light)); } /* é¸ä¿®è— */
        
        .gpa-box { background: linear-gradient(45deg, #333, #555); color: var(--cafa-gold); padding: 15px 25px; border-radius: 8px; display: inline-block; margin-bottom: 20px; font-size: 20px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: 2px solid var(--cafa-gold); }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 999; color: var(--cafa-blue-main); }
        .loading-spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--cafa-gold); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media print { .sidebar, .btn, .header-bar input { display: none !important; } .main-content { padding: 0; background: white; } .card { box-shadow: none; border:none; } }
    </style>
</head>
<body>
    <div id="loading"><div class="loading-spinner"></div><div>é›²ç«¯è³‡æ–™åŒæ­¥ä¸­ï¼Œè«‹ç¨å€™...</div></div>
    
    <div class="sidebar">
        <div class="sidebar-header">
            <h2 style="display: flex; align-items: center; justify-content: center;"><span style="margin-right: 10px; font-size: 28px;">âœˆï¸</span>CAFA é¸èª²ç³»çµ±</h2>
            <p>114å­¸å¹´åº¦ ç¬¬1å­¸æœŸ</p>
        </div>
        <div class="menu-item active" onclick="switchTab('selection')"><span>ğŸ›’</span> åŠ é€€é¸èª²ç¨‹</div>
        <div class="menu-item" onclick="switchTab('schedule')"><span>ğŸ“…</span> å·²é¸æ¸…å–®</div>
        <div class="menu-item" onclick="switchTab('visual')"><span>ğŸ“Š</span> å¯è¦–åŒ–èª²è¡¨</div>
        <div class="menu-item" onclick="switchTab('history')"><span>ğŸ“ˆ</span> æ­·å¹´æˆç¸¾</div>
        <div class="menu-item" onclick="logout()" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 25px; color: #ffcccb;"><span>ğŸšª</span> ç™»å‡ºç³»çµ±</div>
        <div class="student-info" id="user-info-box">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="main-content">
        <div id="selection-view">
            <div class="header-bar"><div class="header-title">é–‹æ”¾é¸èª²æ¸…å–®</div><span style="color:var(--cafa-blue-main);font-weight:bold; font-size: 16px;">å·²é¸å­¸åˆ†ï¼š<span id="current-credits" style="color: var(--cafa-gold); background: var(--cafa-blue-main); padding: 2px 8px; border-radius: 10px;">0</span></span></div>
            <div class="card"><table style="width:100%"><thead><tr><th>é¸åˆ¥</th><th>èª²è™Ÿ</th><th>èª²ç¨‹åç¨±</th><th>å­¸åˆ†</th><th>æ™‚é–“</th><th>åé¡</th><th>æ“ä½œ</th></tr></thead><tbody id="course-list-body"></tbody></table></div>
        </div>
        <div id="schedule-view" style="display: none;">
            <div class="header-bar"><div class="header-title">å·²é¸èª²ç¨‹åˆ—è¡¨</div></div>
            <div class="card"><table style="width:100%"><thead><tr><th>é¸åˆ¥</th><th>èª²ç¨‹åç¨±</th><th>å­¸åˆ†</th><th>æ™‚é–“</th><th>åœ°é»</th><th>æ“ä½œ</th></tr></thead><tbody id="my-course-body"></tbody></table></div>
        </div>
        <div id="visual-view" style="display: none;">
            <div class="header-bar"><div class="header-title">é€±èª²è¡¨æª¢è¦–</div><button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°èª²è¡¨</button></div>
            <div class="card" style="overflow-x: auto;"><table class="schedule-table" style="min-width: 800px;"><thead><tr><th style="width:80px; background: #f8f9fa; color: #555;">ç¯€æ¬¡</th><th>æ˜ŸæœŸä¸€</th><th>æ˜ŸæœŸäºŒ</th><th>æ˜ŸæœŸä¸‰</th><th>æ˜ŸæœŸå››</th><th>æ˜ŸæœŸäº”</th></tr></thead><tbody id="visual-schedule-body"></tbody></table></div>
        </div>
        <div id="history-view" style="display: none;">
            <div class="header-bar"><div class="header-title">æ­·å¹´æˆç¸¾æŸ¥è©¢</div><button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°æˆç¸¾å–®</button></div>
            <div class="gpa-box">â­ ç¸½å¹³å‡ (GPA): <span id="total-gpa" style="color: white;">--</span></div>
            <div id="history-content"></div>
        </div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud } from './firebase-connect.js';

        const KEYS = { STUDENTS: 'cafa_all_students_db', FIXED: 'cafa_fixed_courses', ELECTIVE: 'cafa_public_electives' };
        let allCourses = [], myCourses = [], currentUser = null, studentDB = [];

        // ç¶å®šæŒ‰éˆ•åŠŸèƒ½
        window.logout = function() { sessionStorage.removeItem('cafa_user'); window.location.href='index.html'; }
        window.switchTab = switchTab;
        window.add = add;
        window.drop = drop;

        window.onload = async function() {
            const userStr = sessionStorage.getItem('cafa_user');
            if(!userStr) { window.location.href='index.html'; return; }
            currentUser = JSON.parse(userStr);
            document.getElementById('user-info-box').innerHTML = `<strong>${currentUser.id}</strong><br>${currentUser.name}<br>${currentUser.dept}`;

            document.getElementById('loading').style.display = 'flex';
            await syncData();
            document.getElementById('loading').style.display = 'none';
        };

        async function syncData() {
            studentDB = (await loadFromCloud(KEYS.STUDENTS)) || [];
            const me = studentDB.find(s => s.id === currentUser.id);
            if(me) { currentUser = me; myCourses = me.courses || []; }
            
            allCourses = [];
            const elect = (await loadFromCloud(KEYS.ELECTIVE)) || [];
            elect.forEach(c => { c.capacity=50; c.enrolled=0; allCourses.push(c); });
            
            const fixed = (await loadFromCloud(KEYS.FIXED)) || [];
            let hasNewFixed = false;
            fixed.forEach(c => {
                const exists = myCourses.some(mc => mc.id === c.id);
                if(!exists) { myCourses.push(c); hasNewFixed = true; } 
                else { myCourses[myCourses.findIndex(mc => mc.id === c.id)] = c; }
            });

            if(hasNewFixed) { await saveMyData(); }

            renderCourseList(); generateGrid(); renderMySchedule();
        }

        async function saveMyData() {
            const idx = studentDB.findIndex(s => s.id === currentUser.id);
            if(idx > -1) {
                studentDB[idx].courses = myCourses;
                studentDB[idx].totalCredits = myCourses.reduce((s,c)=>s+c.credit,0);
                await saveToCloud(KEYS.STUDENTS, studentDB);
            }
        }

        async function add(id) {
            const c = allCourses.find(x => x.id === id);
            const conflictName = checkTimeConflict(c);
            if(conflictName) { alert(`âŒ åŠ é¸å¤±æ•—ï¼èˆ‡ã€${conflictName}ã€‘æ™‚é–“è¡çªï¼`); return; }
            myCourses.push(c); await saveMyData(); renderCourseList(); generateGrid(); renderMySchedule();
            alert(`âœ… æˆåŠŸåŠ é¸ï¼š${c.name}`);
        }

        async function drop(id) {
            const c = myCourses.find(x => x.id === id);
            if(c && c.isFixed) { alert("âš ï¸ ç­å®šå¿…ä¿®ç„¡æ³•é€€é¸ï¼"); return; }
            if(!confirm("ç¢ºå®šé€€é¸ï¼Ÿ")) return;
            myCourses = myCourses.filter(c => c.id !== id); await saveMyData(); renderCourseList(); generateGrid(); renderMySchedule();
        }
        
        function checkTimeConflict(newCourse) {
             if(!newCourse.time) return null;
             let [d1, pStr1] = newCourse.time.split('/');
             let periods1 = pStr1.split(',');
             for(let oldCourse of myCourses) {
                 if(!oldCourse.time) continue;
                 let [d2, pStr2] = oldCourse.time.split('/');
                 if(d1 === d2) {
                     let periods2 = pStr2.split(',');
                     if(periods1.some(p => periods2.includes(p))) return oldCourse.name;
                 }
             }
             return null;
        }

        function renderCourseList() {
            const tbody = document.getElementById('course-list-body'); tbody.innerHTML='';
            allCourses.forEach(c => {
                const isSel = myCourses.some(mc=>mc.id===c.id);
                const isOpen = c.isOpen !== false;
                let btn = isSel ? `<button class="btn btn-disabled" disabled>å·²é¸</button>` : 
                          !isOpen ? `<button class="btn btn-disabled" disabled>â›” æš«åœ</button>` :
                          `<button class="btn btn-add" onclick="add('${c.id}')">åŠ é¸</button>`;
                const tag = c.type==='å¿…ä¿®'?'tag-compulsory':'tag-elective';
                tbody.innerHTML += `<tr><td><span class="tag ${tag}">${c.type}</span></td><td>${c.id}</td><td><strong>${c.name}</strong></td><td>${c.credit}</td><td>${c.time}</td><td>${c.enrolled}/${c.capacity}</td><td>${btn}</td></tr>`;
            });
            document.getElementById('current-credits').innerText = myCourses.reduce((s,c)=>s+c.credit,0);
        }

        function renderMySchedule() {
             const tb = document.getElementById('my-course-body'); tb.innerHTML='';
             if(myCourses.length === 0) { tb.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999; padding: 30px;">å°šæœªé¸èª²</td></tr>'; return; }
             myCourses.forEach(c => {
                 let isFixed = c.isFixed===true;
                 tb.innerHTML += `<tr><td><span class="tag ${isFixed?'tag-fixed':'tag-elective'}">${c.type}</span></td><td><strong>${c.name}</strong></td><td>${c.credit}</td><td>${c.time}</td><td>${c.location||'-'}</td><td>${isFixed?'<span style="color:#c62828;font-weight:bold;font-size:12px;">ğŸ”’ ç­å®šå¿…ä¿®</span>':`<button class="btn btn-drop" onclick="drop('${c.id}')">é€€é¸</button>`}</td></tr>`;
             });
        }

        function generateGrid() {
            const t = document.getElementById('visual-schedule-body'); t.innerHTML='';
            const times = ["08:10", "09:10", "10:10", "11:10", "13:30", "14:30", "15:30", "16:30", "17:30", "19:00"];
            for(let i=1;i<=10;i++) t.innerHTML+=`<tr><td style="background:#f8f9fa;font-weight:bold;color:#555;">${i}<br><span style="font-weight:normal;font-size:11px;">${times[i-1]}</span></td><td id="c1-${i}"></td><td id="c2-${i}"></td><td id="c3-${i}"></td><td id="c4-${i}"></td><td id="c5-${i}"></td></tr>`;
            
            const dayMap = {"ä¸€":1,"äºŒ":2,"ä¸‰":3,"å››":4,"äº”":5};
            myCourses.forEach(c => {
                if(!c.time) return;
                let [dayStr, pStr] = c.time.split('/');
                let day = dayMap[dayStr];
                pStr.split(',').forEach(p => {
                    let el = document.getElementById(`c${day}-${p}`);
                    if(el) el.innerHTML = `<div class="course-block ${c.isFixed?'block-fixed':'block-normal'}">${c.name}<br><span style="font-size:11px; opacity:0.8;">${c.location||''}</span></div>`;
                });
            });
        }
        
        function renderHistory() {
            const container = document.getElementById('history-content'); container.innerHTML = '';
            let totalScore=0, totalCredits=0;
            // æ¨¡æ“¬æ­·å²è³‡æ–™ (å¯è‡ªè¡Œä¿®æ”¹æˆ–ç§»é™¤)
            const mockHistory = [{ semester: "113å­¸å¹´åº¦ ç¬¬2å­¸æœŸ (æ¨¡æ“¬)", courses: [{ name: "é£›è¡ŒåŸç†æ¦‚è«–", credit: 3, score: 88 }, { name: "è»äº‹è‹±æ–‡", credit: 2, score: 75 }] }];
            
            mockHistory.forEach(sem => {
                let html = `<div class="card" style="border-top-color:#999;"><div class="semester-title" style="background:#eee; color:#333;">${sem.semester}</div><table><thead><tr><th>èª²ç¨‹</th><th>å­¸åˆ†</th><th>æˆç¸¾</th></tr></thead><tbody>`;
                sem.courses.forEach(c => { totalScore+=c.score*c.credit; totalCredits+=c.credit; html+=`<tr><td>${c.name}</td><td>${c.credit}</td><td class="${c.score<60?'score-fail':'score-high'}">${c.score}</td></tr>`; });
                html+=`</tbody></table></div>`; container.innerHTML+=html;
            });

            const currentGraded = myCourses.filter(c => c.score !== undefined && c.score !== null && c.score !== '');
            if(currentGraded.length>0) {
                let html = `<div class="card"><div class="semester-title">114å­¸å¹´åº¦ ç¬¬1å­¸æœŸ (æœ¬å­¸æœŸ)</div><table><thead><tr><th>èª²ç¨‹</th><th>å­¸åˆ†</th><th>æˆç¸¾</th></tr></thead><tbody>`;
                currentGraded.forEach(c => { let s=parseInt(c.score); totalScore+=s*c.credit; totalCredits+=c.credit; html+=`<tr><td><strong>${c.name}</strong></td><td>${c.credit}</td><td class="${s<60?'score-fail':'score-high'}" style="font-size:16px;">${s}</td></tr>`; });
                html+=`</tbody></table></div>`; container.innerHTML = html + container.innerHTML;
            } else {
                container.innerHTML = `<div class="card" style="text-align:center; padding:30px; color:#999;">æœ¬å­¸æœŸå°šç„¡æˆç¸¾ç´€éŒ„</div>` + container.innerHTML;
            }
            document.getElementById('total-gpa').innerText = totalCredits>0 ? (totalScore/totalCredits).toFixed(2) : "0.0";
        }

        function switchTab(tab) {
            ['selection','schedule','visual','history'].forEach(v => document.getElementById(v+'-view').style.display='none');
            document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
            if(tab==='selection') { document.getElementById('selection-view').style.display='block'; renderCourseList(); }
            if(tab==='schedule') { document.getElementById('schedule-view').style.display='block'; renderMySchedule(); }
            if(tab==='visual') { document.getElementById('visual-view').style.display='block'; generateGrid(); }
            if(tab==='history') { document.getElementById('history-view').style.display='block'; renderHistory(); }
            // æ›´æ–°é¸å–® active ç‹€æ…‹
            const iconMap = {'selection':0, 'schedule':1, 'visual':2, 'history':3};
            if(iconMap[tab]!==undefined) document.querySelectorAll('.menu-item')[iconMap[tab]].classList.add('active');
        }
    </script>
</body>
</html>



